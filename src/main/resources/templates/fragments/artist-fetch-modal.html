<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Artist External Fetch Modal Fragment</title>
</head>
<body>
    <!-- Artist External Fetch Modal Fragment -->
    <!-- Used for fetching artist metadata from MusicBrainz (birth date, death date, country) -->
    <th:block th:fragment="artist-fetch-modal">
        <div id="artistFetchModal" class="af-modal">
            <div class="af-modal-content" onclick="event.stopPropagation()">
                <div class="af-modal-header">
                    <h3 id="afModalTitle">Fetch Artist Info</h3>
                    <button class="af-modal-close" onclick="closeArtistFetchModal(event)">&times;</button>
                </div>
                
                <div class="af-modal-body">
                    <!-- Search form -->
                    <div class="af-search-form">
                        <input type="text" id="afSearchInput" class="af-search-input" placeholder="Artist Name" 
                               onkeydown="if(event.key==='Enter') performArtistSearch()">
                        <button type="button" class="af-btn-search" onclick="performArtistSearch()">Search MusicBrainz</button>
                    </div>
                    
                    <!-- Search status -->
                    <div id="afSearchStatus" class="af-search-status" style="display: none;">
                        Searching...
                    </div>
                    
                    <!-- Error message -->
                    <div id="afErrorMessage" class="af-error-message" style="display: none;">
                        No results found
                    </div>
                    
                    <!-- Results list -->
                    <div id="afResultsList" class="af-results-list" style="display: none;">
                    </div>
                </div>
                
                <div class="af-modal-footer">
                    <div class="af-modal-buttons">
                        <button type="button" class="af-btn-cancel" onclick="closeArtistFetchModal(event)">Cancel</button>
                        <button type="button" class="af-btn-apply" id="afApplyBtn" onclick="applyArtistSelection()" disabled>
                            Apply Selected
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <style>
            .af-modal {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.85);
                z-index: 10000;
                align-items: center;
                justify-content: center;
            }
            
            .af-modal.show {
                display: flex;
            }
            
            .af-modal-content {
                background: var(--surface, #1a1a2e);
                border: 1px solid rgba(255, 255, 255, 0.1);
                border-radius: 12px;
                width: 90%;
                max-width: 700px;
                max-height: 85vh;
                display: flex;
                flex-direction: column;
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            }
            
            .af-modal-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 16px 20px;
                border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            }
            
            .af-modal-header h3 {
                margin: 0;
                color: #fff;
                font-size: 18px;
            }
            
            .af-modal-close {
                background: transparent;
                border: none;
                color: #fff;
                font-size: 28px;
                cursor: pointer;
                padding: 0 8px;
                line-height: 1;
                opacity: 0.7;
                transition: opacity 0.2s;
            }
            
            .af-modal-close:hover {
                opacity: 1;
            }
            
            .af-modal-body {
                flex: 1;
                overflow-y: auto;
                padding: 20px;
                min-height: 300px;
            }
            
            .af-search-form {
                display: flex;
                gap: 10px;
                margin-bottom: 20px;
            }
            
            .af-search-input {
                flex: 1;
                padding: 10px 14px;
                background: rgba(255, 255, 255, 0.1);
                border: 1px solid rgba(255, 255, 255, 0.2);
                border-radius: 6px;
                color: #fff;
                font-size: 14px;
            }
            
            .af-search-input::placeholder {
                color: rgba(255, 255, 255, 0.5);
            }
            
            .af-search-input:focus {
                outline: none;
                border-color: rgba(255, 255, 255, 0.4);
                background: rgba(255, 255, 255, 0.15);
            }
            
            .af-btn-search {
                padding: 10px 20px;
                background: #ffa500;
                border: none;
                color: #1a1a1a;
                border-radius: 6px;
                cursor: pointer;
                font-size: 14px;
                font-weight: 600;
                transition: all 0.2s;
            }
            
            .af-btn-search:hover {
                background: #ff8c00;
            }
            
            .af-search-status {
                text-align: center;
                color: var(--text-muted, #888);
                font-size: 14px;
                padding: 40px;
            }
            
            .af-error-message {
                text-align: center;
                color: #f44336;
                font-size: 14px;
                padding: 40px;
            }
            
            .af-results-list {
                display: flex;
                flex-direction: column;
                gap: 8px;
            }
            
            .af-result-item {
                display: flex;
                flex-direction: column;
                padding: 14px 16px;
                background: rgba(255, 255, 255, 0.05);
                border: 2px solid transparent;
                border-radius: 8px;
                cursor: pointer;
                transition: all 0.2s, transform 0.1s;
            }
            
            .af-result-item:hover {
                background: rgba(255, 255, 255, 0.1);
                border-color: rgba(255, 255, 255, 0.2);
            }
            
            .af-result-item:active {
                transform: scale(0.98);
            }
            
            .af-result-item.selected {
                background: rgba(255, 165, 0, 0.15);
                border-color: #ffa500;
            }
            
            .af-result-header {
                display: flex;
                align-items: center;
                gap: 10px;
                margin-bottom: 6px;
            }
            
            .af-result-name {
                font-size: 15px;
                font-weight: 600;
                color: #fff;
                flex: 1;
            }
            
            .af-result-type {
                font-size: 11px;
                padding: 2px 8px;
                border-radius: 4px;
                background: rgba(255, 165, 0, 0.25);
                color: #ffa500;
                font-weight: 500;
            }
            
            .af-result-type.group {
                background: rgba(66, 165, 245, 0.25);
                color: #42a5f5;
            }
            
            .af-result-score {
                font-size: 11px;
                padding: 2px 8px;
                border-radius: 4px;
                background: rgba(255, 255, 255, 0.1);
                color: rgba(255, 255, 255, 0.6);
            }
            
            .af-result-disambiguation {
                font-size: 12px;
                color: rgba(255, 255, 255, 0.5);
                font-style: italic;
                margin-bottom: 8px;
            }
            
            .af-result-details {
                display: flex;
                flex-wrap: wrap;
                gap: 16px;
                font-size: 13px;
            }
            
            .af-result-detail {
                display: flex;
                align-items: center;
                gap: 4px;
                color: rgba(255, 255, 255, 0.7);
            }
            
            .af-result-detail-label {
                color: rgba(255, 255, 255, 0.4);
            }
            
            .af-result-detail-value {
                color: #fff;
            }
            
            .af-result-deceased {
                color: #f44336;
            }
            
            .af-modal-footer {
                display: flex;
                justify-content: flex-end;
                padding: 16px 20px;
                border-top: 1px solid rgba(255, 255, 255, 0.1);
            }
            
            .af-modal-buttons {
                display: flex;
                gap: 10px;
            }
            
            .af-btn-cancel {
                padding: 10px 20px;
                background: rgba(255, 255, 255, 0.1);
                border: 1px solid rgba(255, 255, 255, 0.2);
                color: #fff;
                border-radius: 6px;
                cursor: pointer;
                font-size: 14px;
                transition: all 0.2s;
            }
            
            .af-btn-cancel:hover {
                background: rgba(255, 255, 255, 0.15);
            }
            
            .af-btn-apply {
                padding: 10px 20px;
                background: #ffa500;
                border: none;
                color: #1a1a1a;
                border-radius: 6px;
                cursor: pointer;
                font-size: 14px;
                font-weight: 600;
                transition: all 0.2s;
            }
            
            .af-btn-apply:hover:not(:disabled) {
                background: #ff8c00;
            }
            
            .af-btn-apply:disabled {
                opacity: 0.5;
                cursor: not-allowed;
            }
        </style>
        
        <script th:inline="javascript">
            // Artist Fetch Modal state
            let afArtistId = null;
            let afSelectedArtist = null;
            let afOnApplyCallback = null;
            
            /**
             * Open the Artist Fetch Modal
             * @param artistName - Pre-fill search with this artist name
             * @param artistId - ID of artist to update (null if creating new)
             * @param onApplyCallback - Callback function when metadata is applied (for wizard mode)
             */
            function openArtistFetchModal(artistName, artistId, onApplyCallback) {
                afArtistId = artistId;
                afSelectedArtist = null;
                afOnApplyCallback = onApplyCallback || null;
                
                const modal = document.getElementById('artistFetchModal');
                const searchInput = document.getElementById('afSearchInput');
                const status = document.getElementById('afSearchStatus');
                const error = document.getElementById('afErrorMessage');
                const list = document.getElementById('afResultsList');
                const applyBtn = document.getElementById('afApplyBtn');
                const titleEl = document.getElementById('afModalTitle');
                
                // Set title based on mode
                titleEl.textContent = artistId ? 'Fetch Artist Info' : 'Fetch Artist Info (New Artist)';
                
                // Set search input value
                searchInput.value = artistName || '';
                
                // Reset state
                status.style.display = 'none';
                error.style.display = 'none';
                list.style.display = 'none';
                list.innerHTML = '';
                applyBtn.disabled = true;
                
                modal.classList.add('show');
                document.body.style.overflow = 'hidden';
                
                // Auto-perform initial search if name provided
                if (artistName) {
                    performArtistSearch();
                }
            }
            
            function performArtistSearch() {
                const searchInput = document.getElementById('afSearchInput');
                const searchValue = searchInput.value.trim();
                
                if (!searchValue) {
                    showWarningToast('Please enter an artist name');
                    return;
                }
                
                const status = document.getElementById('afSearchStatus');
                const error = document.getElementById('afErrorMessage');
                const list = document.getElementById('afResultsList');
                const applyBtn = document.getElementById('afApplyBtn');
                
                // Reset state
                afSelectedArtist = null;
                status.style.display = 'block';
                status.textContent = 'Searching MusicBrainz... (please wait, rate limited)';
                error.style.display = 'none';
                list.style.display = 'none';
                list.innerHTML = '';
                applyBtn.disabled = true;
                
                fetch(`/api/musicbrainz/search-artist?term=${encodeURIComponent(searchValue)}`)
                    .then(response => response.json())
                    .then(data => {
                        status.style.display = 'none';
                        
                        if (!data || data.length === 0) {
                            error.textContent = 'No artists found. Try a different spelling.';
                            error.style.display = 'block';
                            return;
                        }
                        
                        // Render results
                        list.innerHTML = data.map((artist, index) => {
                            const typeClass = (artist.type === 'Group' || artist.type === 'Orchestra' || artist.type === 'Choir') ? 'group' : '';
                            const typeLabel = artist.type || 'Unknown';
                            
                            // Format dates for display
                            const birthDisplay = formatMbDate(artist.birthDate);
                            const deathDisplay = formatMbDate(artist.deathDate);
                            
                            // Build details line
                            let details = [];
                            if (artist.country) {
                                details.push(`<span class="af-result-detail"><span class="af-result-detail-label">Country:</span> <span class="af-result-detail-value">${escapeHtml(artist.country)}</span></span>`);
                            }
                            if (birthDisplay) {
                                const label = typeClass ? 'Formed:' : 'Born:';
                                details.push(`<span class="af-result-detail"><span class="af-result-detail-label">${label}</span> <span class="af-result-detail-value">${birthDisplay}</span></span>`);
                            }
                            if (deathDisplay) {
                                const label = typeClass ? 'Disbanded:' : 'Died:';
                                details.push(`<span class="af-result-detail af-result-deceased"><span class="af-result-detail-label">${label}</span> <span class="af-result-detail-value">${deathDisplay}</span></span>`);
                            } else if (artist.isDeceased) {
                                const label = typeClass ? 'Disbanded' : 'Deceased';
                                details.push(`<span class="af-result-detail af-result-deceased">${label}</span>`);
                            }
                            
                            return `
                                <div class="af-result-item" data-index="${index}"
                                     data-mbid="${artist.mbid}"
                                     data-name="${escapeAttr(artist.name)}"
                                     data-birth-date="${artist.birthDate || ''}"
                                     data-death-date="${artist.deathDate || ''}"
                                     data-country="${escapeAttr(artist.country || '')}"
                                     data-type="${artist.type || ''}"
                                     onclick="selectArtistResult(this)">
                                    <div class="af-result-header">
                                        <span class="af-result-name">${escapeHtml(artist.name)}</span>
                                        <span class="af-result-type ${typeClass}">${typeLabel}</span>
                                        <span class="af-result-score">${artist.score}%</span>
                                    </div>
                                    ${artist.disambiguation ? `<div class="af-result-disambiguation">${escapeHtml(artist.disambiguation)}</div>` : ''}
                                    <div class="af-result-details">${details.join('')}</div>
                                </div>
                            `;
                        }).join('');
                        
                        list.style.display = 'flex';
                    })
                    .catch(err => {
                        console.error('MusicBrainz search error:', err);
                        status.style.display = 'none';
                        error.textContent = 'Error searching MusicBrainz. Please try again.';
                        error.style.display = 'block';
                    });
            }
            
            function selectArtistResult(element) {
                // Add immediate visual feedback
                element.style.transform = 'scale(0.98)';
                setTimeout(() => { element.style.transform = ''; }, 100);
                
                // Deselect all (only ones that are selected)
                document.querySelectorAll('.af-result-item.selected').forEach(item => {
                    item.classList.remove('selected');
                });
                
                // Select this one
                element.classList.add('selected');
                
                afSelectedArtist = {
                    mbid: element.dataset.mbid,
                    name: element.dataset.name,
                    birthDate: element.dataset.birthDate || null,
                    deathDate: element.dataset.deathDate || null,
                    country: element.dataset.country || null,
                    type: element.dataset.type || null
                };
                
                document.getElementById('afApplyBtn').disabled = false;
            }
            
            function applyArtistSelection() {
                if (!afSelectedArtist) return;
                
                // If callback provided (wizard mode), call it with data
                if (afOnApplyCallback) {
                    afOnApplyCallback(afSelectedArtist);
                    closeArtistFetchModal();
                    return;
                }
                
                // Otherwise, apply to existing artist via API
                if (!afArtistId) {
                    showErrorToast('No artist ID specified');
                    return;
                }
                
                const applyBtn = document.getElementById('afApplyBtn');
                applyBtn.disabled = true;
                applyBtn.textContent = 'Applying...';
                
                fetch(`/api/musicbrainz/apply/${afArtistId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(afSelectedArtist)
                })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        // Refresh page to show updated data
                        window.location.reload();
                    } else {
                        showErrorToast('Error: ' + (result.error || 'Failed to apply metadata'));
                        applyBtn.disabled = false;
                        applyBtn.textContent = 'Apply Selected';
                    }
                })
                .catch(err => {
                    console.error('Apply error:', err);
                    showErrorToast('Error applying metadata. Please try again.');
                    applyBtn.disabled = false;
                    applyBtn.textContent = 'Apply Selected';
                });
            }
            
            function closeArtistFetchModal(event) {
                if (event && event.target && event.target.classList.contains('af-modal-content')) {
                    return;
                }
                const modal = document.getElementById('artistFetchModal');
                modal.classList.remove('show');
                document.body.style.overflow = '';
            }
            
            function formatMbDate(dateStr) {
                if (!dateStr) return null;
                
                // Parse YYYY, YYYY-MM, or YYYY-MM-DD
                const parts = dateStr.split('-');
                if (parts.length === 1) {
                    return parts[0]; // Just year
                } else if (parts.length === 2) {
                    const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                    return months[parseInt(parts[1]) - 1] + ' ' + parts[0];
                } else {
                    const d = new Date(dateStr + 'T00:00:00');
                    return d.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
                }
            }
            
            function escapeHtml(str) {
                if (!str) return '';
                const div = document.createElement('div');
                div.textContent = str;
                return div.innerHTML;
            }
            
            function escapeAttr(str) {
                if (!str) return '';
                return str.replace(/"/g, '&quot;').replace(/'/g, '&#39;');
            }
        </script>
    </th:block>
</body>
</html>
