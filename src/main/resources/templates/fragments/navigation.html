<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <th:block th:fragment="nav-styles">
        <!-- Navigation CSS moved to /css/global.css to centralize layout and avoid
             duplication; keep this fragment focused on the script and markup. -->
         <script>
             // Robust floating tooltip: append a positioned element to document.body
             (function(){
                 const activeTooltips = new WeakMap();

                 function createFloatingTooltip(text) {
                     const node = document.createElement('div');
                     node.className = 'floating-tooltip';
                     // Inline styles to avoid relying on external CSS
                     node.style.position = 'fixed';
                     node.style.background = 'rgba(0,0,0,0.92)';
                     node.style.color = '#fff';
                     node.style.padding = '8px 10px';
                     node.style.borderRadius = '8px';
                     node.style.boxShadow = '0 10px 20px rgba(0,0,0,0.45)';
                     node.style.zIndex = 2147483000;
                     node.style.maxWidth = '360px';
                     node.style.whiteSpace = 'pre-line';
                     node.style.transition = 'opacity 160ms ease, transform 160ms ease';
                     node.style.opacity = '0';
                     node.style.pointerEvents = 'auto';
                     node.style.left = '0px';
                     node.style.top = '0px';
                     node.style.willChange = 'opacity, transform';
                     node.textContent = text || '';
                     return node;
                 }

                 window.showTooltip = function(el) {
                     try {
                         if (!el) return;
                         // Prefer dataset on the element to avoid showing text inline
                         const contentNode = el.querySelector('.tooltiptext');
                         const text = (el.dataset && el.dataset.plays) ? el.dataset.plays : (contentNode ? contentNode.textContent : '');
                         if (!text || text.trim() === '') return;

                         // If already created, reuse
                         if (activeTooltips.has(el)) return;

                         const tip = createFloatingTooltip(text);
                         document.body.appendChild(tip);
                         activeTooltips.set(el, tip);

                         // Position
                         const rect = el.getBoundingClientRect();
                         // Let tip render to measure
                         const measure = () => {
                             const tw = tip.offsetWidth;
                             const th = tip.offsetHeight;
                             // Preferred above the element
                             let left = rect.left + (rect.width / 2) - (tw / 2);
                             left = Math.max(8, Math.min(left, window.innerWidth - tw - 8));
                             let top = rect.top - th - 8;
                             let transform = 'translateY(6px)';
                             if (top < 8) {
                                 // Not enough space above ‚Äî place below
                                 top = rect.bottom + 8;
                                 transform = 'translateY(-6px)';
                             }
                             tip.style.left = Math.round(left) + 'px';
                             tip.style.top = Math.round(top) + 'px';
                             // Force reflow then animate in
                             requestAnimationFrame(() => {
                                 tip.style.transform = 'translateY(0)';
                                 tip.style.opacity = '1';
                             });
                         };
                         // Delay to ensure DOM appended
                         setTimeout(measure, 8);

                         // hide on scroll/resizes
                         const onWindowChange = () => { window.hideTooltip(el); };
                         window.addEventListener('scroll', onWindowChange, true);
                         window.addEventListener('resize', onWindowChange);
                         // store cleanup handler
                         tip._cleanup = () => {
                             window.removeEventListener('scroll', onWindowChange, true);
                             window.removeEventListener('resize', onWindowChange);
                         };
                     } catch (e) { /* ignore */ }
                 };

                 window.hideTooltip = function(el) {
                     try {
                         const tip = activeTooltips.get(el);
                         if (!tip) return;
                         tip.style.opacity = '0';
                         tip.style.transform = 'translateY(6px)';
                         // allow transition to finish then remove
                         const cleanup = () => {
                             try { if (tip._cleanup) tip._cleanup(); } catch(e){}
                             if (tip.parentNode) tip.parentNode.removeChild(tip);
                         };
                         setTimeout(cleanup, 180);
                         activeTooltips.delete(el);
                     } catch (e) { /* ignore */ }
                 };
             })();
          </script>
          <!-- Toast Notification System -->
          <style>
            .toast-container {
                position: fixed;
                top: 80px;
                right: 20px;
                z-index: 2147483647;
                display: flex;
                flex-direction: column;
                gap: 10px;
                pointer-events: none;
            }
            .toast {
                display: flex;
                align-items: flex-start;
                gap: 12px;
                padding: 14px 16px;
                min-width: 300px;
                max-width: 420px;
                border-radius: 10px;
                box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
                pointer-events: auto;
                animation: toastSlideIn 0.3s ease-out;
                backdrop-filter: blur(8px);
            }
            .toast.toast-hiding { animation: toastSlideOut 0.3s ease-in forwards; }
            .toast-error { background: linear-gradient(135deg, rgba(220, 38, 38, 0.95), rgba(185, 28, 28, 0.95)); border: 1px solid rgba(248, 113, 113, 0.3); }
            .toast-warning { background: linear-gradient(135deg, rgba(217, 119, 6, 0.95), rgba(180, 83, 9, 0.95)); border: 1px solid rgba(251, 191, 36, 0.3); }
            .toast-success { background: linear-gradient(135deg, rgba(22, 163, 74, 0.95), rgba(21, 128, 61, 0.95)); border: 1px solid rgba(74, 222, 128, 0.3); }
            .toast-info { background: linear-gradient(135deg, rgba(59, 130, 246, 0.95), rgba(37, 99, 235, 0.95)); border: 1px solid rgba(147, 197, 253, 0.3); }
            .toast-icon { flex-shrink: 0; font-size: 1.3rem; line-height: 1; margin-top: 2px; }
            .toast-content { flex: 1; color: #fff; }
            .toast-title { font-weight: 600; font-size: 0.95rem; margin-bottom: 2px; }
            .toast-message { font-size: 0.875rem; opacity: 0.92; line-height: 1.4; word-break: break-word; }
            .toast-close { flex-shrink: 0; background: rgba(255, 255, 255, 0.15); border: none; color: #fff; width: 24px; height: 24px; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1rem; transition: background 0.15s ease; margin-top: -2px; }
            .toast-close:hover { background: rgba(255, 255, 255, 0.25); }
            @keyframes toastSlideIn { from { opacity: 0; transform: translateX(100%); } to { opacity: 1; transform: translateX(0); } }
            @keyframes toastSlideOut { from { opacity: 1; transform: translateX(0); } to { opacity: 0; transform: translateX(100%); } }
            @media (max-width: 480px) { .toast-container { left: 10px; right: 10px; top: 70px; } .toast { min-width: auto; max-width: none; } }
          </style>
          <script>
            (function() {
                function ensureContainer() {
                    let container = document.getElementById('toastContainer');
                    if (!container) {
                        container = document.createElement('div');
                        container.id = 'toastContainer';
                        container.className = 'toast-container';
                        document.body.appendChild(container);
                    }
                    return container;
                }
                window.showToast = function(message, type, duration) {
                    type = type || 'info';
                    duration = duration !== undefined ? duration : 5000;
                    const container = ensureContainer();
                    const icons = { error: '‚ùå', warning: '‚ö†Ô∏è', success: '‚úÖ', info: '‚ÑπÔ∏è' };
                    const titles = { error: 'Error', warning: 'Warning', success: 'Success', info: 'Info' };
                    const toast = document.createElement('div');
                    toast.className = 'toast toast-' + type;
                    toast.innerHTML = '<span class="toast-icon">' + (icons[type] || icons.info) + '</span>' +
                        '<div class="toast-content"><div class="toast-title">' + (titles[type] || titles.info) + '</div>' +
                        '<div class="toast-message">' + message + '</div></div>' +
                        '<button class="toast-close" onclick="this.parentElement.remove()">√ó</button>';
                    container.appendChild(toast);
                    if (duration > 0) {
                        setTimeout(function() {
                            if (toast.parentElement) {
                                toast.classList.add('toast-hiding');
                                setTimeout(function() { toast.remove(); }, 300);
                            }
                        }, duration);
                    }
                    return toast;
                };
                window.showErrorToast = function(message, duration) { return showToast(message, 'error', duration || 6000); };
                window.showWarningToast = function(message, duration) { return showToast(message, 'warning', duration || 5000); };
                window.showSuccessToast = function(message, duration) { return showToast(message, 'success', duration || 4000); };
                window.showInfoToast = function(message, duration) { return showToast(message, 'info', duration || 5000); };
            })();
          </script>
     </th:block>
</head>
<body>
    <nav th:fragment="navigation" class="app-nav">
        <div class="app-nav-container">
         <div class="app-nav-left">
             <a href="/" class="app-nav-brand">Music Stats</a>
             <!-- Mobile hamburger menu button -->
             <button class="mobile-menu-toggle" onclick="toggleMobileNav()" aria-label="Open menu">‚ò∞</button>
             <ul class="app-nav-links" id="mobileNavLinks">
                 <!-- Mobile close button (wrapped in li for valid HTML) -->
                 <li class="mobile-nav-close-wrapper"><button class="mobile-nav-close" onclick="toggleMobileNav()" aria-label="Close menu">√ó</button></li>
                 <li><a href="/artists" class="app-nav-link" th:classappend="${currentSection == 'artists'} ? 'active' : ''">Artists</a></li>
                 <li><a href="/albums" class="app-nav-link" th:classappend="${currentSection == 'albums'} ? 'active' : ''">Albums</a></li>
                 <li><a href="/songs" class="app-nav-link" th:classappend="${currentSection == 'songs'} ? 'active' : ''">Songs</a></li>
                 <li class="app-nav-dropdown">
                     <a href="#" class="app-nav-link app-nav-dropdown-toggle" 
                        th:classappend="${currentSection == 'genders' or currentSection == 'genres' or currentSection == 'subgenres' or currentSection == 'ethnicities' or currentSection == 'languages' or currentSection == 'countries' or currentSection == 'listen-years' or currentSection == 'release-years'} ? 'active' : ''"
                        onclick="toggleDropdown(event, this)">Catalogs ‚ñæ</a>
                     <ul class="app-nav-dropdown-menu">
                         <li><a href="/countries" class="app-nav-dropdown-link" th:classappend="${currentSection == 'countries'} ? 'active' : ''">Countries</a></li>
                         <li><a href="/ethnicities" class="app-nav-dropdown-link" th:classappend="${currentSection == 'ethnicities'} ? 'active' : ''">Ethnicities</a></li>
                         <li><a href="/genders" class="app-nav-dropdown-link" th:classappend="${currentSection == 'genders'} ? 'active' : ''">Genders</a></li>
                         <li><a href="/genres" class="app-nav-dropdown-link" th:classappend="${currentSection == 'genres'} ? 'active' : ''">Genres</a></li>
                         <li><a href="/languages" class="app-nav-dropdown-link" th:classappend="${currentSection == 'languages'} ? 'active' : ''">Languages</a></li>
                         <li><a href="/listen-years" class="app-nav-dropdown-link" th:classappend="${currentSection == 'listen-years'} ? 'active' : ''">Listen Years</a></li>
                         <li><a href="/release-years" class="app-nav-dropdown-link" th:classappend="${currentSection == 'release-years'} ? 'active' : ''">Release Years</a></li>
                         <li><a href="/subgenres" class="app-nav-dropdown-link" th:classappend="${currentSection == 'subgenres'} ? 'active' : ''">Subgenres</a></li>
                     </ul>
                 </li>
                 <li class="app-nav-dropdown">
                     <a href="#" class="app-nav-link app-nav-dropdown-toggle" 
                        th:classappend="${currentSection == 'days' or currentSection == 'weeks' or currentSection == 'months' or currentSection == 'seasons' or currentSection == 'years' or currentSection == 'decades'} ? 'active' : ''"
                        onclick="toggleDropdown(event, this)">Timeframes ‚ñæ</a>
                     <ul class="app-nav-dropdown-menu">
                         <li><a href="/days" class="app-nav-dropdown-link" th:classappend="${currentSection == 'days'} ? 'active' : ''">Days</a></li>
                         <li><a href="/weeks" class="app-nav-dropdown-link" th:classappend="${currentSection == 'weeks'} ? 'active' : ''">Weeks</a></li>
                         <li><a href="/months" class="app-nav-dropdown-link" th:classappend="${currentSection == 'months'} ? 'active' : ''">Months</a></li>
                         <li><a href="/seasons" class="app-nav-dropdown-link" th:classappend="${currentSection == 'seasons'} ? 'active' : ''">Seasons</a></li>
                         <li><a href="/years" class="app-nav-dropdown-link" th:classappend="${currentSection == 'years'} ? 'active' : ''">Years</a></li>
                         <li><a href="/decades" class="app-nav-dropdown-link" th:classappend="${currentSection == 'decades'} ? 'active' : ''">Decades</a></li>
                     </ul>
                 </li>
                 <li class="app-nav-dropdown">
                     <a href="#" class="app-nav-link app-nav-dropdown-toggle" 
                        th:classappend="${currentSection == 'weekly-charts' or currentSection == 'seasonal-charts' or currentSection == 'yearly-charts' or currentSection == 'most-weeks-charts' or currentSection == 'most-hits-charts'} ? 'active' : ''"
                        onclick="toggleDropdown(event, this)">üìà Charts ‚ñæ</a>
                     <ul class="app-nav-dropdown-menu">
                         <li><a href="/charts/weekly" class="app-nav-dropdown-link" th:classappend="${currentSection == 'weekly-charts'} ? 'active' : ''">Weekly</a></li>
                         <li><a href="/charts/seasonal" class="app-nav-dropdown-link" th:classappend="${currentSection == 'seasonal-charts'} ? 'active' : ''">Seasonal</a></li>
                         <li><a href="/charts/yearly" class="app-nav-dropdown-link" th:classappend="${currentSection == 'yearly-charts'} ? 'active' : ''">Yearly</a></li>
                         <li><a href="/charts/most-weeks" class="app-nav-dropdown-link" th:classappend="${currentSection == 'most-weeks-charts'} ? 'active' : ''">Most Weeks at Position</a></li>
                         <li><a href="/charts/most-hits" class="app-nav-dropdown-link" th:classappend="${currentSection == 'most-hits-charts'} ? 'active' : ''">Most Hits</a></li>
                     </ul>
                 </li>
                 <li><a href="/graphs" class="app-nav-link" th:classappend="${currentSection == 'graphs'} ? 'active' : ''">üìä Graphs</a></li>
                 <!-- Mobile-only: utilities links -->
                 <li class="app-nav-utilities-mobile" style="display: none;">
                     <a href="/scrobbles/upload" class="app-nav-link">Import</a>
                     <a href="/scrobbles/unmatched" class="app-nav-link">Unmatched Plays</a>
                     <a href="/itunes/unmatched" class="app-nav-link">iTunes Only</a>
                     <a href="/itunes/changes" class="app-nav-link">iTunes Changes</a>
                 </li>
             </ul>
         </div>
         <div class="app-nav-utilities">
             <a href="/scrobbles/upload" class="app-nav-link-discreet">Import</a>
             <a href="/scrobbles/unmatched" class="app-nav-link-discreet">Unmatched Plays</a>
             <a href="/itunes/unmatched" class="app-nav-link-discreet">iTunes Only</a>
             <a href="/itunes/changes" class="app-nav-link-discreet" th:classappend="${currentSection == 'itunes-changes'} ? 'active' : ''">iTunes Changes</a>
         </div>
        </div>
        <!-- Mobile nav overlay -->
        <div class="mobile-nav-overlay" id="mobileNavOverlay" onclick="toggleMobileNav()"></div>
        <script>
            function toggleMobileNav() {
                const navLinks = document.getElementById('mobileNavLinks');
                const overlay = document.getElementById('mobileNavOverlay');
                const isOpen = navLinks.classList.contains('mobile-open');
                
                if (isOpen) {
                    navLinks.classList.remove('mobile-open');
                    overlay.classList.remove('active');
                    document.body.style.overflow = '';
                } else {
                    navLinks.classList.add('mobile-open');
                    overlay.classList.add('active');
                    document.body.style.overflow = 'hidden';
                }
            }
            
            function toggleDropdown(event, element) {
                // On mobile/touch, toggle dropdown visibility
                if (window.matchMedia('(max-width: 900px)').matches || window.matchMedia('(pointer: coarse)').matches) {
                    event.preventDefault();
                    const dropdown = element.closest('.app-nav-dropdown');
                    dropdown.classList.toggle('touch-open');
                }
            }
            
            // Close mobile nav on escape key
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    const navLinks = document.getElementById('mobileNavLinks');
                    if (navLinks && navLinks.classList.contains('mobile-open')) {
                        toggleMobileNav();
                    }
                }
            });
        </script>
     </nav>
 </body>
</html>