<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${artist.name} + ' - Music Stats'">Artist Detail</title>
    <link rel="stylesheet" th:href="@{/css/global.css}">
    <th:block th:replace="~{fragments/navigation :: nav-styles}"></th:block>
    <link rel="stylesheet" th:href="@{/css/catalog-list.css}">
    <link rel="stylesheet" th:href="@{/css/artist-detail.css}">
    <link rel="stylesheet" th:href="@{/css/top-tables.css}">
    <link rel="stylesheet" th:href="@{/css/detail-tabs.css}">
    <!-- Flatpickr Date Picker -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script th:src="@{/js/list-utils.js}"></script>
    <script th:src="@{/js/top-table-sort.js}" defer></script>
    <script th:src="@{/js/table-sort.js}" defer></script>
    <script th:src="@{/js/searchable-select.js}" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation"></script>
</head>
<body>
    <th:block th:replace="~{fragments/navigation :: navigation}"></th:block>
    <div class="container-wide artist-detail" th:classappend="${artist.genderId != null and genders.get(artist.genderId) != null and genders.get(artist.genderId).toLowerCase().contains('male') and !genders.get(artist.genderId).toLowerCase().contains('female')} ? 'gender-male' : (${artist.genderId != null and genders.get(artist.genderId) != null and genders.get(artist.genderId).toLowerCase().contains('female')} ? 'gender-female' : '')">
        <div class="detail-grid">
            <!-- Left column: Image with name overlay -->
            <div class="detail-sidebar">
                <div class="item-name-overlay">
                    <h1 class="item-name-top">
                        <span th:if="${artist.inItunes != null}" 
                              th:classappend="${artist.inItunes ? 'in-itunes' : 'not-in-itunes'}"
                              class="itunes-badge"
                              th:title="${artist.inItunes ? 'In iTunes Library' : 'Not in iTunes Library'}"
                              th:text="${artist.inItunes ? '‚úì' : '‚úó'}"></span><span th:text="${artist.name}">Artist Name</span>
                    </h1>
                </div>
                <div class="item-image-container">
                    <!-- Gallery Navigation Arrows -->
                    <button type="button" class="gallery-nav gallery-nav-left" id="galleryPrev" onclick="galleryNavigate(-1)" style="display: none;">
                        ‚ùÆ
                    </button>
                    <button type="button" class="gallery-nav gallery-nav-right" id="galleryNext" onclick="galleryNavigate(1)" style="display: none;">
                        ‚ùØ
                    </button>

                    <img th:if="${hasImage}"
                         th:src="@{'/artists/' + ${artist.id} + '/image?raw=true'}"
                         th:alt="${artist.name}"
                         id="artistImage"
                         class="item-image-large clickable-image"
                         onclick="openArtistImageModal()"
                         style="cursor: pointer;">
                    <div th:unless="${hasImage}" class="no-image-large" id="noImagePlaceholder">
                        <span th:text="${#strings.substring(artist.name, 0, 1)}"></span>
                    </div>

                    <span class="flag-overlay" th:if="${artist.country != null and @countryCodeMapper.getCode(artist.country) != null}"
                          th:title="${artist.country}">
                        <img th:src="@{https://flagcdn.com/w40/{code}.png(code=${@countryCodeMapper.getCode(artist.country)})}"
                             th:alt="${artist.country}" />
                    </span>

                    <!-- Death indicator overlay -->
                    <span class="death-overlay" th:if="${artist.deathDate != null}" th:title="'Passed away on ' + ${#temporals.format(artist.deathDate, 'dd-MMM-yyyy')}">‚Ä†</span>

                    <!-- Image Counter -->
                    <div class="gallery-counter" id="galleryCounter" style="display: none;">
                        <span id="currentImageIndex">1</span> / <span id="totalImageCount">1</span>
                    </div>

                    <div class="image-upload-overlay">
                        <input type="file" autocomplete="off" id="imageInput" accept="image/*" style="display: none;" onchange="handleImageUpload(event)">
                        <button type="button" class="btn-upload-image" id="btnUploadImage" onclick="document.getElementById('imageInput').click()">
                            Upload Image
                        </button>
                        <button type="button" class="btn-remove-image" id="btnRemoveMain" th:if="${hasImage}" onclick="removeImage()">
                            Remove
                        </button>
                        <!-- Gallery-specific buttons (shown for secondary images) -->
                        <button type="button" class="btn-set-default" id="btnSetDefault" onclick="setAsDefaultImage()" style="display: none;">
                            Set as Default
                        </button>
                        <button type="button" class="btn-remove-gallery" id="btnRemoveGallery" onclick="removeGalleryImage()" style="display: none;">
                            Remove
                        </button>
                        <!-- Assign to Theme (always visible when themes exist) -->
                        <button type="button" class="btn-assign-theme" id="btnAssignTheme" onclick="openAssignThemeModal()" style="display: none;">
                            Assign Theme
                        </button>
                    </div>
                </div>
                
                <div class="item-stats">
                    <div class="stat">
                        <span class="stat-icon">üéµ</span>
                        <span class="stat-value" th:text="${songCount}">0</span>
                    </div>
                    <div class="stat">
                        <span class="stat-icon">üíø</span>
                        <span class="stat-value" th:text="${albumCount}">0</span>
                    </div>
                </div>
                <div class="item-stats">
                    <div class="stat" title="Total plays">
                        <span class="stat-icon total-plays">‚èµ</span>
                        <span class="stat-value" th:text="${artistPlayCount != null ? artistPlayCount : 0}">0</span>
                    </div>
                    <div class="stat" title="Primary plays">
                        <span class="stat-icon primary-plays">‚èµ</span>
                        <span class="stat-value" th:text="${artistVatitoPlayCount != null ? artistVatitoPlayCount : 0}">0</span>
                    </div>
                    <div class="stat" title="Legacy plays">
                        <span class="stat-icon legacy-plays">‚èµ</span>
                        <span class="stat-value" th:text="${artistRobertloverPlayCount != null ? artistRobertloverPlayCount : 0}">0</span>
                    </div>
                </div>
                
                <!-- Ranking Chips -->
                <div class="ranking-chips-section" style="margin-top: 15px; text-align: center;">
                    <div class="winning-chips chips-expandable">
                        <!-- GROUP 1: Overall & Artist Rankings -->
                        <!-- Overall Position -->
                        <a th:if="${overallPosition != null}"
                           th:href="@{/artists}"
                           target="_blank"
                           class="winning-chip rank-chip overall"
                           th:text="'#' + ${overallPosition} + ' overall'"
                           th:title="'Rank #' + ${overallPosition} + ' among all artists'"></a>
                        
                        <!-- Number One Songs Count (with weeks) -->
                        <a th:if="${numberOneSongsCount != null and numberOneSongsCount > 0}"
                           th:href="@{'/artists/' + ${artist.id} + '?tab=chart-history'}"
                           class="winning-chip rank-chip chart-achievement number-one-songs-chip"
                           th:text="${numberOneSongsCount} + ' ' + (${numberOneSongsCount == 1} ? 'song' : 'songs') + ' at #1 (for ' + ${numberOneWeeksCount} + ' ' + (${numberOneWeeksCount == 1} ? 'week' : 'weeks') + ')'"
                           th:attr="data-songs=${numberOneSongsList != null ? #strings.listJoin(numberOneSongsList, '|') : ''}">
                        </a>
                        
                        <!-- Number One Featured Songs Count (with weeks) -->
                        <a th:if="${numberOneFeaturedSongsCount != null and numberOneFeaturedSongsCount > 0}"
                           th:href="@{'/artists/' + ${artist.id} + '?tab=chart-history'}"
                           class="winning-chip rank-chip chart-achievement number-one-featured-songs-chip"
                           th:text="${numberOneFeaturedSongsCount} + ' featured ' + (${numberOneFeaturedSongsCount == 1} ? 'song' : 'songs') + ' at #1 (for ' + ${numberOneFeaturedWeeksCount} + ' ' + (${numberOneFeaturedWeeksCount == 1} ? 'week' : 'weeks') + ')'"
                           th:attr="data-featured-songs=${numberOneFeaturedSongsList != null ? #strings.listJoin(numberOneFeaturedSongsList, '|') : ''}">
                        </a>
                        
                        <!-- Number One Albums Count (with weeks) -->
                        <a th:if="${numberOneAlbumsCount != null and numberOneAlbumsCount > 0}"
                           th:href="@{'/artists/' + ${artist.id} + '?tab=chart-history'}"
                           class="winning-chip rank-chip chart-achievement number-one-albums-chip"
                           th:text="${numberOneAlbumsCount} + ' ' + (${numberOneAlbumsCount == 1} ? 'album' : 'albums') + ' at #1 (for ' + ${numberOneAlbumWeeksCount} + ' ' + (${numberOneAlbumWeeksCount == 1} ? 'week' : 'weeks') + ')'"
                           th:attr="data-albums=${numberOneAlbumsList != null ? #strings.listJoin(numberOneAlbumsList, '|') : ''}">
                        </a>

                        <!-- GROUP 2: Catalog Rankings (Gender > Genre > Subgenre > Ethnicity > Country > Language) -->
                        <div class="chip-group-separator"></div>
                        
                        <!-- Gender Rank -->
                        <a th:if="${rankByGender != null and artist.genderId != null}" 
                           th:href="@{/graphs(filterType='gender',filterId=${artist.genderId},filterName=${genders.get(artist.genderId)})}"
                           target="_blank"
                           class="winning-chip rank-chip gender"
                           th:classappend="${genders.get(artist.genderId) != null and genders.get(artist.genderId).toLowerCase().contains('female')} ? 'female' : (${genders.get(artist.genderId) != null and genders.get(artist.genderId).toLowerCase().contains('male')} ? 'male' : '')"
                           th:text="'#' + ${rankByGender} + ' ' + ${genders.get(artist.genderId)}" 
                           th:title="'Rank #' + ${rankByGender} + ' among ' + ${genders.get(artist.genderId)} + ' artists'"></a>
                        
                        <!-- Genre Rank -->
                        <a th:if="${rankByGenre != null and artist.genreId != null}" 
                           th:href="@{/graphs(filterType='genre',filterId=${artist.genreId},filterName=${genres.get(artist.genreId)})}"
                           target="_blank"
                           class="winning-chip rank-chip genre" 
                           th:text="'#' + ${rankByGenre} + ' ' + ${genres.get(artist.genreId)}" 
                           th:title="'Rank #' + ${rankByGenre} + ' among ' + ${genres.get(artist.genreId)} + ' artists'"></a>
                        
                        <!-- Subgenre Rank -->
                        <a th:if="${rankBySubgenre != null and artist.subgenreId != null}" 
                           th:href="@{/graphs(filterType='subgenre',filterId=${artist.subgenreId},filterName=${subgenres.get(artist.subgenreId)})}"
                           target="_blank"
                           class="winning-chip rank-chip subgenre" 
                           th:text="'#' + ${rankBySubgenre} + ' ' + ${subgenres.get(artist.subgenreId)}" 
                           th:title="'Rank #' + ${rankBySubgenre} + ' among ' + ${subgenres.get(artist.subgenreId)} + ' artists'"></a>
                        
                        <!-- Ethnicity Rank -->
                        <a th:if="${rankByEthnicity != null and artist.ethnicityId != null}" 
                           th:href="@{/graphs(filterType='ethnicity',filterId=${artist.ethnicityId},filterName=${ethnicities.get(artist.ethnicityId)})}"
                           target="_blank"
                           class="winning-chip rank-chip ethnicity" 
                           th:text="'#' + ${rankByEthnicity} + ' ' + ${ethnicities.get(artist.ethnicityId)}" 
                           th:title="'Rank #' + ${rankByEthnicity} + ' among ' + ${ethnicities.get(artist.ethnicityId)} + ' artists'"></a>
                        
                        <!-- Country Rank -->
                        <a th:if="${rankByCountry != null and artist.country != null}" 
                           th:href="@{/graphs(country=${artist.country},countryMode='includes')}"
                           target="_blank"
                           class="winning-chip rank-chip country" 
                           th:text="'#' + ${rankByCountry} + ' ' + ${artist.country}" 
                           th:title="'Rank #' + ${rankByCountry} + ' among ' + ${artist.country} + ' artists'"></a>
                        
                        <!-- Language Rank -->
                        <a th:if="${rankByLanguage != null and artist.languageId != null}" 
                           th:href="@{/graphs(filterType='language',filterId=${artist.languageId},filterName=${languages.get(artist.languageId)})}"
                           target="_blank"
                           class="winning-chip rank-chip language" 
                           th:text="'#' + ${rankByLanguage} + ' ' + ${languages.get(artist.languageId)}" 
                           th:title="'Rank #' + ${rankByLanguage} + ' among ' + ${languages.get(artist.languageId)} + ' artists'"></a>
                        
                        <!-- Spanish Rap Rank (special combination) -->
                        <a th:if="${rankBySpanishRap != null}"
                           th:href="@{/graphs(genre=${rapGenreId},genreMode='includes',language=${spanishLanguageId},languageMode='includes')}"
                           target="_blank"
                           class="winning-chip rank-chip spanish-rap"
                           th:text="'#' + ${rankBySpanishRap} + ' Spanish Rap'"
                           th:title="'Rank #' + ${rankBySpanishRap} + ' among Spanish Rap artists'"></a>

                        <!-- GROUP 3: Year-Based Rankings (Listened in year) -->
                        <div class="chip-group-separator" th:if="${ranksByYear != null and !ranksByYear.isEmpty()}"></div>
                        
                        <!-- Year Ranks (only if <= 100) -->
                        <a th:each="yearEntry : ${ranksByYear}" 
                           th:if="${yearEntry.value != null and yearEntry.value <= 100}"
                           th:href="@{/graphs(listenedDateFrom=${yearEntry.key} + '-01-01',listenedDateTo=${yearEntry.key} + '-12-31')}"
                           target="_blank"
                           class="winning-chip rank-chip year-rank" 
                           th:text="'#' + ${yearEntry.value} + ' most listened in ' + ${yearEntry.key}" 
                           th:title="'Rank #' + ${yearEntry.value} + ' most listened artist in year ' + ${yearEntry.key}"></a>
                    </div>
                    <button type="button" class="chips-expand-btn" onclick="toggleChipsExpand(this)">
                        Show more <span class="expand-icon">‚ñº</span>
                    </button>
                </div>
            </div>
            
            <!-- Tab Navigation -->
            <div class="detail-tabs">
                <a href="#" onclick="switchTab(event, 'general')" 
                   th:classappend="${activeTab == 'general' or activeTab == null} ? 'active' : ''"
                   class="detail-tab" id="generalTab">General</a>
                <a href="#" onclick="switchTab(event, 'plays')" 
                   th:classappend="${activeTab == 'plays'} ? 'active' : ''"
                   class="detail-tab" id="playsTab">Plays</a>
                <a href="#" onclick="switchTab(event, 'collaborated')" 
                   th:classappend="${activeTab == 'collaborated'} ? 'active' : ''"
                   class="detail-tab" id="collaboratedTab">Artist Associations</a>
                <a href="#" onclick="switchTab(event, 'chart-history')" 
                   th:classappend="${activeTab == 'chart-history'} ? 'active' : ''"
                   class="detail-tab" id="chartHistoryTab">Chart History</a>
                
                <!-- Toggles Container (always show since Include Main is always present) -->
                <div class="toggles-container">
                    <!-- Include Main Toggle (always shown, on by default) -->
                    <div class="include-groups-toggle">
                        <label class="toggle-label">
                            <input type="checkbox" autocomplete="off"
                                   id="includeMainToggle" 
                                   th:checked="${includeMain}"
                                   onchange="toggleIncludeMain(this.checked)">
                            <span class="toggle-slider"></span>
                            <span class="toggle-text">Include main</span>
                        </label>
                    </div>
                    
                    <!-- Include Groups Toggle (only shown if artist has groups) -->
                    <div th:if="${hasGroups}" class="include-groups-toggle">
                        <label class="toggle-label">
                            <input type="checkbox" autocomplete="off"
                                   id="includeGroupsToggle" 
                                   th:checked="${includeGroups}"
                                   onchange="toggleIncludeGroups(this.checked)">
                            <span class="toggle-slider"></span>
                            <span class="toggle-text">Include groups</span>
                        </label>
                    </div>
                    
                    <!-- Include Featured Songs Toggle (only shown if artist has featured songs) -->
                    <div th:if="${hasFeaturedSongs}" class="include-groups-toggle">
                        <label class="toggle-label">
                            <input type="checkbox" autocomplete="off"
                                   id="includeFeaturedToggle" 
                                   th:checked="${includeFeatured}"
                                   onchange="toggleIncludeFeatured(this.checked)">
                            <span class="toggle-slider"></span>
                            <span class="toggle-text">Include featured</span>
                        </label>
                    </div>
                </div>
            </div>
            
            <!-- Right side: Stacked cards layout for General and Statistics -->
            <div class="detail-right-section" id="generalSectionContent"
                 th:style="${activeTab == 'general' or activeTab == null} ? 'display: block !important;' : 'display: none !important;'">
                <!-- General Section (Left) -->
                <div class="detail-content-card">
                    <div class="section-header">
                        <h2 class="section-title">General</h2>
                        <div class="edit-button-container">
                            <button type="button" class="btn-action" id="editBtn" onclick="toggleEdit()">Edit</button>
                            <button type="button" class="btn-negative" id="deleteBtn" 
                                    th:disabled="${artistPlayCount > 0}"
                                    th:title="${artistPlayCount > 0 ? 'Cannot delete artist with existing plays' : 'Delete this artist and all associated albums and songs'}"
                                    onclick="confirmDelete()">Delete</button>
                        </div>
                    </div>
                    
                    <form method="post" th:action="@{'/artists/' + ${artist.id}}" th:object="${artist}" id="artistForm">
                        
                        <div class="form-section">
                            <!-- Name field (editable, only shown in edit mode) -->
                            <div class="form-group form-group-full-width name-field-group" id="nameFieldGroup" style="display:none;">
                                <label for="name">Name</label>
                                <span class="attribute-text" data-field="name" th:text="${artist.name}" style="display:none;">Artist Name</span>
                                <input type="text" autocomplete="off" id="name" name="name" th:field="*{name}" class="editable-input" />
                            </div>
                            <div class="attributes-grid">
                                <!-- Column 1: Gender, Language, Genre, Subgenre, Country, Ethnicity -->
                                <div class="form-group">
                                    <label for="genderId">Gender</label>
                                    <span class="attribute-text" data-field="genderId" th:text="${artist.genderId != null ? genders.get(artist.genderId) : '-'}">-</span>
                                    <select id="genderId" name="genderId" th:field="*{genderId}" disabled style="display:none;">
                                        <option value="">Select...</option>
                                        <option th:each="entry : ${genders}" 
                                                th:value="${entry.key}" 
                                                th:text="${entry.value}"></option>
                                    </select>
                                </div>
                                
                                <!-- Column 2: First Listened, Last Listened, Birth Date, Death Date -->
                                <div class="form-group">
                                    <label>First Listened Date</label>
                                    <span class="attribute-text" th:text="${firstListenedDate}">-</span>
                                </div>
                                
                                <div class="form-group">
                                    <label for="languageId">Language</label>
                                    <span class="attribute-text" data-field="languageId" th:text="${artist.languageId != null ? languages.get(artist.languageId) : '-'}">-</span>
                                    <select id="languageId" name="languageId" th:field="*{languageId}" disabled style="display:none;">
                                        <option value="">Select...</option>
                                        <option th:each="entry : ${languages}" 
                                                th:value="${entry.key}" 
                                                th:text="${entry.value}"></option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label>Last Listened Date</label>
                                    <span class="attribute-text" th:text="${lastListenedDate}">-</span>
                                </div>
                                
                                <div class="form-group">
                                    <label for="genreId">Genre</label>
                                    <span class="attribute-text" data-field="genreId" th:text="${artist.genreId != null ? genres.get(artist.genreId) : '-'}">-</span>
                                    <select id="genreId" name="genreId" th:field="*{genreId}" disabled style="display:none;">
                                        <option value="">Select...</option>
                                        <option th:each="entry : ${genres}" 
                                                th:value="${entry.key}" 
                                                th:text="${entry.value}"></option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label for="birthDate">Birth Date</label>
                                    <span class="attribute-text" data-field="birthDate">
                                        <th:block th:if="${artist.birthDate != null}">
                                            <span th:text="${#temporals.format(artist.birthDate, 'dd-MMM-yyyy')}"></span>
                                            <span style="color: var(--text-muted); margin-left: 4px;" 
                                                  th:with="endDate=${artist.deathDate != null ? artist.deathDate : #temporals.createNow()},
                                                           years=${T(java.time.temporal.ChronoUnit).YEARS.between(artist.birthDate, endDate)}"
                                                  th:text="'(' + ${years} + ' years old)'"></span>
                                        </th:block>
                                        <th:block th:if="${artist.birthDate == null}">-</th:block>
                                    </span>
                                    <input type="text" autocomplete="off" id="birthDate" name="birthDate" th:value="${artist.birthDate != null ? #temporals.format(artist.birthDate, 'dd/MM/yyyy') : ''}" placeholder="dd/MM/yyyy" pattern="\d{2}/\d{2}/\d{4}" class="editable-input" style="display:none;" />
                                </div>
                                
                                <div class="form-group">
                                    <label for="subgenreId">Subgenre</label>
                                    <span class="attribute-text" data-field="subgenreId" th:text="${artist.subgenreId != null ? subgenres.get(artist.subgenreId) : '-'}">-</span>
                                    <select id="subgenreId" name="subgenreId" th:field="*{subgenreId}" disabled style="display:none;">
                                        <option value="">Select...</option>
                                        <option th:each="entry : ${subgenres}" 
                                                th:value="${entry.key}" 
                                                th:text="${entry.value}"></option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label for="deathDate">Death Date</label>
                                    <span class="attribute-text" data-field="deathDate" th:text="${artist.deathDate != null ? #temporals.format(artist.deathDate, 'dd-MMM-yyyy') : '-'}">-</span>
                                    <input type="text" autocomplete="off" id="deathDate" name="deathDate" th:value="${artist.deathDate != null ? #temporals.format(artist.deathDate, 'dd/MM/yyyy') : ''}" placeholder="dd/MM/yyyy" pattern="\d{2}/\d{2}/\d{4}" class="editable-input" style="display:none;" />
                                </div>
                                
                                <div class="form-group">
                                    <label for="country">Country</label>
                                    <span class="attribute-text" data-field="country" th:text="${artist.country != null && !#strings.isEmpty(artist.country) ? artist.country : '-'}">-</span>
                                    <select id="country" name="country" th:field="*{country}" disabled style="display:none;">
                                        <option value="">Select...</option>
                                        <option th:each="c : ${countries}" th:value="${c}" th:text="${c}"></option>
                                    </select>
                                </div>
                                
                                <div class="form-group form-group-checkbox">
                                    <label class="field-label label-view">Is Band</label>
                                    <span class="attribute-text" data-field="isBand" 
                                          th:classappend="${artist.isBand != null and artist.isBand ? 'checkbox-yes' : 'checkbox-no'}"
                                          th:text="${artist.isBand != null and artist.isBand ? '‚úì Yes' : '‚Äî No'}">‚Äî No</span>
                                    <label class="inline-checkbox-label" style="display:none;">
                                        <input type="checkbox" autocomplete="off" id="isBand" name="isBand" th:field="*{isBand}" />
                                        Is Band
                                    </label>
                                </div>
                                
                                <div class="form-group">
                                    <label for="ethnicityId">Ethnicity</label>
                                    <span class="attribute-text" data-field="ethnicityId" th:text="${artist.ethnicityId != null ? ethnicities.get(artist.ethnicityId) : '-'}">-</span>
                                    <select id="ethnicityId" name="ethnicityId" th:field="*{ethnicityId}" disabled style="display:none;">
                                        <option value="">Select...</option>
                                        <option th:each="entry : ${ethnicities}" 
                                                th:value="${entry.key}" 
                                                th:text="${entry.value}"></option>
                                    </select>
                                </div>
                                
                                <div class="form-group form-group-checkbox">
                                    <label class="field-label label-view">Organized</label>
                                    <span class="attribute-text" data-field="organized" 
                                          th:classappend="${artist.organized != null and artist.organized ? 'checkbox-yes' : 'checkbox-no'}"
                                          th:text="${artist.organized != null and artist.organized ? '‚úì Yes' : '‚Äî No'}">‚Äî No</span>
                                    <label class="inline-checkbox-label" style="display:none;">
                                        <input type="checkbox" autocomplete="off" id="organized" name="organized" th:field="*{organized}" />
                                        Organized
                                    </label>
                                </div>
                                
                                <!-- Groups field (spans full width) - only shown in edit mode -->
                                <div class="form-group form-group-full-width" id="groupsField" style="display:none;">
                                    <label>Is Part Of (Groups)</label>
                                    <span class="attribute-text groups-display" data-field="groups" style="display:none;">
                                        <th:block th:if="${groupArtistCards != null and !groupArtistCards.isEmpty()}">
                                            <th:block th:each="group, stat : ${groupArtistCards}">
                                                <a th:href="@{'/artists/' + ${group.id}}" 
                                                   class="group-artist-link"
                                                   th:text="${group.name}"></a><th:block th:if="${!stat.last}">, </th:block>
                                            </th:block>
                                        </th:block>
                                        <th:block th:if="${groupArtistCards == null or groupArtistCards.isEmpty()}">-</th:block>
                                    </span>
                                    <!-- Groups multi-select component (shown in edit mode) -->
                                    <div id="groupsContainer" class="groups-container" style="display:none;">
                                        <div class="chips-input-wrapper">
                                            <div id="groupsChips" class="chips-container">
                                                <!-- Chips will be added here dynamically -->
                                            </div>
                                            <input type="text" 
                                                   id="groupsInput" 
                                                   class="chips-text-input"
                                                   placeholder="Search groups..."
                                                   autocomplete="off" />
                                        </div>
                                        <div id="groupsDropdown" class="chips-dropdown" style="display:none;">
                                            <!-- Search results will appear here -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-actions" id="formActions" style="display: none;">
                            <button type="submit" class="btn-action" onclick="clearAllHighlights()">Save</button>
                            <button type="button" class="btn-negative" onclick="clearAllHighlights(); cancelEdit()">Cancel</button>
                            <button type="button" class="btn-fetch-external" id="btnFetchExternal" th:data-artist-name="${artist.name}" th:data-artist-id="${artist.id}">External</button>
                        </div>
                    </form>
                </div>
                
                <!-- Statistics Section (Redesigned) -->
                <div class="detail-content-card">
                    <div class="section-header">
                        <h2 class="section-title">Statistics</h2>
                    </div>
                    
                    <!-- Hero Stats -->
                    <div class="stats-hero">
                        <div class="stat-hero-item">
                            <span class="stat-label">Total Listening Time</span>
                            <span class="stat-value" th:text="${totalListeningTime}">0:00</span>
                        </div>
                        <div class="stat-hero-item">
                            <span class="stat-label">Avg Plays / Song</span>
                            <span class="stat-value" th:text="${averagePlaysPerSong}">-</span>
                        </div>
                    </div>
                    
                    <!-- Consistency Metrics -->
                    <div class="stats-consistency">
                        <div class="stat-mini">
                            <span class="stat-label">Days</span>
                            <span class="stat-value" th:text="${uniqueDaysPlayed}">0</span><span class="stat-value stat-total" th:text="' / ' + ${totalDaysSinceFirstPlay}"></span>
                        </div>
                        <div class="stat-mini">
                            <span class="stat-label">Weeks</span>
                            <span class="stat-value" th:text="${uniqueWeeksPlayed}">0</span><span class="stat-value stat-total" th:text="' / ' + ${totalWeeksSinceFirstPlay}"></span>
                        </div>
                        <div class="stat-mini">
                            <span class="stat-label">Months</span>
                            <span class="stat-value" th:text="${uniqueMonthsPlayed}">0</span><span class="stat-value stat-total" th:text="' / ' + ${totalMonthsSinceFirstPlay}"></span>
                        </div>
                        <div class="stat-mini">
                            <span class="stat-label">Years</span>
                            <span class="stat-value" th:text="${uniqueYearsPlayed}">0</span><span class="stat-value stat-total" th:text="' / ' + ${totalYearsSinceFirstPlay}"></span>
                        </div>
                    </div>

                    <!-- Extended Stats -->
                    <div class="card-expanded-stats always-visible">
                        <div class="stats-extra">
                            <div class="stat-mini">
                                <span class="stat-label">Avg Song Length</span>
                                <span class="stat-value" th:text="${averageSongLength != null ? averageSongLength : '-'}">-</span>
                            </div>
                            <div class="stat-mini">
                                <span class="stat-label">Solo Songs</span>
                                <span class="stat-value" th:text="${soloSongCount != null ? soloSongCount : 0}">0</span>
                            </div>
                            <div class="stat-mini">
                                <span class="stat-label">Songs w/ Feat</span>
                                <span class="stat-value" th:text="${songsWithFeatCount != null ? songsWithFeatCount : 0}">0</span>
                            </div>
                        </div>
                        <div class="stats-extra-2col">
                            <div class="stat-mini">
                                <span class="stat-label">Feat. Artists</span>
                                <span class="stat-value" th:text="${collaboratedArtistCards != null ? collaboratedArtistCards.size() : 0}">0</span>
                            </div>
                            <div class="stat-mini">
                                <span class="stat-label">Avg Plays / Song</span>
                                <span class="stat-value" th:text="${averagePlaysPerSong != null ? averagePlaysPerSong : '-'}">-</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Albums List Section - Aligned with right section -->
            <div class="detail-content-section general-tab-section" th:if="${(activeTab == 'general' or activeTab == null) and albums != null}"
                 th:style="${activeTab == 'general' or activeTab == null} ? 'display: block !important;' : 'display: none !important;'">
                <h2 class="section-title">Albums</h2>
                <div class="top-table-container">
                    <table class="top-table" id="albumsTable">
                        <thead>
                            <tr>
                                <th class="row-num-col" data-no-sort>#</th>
                                <th class="cover-col">Cover</th>
                                <th data-sort="name">Album Name</th>
                                <th data-sort="totalplays" style="text-align:right;">Total</th>
                                <th data-sort="primaryplays" style="text-align:right;" class="hide-mobile">Primary</th>
                                <th data-sort="legacyplays" style="text-align:right;" class="hide-mobile">Legacy</th>
                                <th data-sort="length" style="text-align:right;" class="hide-mobile">Length</th>
                                <th data-sort="releasedate" class="hide-mobile">Release Date</th>
                                <th data-sort="firstlistened" class="hide-mobile">First Listened</th>
                                <th data-sort="lastlistened" class="hide-mobile">Last Listened</th>
                                <th data-sort="timelistened" style="text-align:right;" class="hide-mobile">Time Listened</th>
                            </tr>
                        </thead>
                        <tbody id="albumsTableBody">
                            <tr th:each="album, iter : ${albums}"
                                th:classappend="${includeGroups and album.fromGroup} ? 'group-item-row' : ''"
                                th:attr="data-name=${album.name},
                                        data-length=${album.totalLengthSeconds != null ? album.totalLengthSeconds : 0},
                                        data-releasedate=${album.releaseDate},
                                        data-firstlistened=${album.firstListenedDate},
                                        data-lastlistened=${album.lastListenedDate},
                                        data-primaryplays=${album.vatitoPlays},
                                        data-legacyplays=${album.robertloverPlays},
                                        data-totalplays=${album.totalPlays},
                                        data-timelistened=${album.totalListeningTimeSeconds}">
                                <td class="row-num-col" th:text="${iter.count}">1</td>
                                <td class="cover-col">
                                    <div style="cursor:pointer;" th:onclick="|openAlbumImageModalFromArtist(${album.id})|" th:title="${album.name}">
                                        <img th:src="@{'/albums/' + ${album.id} + '/image'}" th:alt="${album.name} + ' cover'" class="clickable-image" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" style="width:50px;height:50px;object-fit:cover;border-radius:4px;">
                                        <div class="cover-placeholder" style="display:none;width:50px;height:50px;background:#2a2a2a;border-radius:4px;align-items:center;justify-content:center;color:#666;font-size:18px;">üíø</div>
                                    </div>
                                </td>
                                <td>
                                    <a th:href="@{'/albums/' + ${album.id}}" th:text="${album.name}">Album Name</a>
                                    <span th:if="${includeGroups and album.fromGroup and album.sourceArtistName != null}" 
                                          class="group-artist-label">
                                        (by <a th:href="@{'/artists/' + ${album.sourceArtistId}}" th:text="${album.sourceArtistName}">Group</a>)
                                    </span>
                                </td>
                                <td style="text-align:right;" th:classappend="${album.totalPlays != null and album.totalPlays >= 500} ? 'golden-plays' : ''" th:text="${album.totalPlays != null ? album.totalPlays : 0}">0</td>
                                <td style="text-align:right;" class="hide-mobile" th:text="${album.vatitoPlays != null ? album.vatitoPlays : 0}">0</td>
                                <td style="text-align:right;" class="hide-mobile" th:text="${album.robertloverPlays != null ? album.robertloverPlays : 0}">0</td>
                                <td style="text-align:right;" class="hide-mobile" th:text="${album.totalLength != null ? album.totalLength : '-'}">-</td>
                                <td class="hide-mobile" th:text="${album.releaseDate != null ? album.releaseDate : '-'}">-</td>
                                <td class="hide-mobile" th:text="${album.firstListenedDate != null ? album.firstListenedDate : '-'}">-</td>
                                <td class="hide-mobile" th:text="${album.lastListenedDate != null ? album.lastListenedDate : '-'}">-</td>
                                <td style="text-align:right;" class="hide-mobile" th:text="${album.totalListeningTime != null ? album.totalListeningTime : '-'}">-</td>
                            </tr>
                            <tr class="no-data" th:if="${#lists.isEmpty(albums)}">
                                <td colspan="11"><em>No albums</em></td>
                            </tr>
                            <tr id="noAlbumSummaryRow" class="summary-row" style="display:none;">
                                <td class="row-num-col"></td>
                                <td class="cover-col"></td>
                                <td><strong>No Album Songs</strong></td>
                                <td style="text-align:right;" id="noAlbumTotalPlays">0</td>
                                <td style="text-align:right;" class="hide-mobile" id="noAlbumVatitoPlays">0</td>
                                <td style="text-align:right;" class="hide-mobile" id="noAlbumRobertloverPlays">0</td>
                                <td style="text-align:right;" class="hide-mobile">-</td>
                                <td class="hide-mobile" id="noAlbumReleaseDate">-</td>
                                <td class="hide-mobile" id="noAlbumFirstListened">-</td>
                                <td class="hide-mobile" id="noAlbumLastListened">-</td>
                                <td style="text-align:right;" class="hide-mobile" id="noAlbumTotalListeningTime">-</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Songs List Section - Aligned with right section -->
            <div class="detail-content-section general-tab-section" th:if="${(activeTab == 'general' or activeTab == null) and songs != null and !songs.isEmpty()}"
                 th:style="${activeTab == 'general' or activeTab == null} ? 'display: block !important;' : 'display: none !important;'">
                <h2 class="section-title">Songs</h2>
                <div class="top-table-container">
                    <table class="top-table" id="songsTable">
                            <thead>
                                <tr>
                                    <th class="row-num-col" data-no-sort>#</th>
                                    <th class="cover-col">Cover</th>
                                    <th data-sort="name" class="song-name-col">Song Name</th>
                                    <th data-sort="totalplays" style="text-align:right;">Total</th>
                                    <th data-sort="primaryplays" style="text-align:right;" class="hide-mobile">Primary</th>
                                    <th data-sort="legacyplays" style="text-align:right;" class="hide-mobile">Legacy</th>
                                <th data-sort="length" style="text-align:right;" class="hide-mobile">Length</th>
                                <th data-sort="releasedate" class="hide-mobile">Release Date</th>
                                <th data-sort="firstlistened" class="hide-mobile">First Listened</th>
                                <th data-sort="lastlistened" class="hide-mobile">Last Listened</th>
                                <th data-sort="timelistened" style="text-align:right;" class="hide-mobile">Time Listened</th>
                            </tr>
                        </thead>
                        <tbody id="songsTableBody">
                            <tr th:each="song, iter : ${songs}"
                                th:classappend="${(includeFeatured and song.featuredOn) ? 'featured-song-row' : ''} + ${(includeGroups and song.fromGroup) ? ' group-item-row' : ''}"
                                th:attr="data-name=${song.name},
                                        data-albumname=${song.albumName},
                                        data-length=${song.length != null ? song.length : 0},
                                        data-releasedate=${song.releaseDate},
                                        data-firstlistened=${song.firstListenedDate},
                                        data-lastlistened=${song.lastListenedDate},
                                        data-primaryplays=${song.vatitoPlays},
                                        data-legacyplays=${song.robertloverPlays},
                                        data-totalplays=${song.totalPlays},
                                        data-timelistened=${song.totalListeningTimeSeconds}">
                                <td class="row-num-col" th:text="${iter.count}">1</td>
                                <td class="cover-col">
                                    <div th:title="${song.name}" style="cursor: pointer;">
                                        <!-- Case 1: Song has image AND album has image - show album by default, song on hover -->
                                        <div th:if="${song.hasImage and song.albumHasImage}" class="hover-image-container" style="width:50px;height:50px;">
                                            <img th:src="@{'/albums/' + ${song.albumId} + '/image'}" 
                                                 th:alt="${song.name}"
                                                 th:onclick="|openSongImageModalFromArtist(${song.id})|"
                                                 class="album-image-default clickable-image"
                                                 style="border-radius:4px;">
                                            <img th:src="@{'/songs/' + ${song.id} + '/image'}" 
                                                 th:alt="${song.name}"
                                                 th:onclick="|openSongImageModalFromArtist(${song.id})|"
                                                 class="song-image-hover clickable-image"
                                                 style="border-radius:4px;">
                                        </div>
                                        <!-- Case 2: Song has image but album doesn't - just show song image -->
                                        <img th:if="${song.hasImage and !song.albumHasImage}" 
                                             th:src="@{'/songs/' + ${song.id} + '/image'}" 
                                             th:alt="${song.name}" 
                                             th:onclick="|openSongImageModalFromArtist(${song.id})|"
                                             class="clickable-image"
                                             style="width:50px;height:50px;object-fit:cover;border-radius:4px;">
                                        <!-- Case 3: Song doesn't have image but album does - show album image with opacity -->
                                        <img th:if="${!song.hasImage and song.albumId != null}" 
                                             th:src="@{'/albums/' + ${song.albumId} + '/image'}" 
                                             th:alt="${song.name}"
                                             th:onclick="|openAlbumImageModalFromArtist(${song.albumId})|"
                                             class="inherited-cover clickable-image"
                                             onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
                                             style="width:50px;height:50px;object-fit:cover;border-radius:4px;">
                                        <div th:if="${!song.hasImage and song.albumId == null}" class="cover-placeholder" style="width:50px;height:50px;background:#2a2a2a;border-radius:4px;display:flex;align-items:center;justify-content:center;color:#666;font-size:18px;">üéµ</div>
                                        <div th:if="${!song.hasImage and song.albumId != null}" class="cover-placeholder" style="display:none;width:50px;height:50px;background:#2a2a2a;border-radius:4px;align-items:center;justify-content:center;color:#666;font-size:18px;">üéµ</div>
                                    </div>
                                </td>
                                <td class="song-name-col">
                                    <a th:href="@{'/songs/' + ${song.id}}" th:text="${song.name}">Song Name</a>
                                    <span th:if="${song.isSingle}" class="single-indicator" title="Single">üîπ</span>
                                    <span th:if="${includeFeatured and song.featuredOn and song.primaryArtistName != null}" 
                                          class="featured-artist-label">
                                        (feat. on <a th:href="@{'/artists/' + ${song.primaryArtistId}}" th:text="${song.primaryArtistName}">Artist</a>)
                                    </span>
                                    <span th:if="${includeGroups and song.fromGroup and song.sourceArtistName != null}" 
                                          class="group-artist-label">
                                        (by <a th:href="@{'/artists/' + ${song.sourceArtistId}}" th:text="${song.sourceArtistName}">Group</a>)
                                    </span>
                                </td>
                                <td style="text-align:right;" th:classappend="${song.totalPlays != null and song.totalPlays >= 100} ? 'golden-plays' : ''" th:text="${song.totalPlays != null ? song.totalPlays : 0}">0</td>
                                <td style="text-align:right;" class="hide-mobile" th:text="${song.vatitoPlays != null ? song.vatitoPlays : 0}">0</td>
                                <td style="text-align:right;" class="hide-mobile" th:text="${song.robertloverPlays != null ? song.robertloverPlays : 0}">0</td>
                                <td style="text-align:right;" class="hide-mobile" th:text="${song.lengthFormatted != null ? song.lengthFormatted : '-'}">-</td>
                                <td class="hide-mobile" th:text="${song.releaseDate != null ? song.releaseDate : '-'}">-</td>
                                <td class="hide-mobile" th:text="${song.firstListenedDate != null ? song.firstListenedDate : '-'}">-</td>
                                <td class="hide-mobile" th:text="${song.lastListenedDate != null ? song.lastListenedDate : '-'}">-</td>
                                <td style="text-align:right;" class="hide-mobile" th:text="${song.totalListeningTime != null ? song.totalListeningTime : '-'}">-</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Plays Tab Content -->
            <div class="plays-tab-content" id="playsTabContent"
                 th:style="${activeTab == 'plays'} ? 'display: block !important;' : 'display: none !important;'">
                <!-- Plays by Year Chart -->
                <div class="detail-content-card plays-chart-section">
                    <h2 class="section-title">Plays by Year</h2>
                    <div class="chart-container">
                        <canvas id="playsByYearChart"></canvas>
                    </div>
                </div>
                
                <!-- Plays Table -->
                <div class="detail-content-section">
                    <h2 class="section-title">Play History 
                        <span class="play-count">(<span th:text="${playsTotalCount}">0</span> plays)</span>
                    </h2>
                    
                    <!-- Top Pagination -->
                    <div class="pagination pagination-top" th:if="${playsTotalPages > 1}">
                        <a th:href="@{/artists/{id}(id=${artist.id}, tab='plays', playsPage=0, includeGroups=${includeGroups ? 'true' : null}, includeFeatured=${includeFeatured ? 'true' : null}, includeMain=${includeMain ? null : 'false'})}"
                           th:classappend="${playsPage == 0} ? 'disabled' : ''" class="page-link">&laquo; First</a>
                        <a th:href="@{/artists/{id}(id=${artist.id}, tab='plays', playsPage=${playsPage - 1}, includeGroups=${includeGroups ? 'true' : null}, includeFeatured=${includeFeatured ? 'true' : null}, includeMain=${includeMain ? null : 'false'})}"
                           th:classappend="${playsPage == 0} ? 'disabled' : ''" class="page-link">&lsaquo; Prev</a>
                        <span class="page-info">Page <span th:text="${playsPage + 1}">1</span> of <span th:text="${playsTotalPages}">1</span></span>
                        <a th:href="@{/artists/{id}(id=${artist.id}, tab='plays', playsPage=${playsPage + 1}, includeGroups=${includeGroups ? 'true' : null}, includeFeatured=${includeFeatured ? 'true' : null}, includeMain=${includeMain ? null : 'false'})}"
                           th:classappend="${playsPage >= playsTotalPages - 1} ? 'disabled' : ''" class="page-link">Next &rsaquo;</a>
                        <a th:href="@{/artists/{id}(id=${artist.id}, tab='plays', playsPage=${playsTotalPages - 1}, includeGroups=${includeGroups ? 'true' : null}, includeFeatured=${includeFeatured ? 'true' : null}, includeMain=${includeMain ? null : 'false'})}"
                           th:classappend="${playsPage >= playsTotalPages - 1} ? 'disabled' : ''" class="page-link">Last &raquo;</a>
                    </div>
                    
                    <div class="top-table-container">
                        <table class="top-table" id="playsTable">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Song</th>
                                    <th>Album</th>
                                    <th>Account</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr th:each="play : ${plays}"
                                    th:class="${play.fromGroup ? 'from-group' : (play.fromFeatured ? 'featured-row' : '')}"
                                    th:style="${play.fromGroup ? 'background-color: rgba(0, 128, 128, 0.08);' : (play.fromFeatured ? 'background-color: rgba(219, 112, 147, 0.08);' : '')}">
                                    <td th:text="${play.playDate}">-</td>
                                    <td>
                                        <a th:href="@{'/songs/' + ${play.songId}}" th:text="${play.songName}">Song</a>
                                        <span th:if="${play.fromGroup}" class="by-artist-label" style="color: teal; font-size: 0.85em; margin-left: 6px;"
                                              th:text="'(by ' + ${play.artistName} + ')'"></span>
                                        <span th:if="${play.fromFeatured}" class="feat-label" style="color: #db7093; font-size: 0.85em; margin-left: 6px;"
                                              th:text="'(feat. on ' + ${play.artistName} + ')'"></span>
                                    </td>
                                    <td>
                                        <a th:if="${play.albumId != null}" th:href="@{'/albums/' + ${play.albumId}}" th:text="${play.albumName}">Album</a>
                                        <span th:unless="${play.albumId != null}">-</span>
                                    </td>
                                    <td th:text="${play.account}">-</td>
                                </tr>
                                <tr th:if="${plays == null or plays.isEmpty()}">
                                    <td colspan="4"><em>No plays recorded</em></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Bottom Pagination -->
                    <div class="pagination pagination-bottom" th:if="${playsTotalPages > 1}">
                        <a th:href="@{/artists/{id}(id=${artist.id}, tab='plays', playsPage=0, includeGroups=${includeGroups ? 'true' : null}, includeFeatured=${includeFeatured ? 'true' : null}, includeMain=${includeMain ? null : 'false'})}"
                           th:classappend="${playsPage == 0} ? 'disabled' : ''" class="page-link">&laquo; First</a>
                        <a th:href="@{/artists/{id}(id=${artist.id}, tab='plays', playsPage=${playsPage - 1}, includeGroups=${includeGroups ? 'true' : null}, includeFeatured=${includeFeatured ? 'true' : null}, includeMain=${includeMain ? null : 'false'})}"
                           th:classappend="${playsPage == 0} ? 'disabled' : ''" class="page-link">&lsaquo; Prev</a>
                        <span class="page-info">Page <span th:text="${playsPage + 1}">1</span> of <span th:text="${playsTotalPages}">1</span></span>
                        <a th:href="@{/artists/{id}(id=${artist.id}, tab='plays', playsPage=${playsPage + 1}, includeGroups=${includeGroups ? 'true' : null}, includeFeatured=${includeFeatured ? 'true' : null}, includeMain=${includeMain ? null : 'false'})}"
                           th:classappend="${playsPage >= playsTotalPages - 1} ? 'disabled' : ''" class="page-link">Next &rsaquo;</a>
                        <a th:href="@{/artists/{id}(id=${artist.id}, tab='plays', playsPage=${playsTotalPages - 1}, includeGroups=${includeGroups ? 'true' : null}, includeFeatured=${includeFeatured ? 'true' : null}, includeMain=${includeMain ? null : 'false'})}"
                           th:classappend="${playsPage >= playsTotalPages - 1} ? 'disabled' : ''" class="page-link">Last &raquo;</a>
                    </div>
                </div>
            </div>
            
            <!-- Artist Associations Tab Content -->
            <div class="featured-tab-content" id="collaboratedTabContent" 
                 th:style="${activeTab == 'collaborated'} ? 'display: block !important;' : 'display: none !important;'">
                
                <!-- Is Part Of Section (Groups this artist belongs to) -->
                <div th:if="${groupArtistCards != null and !groupArtistCards.isEmpty()}" class="detail-content-card">
                    <h2 class="section-title">Is Part Of 
                        <span class="item-count">(<span th:text="${groupArtistCards.size()}">0</span>)</span>
                    </h2>
                    
                    <div class="featured-artist-grid">
                        <div th:each="group : ${groupArtistCards}" 
                             class="featured-artist-card"
                             th:classappend="${group.genderName != null and group.genderName.toLowerCase().contains('male') and !group.genderName.toLowerCase().contains('female')} ? 'gender-male' : (${group.genderName != null and group.genderName.toLowerCase().contains('female')} ? 'gender-female' : '')">
                            <a th:href="@{'/artists/' + ${group.id}}" class="featured-artist-image item-image-container">
                                <img th:if="${group.hasImage}"
                                     th:src="@{'/artists/' + ${group.id} + '/image'}"
                                     th:alt="${group.name}">
                                <div th:unless="${group.hasImage}" class="no-image">
                                    <span th:text="${#strings.substring(group.name, 0, 1)}"></span>
                                </div>
                                <span class="flag-overlay" th:if="${group.country != null and @countryCodeMapper.getCode(group.country) != null}"
                                      th:title="${group.country}">
                                    <img th:src="@{https://flagcdn.com/w40/{code}.png(code=${@countryCodeMapper.getCode(group.country)})}"
                                         th:alt="${group.country}" />
                                </span>
                                <!-- Death indicator overlay -->
                                <span class="death-overlay" th:if="${group.deathDate != null}" th:title="'Passed away on ' + ${#temporals.format(group.deathDate, 'dd-MMM-yyyy')}">‚Ä†</span>
                            </a>
                            <div class="featured-artist-info">
                                <a th:href="@{'/artists/' + ${group.id}}">
                                    <h3 class="featured-artist-name" th:text="${group.name}">Group Name</h3>
                                </a>
                                <div class="featured-artist-details" th:if="${group.genderName != null or group.ethnicityName != null}">
                                    <span th:if="${group.genderName != null}" th:text="${group.genderName}"></span>
                                    <span th:if="${group.genderName != null and group.ethnicityName != null}"> ‚Ä¢ </span>
                                    <span th:if="${group.ethnicityName != null}" th:text="${group.ethnicityName}"></span>
                                </div>
                                <div class="featured-artist-metadata" th:if="${group.genreName != null or group.country != null}">
                                    <span th:if="${group.genreName != null}" th:text="${group.genreName}"></span>
                                    <span th:if="${group.genreName != null and group.country != null}"> ‚Ä¢ </span>
                                    <span th:if="${group.country != null}" th:text="${group.country}"></span>
                                </div>
                                <div class="featured-artist-stats">
                                    <div class="stat">
                                        <span class="stat-icon total-plays">‚èµ</span>
                                        <span class="stat-value" th:text="${group.playCount}">0</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Members Section (Artists that are part of this group) - MOVED BEFORE Collaborated With -->
                <div th:if="${memberArtistCards != null and !memberArtistCards.isEmpty()}" class="detail-content-card">
                    <h2 class="section-title">Members 
                        <span class="item-count">(<span th:text="${memberArtistCards.size()}">0</span>)</span>
                    </h2>
                    
                    <div class="featured-artist-grid">
                        <div th:each="member : ${memberArtistCards}" 
                             class="featured-artist-card"
                             th:classappend="${member.genderName != null and member.genderName.toLowerCase().contains('male') and !member.genderName.toLowerCase().contains('female')} ? 'gender-male' : (${member.genderName != null and member.genderName.toLowerCase().contains('female')} ? 'gender-female' : '')">
                            <a th:href="@{'/artists/' + ${member.id}}" class="featured-artist-image item-image-container">
                                <img th:if="${member.hasImage}"
                                     th:src="@{'/artists/' + ${member.id} + '/image'}"
                                     th:alt="${member.name}">
                                <div th:unless="${member.hasImage}" class="no-image">
                                    <span th:text="${#strings.substring(member.name, 0, 1)}"></span>
                                </div>
                                <span class="flag-overlay" th:if="${member.country != null and @countryCodeMapper.getCode(member.country) != null}"
                                      th:title="${member.country}">
                                    <img th:src="@{https://flagcdn.com/w40/{code}.png(code=${@countryCodeMapper.getCode(member.country)})}"
                                         th:alt="${member.country}" />
                                </span>
                                <!-- Death indicator overlay -->
                                <span class="death-overlay" th:if="${member.deathDate != null}" th:title="'Passed away on ' + ${#temporals.format(member.deathDate, 'dd-MMM-yyyy')}">‚Ä†</span>
                            </a>
                            <div class="featured-artist-info">
                                <a th:href="@{'/artists/' + ${member.id}}">
                                    <h3 class="featured-artist-name" th:text="${member.name}">Member Name</h3>
                                </a>
                                <div class="featured-artist-details" th:if="${member.genderName != null or member.ethnicityName != null}">
                                    <span th:if="${member.genderName != null}" th:text="${member.genderName}"></span>
                                    <span th:if="${member.genderName != null and member.ethnicityName != null}"> ‚Ä¢ </span>
                                    <span th:if="${member.ethnicityName != null}" th:text="${member.ethnicityName}"></span>
                                </div>
                                <div class="featured-artist-metadata" th:if="${member.genreName != null or member.country != null}">
                                    <span th:if="${member.genreName != null}" th:text="${member.genreName}"></span>
                                    <span th:if="${member.genreName != null and member.country != null}"> ‚Ä¢ </span>
                                    <span th:if="${member.country != null}" th:text="${member.country}"></span>
                                </div>
                                <div class="featured-artist-stats">
                                    <div class="stat">
                                        <span class="stat-icon total-plays">‚èµ</span>
                                        <span class="stat-value" th:text="${member.playCount}">0</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Collaborated With Section -->
                <div class="detail-content-card">
                    <h2 class="section-title">Collaborated With 
                        <span class="item-count">(<span th:text="${collaboratedArtistCards != null ? collaboratedArtistCards.size() : 0}">0</span>)</span>
                    </h2>
                    
                    <div th:if="${collaboratedArtistCards == null or collaboratedArtistCards.isEmpty()}" class="no-items-message">
                        <p>No collaborations found for this artist.</p>
                    </div>
                    
                    <div th:if="${collaboratedArtistCards != null and !collaboratedArtistCards.isEmpty()}" class="featured-artist-grid">
                        <div th:each="collab : ${collaboratedArtistCards}" 
                             class="featured-artist-card"
                             th:title="${collab.songNamesFormatted}"
                             th:classappend="${collab.genderName != null and collab.genderName.toLowerCase().contains('male') and !collab.genderName.toLowerCase().contains('female')} ? 'gender-male' : (${collab.genderName != null and collab.genderName.toLowerCase().contains('female')} ? 'gender-female' : '')">
                            <a th:href="@{'/artists/' + ${collab.id}}" class="featured-artist-image item-image-container">
                                <img th:if="${collab.hasImage}"
                                     th:src="@{'/artists/' + ${collab.id} + '/image'}"
                                     th:alt="${collab.name}">
                                <div th:unless="${collab.hasImage}" class="no-image">
                                    <span th:text="${#strings.substring(collab.name, 0, 1)}"></span>
                                </div>
                                <span class="flag-overlay" th:if="${collab.country != null and @countryCodeMapper.getCode(collab.country) != null}"
                                      th:title="${collab.country}">
                                    <img th:src="@{https://flagcdn.com/w40/{code}.png(code=${@countryCodeMapper.getCode(collab.country)})}"
                                         th:alt="${collab.country}" />
                                </span>
                                <!-- Death indicator overlay -->
                                <span class="death-overlay" th:if="${collab.deathDate != null}" th:title="'Passed away on ' + ${#temporals.format(collab.deathDate, 'dd-MMM-yyyy')}">‚Ä†</span>
                                <!-- Feature count badge for artists -->
                                <span th:if="${collab.featureCount > 1}" class="feature-count-badge" 
                                      th:text="${collab.featureCount}" th:title="${collab.featureCount + ' songs'}"></span>
                            </a>
                            <div class="featured-artist-info">
                                <a th:href="@{'/artists/' + ${collab.id}}">
                                    <h3 class="featured-artist-name" th:text="${collab.name}">Artist Name</h3>
                                </a>
                                <div class="featured-artist-details" th:if="${collab.genderName != null or collab.ethnicityName != null}">
                                    <span th:if="${collab.genderName != null}" th:text="${collab.genderName}"></span>
                                    <span th:if="${collab.genderName != null and collab.ethnicityName != null}"> ‚Ä¢ </span>
                                    <span th:if="${collab.ethnicityName != null}" th:text="${collab.ethnicityName}"></span>
                                </div>
                                <div class="featured-artist-metadata" th:if="${collab.genreName != null or collab.country != null}">
                                    <span th:if="${collab.genreName != null}" th:text="${collab.genreName}"></span>
                                    <span th:if="${collab.genreName != null and collab.country != null}"> ‚Ä¢ </span>
                                    <span th:if="${collab.country != null}" th:text="${collab.country}"></span>
                                </div>
                                <div class="featured-artist-stats">
                                    <div class="stat">
                                        <span class="stat-icon total-plays">‚èµ</span>
                                        <span class="stat-value" th:text="${collab.playCount}">0</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Chart History Tab Content -->
            <div class="featured-tab-content chart-history-content" id="chartHistoryTabContent"
                 th:style="${activeTab == 'chart-history'} ? 'display: block !important;' : 'display: none !important;'">
                    <!-- Albums Chart History -->
                    <div class="detail-content-card">
                        <h2 class="section-title">üíø Albums 
                            <span class="item-count">(<span th:text="${albumChartHistory != null ? albumChartHistory.size() : 0}">0</span>)</span>
                        </h2>
                        
                        <div th:if="${albumChartHistory == null or albumChartHistory.isEmpty()}" class="no-items-message">
                            <p>No albums have charted yet.</p>
                        </div>
                        
                        <div th:if="${albumChartHistory != null and !albumChartHistory.isEmpty()}" class="table-wrapper">
                            <table class="table js-sortable">
                                <thead>
                                    <tr>
                                        <th class="cover-col">Cover</th>
                                        <th>Name</th>
                                        <th style="text-align:right;">Peak</th>
                                        <th style="text-align:right;">Wks@Peak</th>
                                        <th style="text-align:right;">Total Weeks</th>
                                        <th>Release</th>
                                        <th>Debut</th>
                                        <th>Peak Date</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr th:each="entry : ${albumChartHistory}"
                                        th:classappend="${includeGroups and entry.fromGroup} ? 'group-item-row' : ''">
                                        <td class="cover-col">
                                            <div style="cursor:pointer;" th:onclick="|openAlbumImageModalFromArtist(${entry.id})| " th:title="${entry.name}">
                                                <img th:src="@{'/albums/' + ${entry.id} + '/image'}" th:alt="${entry.name} + ' cover'" class="clickable-image" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" style="width:50px;height:50px;object-fit:cover;border-radius:4px;">
                                                <div class="cover-placeholder" style="display:none;width:50px;height:50px;background:#2a2a2a;border-radius:4px;align-items:center;justify-content:center;color:#666;font-size:18px;">üíø</div>
                                            </div>
                                        </td>
                                        <td>
                                            <a th:href="@{'/albums/' + ${entry.id}}" th:text="${entry.name}">Album Name</a>
                                            <span th:if="${includeGroups and entry.fromGroup and entry.sourceArtistName != null}"
                                                  class="group-artist-label">
                                                (by <a th:href="@{'/artists/' + ${entry.sourceArtistId}}" th:text="${entry.sourceArtistName}">Group</a>)
                                            </span>
                                        </td>
                                        <td style="text-align:right;">
                                            <span th:classappend="${entry.peakNumberOne} ? 'peak-number-one' : ''" 
                                                  th:text="${entry.peakPosition}">#1</span>
                                        </td>
                                        <td style="text-align:right;">
                                            <span th:classappend="${entry.peakNumberOne} ? 'peak-number-one' : ''" 
                                                  th:text="${entry.weeksAtPeak}">1</span>
                                        </td>
                                        <td style="text-align:right;" th:text="${entry.totalWeeks}">5</td>
                                        <td th:text="${entry.releaseDate != null ? entry.releaseDate : '-'}">-</td>
                                        <td>
                                            <a th:if="${entry.debutWeek != null}" th:href="@{/charts/weekly/{week}(week=${entry.debutWeek})}" th:text="${entry.debutDate}">-</a>
                                            <span th:unless="${entry.debutWeek != null}">-</span>
                                        </td>
                                        <td>
                                            <a th:if="${entry.peakWeek != null}" th:href="@{/charts/weekly/{week}(week=${entry.peakWeek})}" th:text="${entry.peakDate}">-</a>
                                            <span th:unless="${entry.peakWeek != null}">-</span>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Songs Chart History -->
                    <div class="detail-content-card" style="margin-top: 20px;">
                        <h2 class="section-title">üéµ Songs 
                            <span class="item-count">(<span th:text="${songChartHistory != null ? songChartHistory.size() : 0}">0</span>)</span>
                        </h2>
                        
                        <div th:if="${songChartHistory == null or songChartHistory.isEmpty()}" class="no-items-message">
                            <p>No songs have charted yet.</p>
                        </div>
                        
                        <div th:if="${songChartHistory != null and !songChartHistory.isEmpty()}" class="table-wrapper">
                            <table class="table js-sortable">
                                <thead>
                                    <tr>
                                        <th class="cover-col">Cover</th>
                                        <th>Name</th>
                                        <th style="text-align:right;">Peak</th>
                                        <th style="text-align:right;">Wks@Peak</th>
                                        <th style="text-align:right;">Total Weeks</th>
                                        <th>Release</th>
                                        <th>Debut</th>
                                        <th>Peak Date</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr th:each="entry : ${songChartHistory}"
                                        th:classappend="${(includeFeatured and entry.featuredOn) ? 'featured-song-row' : ''} + ${(includeGroups and entry.fromGroup) ? ' group-item-row' : ''}">
                                        <td class="cover-col">
                                            <div th:title="${entry.name}" style="cursor: pointer;">
                                                <!-- If song has image - show it -->
                                                <div th:if="${entry.hasImage}" class="hover-image-container" style="width:50px;height:50px;">
                                                    <!-- Show album by default if it exists -->
                                                    <img th:if="${entry.albumId != null}"
                                                         th:src="@{'/albums/' + ${entry.albumId} + '/image'}" 
                                                         th:alt="${entry.name}"
                                                         th:onclick="|openSongImageModalFromArtist(${entry.id})|"
                                                         class="album-image-default clickable-image"
                                                         onerror="this.style.display='none';"
                                                         style="border-radius:4px;">
                                                    <!-- Show song image on hover or if no album -->
                                                    <img th:src="@{'/songs/' + ${entry.id} + '/image'}" 
                                                         th:alt="${entry.name}"
                                                         th:onclick="|openSongImageModalFromArtist(${entry.id})|"
                                                         th:class="${entry.albumId != null} ? 'song-image-hover clickable-image' : 'clickable-image'"
                                                         style="border-radius:4px;">
                                                </div>
                                                <!-- If song doesn't have image but has album - show album image -->
                                                <img th:if="${!entry.hasImage and entry.albumId != null}" 
                                                     th:src="@{'/albums/' + ${entry.albumId} + '/image'}" 
                                                     th:alt="${entry.name}"
                                                     th:onclick="|openAlbumImageModalFromArtist(${entry.albumId})|"
                                                     class="inherited-cover clickable-image"
                                                     onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
                                                     style="width:50px;height:50px;object-fit:cover;border-radius:4px;">
                                                <!-- Placeholder if no images -->
                                                <div th:if="${!entry.hasImage and entry.albumId == null}" class="cover-placeholder" style="width:50px;height:50px;background:#2a2a2a;border-radius:4px;display:flex;align-items:center;justify-content:center;color:#666;font-size:18px;">üéµ</div>
                                                <div th:if="${!entry.hasImage and entry.albumId != null}" class="cover-placeholder" style="display:none;width:50px;height:50px;background:#2a2a2a;border-radius:4px;align-items:center;justify-content:center;color:#666;font-size:18px;">üéµ</div>
                                            </div>
                                        </td>
                                        <td>
                                            <a th:href="@{'/songs/' + ${entry.id}}" th:text="${entry.name}">Song Name</a>
                                            <span th:if="${includeFeatured and entry.featuredOn and entry.sourceArtistName != null}"
                                                  class="featured-artist-label">
                                                (feat. on <a th:href="@{'/artists/' + ${entry.sourceArtistId}}" th:text="${entry.sourceArtistName}">Artist</a>)
                                            </span>
                                            <span th:if="${includeGroups and entry.fromGroup and entry.sourceArtistName != null}"
                                                  class="group-artist-label">
                                                (by <a th:href="@{'/artists/' + ${entry.sourceArtistId}}" th:text="${entry.sourceArtistName}">Group</a>)
                                            </span>
                                        </td>
                                        <td style="text-align:right;">
                                            <span th:classappend="${entry.peakNumberOne} ? 'peak-number-one' : ''" 
                                                  th:text="${entry.peakPosition}">#1</span>
                                        </td>
                                        <td style="text-align:right;">
                                            <span th:classappend="${entry.peakNumberOne} ? 'peak-number-one' : ''" 
                                                  th:text="${entry.weeksAtPeak}">1</span>
                                        </td>
                                        <td style="text-align:right;" th:text="${entry.totalWeeks}">5</td>
                                        <td th:text="${entry.releaseDate != null ? entry.releaseDate : '-'}">-</td>
                                        <td>
                                            <a th:if="${entry.debutWeek != null}" th:href="@{/charts/weekly/{week}(week=${entry.debutWeek})}" th:text="${entry.debutDate}">-</a>
                                            <span th:unless="${entry.debutWeek != null}">-</span>
                                        </td>
                                        <td>
                                            <a th:if="${entry.peakWeek != null}" th:href="@{/charts/weekly/{week}(week=${entry.peakWeek})}" th:text="${entry.peakDate}">-</a>
                                            <span th:unless="${entry.peakWeek != null}">-</span>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Album Seasonal/Yearly Charts -->
                    <div th:if="${(seasonalAlbumChartHistory != null and !seasonalAlbumChartHistory.isEmpty()) or (yearlyAlbumChartHistory != null and !yearlyAlbumChartHistory.isEmpty())}" class="detail-content-card" style="margin-top: 20px;">
                        <h2 class="section-title">üíø Albums Seasonal/Yearly Charts</h2>
                        <div class="table-wrapper">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Album</th>
                                        <th style="text-align:right;">Position</th>
                                        <th>Period</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Yearly entries first -->
                                    <tr th:each="entry : ${yearlyAlbumChartHistory}"
                                        th:classappend="${includeGroups and entry['fromGroup'] == true} ? 'group-item-row' : ''">
                                        <td>
                                            <a th:href="@{/albums/{id}(id=${entry['albumId']})}" th:text="${entry['albumName']}">Album Name</a>
                                            <span th:if="${includeGroups and entry['fromGroup'] == true and entry['sourceArtistName'] != null}"
                                                  class="group-artist-label">
                                                (by <a th:href="@{'/artists/' + ${entry['sourceArtistId']}}" th:text="${entry['sourceArtistName']}">Group</a>)
                                            </span>
                                        </td>
                                        <td style="text-align:right;">
                                            <span th:classappend="${entry['position'] == 1} ? 'peak-number-one' : ''"
                                                  th:text="'#' + ${entry['position']}">#1</span>
                                        </td>
                                        <td>
                                            <a th:href="@{/charts/yearly/{pk}(pk=${entry['periodKey']})}" style="text-decoration: none; color: inherit;">
                                                üìÖ <span th:text="${entry['displayName']}">2024</span>
                                            </a>
                                        </td>
                                    </tr>
                                    <!-- Seasonal entries second -->
                                    <tr th:each="entry : ${seasonalAlbumChartHistory}"
                                        th:classappend="${includeGroups and entry['fromGroup'] == true} ? 'group-item-row' : ''">
                                        <td>
                                            <a th:href="@{/albums/{id}(id=${entry['albumId']})}" th:text="${entry['albumName']}">Album Name</a>
                                            <span th:if="${includeGroups and entry['fromGroup'] == true and entry['sourceArtistName'] != null}"
                                                  class="group-artist-label">
                                                (by <a th:href="@{'/artists/' + ${entry['sourceArtistId']}}" th:text="${entry['sourceArtistName']}">Group</a>)
                                            </span>
                                        </td>
                                        <td style="text-align:right;">
                                            <span th:classappend="${entry['position'] == 1} ? 'peak-number-one' : ''"
                                                  th:text="'#' + ${entry['position']}">#1</span>
                                        </td>
                                        <td>
                                            <a th:href="@{/charts/seasonal/{pk}(pk=${entry['periodKey']})}" style="text-decoration: none; color: inherit;">
                                                <span th:if="${#strings.contains(entry['displayName'], 'Winter')}">‚ùÑÔ∏è</span>
                                                <span th:if="${#strings.contains(entry['displayName'], 'Spring')}">üå∏</span>
                                                <span th:if="${#strings.contains(entry['displayName'], 'Summer')}">‚òÄÔ∏è</span>
                                                <span th:if="${#strings.contains(entry['displayName'], 'Fall')}">üçÇ</span>
                                                <span th:text="${entry['displayName']}">Winter 2024</span>
                                            </a>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Songs Seasonal/Yearly Charts -->
                    <div th:if="${(seasonalSongChartHistory != null and !seasonalSongChartHistory.isEmpty()) or (yearlySongChartHistory != null and !yearlySongChartHistory.isEmpty())}" class="detail-content-card" style="margin-top: 20px;">
                        <h2 class="section-title">üéµ Songs Seasonal/Yearly Charts</h2>
                        <div class="table-wrapper">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Song</th>
                                        <th style="text-align:right;">Position</th>
                                        <th>Period</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Yearly entries first -->
                                    <tr th:each="entry : ${yearlySongChartHistory}"
                                        th:classappend="${(includeFeatured and entry['featuredOn'] == true) ? 'featured-song-row' : ''} + ${(includeGroups and entry['fromGroup'] == true) ? ' group-item-row' : ''}">
                                        <td>
                                            <a th:href="@{/songs/{id}(id=${entry['songId']})}" th:text="${entry['songName']}">Song Name</a>
                                            <span th:if="${includeFeatured and entry['featuredOn'] == true and entry['sourceArtistName'] != null}"
                                                  class="featured-artist-label">
                                                (feat. on <a th:href="@{'/artists/' + ${entry['sourceArtistId']}}" th:text="${entry['sourceArtistName']}">Artist</a>)
                                            </span>
                                            <span th:if="${includeGroups and entry['fromGroup'] == true and entry['sourceArtistName'] != null}"
                                                  class="group-artist-label">
                                                (by <a th:href="@{'/artists/' + ${entry['sourceArtistId']}}" th:text="${entry['sourceArtistName']}">Group</a>)
                                            </span>
                                        </td>
                                        <td style="text-align:right;">
                                            <span th:classappend="${entry['position'] == 1} ? 'peak-number-one' : ''"
                                                  th:text="'#' + ${entry['position']}">#1</span>
                                        </td>
                                        <td>
                                            <a th:href="@{/charts/yearly/{pk}(pk=${entry['periodKey']})}" style="text-decoration: none; color: inherit;">
                                                üìÖ <span th:text="${entry['displayName']}">2024</span>
                                            </a>
                                        </td>
                                    </tr>
                                    <!-- Seasonal entries second -->
                                    <tr th:each="entry : ${seasonalSongChartHistory}"
                                        th:classappend="${(includeFeatured and entry['featuredOn'] == true) ? 'featured-song-row' : ''} + ${(includeGroups and entry['fromGroup'] == true) ? ' group-item-row' : ''}">
                                        <td>
                                            <a th:href="@{/songs/{id}(id=${entry['songId']})}" th:text="${entry['songName']}">Song Name</a>
                                            <span th:if="${includeFeatured and entry['featuredOn'] == true and entry['sourceArtistName'] != null}"
                                                  class="featured-artist-label">
                                                (feat. on <a th:href="@{'/artists/' + ${entry['sourceArtistId']}}" th:text="${entry['sourceArtistName']}">Artist</a>)
                                            </span>
                                            <span th:if="${includeGroups and entry['fromGroup'] == true and entry['sourceArtistName'] != null}"
                                                  class="group-artist-label">
                                                (by <a th:href="@{'/artists/' + ${entry['sourceArtistId']}}" th:text="${entry['sourceArtistName']}">Group</a>)
                                            </span>
                                        </td>
                                        <td style="text-align:right;">
                                            <span th:classappend="${entry['position'] == 1} ? 'peak-number-one' : ''"
                                                  th:text="'#' + ${entry['position']}">#1</span>
                                        </td>
                                        <td>
                                            <a th:href="@{/charts/seasonal/{pk}(pk=${entry['periodKey']})}" style="text-decoration: none; color: inherit;">
                                                <span th:if="${#strings.contains(entry['displayName'], 'Winter')}">‚ùÑÔ∏è</span>
                                                <span th:if="${#strings.contains(entry['displayName'], 'Spring')}">üå∏</span>
                                                <span th:if="${#strings.contains(entry['displayName'], 'Summer')}">‚òÄÔ∏è</span>
                                                <span th:if="${#strings.contains(entry['displayName'], 'Fall')}">üçÇ</span>
                                                <span th:text="${entry['displayName']}">Winter 2024</span>
                                            </a>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
            </div>
        </div>
    </div>
    
    <script th:inline="javascript">
        // Initialize plays by month chart (grouped by year)
        document.addEventListener('DOMContentLoaded', function() {
            const playsByMonthData = /*[[${playsByMonth}]]*/ [];
            const artistGenderName = /*[[${artistGenderName}]]*/ '';
            // Album release dates for annotations
            const albumsData = /*[[${albums}]]*/ [];
            
            if (playsByMonthData && playsByMonthData.length > 0) {
                const ctx = document.getElementById('playsByYearChart').getContext('2d');
                
                // Create styled tooltip div for year hovering
                const tooltipDiv = document.createElement('div');
                tooltipDiv.style.cssText = `
                    position: absolute;
                    background: rgba(0, 0, 0, 0.8);
                    color: white;
                    padding: 8px 12px;
                    border-radius: 6px;
                    font-size: 13px;
                    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
                    pointer-events: none;
                    z-index: 1000;
                    display: none;
                    white-space: nowrap;
                    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
                `;
                document.body.appendChild(tooltipDiv);
                
                const chartCanvas = document.getElementById('playsByYearChart');
                const canvasContainer = chartCanvas.parentElement;
                
                // Add double-click for fullscreen
                chartCanvas.addEventListener('dblclick', () => {
                    openChartFullscreen();
                });
                chartCanvas.style.cursor = 'pointer';
                
                function openChartFullscreen() {
                    const modal = document.createElement('div');
                    modal.style.cssText = `
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0, 0, 0, 0.95);
                        z-index: 10000;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        padding: 40px;
                    `;
                    
                    const closeBtn = document.createElement('button');
                    closeBtn.textContent = '‚úï';
                    closeBtn.style.cssText = `
                        position: absolute;
                        top: 20px;
                        right: 20px;
                        background: rgba(255, 255, 255, 0.1);
                        border: 2px solid rgba(255, 255, 255, 0.3);
                        color: white;
                        font-size: 24px;
                        width: 50px;
                        height: 50px;
                        border-radius: 50%;
                        cursor: pointer;
                        transition: all 0.2s;
                    `;
                    closeBtn.onmouseover = () => {
                        closeBtn.style.background = 'rgba(255, 255, 255, 0.2)';
                        closeBtn.style.transform = 'scale(1.1)';
                    };
                    closeBtn.onmouseout = () => {
                        closeBtn.style.background = 'rgba(255, 255, 255, 0.1)';
                        closeBtn.style.transform = 'scale(1)';
                    };
                    closeBtn.onclick = () => document.body.removeChild(modal);
                    
                    const canvasClone = chartCanvas.cloneNode(true);
                    canvasClone.style.cssText = 'max-width: 100%; max-height: 100%; width: auto; height: auto;';
                    
                    modal.appendChild(closeBtn);
                    modal.appendChild(canvasClone);
                    document.body.appendChild(modal);
                    
                    modal.onclick = (e) => {
                        if (e.target === modal) document.body.removeChild(modal);
                    };
                    
                    // Re-render chart in fullscreen
                    const ctxClone = canvasClone.getContext('2d');
                    canvasClone.width = window.innerWidth - 100;
                    canvasClone.height = window.innerHeight - 100;
                    new Chart(ctxClone, chartInstance.config);
                }
                
                canvasContainer.addEventListener('mousemove', (e) => {
                    const rect = document.getElementById('playsByYearChart').getBoundingClientRect();
                    tooltipDiv.style.left = (e.pageX + 10) + 'px';
                    tooltipDiv.style.top = (e.pageY - 25) + 'px';
                });
                
                canvasContainer.addEventListener('mouseleave', () => {
                    hideYearTooltip();
                });
                
                function showYearTooltip(year, plays) {
                    tooltipDiv.textContent = year + ': ' + plays.toLocaleString() + ' plays';
                    tooltipDiv.style.display = 'block';
                }
                
                function hideYearTooltip() {
                    tooltipDiv.style.display = 'none';
                }
                
                const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                const monthMap = { 'Jan': 0, 'Feb': 1, 'Mar': 2, 'Apr': 3, 'May': 4, 'Jun': 5, 
                                   'Jul': 6, 'Aug': 7, 'Sep': 8, 'Oct': 9, 'Nov': 10, 'Dec': 11 };
                
                // Build a map of existing data
                const dataMap = {};
                playsByMonthData.forEach(d => {
                    dataMap[d.year + '-' + d.month] = d.playCount;
                });
                
                // Find year range based on actual play data
                const allYears = [...new Set(playsByMonthData.map(d => parseInt(d.year)))].sort((a, b) => a - b);
                const minYear = allYears[0];
                const maxYear = allYears[allYears.length - 1];
                
                // Fill in all months between first and last play data point
                const filledData = [];
                for (let year = minYear; year <= maxYear; year++) {
                    for (let month = 1; month <= 12; month++) {
                        const monthStr = month.toString().padStart(2, '0');
                        const key = year + '-' + monthStr;
                        filledData.push({
                            year: year.toString(),
                            month: monthStr,
                            monthIndex: month - 1,
                            label: year + '-' + monthStr,
                            playCount: dataMap[key] || 0
                        });
                    }
                }
                
                // Determine bar color based on gender
                const isFemale = artistGenderName && artistGenderName.toLowerCase().includes('female');
                const barColor = isFemale ? 'rgba(236, 72, 153, 0.8)' : 'rgba(59, 130, 246, 0.8)';
                const borderColor = isFemale ? 'rgba(236, 72, 153, 1)' : 'rgba(59, 130, 246, 1)';
                // Release line color: lighter shade based on gender
                const releaseColor = isFemale ? 'rgba(244, 114, 182, 0.9)' : 'rgba(147, 197, 253, 0.9)';
                
                // Calculate total plays per year for hover display
                const yearTotals = {};
                filledData.forEach(d => {
                    if (!yearTotals[d.year]) yearTotals[d.year] = 0;
                    yearTotals[d.year] += d.playCount;
                });
                
                // Parse album release dates with full precision (year + month)
                const albumReleases = [];
                if (albumsData && albumsData.length > 0) {
                    albumsData.forEach(album => {
                        if (album.releaseDate) {
                            // Parse date in dd-MMM-yyyy format
                            const dateParts = album.releaseDate.split('-');
                            if (dateParts.length === 3) {
                                const month = monthMap[dateParts[1]] || 0;
                                const year = parseInt(dateParts[2]);
                                albumReleases.push({ name: album.name, year: year, month: month });
                            }
                        }
                    });
                }
                
                // Sort by year then month
                albumReleases.sort((a, b) => {
                    if (a.year !== b.year) return a.year - b.year;
                    return a.month - b.month;
                });
                
                // Build album release date annotations (only for albums within chart range)
                const annotations = {};
                albumReleases.forEach((album, idx) => {
                    // Find the index in filledData that matches this year/month
                    const releaseIndex = filledData.findIndex(d => 
                        parseInt(d.year) === album.year && d.monthIndex === album.month
                    );
                    
                    if (releaseIndex !== -1) {
                        annotations['release_' + idx] = {
                            type: 'line',
                            xMin: releaseIndex,
                            xMax: releaseIndex,
                            borderColor: releaseColor,
                            borderWidth: 2,
                            borderDash: [6, 4],
                            albumName: album.name,
                            albumDate: monthNames[album.month] + ' ' + album.year
                        };
                    }
                });
                
                const chartInstance = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: filledData.map(d => d.label),
                        datasets: [{
                            label: 'Plays',
                            data: filledData.map(d => d.playCount),
                            backgroundColor: barColor,
                            borderColor: borderColor,
                            borderWidth: 1
                        }]
                    },
                    plugins: [{
                        id: 'yearSeparators',
                        afterDatasetsDraw: function(chart) {
                            const ctx = chart.ctx;
                            const xAxis = chart.scales.x;
                            const yAxis = chart.scales.y;
                            
                            ctx.save();
                            ctx.strokeStyle = 'rgba(255,255,255,0.15)';
                            ctx.lineWidth = 1.5;
                            ctx.setLineDash([]);
                            
                            filledData.forEach((item, idx) => {
                                if (item.monthIndex === 0 && idx > 0) {
                                    const x = xAxis.getPixelForValue(idx - 0.5);
                                    ctx.beginPath();
                                    ctx.moveTo(x, yAxis.top);
                                    ctx.lineTo(x, yAxis.bottom);
                                    ctx.stroke();
                                }
                            });
                            ctx.restore();
                        }
                    }],
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        onHover: function(event, activeElements) {
                            const chart = chartInstance;
                            const canvasPosition = Chart.helpers.getRelativePosition(event, chart);
                            const dataX = chart.scales.x.getValueForPixel(canvasPosition.x);
                            
                            // Priority 1: Check if we're near any release line
                            let nearRelease = null;
                            Object.values(annotations).forEach(ann => {
                                if (ann.xMin !== undefined && ann.albumName) {
                                    if (Math.abs(dataX - ann.xMin) < 0.5) {
                                        if (!nearRelease) nearRelease = [];
                                        nearRelease.push(ann.albumName + ' (' + ann.albumDate + ')');
                                    }
                                }
                            });
                            
                            if (nearRelease) {
                                chart.canvas.title = 'üìÄ ' + nearRelease.join(', ');
                                hideYearTooltip();
                                return;
                            }
                            
                            // Priority 2: If not hovering on a bar, show year total
                            if (activeElements.length === 0 && dataX >= 0 && dataX < filledData.length) {
                                const idx = Math.round(dataX);
                                const item = filledData[idx];
                                if (item && yearTotals[item.year] !== undefined) {
                                    showYearTooltip(item.year, yearTotals[item.year]);
                                    chart.canvas.title = '';
                                    return;
                                }
                            }
                            
                            chart.canvas.title = '';
                            hideYearTooltip();
                        },
                        plugins: {
                            legend: { display: false },
                            annotation: {
                                annotations: annotations
                            },
                            tooltip: {
                                callbacks: {
                                    title: function(tooltipItems) {
                                        const idx = tooltipItems[0].dataIndex;
                                        const item = filledData[idx];
                                        return monthNames[item.monthIndex] + ' ' + item.year;
                                    },
                                    afterTitle: function(tooltipItems) {
                                        // Check if any album was released this month
                                        if (tooltipItems.length > 0) {
                                            const idx = tooltipItems[0].dataIndex;
                                            const releasedAlbums = [];
                                            Object.values(annotations).forEach(ann => {
                                                if (ann.xMin === idx && ann.albumName) {
                                                    releasedAlbums.push(ann.albumName + ' (' + ann.albumDate + ')');
                                                }
                                            });
                                            if (releasedAlbums.length > 0) {
                                                return 'üìÄ ' + releasedAlbums.join(', ');
                                            }
                                        }
                                        return null;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { color: '#9ca3af' },
                                grid: { color: 'rgba(255,255,255,0.1)' }
                            },
                            x: {
                                offset: true,
                                ticks: { 
                                    color: '#9ca3af',
                                    callback: function(value, index) {
                                        // Only show label for January of each year
                                        const item = filledData[index];
                                        if (item.monthIndex === 0) {
                                            return item.year;
                                        }
                                        return '';
                                    },
                                    maxRotation: 0
                                },
                                grid: { 
                                    display: false
                                }
                            }
                        }
                    }
                });
            }
        });
    </script>
    
    <script th:inline="javascript">
        let isEditing = false;
        
        // Groups state
        let selectedGroups = [];
        let groupSearchTimeout = null;
        
        // Initialize groups from server data
        document.addEventListener('DOMContentLoaded', function() {
            initializeGroups();
            setupGroupsInputListener();
        });
        
        function initializeGroups() {
            // Convert server data to our format
            const serverData = /*[[${groupArtistCards}]]*/ [];
            if (serverData && serverData.length > 0) {
                selectedGroups = serverData.map(g => ({
                    id: g.id,
                    name: g.name
                }));
            }
        }
        
        function setupGroupsInputListener() {
            const input = document.getElementById('groupsInput');
            if (input) {
                input.addEventListener('input', function(e) {
                    if (groupSearchTimeout) {
                        clearTimeout(groupSearchTimeout);
                    }
                    groupSearchTimeout = setTimeout(() => {
                        searchGroups(e.target.value);
                    }, 200);
                });
                
                input.addEventListener('focus', function() {
                    if (this.value.trim().length >= 1) {
                        searchGroups(this.value);
                    }
                });
            }
            
            // Close dropdown when clicking outside
            document.addEventListener('click', function(e) {
                const container = document.getElementById('groupsContainer');
                if (container && !container.contains(e.target)) {
                    hideGroupsDropdown();
                }
            });
        }
        
        function toggleEdit() {
            isEditing = !isEditing;
            const editBtn = document.getElementById('editBtn');
            const deleteBtn = document.getElementById('deleteBtn');
            const formActions = document.getElementById('formActions');
            const selects = document.querySelectorAll('#artistForm select');
            const textInputs = document.querySelectorAll('#artistForm input.editable-input');
            const inlineCheckboxLabels = document.querySelectorAll('.inline-checkbox-label');
            const attributeTexts = document.querySelectorAll('.attribute-text');
            
            if (isEditing) {
                editBtn.style.display = 'none';
                deleteBtn.style.display = 'none';
                formActions.style.display = 'flex';
                
                // Show name field group
                const nameFieldGroup = document.getElementById('nameFieldGroup');
                if (nameFieldGroup) {
                    nameFieldGroup.style.display = 'block';
                }
                
                // Show text inputs
                textInputs.forEach(input => {
                    input.style.display = 'block';
                });
                
                selects.forEach(select => {
                    select.removeAttribute('disabled');
                    select.style.display = 'block';
                });
                inlineCheckboxLabels.forEach(label => {
                    label.style.display = 'inline-flex';
                });
                attributeTexts.forEach(text => {
                    if (text.dataset.field) {
                        text.style.display = 'none';
                    }
                });
                
                // Show groups field and container
                const groupsField = document.getElementById('groupsField');
                if (groupsField) {
                    groupsField.style.display = 'block';
                }
                const groupsContainer = document.getElementById('groupsContainer');
                if (groupsContainer) {
                    groupsContainer.style.display = 'block';
                }
                
                // Render group chips
                renderGroupChips();
                
                // Initialize searchable selects for dropdowns
                setTimeout(function() {
                    initSearchableSelect('genderId');
                    initSearchableSelect('ethnicityId');
                    initSearchableSelect('country');
                    initSearchableSelect('genreId');
                    initSearchableSelect('subgenreId');
                    initSearchableSelect('languageId');
                }, 50);
                
                // Initialize Flatpickr for date inputs
                setTimeout(function() {
                    const birthDateInput = document.getElementById('birthDate');
                    if (birthDateInput) {
                        flatpickr(birthDateInput, {
                            dateFormat: 'd/m/Y',
                            allowInput: true,
                            theme: 'dark'
                        });
                    }
                    
                    const deathDateInput = document.getElementById('deathDate');
                    if (deathDateInput) {
                        flatpickr(deathDateInput, {
                            dateFormat: 'd/m/Y',
                            allowInput: true,
                            theme: 'dark'
                        });
                    }
                }, 100);
            } else {
                window.location.reload();
            }
        }
        
        // ============================================
        // Groups (Is Part Of) Functions
        // ============================================
        
        function renderGroupChips() {
            const chipsContainer = document.getElementById('groupsChips');
            if (!chipsContainer) return;
            
            chipsContainer.innerHTML = '';
            
            selectedGroups.forEach(group => {
                const chip = document.createElement('span');
                chip.className = 'artist-chip';
                chip.innerHTML = `
                    ${escapeHtml(group.name)}
                    <button type="button" class="chip-remove" onclick="removeGroup(${group.id})">&times;</button>
                `;
                chipsContainer.appendChild(chip);
            });
        }
        
        function removeGroup(groupId) {
            selectedGroups = selectedGroups.filter(g => g.id !== groupId);
            renderGroupChips();
        }
        
        function addGroup(groupId, groupName) {
            // Check if already added
            if (selectedGroups.some(g => g.id === groupId)) {
                return;
            }
            
            selectedGroups.push({ id: groupId, name: groupName });
            renderGroupChips();
            
            // Clear input and hide dropdown
            const input = document.getElementById('groupsInput');
            if (input) {
                input.value = '';
            }
            hideGroupsDropdown();
        }
        
        function searchGroups(query) {
            if (!query || query.trim().length < 1) {
                hideGroupsDropdown();
                return;
            }
            
            // Get current artist ID to exclude from search
            const currentArtistId = window.location.pathname.split('/').pop();
            
            fetch(`/artists/api/search?q=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(artists => {
                    const dropdown = document.getElementById('groupsDropdown');
                    if (!dropdown) return;
                    
                    // Filter out already selected groups and the current artist
                    const availableArtists = artists.filter(a => 
                        a.id != currentArtistId && !selectedGroups.some(sg => sg.id === a.id)
                    );
                    
                    if (availableArtists.length === 0) {
                        dropdown.innerHTML = '<div class="dropdown-item no-results">No artists found</div>';
                    } else {
                        dropdown.innerHTML = availableArtists.map(a => `
                            <div class="dropdown-item" onclick="addGroup(${a.id}, '${escapeHtml(a.name).replace(/'/g, "\\'")}')">
                                ${escapeHtml(a.name)}
                            </div>
                        `).join('');
                    }
                    
                    dropdown.style.display = 'block';
                })
                .catch(error => {
                    console.error('Error searching artists:', error);
                    hideGroupsDropdown();
                });
        }
        
        function hideGroupsDropdown() {
            const dropdown = document.getElementById('groupsDropdown');
            if (dropdown) {
                dropdown.style.display = 'none';
            }
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function saveGroups() {
            const artistId = window.location.pathname.split('/').pop();
            const groupIds = selectedGroups.map(g => g.id);
            
            return fetch(`/artists/${artistId}/api/groups`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(groupIds)
            })
            .then(response => response.text())
            .then(data => {
                return data === 'success';
            })
            .catch(error => {
                console.error('Error saving groups:', error);
                return false;
            });
        }
        
        // Override form submission to save groups first
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('artistForm');
            if (form) {
                form.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    // Save groups first, then submit the form
                    saveGroups().then(() => {
                        form.submit();
                    });
                });
            }
        });
        
        function cancelEdit() {
            window.location.reload();
        }
        
        function confirmDelete() {
            const artistName = document.querySelector('.item-name-top').textContent;
            const playCount = /*[[${artistPlayCount}]]*/ 0;
            
            if (playCount > 0) {
                showWarningToast('Cannot delete artist with existing plays (' + playCount + ' plays)');
                return;
            }
            
            if (confirm('Are you sure you want to delete "' + artistName + '"?\n\nThis will also delete all associated albums and songs. This action cannot be undone!')) {
                const artistId = window.location.pathname.split('/').pop();
                
                fetch(`/artists/${artistId}`, {
                    method: 'DELETE'
                })
                .then(response => response.text())
                .then(data => {
                    if (data === 'success') {
                        window.location.href = '/artists';
                    } else if (data.startsWith('error:')) {
                        showErrorToast(data.substring(6));
                    } else {
                        showErrorToast('Failed to delete artist');
                    }
                })
                .catch(error => {
                    console.error('Error deleting artist:', error);
                    showErrorToast('Error deleting artist');
                });
            }
        }
        
        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!file.type.startsWith('image/')) {
                showWarningToast('Please select an image file');
                return;
            }
            
            if (file.size > 5 * 1024 * 1024) {
                showWarningToast('Image size must be less than 5MB');
                return;
            }
            
            const formData = new FormData();
            formData.append('image', file);
            
            const artistId = window.location.pathname.split('/').pop();
            const hasDefaultImage = /*[[${hasImage}]]*/ false;

            // If there's already a default image, add to gallery instead
            const endpoint = hasDefaultImage ? `/artists/${artistId}/images` : `/artists/${artistId}/image`;

            fetch(endpoint, {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (response.ok) {
                    window.location.reload();
                } else {
                    showErrorToast('Failed to upload image');
                }
            })
            .catch(error => {
                console.error('Error uploading image:', error);
                showErrorToast('Error uploading image');
            });
        }
        
        function removeImage() {
            if (!confirm('Are you sure you want to remove this image?')) {
                return;
            }
            
            const artistId = window.location.pathname.split('/').pop();
            
            fetch(`/artists/${artistId}/image`, {
                method: 'DELETE'
            })
            .then(response => {
                if (response.ok) {
                    window.location.reload();
                } else {
                    showErrorToast('Failed to remove image');
                }
            })
            .catch(error => {
                console.error('Error removing image:', error);
                showErrorToast('Error removing image');
            });
        }
        
        // ============ GALLERY FUNCTIONALITY ============
        let galleryImages = []; // Array of image IDs (0 = default, rest are secondary)
        let currentGalleryIndex = 0;
        const artistId = window.location.pathname.split('/').pop();
        const hasDefaultImage = /*[[${hasImage}]]*/ false;

        // Load gallery on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadGallery();
        });

        function loadGallery() {
            fetch(`/artists/${artistId}/images`)
                .then(response => response.json())
                .then(data => {
                    // data is array of {id, displayOrder}
                    const imageIds = data.map(img => img.id);
                    console.log('Gallery images loaded:', imageIds, 'Has default:', hasDefaultImage);

                    // Only include 0 (default) if there is a default image
                    if (hasDefaultImage) {
                        galleryImages = [0, ...imageIds]; // 0 represents the default
                    } else {
                        galleryImages = imageIds.length > 0 ? imageIds : [0];
                    }

                    console.log('Total gallery images:', galleryImages.length);
                    updateGalleryUI();
                })
                .catch(error => {
                    console.error('Error loading gallery:', error);
                    galleryImages = [0]; // Just the default
                    updateGalleryUI();
                });
        }

        function updateGalleryUI() {
            const prevBtn = document.getElementById('galleryPrev');
            const nextBtn = document.getElementById('galleryNext');
            const counter = document.getElementById('galleryCounter');
            const currentIndexSpan = document.getElementById('currentImageIndex');
            const totalCountSpan = document.getElementById('totalImageCount');
            const btnSetDefault = document.getElementById('btnSetDefault');
            const btnRemoveGallery = document.getElementById('btnRemoveGallery');
            const btnRemoveMain = document.getElementById('btnRemoveMain');
            const btnUploadMain = document.getElementById('btnUploadImage');

            const hasMultipleImages = galleryImages.length > 1;
            const isOnSecondaryImage = galleryImages[currentGalleryIndex] !== 0;

            // Show/hide navigation arrows
            if (prevBtn) prevBtn.style.display = hasMultipleImages ? 'flex' : 'none';
            if (nextBtn) nextBtn.style.display = hasMultipleImages ? 'flex' : 'none';

            // Show/hide counter
            if (counter) counter.style.display = hasMultipleImages ? 'block' : 'none';
            if (currentIndexSpan) currentIndexSpan.textContent = currentGalleryIndex + 1;
            if (totalCountSpan) totalCountSpan.textContent = galleryImages.length;

            // Upload button is always visible
            if (btnUploadMain) btnUploadMain.style.display = 'inline-block';

            // Show/hide appropriate buttons based on which image we're viewing
            const hasThemeAssignments = typeof _atAssignments === 'object' && Object.keys(_atAssignments).length > 0;
            if (isOnSecondaryImage) {
                // Viewing a secondary image
                if (btnSetDefault) {
                    btnSetDefault.style.display = 'inline-block';
                    btnSetDefault.disabled = hasThemeAssignments;
                    btnSetDefault.title = hasThemeAssignments ? 'Remove all theme image assignments first' : '';
                    btnSetDefault.style.opacity = hasThemeAssignments ? '0.45' : '1';
                    btnSetDefault.style.cursor = hasThemeAssignments ? 'not-allowed' : 'pointer';
                }
                if (btnRemoveGallery) btnRemoveGallery.style.display = 'inline-block';
                if (btnRemoveMain) btnRemoveMain.style.display = 'none';
            } else {
                // Viewing the default image
                if (btnSetDefault) btnSetDefault.style.display = 'none';
                if (btnRemoveGallery) btnRemoveGallery.style.display = 'none';
                // Only show remove button if this is the only image
                if (btnRemoveMain) btnRemoveMain.style.display = hasMultipleImages ? 'none' : 'inline-block';
            }

            // Update the Assign Theme button label for the current image
            if (typeof _updateThemeButtonLabel === 'function') _updateThemeButtonLabel();
        }

        function galleryNavigate(direction) {
            let newIndex = currentGalleryIndex + direction;
            // Wrap around carousel
            if (newIndex < 0) newIndex = galleryImages.length - 1;
            if (newIndex >= galleryImages.length) newIndex = 0;

            currentGalleryIndex = newIndex;
            updateGalleryImage();
            updateGalleryUI();
        }

        function updateGalleryImage() {
            let img = document.getElementById('artistImage');
            const placeholder = document.getElementById('noImagePlaceholder');
            const currentImageId = galleryImages[currentGalleryIndex];

            // If artistImage doesn't exist but we need to show gallery images, create it dynamically
            if (!img && (currentImageId !== 0 || hasDefaultImage)) {
                img = document.createElement('img');
                img.id = 'artistImage';
                img.className = 'item-image-large clickable-image';
                img.style.cursor = 'pointer';
                img.onclick = function() { openArtistImageModal(); };
                const container = document.querySelector('.item-image-container');
                const navRight = document.getElementById('galleryNext');
                if (navRight && navRight.nextSibling) {
                    container.insertBefore(img, navRight.nextSibling);
                } else {
                    container.insertBefore(img, container.firstChild);
                }
            }

            if (currentImageId === 0) {
                // Show default image
                if (img) {
                    img.src = `/artists/${artistId}/image?raw=true&t=${Date.now()}`;
                    img.style.display = 'block';
                }
                if (placeholder) placeholder.style.display = 'none';
            } else {
                // Show secondary image
                if (img) {
                    img.src = `/artists/${artistId}/images/${currentImageId}?t=${Date.now()}`;
                    img.style.display = 'block';
                }
                if (placeholder) placeholder.style.display = 'none';
            }
        }

        function openArtistImageModal() {
            const img = document.getElementById('artistImage');
            if (!img) return;
            
            // Build gallery context if there are multiple images
            if (galleryImages.length > 1) {
                const galleryContext = {
                    images: galleryImages,
                    entityType: 'artists',
                    entityId: artistId,
                    currentIndex: currentGalleryIndex
                };
                openImageModal(img.src, galleryContext);
            } else {
                openImageModal(img.src);
            }
        }

        function openAlbumImageModalFromArtist(albumId) {
            // Fetch the album's gallery images first
            fetch(`/albums/${albumId}/images`)
                .then(response => response.json())
                .then(data => {
                    const imageIds = data.map(img => img.id);
                    const hasDefaultImage = true; // Assume album has default image if we're clicking it
                    
                    let albumGalleryImages = [];
                    if (hasDefaultImage) {
                        albumGalleryImages = [0, ...imageIds];
                    } else {
                        albumGalleryImages = imageIds.length > 0 ? imageIds : [0];
                    }
                    
                    // Open modal with gallery context if multiple images
                    if (albumGalleryImages.length > 1) {
                        const galleryContext = {
                            images: albumGalleryImages,
                            entityType: 'albums',
                            entityId: albumId,
                            currentIndex: 0
                        };
                        openImageModal(`/albums/${albumId}/image`, galleryContext);
                    } else {
                        openImageModal(`/albums/${albumId}/image`);
                    }
                })
                .catch(error => {
                    console.error('Error loading album gallery:', error);
                    // Fallback to just opening the image
                    openImageModal(`/albums/${albumId}/image`);
                });
        }

        function openSongImageModalFromArtist(songId) {
            // Fetch the song's gallery images first
            fetch(`/songs/${songId}/images`)
                .then(response => response.json())
                .then(data => {
                    const imageIds = data.map(img => img.id);
                    const hasDefaultImage = true; // Assume song has default image if we're clicking it
                    
                    let songGalleryImages = [];
                    if (hasDefaultImage) {
                        songGalleryImages = [0, ...imageIds];
                    } else {
                        songGalleryImages = imageIds.length > 0 ? imageIds : [0];
                    }
                    
                    // Open modal with gallery context if multiple images
                    if (songGalleryImages.length > 1) {
                        const galleryContext = {
                            images: songGalleryImages,
                            entityType: 'songs',
                            entityId: songId,
                            currentIndex: 0
                        };
                        openImageModal(`/songs/${songId}/image`, galleryContext);
                    } else {
                        openImageModal(`/songs/${songId}/image`);
                    }
                })
                .catch(error => {
                    console.error('Error loading song gallery:', error);
                    // Fallback to just opening the image
                    openImageModal(`/songs/${songId}/image`);
                });
        }

        function handleGalleryImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!file.type.startsWith('image/')) {
                showWarningToast('Please select an image file');
                return;
            }

            if (file.size > 5 * 1024 * 1024) {
                showWarningToast('Image size must be less than 5MB');
                return;
            }

            const formData = new FormData();
            formData.append('image', file);

            fetch(`/artists/${artistId}/images`, {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (response.ok) {
                    // Reload gallery to get the new image
                    window.location.reload();
                } else {
                    throw new Error('Failed to add image to gallery');
                }
            })
            .catch(error => {
                console.error('Error adding image to gallery:', error);
                showErrorToast('Error adding image to gallery');
            });

            // Clear the input so the same file can be selected again
            event.target.value = '';
        }

        function setAsDefaultImage() {
            const currentImageId = galleryImages[currentGalleryIndex];
            if (currentImageId === 0) return; // Already on default

            fetch(`/artists/${artistId}/images/${currentImageId}/set-default`, {
                method: 'POST'
            })
            .then(response => {
                if (response.ok) {
                    window.location.reload();
                } else {
                    showErrorToast('Failed to set as default image');
                }
            })
            .catch(error => {
                console.error('Error setting default image:', error);
                showErrorToast('Error setting default image');
            });
        }

        function removeGalleryImage() {
            const currentImageId = galleryImages[currentGalleryIndex];
            if (currentImageId === 0) return; // Can't remove default this way

            if (!confirm('Are you sure you want to remove this image from the gallery?')) {
                return;
            }

            fetch(`/artists/${artistId}/images/${currentImageId}`, {
                method: 'DELETE'
            })
            .then(response => {
                if (response.ok) {
                    // Remove from array and go to previous image
                    galleryImages.splice(currentGalleryIndex, 1);
                    if (currentGalleryIndex >= galleryImages.length) {
                        currentGalleryIndex = galleryImages.length - 1;
                    }
                    updateGalleryImage();
                    updateGalleryUI();
                } else {
                    showErrorToast('Failed to remove image from gallery');
                }
            })
            .catch(error => {
                console.error('Error removing image from gallery:', error);
                showErrorToast('Error removing image from gallery');
            });
        }
        // ============ END GALLERY FUNCTIONALITY ============

        function showTooltip(element) {
            const tooltip = element.querySelector('.tooltiptext') || element;
            if (tooltip.classList.contains('tooltiptext')) {
                const dataPlays = element.getAttribute('data-plays') || element.parentElement.getAttribute('data-plays');
                if (dataPlays) {
                    tooltip.textContent = dataPlays;
                }
                tooltip.style.opacity = '1';
                tooltip.style.visibility = 'visible';
            }
        }
        
        function hideTooltip(element) {
            const tooltip = element.querySelector('.tooltiptext') || element;
            if (tooltip.classList.contains('tooltiptext')) {
                tooltip.style.opacity = '0';
                tooltip.style.visibility = 'hidden';
            }
        }
        
        // Initialize table sorting using shared module
        document.addEventListener('DOMContentLoaded', function() {
            // Albums table sorting
            if (document.getElementById('albumsTable')) {
                initTopTableSort('albumsTable', {
                    defaultColumn: 'totalplays',
                    defaultDirection: 'desc',
                    summaryRowId: 'noAlbumSummaryRow'
                });
                computeNoAlbumSummary();
            }
            
            // Songs table sorting
            if (document.getElementById('songsTable')) {
                initTopTableSort('songsTable', {
                    defaultColumn: 'totalplays',
                    defaultDirection: 'desc'
                });
            }
        });
        
        function computeNoAlbumSummary() {
            const songsTableBody = document.getElementById('songsTableBody');
            if (!songsTableBody) return;
            const summaryRow = document.getElementById('noAlbumSummaryRow');
            if (!summaryRow) return;
            const songRows = Array.from(songsTableBody.querySelectorAll('tr'));
            // Filter songs without album (albumname data attribute empty or cell text is "-")
            const noAlbumRows = songRows.filter(r => {
                const albumName = r.dataset.albumname || '';
                return albumName === '' || albumName === '-';
            });
            if (noAlbumRows.length === 0) return; // leave hidden
            
            let firstDate = null, lastDate = null, vatito = 0, robertlover = 0, totalPlays = 0, totalListening = 0;
            noAlbumRows.forEach(r => {
                const first = r.dataset.firstlistened || '';
                const last = r.dataset.lastlistened || '';
                if (first && (!firstDate || parseDisplayDate(first) < parseDisplayDate(firstDate))) firstDate = first;
                if (last && (!lastDate || parseDisplayDate(last) > parseDisplayDate(lastDate))) lastDate = last;
                vatito += parseInt(r.dataset.primaryplays) || 0;
                robertlover += parseInt(r.dataset.legacyplays) || 0;
                totalPlays += parseInt(r.dataset.totalplays) || 0;
                totalListening += parseInt(r.dataset.timelistened) || 0;
            });
            
            // Format time listened
            function formatSeconds(sec) {
                if (sec <= 0) return '-';
                const h = Math.floor(sec / 3600);
                const m = Math.floor((sec % 3600) / 60);
                if (h > 0) return h + 'h ' + m + 'm';
                return m + 'm';
            }
            
            document.getElementById('noAlbumFirstListened').textContent = firstDate || '-';
            document.getElementById('noAlbumLastListened').textContent = lastDate || '-';
            document.getElementById('noAlbumVatitoPlays').textContent = vatito;
            document.getElementById('noAlbumRobertloverPlays').textContent = robertlover;
            document.getElementById('noAlbumTotalPlays').textContent = totalPlays;
            document.getElementById('noAlbumTotalListeningTime').textContent = formatSeconds(totalListening);
            
            // Set data attributes for sorting
            summaryRow.dataset.name = 'zzzz_no_album';
            summaryRow.dataset.firstlistened = firstDate || '';
            summaryRow.dataset.lastlistened = lastDate || '';
            summaryRow.dataset.primaryplays = vatito;
            summaryRow.dataset.legacyplays = robertlover;
            summaryRow.dataset.totalplays = totalPlays;
            summaryRow.dataset.timelistened = totalListening;
            
            summaryRow.style.display = '';
        }
    </script>
    
    <style>
        /* Field highlight for external metadata fetch */
        .field-highlight {
            box-shadow: 0 0 8px 2px #4CAF50 !important;
            border-color: #4CAF50 !important;
        }
        .gender-male .field-highlight {
            box-shadow: 0 0 8px 2px #4a90d9 !important;
            border-color: #4a90d9 !important;
        }
        .gender-female .field-highlight {
            box-shadow: 0 0 8px 2px #d94a8a !important;
            border-color: #d94a8a !important;
        }
        
        /* Make disabled delete buttons visually distinct */
        .btn-negative:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            background-color: #4a4a4a;
            color: #888;
        }
        
        .btn-negative:disabled:hover {
            background-color: #4a4a4a;
            color: #888;
        }
        
        /* Checkbox styling */
        .checkbox-container {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 0;
            flex-wrap: nowrap;
        }

        .checkbox-container input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .checkbox-label {
            font-size: 14px;
            color: #e5e7eb;
            cursor: pointer;
            white-space: nowrap;
        }
        /* Inline layout for checkbox form-groups (compact) */
        .form-group.form-group-checkbox {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            gap: 8px;
        }

        .form-group.form-group-checkbox .field-label {
            margin: 0;
            color: #cbd5e1;
            font-size: 0.95rem;
            white-space: nowrap;
        }

        .form-group.form-group-checkbox .attribute-text {
            margin-left: 4px;
        }

        .form-group.form-group-checkbox .checkbox-container {
            margin: 0;
            padding: 0;
        }

        .form-group.form-group-checkbox .checkbox-label { display: none; }

        .form-group.form-group-checkbox .inline-checkbox-label {
            justify-content: flex-start;
        }
        
        /* Name field styling */
        .name-field-group {
            grid-column: 1 / -1;
            margin-bottom: 10px;
            padding: 0 10px;
        }
        
        .editable-input {
            width: 100%;
            padding: 8px 12px;
            background: #1f2937;
            border: 1px solid #374151;
            border-radius: 6px;
            color: #e5e7eb;
            font-size: 0.95em;
        }
        
        .editable-input:focus {
            outline: none;
            border-color: #22c55e;
            box-shadow: 0 0 0 2px rgba(34, 197, 94, 0.2);
        }
        
        /* Clickable image cursor */
        .item-image-large.clickable {
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        
        .item-image-large.clickable:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
        }
        
        /* Toggles Container */
        .toggles-container {
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 20px;
            flex-shrink: 0;
        }
        
        /* Include Groups Toggle */
        .include-groups-toggle {
            display: flex;
            align-items: center;
        }
        
        .toggle-label {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            user-select: none;
        }
        
        .toggle-label input[type="checkbox"] {
            position: absolute;
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            width: 44px;
            height: 24px;
            background: #374151;
            border-radius: 12px;
            position: relative;
            transition: background 0.3s ease;
        }
        
        .toggle-slider::after {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            width: 18px;
            height: 18px;
            background: #9ca3af;
            border-radius: 50%;
            transition: transform 0.3s ease, background 0.3s ease;
        }
        
        /* Gender-based toggle colors */
        .toggle-label input[type="checkbox"]:checked + .toggle-slider {
            background: #475569; /* neutral gray default */
        }
        
        .container-wide.gender-male .toggle-label input[type="checkbox"]:checked + .toggle-slider {
            background: #1e40af; /* dark blue for male */
        }
        
        .container-wide.gender-female .toggle-label input[type="checkbox"]:checked + .toggle-slider {
            background: #9d174d; /* dark pink for female */
        }
        
        .toggle-label input[type="checkbox"]:checked + .toggle-slider::after {
            transform: translateX(20px);
            background: white;
        }
        
        .toggle-text {
            font-size: 14px;
            color: #9ca3af;
        }
        
        /* Gender-based toggle text colors */
        .toggle-label input[type="checkbox"]:checked ~ .toggle-text {
            color: #94a3b8; /* neutral gray default */
        }
        
        .container-wide.gender-male .toggle-label input[type="checkbox"]:checked ~ .toggle-text {
            color: #60a5fa; /* light blue for male */
        }
        
        .container-wide.gender-female .toggle-label input[type="checkbox"]:checked ~ .toggle-text {
            color: #f472b6; /* light pink for female */
        }
        
        /* Featured song row highlighting - slightly brighter dark teal tint */
        .featured-song-row {
            background: rgba(28, 170, 170, 0.14) !important;
        }
        
        .featured-song-row:hover {
            background: rgba(28, 170, 170, 0.26) !important;
        }
        
        .featured-artist-label {
            font-size: 11px;
            color: #45cfc9;
            font-style: italic;
            margin-left: 6px;
        }
        
        .featured-artist-label a {
            color: #45cfc9;
        }
        
        .featured-artist-label a:hover {
            color: #7fe6e0;
        }
        
        /* Group item row highlighting - different shade of dark teal */
        .group-item-row {
            background: rgba(50, 110, 120, 0.12) !important;
        }
        
        .group-item-row:hover {
            background: rgba(50, 110, 120, 0.20) !important;
        }
        
        /* When both featured and group classes apply, prioritize featured */
        .featured-song-row.group-item-row {
            background: rgba(20, 130, 130, 0.12) !important;
        }
        
        .featured-song-row.group-item-row:hover {
            background: rgba(20, 130, 130, 0.20) !important;
        }
        
        .group-artist-label {
            font-size: 11px;
            color: #5d9ca5;
            font-style: italic;
            margin-left: 6px;
        }
        
        .group-artist-label a {
            color: #5d9ca5;
        }
        
        .group-artist-label a:hover {
            color: #8fc4cc;
        }
        
        /* Groups chip component */
        .groups-container {
            position: relative;
            width: 100%;
        }
        
        .chips-input-wrapper {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 6px;
            padding: 8px 10px;
            background: #1f2937;
            border: 1px solid #374151;
            border-radius: 6px;
            min-height: 42px;
        }
        
        .chips-input-wrapper:focus-within {
            border-color: #6b7280;
            box-shadow: 0 0 0 2px rgba(107, 114, 128, 0.2);
        }
        
        .chips-container {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }
        
        .artist-chip {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            background: #334155;
            color: #fff;
            border-radius: 4px;
            font-size: 0.85em;
            white-space: nowrap;
        }
        
        .chip-remove {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 16px;
            height: 16px;
            padding: 0;
            margin-left: 2px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 50%;
            color: #fff;
            font-size: 12px;
            line-height: 1;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .chip-remove:hover {
            background: rgba(255, 255, 255, 0.4);
        }
        
        .chips-text-input {
            flex: 1;
            min-width: 120px;
            padding: 4px 0;
            background: transparent;
            border: none;
            color: #e5e7eb;
            font-size: 0.9em;
            outline: none;
        }
        
        .chips-text-input::placeholder {
            color: #6b7280;
        }
        
        .chips-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            max-height: 200px;
            overflow-y: auto;
            background: #1f2937;
            border: 1px solid #374151;
            border-top: none;
            border-radius: 0 0 6px 6px;
            z-index: 100;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        /* Custom tooltip for #1 songs */
        .number-one-tooltip {
            position: fixed;
            display: none;
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            border: 1px solid #ffd700;
            border-radius: 8px;
            padding: 12px 16px;
            max-width: 400px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.6), 0 0 20px rgba(255, 215, 0, 0.2);
            z-index: 10000;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }
        
        .number-one-tooltip .tooltip-title {
            font-size: 13px;
            font-weight: 700;
            color: #ffd700;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .number-one-tooltip .tooltip-song {
            font-size: 13px;
            color: #e5e7eb;
            padding: 4px 0;
            line-height: 1.4;
        }
        
        .number-one-songs-chip,
        .number-one-featured-songs-chip,
        .number-one-albums-chip {
            cursor: help !important;
        }
        
        .dropdown-item {
            padding: 10px 12px;
            color: #e5e7eb;
            cursor: pointer;
            transition: background 0.15s;
        }
        
        .dropdown-item:hover {
            background: #374151;
        }
        
        .dropdown-item.no-results {
            color: #6b7280;
            font-style: italic;
            cursor: default;
        }
        
        .dropdown-item.no-results:hover {
            background: transparent;
        }
        
        /* Group artist links in view mode */
        .group-artist-link {
            color: #94a3b8;
            text-decoration: none;
        }
        
        .group-artist-link:hover {
            text-decoration: underline;
        }
        
        /* Responsive styles for tabs and toggles */
        @media (max-width: 1200px) {
            .toggles-container {
                gap: 12px;
            }
            .toggle-text {
                font-size: 12px;
            }
        }
    </style>
    
    <!-- Image Modal -->
    <th:block th:replace="~{fragments/image-modal :: image-modal}"></th:block>
    
    <script>
        // Make artist image clickable to open modal
        document.addEventListener('DOMContentLoaded', function() {
            const artistImage = document.getElementById('artistImage');
            if (artistImage) {
                artistImage.classList.add('clickable');
                // Note: click handler is already set inline via onclick attribute
            }
        });
        
        // Toggle include groups functionality
        function toggleIncludeGroups(checked) {
            const url = new URL(window.location.href);
            if (checked) {
                url.searchParams.set('includeGroups', 'true');
            } else {
                url.searchParams.delete('includeGroups');
            }
            window.location.href = url.toString();
        }
        
        // Toggle include featured songs functionality
        function toggleIncludeFeatured(checked) {
            const url = new URL(window.location.href);
            if (checked) {
                url.searchParams.set('includeFeatured', 'true');
            } else {
                url.searchParams.delete('includeFeatured');
            }
            window.location.href = url.toString();
        }
        
        // Toggle include main artist functionality
        function toggleIncludeMain(checked) {
            const url = new URL(window.location.href);
            if (checked) {
                // When true (default), remove the parameter from URL
                url.searchParams.delete('includeMain');
            } else {
                // When false, explicitly set it
                url.searchParams.set('includeMain', 'false');
            }
            window.location.href = url.toString();
        }
        
        // Custom tooltip for #1 songs
        document.addEventListener('DOMContentLoaded', function() {
            // Setup tooltip for songs
            const numberOneSongsChip = document.querySelector('.number-one-songs-chip');
            if (numberOneSongsChip) {
                const songs = numberOneSongsChip.getAttribute('data-songs');
                if (songs) {
                    const songsList = songs.split('|');
                    setupNumberOneTooltip(numberOneSongsChip, songsList, 'Songs that reached #1:', 'üèÜ');
                }
            }
            
            // Setup tooltip for featured songs
            const numberOneFeaturedSongsChip = document.querySelector('.number-one-featured-songs-chip');
            if (numberOneFeaturedSongsChip) {
                const featuredSongs = numberOneFeaturedSongsChip.getAttribute('data-featured-songs');
                if (featuredSongs) {
                    const featuredSongsList = featuredSongs.split('|');
                    setupNumberOneTooltip(numberOneFeaturedSongsChip, featuredSongsList, 'Featured songs that reached #1:', 'üåü');
                }
            }
            
            // Setup tooltip for albums
            const numberOneAlbumsChip = document.querySelector('.number-one-albums-chip');
            if (numberOneAlbumsChip) {
                const albums = numberOneAlbumsChip.getAttribute('data-albums');
                if (albums) {
                    const albumsList = albums.split('|');
                    setupNumberOneTooltip(numberOneAlbumsChip, albumsList, 'Albums that reached #1:', 'üèÜ');
                }
            }
        });
        
        function setupNumberOneTooltip(chip, itemsList, title, icon) {
            // Create tooltip element
            const tooltip = document.createElement('div');
            tooltip.className = 'number-one-tooltip';
            tooltip.innerHTML = `<div class="tooltip-title">${title}</div>` +
                itemsList.map(item => `<div class="tooltip-song">${icon} ${escapeHtml(item)}</div>`).join('');
            document.body.appendChild(tooltip);
            
            // Show/hide tooltip on hover
            chip.addEventListener('mouseenter', function(e) {
                const rect = chip.getBoundingClientRect();
                tooltip.style.display = 'block';
                
                // Calculate tooltip height after making it visible
                const tooltipHeight = tooltip.offsetHeight;
                
                // Position above the chip
                tooltip.style.left = rect.left + 'px';
                tooltip.style.top = (rect.top - tooltipHeight - 8) + 'px';
            });
            
            chip.addEventListener('mouseleave', function() {
                tooltip.style.display = 'none';
            });
            
            // Reposition on scroll
            window.addEventListener('scroll', function() {
                if (tooltip.style.display === 'block') {
                    const rect = chip.getBoundingClientRect();
                    const tooltipHeight = tooltip.offsetHeight;
                    tooltip.style.left = rect.left + 'px';
                    tooltip.style.top = (rect.top - tooltipHeight - 8) + 'px';
                }
            });
        }
        
        // Chips expandable modal functionality
        document.addEventListener('DOMContentLoaded', function() {
            const chipsContainer = document.querySelector('.chips-expandable');
            if (!chipsContainer) return;
            
            // Check if content is overflowing
            function checkOverflow() {
                if (chipsContainer.scrollHeight > chipsContainer.clientHeight) {
                    chipsContainer.classList.add('has-overflow');
                    chipsContainer.style.cursor = 'pointer';
                } else {
                    chipsContainer.classList.remove('has-overflow');
                    chipsContainer.style.cursor = 'default';
                }
            }
            
            checkOverflow();
            window.addEventListener('resize', checkOverflow);
            
            // Click to show modal
            chipsContainer.addEventListener('click', function(e) {
                if (!chipsContainer.classList.contains('has-overflow')) return;
                
                // Create modal
                const modal = document.createElement('div');
                modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.85);display:flex;align-items:center;justify-content:center;z-index:9999;';
                
                const modalContent = document.createElement('div');
                modalContent.style.cssText = 'background:#1a1a1a;border-radius:12px;padding:32px;max-width:800px;max-height:80vh;overflow-y:auto;position:relative;border:1px solid #333;';
                
                const closeBtn = document.createElement('button');
                closeBtn.innerHTML = '√ó';
                closeBtn.style.cssText = 'position:absolute;top:12px;right:16px;background:none;border:none;color:#999;font-size:32px;cursor:pointer;padding:0;width:32px;height:32px;line-height:32px;';
                closeBtn.onmouseover = () => closeBtn.style.color = '#fff';
                closeBtn.onmouseout = () => closeBtn.style.color = '#999';
                closeBtn.onclick = () => document.body.removeChild(modal);
                
                const title = document.createElement('h3');
                title.textContent = 'All Rankings';
                title.style.cssText = 'margin:0 0 24px 0;color:#fff;font-size:20px;';
                
                const chipsClone = chipsContainer.cloneNode(true);
                chipsClone.classList.remove('chips-expandable', 'has-overflow');
                chipsClone.style.cssText = 'max-height:none;overflow:visible;display:flex;flex-wrap:wrap;gap:8px;justify-content:center;';
                chipsClone.style.cursor = 'default';
                
                modalContent.appendChild(closeBtn);
                modalContent.appendChild(title);
                modalContent.appendChild(chipsClone);
                modal.appendChild(modalContent);
                
                // Close on background click
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        document.body.removeChild(modal);
                    }
                });
                
                // Close on ESC key
                const escHandler = (e) => {
                    if (e.key === 'Escape') {
                        document.body.removeChild(modal);
                        document.removeEventListener('keydown', escHandler);
                    }
                };
                document.addEventListener('keydown', escHandler);
                
                document.body.appendChild(modal);
            });
        });
    </script>
    
    <!-- Script to wire up the Fetch External button -->
    <script>
        function highlightField(fieldId) {
            let el = document.getElementById(fieldId);
            // If the element is a hidden select wrapped by searchable-select, highlight the wrapper's display element
            if (el && el.closest('.searchable-select-wrapper')) {
                const wrapper = el.closest('.searchable-select-wrapper');
                const display = wrapper.querySelector('.searchable-select-display');
                if (display) el = display;
            }
            // If the element is hidden (like a select in view mode without searchable wrapper), find the corresponding attribute-text span
            else if (el && el.style.display === 'none') {
                const span = document.querySelector(`span.attribute-text[data-field="${fieldId}"]`);
                if (span) el = span;
            }
            if (el) {
                el.classList.remove('field-highlight');
                void el.offsetWidth; // Trigger reflow
                el.classList.add('field-highlight');
                // Remove highlight when user modifies the field
                const removeHighlight = () => {
                    el.classList.remove('field-highlight');
                    el.removeEventListener('input', removeHighlight);
                    el.removeEventListener('change', removeHighlight);
                };
                el.addEventListener('input', removeHighlight);
                el.addEventListener('change', removeHighlight);
            }
        }
        
        function clearAllHighlights() {
            document.querySelectorAll('.field-highlight').forEach(el => el.classList.remove('field-highlight'));
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            const fetchBtn = document.getElementById('btnFetchExternal');
            if (fetchBtn) {
                fetchBtn.addEventListener('click', function() {
                    const artistName = this.getAttribute('data-artist-name');
                    const artistId = parseInt(this.getAttribute('data-artist-id'));
                    
                    // Open with callback to populate form fields instead of saving directly
                    openArtistFetchModal(artistName, artistId, function(selectedArtist) {
                        // Populate birth date
                        if (selectedArtist.birthDate) {
                            const dateParts = selectedArtist.birthDate.split('-');
                            let formatted = '';
                            if (dateParts.length === 3) {
                                formatted = `${dateParts[2]}/${dateParts[1]}/${dateParts[0]}`;
                            } else if (dateParts.length === 2) {
                                formatted = `01/${dateParts[1]}/${dateParts[0]}`; // Use first of month
                            } else if (dateParts.length === 1 && dateParts[0].length === 4) {
                                formatted = `01/01/${dateParts[0]}`; // Use first of year
                            }
                            if (formatted) {
                                const birthDateInput = document.getElementById('birthDate');
                                if (birthDateInput) {
                                    const oldValue = birthDateInput.value;
                                    birthDateInput.value = formatted;
                                    const fp = birthDateInput._flatpickr;
                                    if (fp) fp.setDate(formatted, true, 'd/m/Y');
                                    // Only highlight if value changed
                                    if (oldValue !== formatted) {
                                        highlightField('birthDate');
                                    }
                                }
                            }
                        }
                        
                        // Populate death date
                        if (selectedArtist.deathDate) {
                            const dateParts = selectedArtist.deathDate.split('-');
                            let formatted = '';
                            if (dateParts.length === 3) {
                                formatted = `${dateParts[2]}/${dateParts[1]}/${dateParts[0]}`;
                            } else if (dateParts.length === 2) {
                                formatted = `01/${dateParts[1]}/${dateParts[0]}`;
                            } else if (dateParts.length === 1 && dateParts[0].length === 4) {
                                formatted = `01/01/${dateParts[0]}`;
                            }
                            if (formatted) {
                                const deathDateInput = document.getElementById('deathDate');
                                if (deathDateInput) {
                                    const oldValue = deathDateInput.value;
                                    deathDateInput.value = formatted;
                                    const fp = deathDateInput._flatpickr;
                                    if (fp) fp.setDate(formatted, true, 'd/m/Y');
                                    // Only highlight if value changed
                                    if (oldValue !== formatted) {
                                        highlightField('deathDate');
                                    }
                                }
                            }
                        }
                        
                        // Populate country
                        if (selectedArtist.country) {
                            const countrySelect = document.getElementById('country');
                            if (countrySelect) {
                                const oldValue = countrySelect.value;
                                // Try to find matching option
                                const options = countrySelect.options;
                                let newValue = null;
                                for (let i = 0; i < options.length; i++) {
                                    if (options[i].value === selectedArtist.country || 
                                        options[i].text === selectedArtist.country) {
                                        newValue = options[i].value;
                                        countrySelect.value = newValue;
                                        // Update the searchable-select display
                                        const wrapper = countrySelect.closest('.searchable-select-wrapper');
                                        if (wrapper) {
                                            const display = wrapper.querySelector('.searchable-select-display');
                                            if (display) {
                                                display.textContent = options[i].text;
                                                display.classList.add('has-value');
                                            }
                                        }
                                        // Trigger change event
                                        countrySelect.dispatchEvent(new Event('change', { bubbles: true }));
                                        break;
                                    }
                                }
                                // Only highlight if value changed
                                if (newValue !== null && oldValue !== newValue) {
                                    highlightField('country');
                                }
                            }
                        }
                        
                        // Populate Is Band based on type (Group, Orchestra, Choir = true)
                        if (selectedArtist.type) {
                            const isBandCheckbox = document.getElementById('isBand');
                            if (isBandCheckbox) {
                                const bandTypes = ['Group', 'Orchestra', 'Choir'];
                                const isBand = bandTypes.includes(selectedArtist.type);
                                if (isBandCheckbox.checked !== isBand) {
                                    isBandCheckbox.checked = isBand;
                                    highlightField('isBand');
                                }
                            }
                        }
                    });
                });
            }
        });
        
        // Mobile: Toggle ranking chips expand/collapse
        function toggleChipsExpand(btn) {
            const chipsContainer = btn.previousElementSibling;
            if (chipsContainer && chipsContainer.classList.contains('winning-chips')) {
                const isExpanded = chipsContainer.classList.toggle('expanded');
                btn.innerHTML = isExpanded ? 'Show less <span class="expand-icon">‚ñ≤</span>' : 'Show more <span class="expand-icon">‚ñº</span>';
            }
        }
        
        function switchTab(event, tabName) {
            event.preventDefault();
            
            // Get all tab content sections
            const generalSection = document.getElementById('generalSectionContent');
            const collaboratedSection = document.getElementById('collaboratedTabContent');
            const playsSection = document.getElementById('playsTabContent');
            const chartHistorySection = document.getElementById('chartHistoryTabContent');
            const generalTabSections = document.querySelectorAll('.general-tab-section');
            
            // Hide all tab content sections
            if (generalSection) generalSection.style.cssText = 'display: none !important;';
            if (collaboratedSection) collaboratedSection.style.cssText = 'display: none !important;';
            if (playsSection) playsSection.style.cssText = 'display: none !important;';
            if (chartHistorySection) chartHistorySection.style.cssText = 'display: none !important;';
            generalTabSections.forEach(section => section.style.cssText = 'display: none !important;');
            
            // Remove active class from all tabs
            document.querySelectorAll('.detail-tab').forEach(tab => tab.classList.remove('active'));
            
            // Show selected tab and activate it
            if (tabName === 'collaborated' && collaboratedSection) {
                collaboratedSection.style.cssText = 'display: block !important;';
                document.getElementById('collaboratedTab').classList.add('active');
            } else if (tabName === 'plays' && playsSection) {
                playsSection.style.cssText = 'display: block !important;';
                document.getElementById('playsTab').classList.add('active');
            } else if (tabName === 'chart-history' && chartHistorySection) {
                chartHistorySection.style.cssText = 'display: block !important;';
                document.getElementById('chartHistoryTab').classList.add('active');
            } else if (tabName === 'general' && generalSection) {
                generalSection.style.cssText = 'display: block !important;';
                generalTabSections.forEach(section => section.style.cssText = 'display: block !important;');
                document.getElementById('generalTab').classList.add('active');
            }
        }
    </script>
    
    <!-- Artist Fetch Modal (MusicBrainz) -->
    <th:block th:replace="~{fragments/artist-fetch-modal :: artist-fetch-modal}"></th:block>

    <!-- ======================================================
         Assign-to-Theme Modal
         ====================================================== -->
    <div id="assignThemeModal" style="
            display:none; position:fixed; z-index:10000; inset:0;
            background:rgba(0,0,0,0.6); align-items:center; justify-content:center;">
        <div style="
                background:#1a1a1a; border:1px solid #333; border-radius:14px;
                width:440px; max-width:95vw; max-height:90vh; overflow-y:auto;
                padding:24px; box-shadow:0 20px 60px rgba(0,0,0,0.7);">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
                <h3 style="margin:0; font-size:1.1rem;">Assign Image to Theme</h3>
                <button onclick="closeAssignThemeModal()"
                        style="background:none;border:none;color:#aaa;font-size:1.5rem;cursor:pointer;line-height:1;">√ó</button>
            </div>
            <div style="font-size:12px; color:#666; margin-bottom:16px; line-height:1.5;">
                Click a theme to assign the current image to it. Click the highlighted theme to remove the assignment.
            </div>
            <!-- Theme list -->
            <div id="atThemeGrid" style="display:flex; flex-direction:column; gap:8px;"></div>
        </div>
    </div>

    <style>
        .btn-assign-theme {
            padding: 5px 10px;
            background: rgba(74,144,226,0.85);
            border: 1px solid rgba(74,144,226,0.6);
            border-radius: 6px;
            color: #fff;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s, opacity 0.2s;
            white-space: nowrap;
        }
        .btn-assign-theme:hover { background: rgba(74,144,226,1); }
        .btn-assign-theme.no-theme {
            background: rgba(74,144,226,0.35);
            border-color: rgba(74,144,226,0.25);
            color: rgba(255,255,255,0.55);
        }
        .btn-assign-theme.no-theme:hover { background: rgba(74,144,226,0.55); color: #fff; }
        #atConfirmBtn:not(:disabled) { opacity: 1; cursor: pointer; }
    </style>

    <script>
    // ==========================================================================
    // Assign-to-Theme modal logic
    // ==========================================================================
    let _atCurrentImageId = null;   // null = default image; integer = ArtistImage.id
    let _atThemes = [];             // [{id, name, isActive}]
    let _atAssignments = {};        // { themeId -> artistImageId (-1 = default) }
    let _atArtistId = null;
    let _atImageToTheme = {};       // { imageKey -> themeName } ‚Äî reverse map for button label

    (function initThemeButton() {
        _atArtistId = typeof artistId !== 'undefined' ? artistId : null;
        if (!_atArtistId) return;

        fetch('/themes/api/all')
            .then(r => r.json())
            .then(themes => {
                _atThemes = themes;
                if (themes.length > 0) {
                    const btn = document.getElementById('btnAssignTheme');
                    if (btn) btn.style.display = 'inline-block';
                }
                _reloadAssignments();
            }).catch(() => {});
    })();

    function _reloadAssignments() {
        if (!_atArtistId) return;
        fetch(`/artists/${_atArtistId}/theme-assignments`)
            .then(r => r.json())
            .then(list => {
                _atAssignments = {};
                _atImageToTheme = {};
                list.forEach(a => {
                    _atAssignments[a.themeId] = a.artistImageId;
                    const theme = _atThemes.find(t => t.id === a.themeId);
                    if (theme) {
                        const imageKey = (a.artistImageId === -1 || a.artistImageId === null) ? 'default' : String(a.artistImageId);
                        _atImageToTheme[imageKey] = theme.name;
                    }
                });
                _updateThemeButtonLabel();
                _updateSetDefaultButton();
            }).catch(() => {});
    }

    function _updateThemeButtonLabel() {
        const btn = document.getElementById('btnAssignTheme');
        if (!btn) return;
        const currentImageId = (typeof galleryImages !== 'undefined' && typeof currentGalleryIndex !== 'undefined')
            ? galleryImages[currentGalleryIndex] : 0;
        const imageKey = (currentImageId === 0) ? 'default' : String(currentImageId);
        const themeName = _atImageToTheme[imageKey];
        if (themeName) {
            btn.textContent = themeName;
            btn.classList.remove('no-theme');
        } else {
            btn.textContent = 'Theme';
            btn.classList.add('no-theme');
        }
    }

    function _updateSetDefaultButton() {
        const btnSetDefault = document.getElementById('btnSetDefault');
        if (!btnSetDefault) return;
        const hasThemeAssignments = typeof _atAssignments === 'object' && Object.keys(_atAssignments).length > 0;
        const isVisible = btnSetDefault.style.display !== 'none';
        if (isVisible) {
            btnSetDefault.disabled = hasThemeAssignments;
            btnSetDefault.title = hasThemeAssignments ? 'Remove all theme image assignments first' : '';
            btnSetDefault.style.opacity = hasThemeAssignments ? '0.45' : '1';
            btnSetDefault.style.cursor = hasThemeAssignments ? 'not-allowed' : 'pointer';
        }
    }

    function _thumbUrl(artistImageId) {
        if (artistImageId === -1 || artistImageId === null) {
            return `/artists/${_atArtistId}/image?raw=true&t=${Date.now()}`;
        }
        return `/artists/${_atArtistId}/images/${artistImageId}?t=${Date.now()}`;
    }

    function _renderThemeGrid() {
        const grid = document.getElementById('atThemeGrid');
        grid.innerHTML = '';

        _atThemes.forEach(theme => {
            const assignedImageId = _atAssignments[theme.id]; // undefined = none, -1 = default, int = gallery
            const hasAssignment = assignedImageId !== undefined;

            // Is the CURRENT image already assigned to this theme?
            const currentKey = _atCurrentImageId === null ? -1 : _atCurrentImageId;
            const isCurrentAssigned = hasAssignment && (assignedImageId === currentKey);

            const card = document.createElement('div');
            card.dataset.themeId = theme.id;
            card.style.cssText = `
                display:flex; align-items:center; gap:14px; padding:12px 14px;
                border-radius:10px; border:1px solid ${isCurrentAssigned ? '#4a90e2' : '#2e2e2e'};
                background:${isCurrentAssigned ? 'rgba(74,144,226,0.12)' : '#111'};
                cursor:pointer; transition:border-color .15s, background .15s;
                user-select:none;
            `;

            // Thumbnail of what's currently assigned to this theme
            const thumbWrap = document.createElement('div');
            thumbWrap.style.cssText = 'width:48px; height:48px; flex-shrink:0; border-radius:7px; overflow:hidden; border:1px solid #333; background:#0d0d0d; display:flex; align-items:center; justify-content:center;';
            if (hasAssignment) {
                const img = document.createElement('img');
                img.src = _thumbUrl(assignedImageId);
                img.style.cssText = 'width:100%; height:100%; object-fit:cover;';
                img.onerror = () => { img.style.display = 'none'; };
                thumbWrap.appendChild(img);
            } else {
                thumbWrap.innerHTML = '<span style="font-size:18px; color:#444;">üñº</span>';
            }

            // Theme name + active badge
            const nameWrap = document.createElement('div');
            nameWrap.style.cssText = 'flex:1; min-width:0;';
            const nameLine = document.createElement('div');
            nameLine.style.cssText = 'font-size:14px; font-weight:600; color:#e0e0e0;';
            nameLine.textContent = theme.name;
            nameWrap.appendChild(nameLine);
            if (theme.isActive) {
                const badge = document.createElement('span');
                badge.style.cssText = 'font-size:10px; font-weight:700; padding:2px 7px; border-radius:20px; background:#4a90e2; color:#fff; letter-spacing:.5px; text-transform:uppercase; margin-top:4px; display:inline-block;';
                badge.textContent = 'Active';
                nameWrap.appendChild(badge);
            }

            // Status indicator (right side)
            const status = document.createElement('div');
            status.style.cssText = 'flex-shrink:0; font-size:12px; color:' + (isCurrentAssigned ? '#6ab0ff' : '#555') + ';';
            status.textContent = isCurrentAssigned ? '‚úì Assigned' : (hasAssignment ? '‚ü≥ Replace' : '');

            card.appendChild(thumbWrap);
            card.appendChild(nameWrap);
            card.appendChild(status);

            card.addEventListener('mouseenter', () => {
                if (!isCurrentAssigned) card.style.borderColor = '#4a4a4a';
            });
            card.addEventListener('mouseleave', () => {
                if (!isCurrentAssigned) card.style.borderColor = '#2e2e2e';
            });

            card.addEventListener('click', () => _onThemeCardClick(theme.id, isCurrentAssigned));

            grid.appendChild(card);
        });
    }

    function _onThemeCardClick(themeId, isCurrentAssigned) {
        if (isCurrentAssigned) {
            // Deassign
            fetch(`/artists/${_atArtistId}/theme-assignments/${themeId}`, { method: 'DELETE' })
                .then(r => r.json())
                .then(data => {
                    if (!data.success) { showErrorToast(data.message || 'Failed'); return; }
                    delete _atAssignments[themeId];
                    _rebuildImageToThemeMap();
                    _updateThemeButtonLabel();
                    _updateSetDefaultButton();
                    _renderThemeGrid();
                    const themeName = _atThemes.find(t => t.id === themeId)?.name || 'theme';
                    showSuccessToast(`Assignment removed for "${themeName}"`);
                })
                .catch(() => showErrorToast('Network error'));
        } else {
            // Assign
            fetch(`/artists/${_atArtistId}/theme-assignments`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    themeId: themeId,
                    artistImageId: _atCurrentImageId === null ? -1 : _atCurrentImageId
                })
            })
            .then(r => r.json())
            .then(data => {
                if (!data.success) { showErrorToast(data.message || 'Assignment failed'); return; }
                // One image can only belong to one theme ‚Äî remove any prior assignment for this image
                const currentVal = _atCurrentImageId === null ? -1 : _atCurrentImageId;
                Object.keys(_atAssignments).forEach(tid => {
                    if (parseInt(tid) !== themeId && _atAssignments[tid] === currentVal) {
                        delete _atAssignments[tid];
                    }
                });
                _atAssignments[themeId] = currentVal;
                _rebuildImageToThemeMap();
                _updateThemeButtonLabel();
                _updateSetDefaultButton();
                _renderThemeGrid();
                const themeName = _atThemes.find(t => t.id === themeId)?.name || 'theme';
                showSuccessToast(data.wasReplaced ? `Image re-assigned to "${themeName}"` : `Image assigned to "${themeName}"`);
            })
            .catch(() => showErrorToast('Network error'));
        }
    }

    function _rebuildImageToThemeMap() {
        _atImageToTheme = {};
        Object.entries(_atAssignments).forEach(([themeId, imageId]) => {
            const theme = _atThemes.find(t => t.id === parseInt(themeId));
            if (theme) {
                const imageKey = (imageId === -1 || imageId === null) ? 'default' : String(imageId);
                _atImageToTheme[imageKey] = theme.name;
            }
        });
    }

    function openAssignThemeModal() {
        const imageId = (typeof galleryImages !== 'undefined' && typeof currentGalleryIndex !== 'undefined')
            ? galleryImages[currentGalleryIndex] : 0;
        _atCurrentImageId = (imageId === 0) ? null : imageId;

        _renderThemeGrid();
        document.getElementById('assignThemeModal').style.display = 'flex';
    }

    function closeAssignThemeModal() {
        document.getElementById('assignThemeModal').style.display = 'none';
    }

    // Close on backdrop click
    document.getElementById('assignThemeModal').addEventListener('click', function(e) {
        if (e.target === this) closeAssignThemeModal();
    });
    </script>
</body>
</html>
