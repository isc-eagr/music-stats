<html xmlns:th="http://www.thymeleaf.org">
<head>
	<title>Stats</title>
	<script src='https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.1/chart.js'></script>
	<script src='js/utils.js'></script>
	<link rel="stylesheet" href="https://npmcdn.com/flatpickr/dist/themes/dark.css">
	<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
	<script type="text/javascript">
		window.onload = function(){
			flatpickr("#dateStart", dateConfig);
			flatpickr("#dateEnd", dateConfig);
		}
	</script>
	
	
</head>
  <body>
  	<form th:action="@{/}">
		Start date <input type="text" th:name="start" id="dateStart"/>
		End date <input type="text" th:name="end" id="dateEnd"/> 
		<input type="submit"/> 
	</form>
  
  	<a href="/insertItunesInfo">Load Itunes (Do first)</a><br/>
  	<a href="/insertScrobbles">Load Scrobbles (Do second)</a><br/>
  	<a href="/category/ALL/ALL">General Overview</a><br/>
  	<a href="/categorySearch">Category Search</a><br/>
  	<a href="/topArtists">Top Artists</a><br/>
  	<a href="/topAlbums">Top Albums</a><br/>
  	<a href="/topSongs">Top Songs</a><br/>
  	<a href="/topGenres">Top Genres</a><br/>
  	<a href="/timeUnit?unit=day">Days</a><br/>
  	<a href="/timeUnit?unit=week">Weeks</a><br/>
  	<a href="/timeUnit?unit=month">Months</a><br/>
  	<a href="/timeUnit?unit=season">Seasons</a><br/>
  	<a href="/timeUnit?unit=year">Years</a><br/>
  	<a href="/timeUnit?unit=decade">Decades</a><br/>
  	<a href="/songsLastFmButNotLocal">Songs on lastfm but not locally</a><br/>
  	<a href="/songsLocalButNotLastfm">Songs locally but not lastfm</a><br/>
  	
	Total Songs: <span th:text="${totalSongs}"/><br/>
	Total Plays: <span th:text="${totalPlays}"/><br/>
	Total Playtime: <span th:text="${totalPlayTimeGlobalString}"/><br/>
	Average Song Length: <span th:text="${averageSongLength}"/><br/>
	Average Plays Per Song: <span th:text="${#numbers.formatDecimal(averagePlaysPerSong, 1, 'DEFAULT', 2, 'DEFAULT')}"/><br/>
	Average Plays Per Day: <span th:text="${#numbers.formatDecimal(averagePlaysPerDay, 1, 'DEFAULT', 2, 'DEFAULT')}"/><br/>
	First Played On: <span th:text="${firstPlayOn}"/><br/>
	Days Elapsed Since First Play: <span th:text="${daysElapsedSinceFirstPlay}"/><br/>
	
	
	<div th:each="dataForGraphsList : ${dataMap}" style='white-space: nowrap;'> <!--Genre, Sex, Language etc.-->
		<div th:each="dataForGraphs : ${dataForGraphsList.value}" style='display: inline-block; width: 500px; height: 500px; white-space: nowrap;'> <!--Number of songs, number of plays, playtime-->
			<canvas th:id="${'myChart'+dataForGraphsList.key+dataForGraphs.metric}" width='500px'
				height='500px'></canvas>
		
		<script th:inline="javascript">
		/*<![CDATA[*/
                var ctx = document.getElementById(/*[[${'myChart'+dataForGraphsList.key+dataForGraphs.metric}]]*/'').getContext('2d');
		
                var myChart/*[(${dataForGraphsList.key+dataForGraphs.metric})]*/ 
                = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: [ /*[(${dataForGraphs.labels})]*/ ],
                        datasets: [{
                            label: 'Male',
							data: [ /*[(${dataForGraphs.dataMale})]*/ ],
                            backgroundColor: 'rgba(55, 99, 132, 0.8)',
                            borderWidth: 1
                        },{
                            label: 'Others',
                            data: [ /*[(${dataForGraphs.dataOthers})]*/ ],
                            backgroundColor: 'rgba(255, 99, 132, 0.8)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                       scales: {
		                		x: {
		                			stacked: true
		                		},
		                		y: {
		                			stacked: true
		                		}
	                		},
                    	plugins:{
							title: {
		                       display: true,
		                       text: /*[[${dataForGraphs.metric +'By' +dataForGraphsList.key}]]*/''
	                    	},
							tooltip: {
	                            callbacks: {
	                                label: function(context) {
	                               		var totalCount =0;
	                                    var thisDatasetCount = 0;
	                                    var myChart = myChart/*[(${dataForGraphsList.key+dataForGraphs.metric})]*/;
	                       				for(var i=0; i<myChart.data.datasets.length; i++){
	                						for(var j=0; j<myChart.data.datasets[i].data.length; j++){
	                							totalCount+= myChart.data.datasets[i].data[j];
	                                            if(context.dataIndex == j){
	                       							thisDatasetCount += myChart.data.datasets[i].data[j];
	                							}//if
	                						}//for
	                					}//for
	                                    var label = context.dataset.label || '';
	 	                             	var percentageInTotal = context.raw/totalCount * 100;
			                            var percentageInTotalString = percentageInTotal.toFixed(3);
			                            var percentageOfBarInTotal = thisDatasetCount/totalCount * 100;
			                            var percentageOfBarInTotalString = percentageOfBarInTotal.toFixed(3);
			                            var percentageInDataset = context.raw/thisDatasetCount * 100;
			                       	    var percentageInDatasetString = percentageInDataset.toFixed(3);
			                       	    
			                       	  	var metric = /*[[${dataForGraphs.metric}]]*/'';
			                       	  	var metricToDisplay = metric.includes("Playtime")?"Playtime":(metric.includes("Songs")?"Songs":"Plays");
			                       	  	
			                       	  	 return metric.includes("Playtime") ? 
			                       	  			 [context.label+" "+metricToDisplay+": "+secondsToString(thisDatasetCount),
			                       	  			 	context.label+" "+metricToDisplay+" that is "+label+": " + secondsToString(context.raw),
			                       	  			 	'Percentage of '+context.label+': '+percentageOfBarInTotalString+'%',
			                       	  			 	'Percentage of '+context.label+' that is '+label+': '+percentageInDatasetString+'%']:
			                       	  			 [context.label+" "+metricToDisplay+": "+thisDatasetCount,
			                       	  			 	context.label+" "+metricToDisplay+" that are "+label +": "+ context.raw, 
			                       	  			 	"Percentage of "+context.label+" in total: "+percentageOfBarInTotalString+'%',
			                       	  			 	"Percentage of "+context.label+" that is "+label+": "+percentageInDatasetString+'%'];
	                                }//label
	                            }//callbacks
                        	}//tooltips
						}//plugins
                    }
                });
                
                var chrt = myChart/*[(${dataForGraphsList.key+dataForGraphs.metric})]*/;
                var displayText = chrt.options.plugins.title.text;
                
                chrt.options.plugins.title.text=displayText.replace(/[A-Z]/g, ' $&').trim();
                 
                if(/*[[${dataForGraphs.metric}]]*/'' 
                	==="Playtime"){
					chrt.options.scales.y.ticks.callback = function(value, index, ticks) {
					                        return secondsToDays(value)+' days';
					                    };
					                 
				}
				myChart/*[(${dataForGraphsList.key+dataForGraphs.metric})]*/
					.update(); 
                /*]]>*/
                </script>
                </div>

	</div>
	
	<div>
	<canvas th:id="${'plays'}"></canvas>
		
		<script th:inline="javascript">
		/*<![CDATA[*/
                var ctx = document.getElementById('plays').getContext('2d');
                var myChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: [ /*[(${chartLabels})]*/ ],
                        datasets: [{
                            label: 'Plays',
							data: [ /*[(${chartValues})]*/ ],
                            fill: false,
                            borderColor: 'rgb(75, 192, 192)',
                            pointBackgroundColor: 'rgb(212, 25, 66)',
                            pointStyle: 'rect'
                        }]
                    },
                    options:{
						responsive:true
					}
                });

				myChart.update(); 
                /*]]>*/
                </script>
	</div>
	
</body>

</html>