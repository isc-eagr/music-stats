<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weekly Charts - Music Stats</title>
    <link rel="stylesheet" th:href="@{/css/global.css}">
    <!-- Flatpickr Date Picker -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <th:block th:replace="~{fragments/navigation :: nav-styles}"></th:block>
    <style>
        .charts-page {
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .charts-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .charts-title {
            font-size: 1.8rem;
            color: #fff;
            margin: 0 0 10px 0;
        }
        
        .charts-period {
            font-size: 1.2rem;
            color: #aaa;
        }
        
        .charts-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .charts-nav-center {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .date-picker-input {
            background: #1a1a1a;
            border: 1px solid #333;
            color: #fff;
            padding: 10px 14px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        
        .date-picker-input:hover {
            border-color: #444;
        }
        
        .nav-btn {
            background: #1a1a1a;
            border: 1px solid #333;
            color: #fff;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s ease;
        }
        
        .nav-btn:hover:not(.disabled) {
            background: #2a2a2a;
            border-color: #444;
        }
        
        .nav-btn.disabled {
            opacity: 0.3;
            cursor: not-allowed;
            pointer-events: none;
        }
        
        /* Chart type toggle buttons */
        .chart-type-toggle {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-bottom: 30px;
        }
        
        .chart-toggle-btn {
            background: #1a1a1a;
            border: 1px solid #333;
            color: #888;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.2s ease;
        }
        
        .chart-toggle-btn:hover {
            background: #2a2a2a;
            border-color: #444;
            color: #fff;
        }
        
        .chart-toggle-btn.active {
            background: #2d5016;
            border-color: #3d6b1e;
            color: #fff;
        }
        
        .number-one-section {
            display: flex;
            justify-content: center;
            gap: 40px;
            margin-bottom: 30px;
        }
        
        .number-one-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }
        
        .number-one-label {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.85rem;
            color: #888;
        }
        
        .number-one-image {
            width: 200px;
            height: 200px;
            border-radius: 12px;
            object-fit: cover;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        }
        
        .number-one-hover-container {
            position: relative;
            width: 200px;
            height: 200px;
        }

        .number-one-hover-container .album-image-default {
            position: absolute;
            top: 0;
            left: 0;
            opacity: 1;
            transition: opacity 0.2s ease;
            z-index: 2;
        }

        .number-one-hover-container .song-image-hover {
            position: absolute;
            top: 0;
            left: 0;
            opacity: 0;
            transition: opacity 0.2s ease;
            z-index: 1;
        }

        .number-one-hover-container:hover .album-image-default {
            opacity: 0;
        }

        .number-one-hover-container:hover .song-image-hover {
            opacity: 1;
        }

        .number-one-placeholder {
            width: 200px;
            height: 200px;
            border-radius: 12px;
            background: #1a1a1a;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 4rem;
            color: #444;
        }
        
        /* Section headers for Songs/Albums */
        .chart-section {
            margin-bottom: 40px;
        }
        
        .chart-section-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid #2a2a2a;
        }
        
        .chart-section-icon {
            font-size: 1.5rem;
        }
        
        .chart-section-title {
            font-size: 1.3rem;
            font-weight: 600;
            flex: 1;
            color: #fff;
            margin: 0;
        }
        
        .charts-table-container {
            background: #0a0a0a;
            border-radius: 12px;
            border: 1px solid #2a2a2a;
            overflow: hidden;
        }
        
        /* Chart table links */
        .chart-link {
            text-decoration: none;
            transition: color 0.2s ease;
        }
        
        .chart-link:hover {
            text-decoration: underline;
        }
        
        .chart-link-primary {
            color: #fff;
        }
        
        .chart-link-primary:hover {
            color: #22c55e;
        }
        
        .chart-link-secondary {
            color: #aaa;
        }
        
        .chart-link-secondary:hover {
            color: #fff;
        }
        
        .charts-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .charts-table th,
        .charts-table td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid #1a1a1a;
        }
        
        .charts-table th {
            background: #111;
            color: #888;
            font-weight: 600;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .charts-table tbody tr:hover {
            background: #151515;
        }
        
        .charts-table tbody tr:last-child td {
            border-bottom: none;
        }
        
        /* Column widths */
        .col-expand { width: 40px; text-align: center; }
        .col-position { width: 80px; text-align: center; }
        .col-image { width: 50px; text-align: center; }
        .col-title { min-width: 200px; }
        .col-artist { min-width: 150px; }
        .col-plays { width: 100px; text-align: right; }
        .col-peak { width: 80px; text-align: center; }
        .col-weeks { width: 80px; text-align: center; }
        
        /* Table entry images */
        .chart-entry-image {
            width: 40px;
            height: 40px;
            border-radius: 4px;
            object-fit: cover;
            background: #222;
        }

        .chart-entry-image-container {
            position: relative;
            width: 40px;
            height: 40px;
        }

        .chart-entry-image-container .album-image-default {
            position: absolute;
            top: 0;
            left: 0;
            opacity: 1;
            transition: opacity 0.2s ease;
            z-index: 2;
        }

        .chart-entry-image-container .song-image-hover {
            position: absolute;
            top: 0;
            left: 0;
            opacity: 0;
            transition: opacity 0.2s ease;
            z-index: 1;
        }

        .chart-entry-image-container:hover .album-image-default {
            opacity: 0;
        }

        .chart-entry-image-container:hover .song-image-hover {
            opacity: 1;
        }

        .chart-entry-placeholder {
            width: 40px;
            height: 40px;
            border-radius: 4px;
            background: #222;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #444;
            font-size: 1rem;
        }

        /* Position cell */
        .position-cell {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .position-number {
            font-size: 1.5rem;
            font-weight: bold;
            color: #fff;
        }
        
        .position-lw {
            font-size: 0.75rem;
            color: #666;
        }
        
        .position-lw.new-entry { color: #4ade80; }
        .position-lw.re-entry { color: #fbbf24; }
        
        /* Change indicator */
        .change-indicator {
            display: inline-block;
            margin-right: 4px;
        }
        
        .position-up { color: #4ade80; }
        .position-down { color: #f87171; }
        .position-same { color: #888; }
        
        /* Plays cell */
        .plays-cell {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }
        
        .plays-count {
            font-size: 1.1rem;
            font-weight: 600;
            color: #fff;
        }
        
        .plays-lw {
            font-size: 0.75rem;
            color: #666;
        }
        
        /* Peak cell */
        .peak-cell {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .peak-position {
            font-size: 1.1rem;
            font-weight: bold;
            color: #e5e7eb;
        }
        
        .peak-position.peak-number-one {
            color: #fbbf24;
            text-shadow: 0 0 10px rgba(251, 191, 36, 0.6), 0 0 20px rgba(251, 191, 36, 0.4);
        }
        
        .peak-times {
            font-size: 0.75rem;
            color: #666;
        }
        
        /* Expand button */
        .expand-btn {
            background: #222;
            border: 1px solid #333;
            color: #888;
            width: 28px;
            height: 28px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.2s ease;
        }
        
        .expand-btn:hover {
            background: #333;
            color: #fff;
        }
        
        .expand-btn.expanded {
            background: #2d5016;
            border-color: #3d6b1e;
            color: #fff;
        }
        
        /* Chart run detail row */
        .chart-run-row {
            display: none;
        }
        
        .chart-run-row.visible {
            display: table-row;
        }
        
        .chart-run-cell {
            background: #0f0f0f;
            padding: 20px !important;
        }
        
        .chart-run-header {
            font-size: 1rem;
            color: #fff;
            margin-bottom: 15px;
        }
        
        .chart-run-header a {
            color: #22c55e;
            text-decoration: none;
        }
        
        .chart-run-header a:hover {
            text-decoration: underline;
        }
        
        .chart-run-boxes {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-bottom: 15px;
            max-width: 100%;
            overflow-x: auto;
        }
        
        .chart-run-box {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: 600;
            border-radius: 4px;
            background: #1a1a1a;
            color: #888;
            border: 1px solid #333;
            text-decoration: none;
            cursor: pointer;
        }
        
        .chart-run-box:hover {
            text-decoration: none;
        }
        
        .chart-run-box.on-chart {
            background: #1a1a2e;
            color: #e5e7eb;
            border-color: #333;
        }
        
        .chart-run-box.on-chart.peak-one {
            background: #3d3012;
            color: #fbbf24;
            border-color: #6b5c1f;
            box-shadow: 0 0 8px rgba(251, 191, 36, 0.3);
        }
        
        .chart-run-box.current {
            background: #2d5016;
            color: #fff;
            border-color: #22c55e;
        }
        
        .chart-run-box.absent {
            color: #555;
        }
        
        .chart-run-box.absent.consolidated {
            background: #2a2a2a;
            color: #888;
            font-size: 11px;
            padding: 4px 8px;
            cursor: default;
        }
        
        .chart-run-stats {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }
        
        .chart-run-stat {
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            border-radius: 8px;
            padding: 12px 16px;
            text-align: center;
        }
        
        .chart-run-stat-label {
            font-size: 0.75rem;
            color: #888;
            margin-bottom: 4px;
        }
        
        .chart-run-stat-value {
            font-size: 1.2rem;
            font-weight: bold;
            color: #fff;
        }
        
        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
        }
        
        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 20px;
        }
        
        .empty-state-title {
            font-size: 1.5rem;
            color: #fff;
            margin-bottom: 10px;
        }
        
        .empty-state-text {
            color: #888;
            margin-bottom: 20px;
        }
        
        .generate-all-btn {
            background: #2d5016;
            color: #fff;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .generate-all-btn:hover {
            background: #3d6b1e;
        }        /* Progress modal */
        .progress-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .progress-modal.visible {
            display: flex;
        }
        
        .progress-modal-content {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 12px;
            padding: 30px;
            width: 400px;
            text-align: center;
        }
        
        .progress-modal-title {
            font-size: 1.2rem;
            color: #fff;
            margin-bottom: 20px;
        }
        
        .progress-bar-container {
            background: #0a0a0a;
            border-radius: 8px;
            height: 24px;
            overflow: hidden;
            margin-bottom: 15px;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #2d5016, #22c55e);
            transition: width 0.3s ease;
            border-radius: 8px;
        }
        
        .progress-text {
            color: #888;
            font-size: 0.9rem;
        }
        
        .progress-current-week {
            color: #22c55e;
            font-weight: 600;
        }
        
        /* Action buttons row */
        .charts-actions {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 20px;
            gap: 10px;
        }
        
        .action-btn {
            background: #1a1a1a;
            border: 1px solid #333;
            color: #fff;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s ease;
        }
        
        .action-btn:hover {
            background: #2a2a2a;
            border-color: #444;
        }
        
        .action-btn.primary {
            background: #2d5016;
            border-color: #3d6b1e;
        }

        .action-btn.primary:hover {
            background: #3d6b1e;
        }
        
        .chart-playlist-btn {
            padding: 8px 16px;
            background: #2d5016;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s ease;
            margin-left: auto;
        }
        
        .chart-playlist-btn:hover {
            background: #3d6b1e;
        }

        /* Gender percentage badge styling */
        .gender-pct {
            color: #3b82f6; /* lighter blue */
            font-weight: 600;
            font-size: 0.95rem;
            margin-left: 12px;
            transition: text-shadow 0.2s ease, color 0.2s ease;
            text-shadow: 0 0 6px rgba(59,130,246,0.45), 0 0 12px rgba(59,130,246,0.25);
        }

        .gender-pct--full {
            /* shimmer the text itself using a moving gradient */
            color: transparent;
            background-image: linear-gradient(110deg, rgba(59,130,246,0.95) 20%, rgba(255,255,255,0.95) 45%, rgba(59,130,246,0.95) 75%);
            background-size: 200% 100%;
            -webkit-background-clip: text;
            background-clip: text;
            animation: metallicShine 2.6s ease-in-out infinite;
            text-shadow: 0 0 10px rgba(59,130,246,0.5);
        }

        @keyframes metallicShine {
            0% { background-position: -200% center; }
            100% { background-position: 200% center; }
        }

        .gender-pct {
            position: relative;
            display: inline-block;
            z-index: 2;
        }

        /* removed ::before overlay; shimmer applied directly to text via background-clip */
    </style>
</head>
<body>
    <th:block th:replace="~{fragments/navigation :: navigation}"></th:block>
    
    <div class="charts-page">
        <!-- Empty state when no chart exists -->
        <div th:if="${!hasChart}" class="empty-state">
            <div class="empty-state-icon">üìä</div>
            <h2 class="empty-state-title">No Charts Generated Yet</h2>
            <p class="empty-state-text" th:if="${missingWeeksCount > 0}">
                There are <span th:text="${missingWeeksCount}">0</span> weeks with scrobble data that don't have charts.
            </p>
            <p class="empty-state-text" th:if="${missingWeeksCount == 0}">
                No scrobble data available to generate charts.
            </p>
            <button th:if="${missingWeeksCount > 0}" class="generate-all-btn" onclick="startBulkGeneration()">
                Generate All Missing Charts
            </button>
        </div>
        
        <!-- Chart display when chart exists -->
        <div th:if="${hasChart}">
            <!-- Header -->
            <div class="charts-header">
                <h1 class="charts-title">Weekly Charts</h1>
                <div class="charts-period" th:text="${formattedPeriod}">Nov 16 - Nov 22, 2025</div>
            </div>

            <!-- Navigation -->
            <div class="charts-nav">
                <a th:if="${prevPeriodKey != null}" 
                   th:href="@{/charts/weekly/{pk}(pk=${prevPeriodKey})}" 
                   class="nav-btn">
                    ‚Üê Previous
                </a>
                <span th:if="${prevPeriodKey == null}" class="nav-btn disabled">‚Üê Previous</span>

                <div class="charts-nav-center">
                    <input type="text"
                           id="chartDatePicker"
                           class="date-picker-input"
                           placeholder="dd/mm/yyyy"
                           title="Jump to a specific week">
                </div>

                <a th:if="${nextPeriodKey != null}" 
                   th:href="@{/charts/weekly/{pk}(pk=${nextPeriodKey})}" 
                   class="nav-btn">
                    Next ‚Üí
                </a>
                <span th:if="${nextPeriodKey == null}" class="nav-btn disabled">Next ‚Üí</span>
            </div>
            
            <!-- Chart type toggle buttons -->
            <div class="chart-type-toggle">
                <button id="songsToggle" class="chart-toggle-btn active" onclick="showSongsChart()">
                    üéµ Songs Chart
                </button>
                <button id="albumsToggle" class="chart-toggle-btn" onclick="showAlbumsChart()">
                    üíø Albums Chart
                </button>
            </div>
            
            <!-- Actions -->
            <div class="charts-actions" th:if="${missingWeeksCount > 0}">
                <button class="action-btn primary" onclick="startBulkGeneration()">
                    Generate <span th:text="${missingWeeksCount}">0</span> Missing Charts
                </button>
            </div>
            
            <!-- Top 20 Songs Section -->
            <div id="songsSection" class="chart-section">
                <!-- #1 Song Image -->
                <div class="number-one-section" th:if="${numberOneSong != null}">
                    <div class="number-one-card">
                        <div class="number-one-label">üéµ #1 Song</div>
                        <!-- Case 1: Song has image AND album has image - show album by default, song on hover -->
                        <div th:if="${numberOneSong.hasImage and numberOneSong.albumHasImage and numberOneSong.albumId != null}" class="hover-image-container number-one-hover-container">
                            <img th:src="@{/albums/{id}/image(id=${numberOneSong.albumId})}"
                                 alt="Number 1 Song"
                                 class="album-image-default number-one-image">
                            <img th:src="@{/songs/{id}/image(id=${numberOneSong.songId})}"
                                 alt="Number 1 Song"
                                 class="song-image-hover number-one-image">
                        </div>
                        <!-- Case 2: Song has image but album doesn't - just show song image -->
                        <img th:if="${numberOneSong.hasImage and (!numberOneSong.albumHasImage or numberOneSong.albumId == null)}"
                             th:src="@{/songs/{id}/image(id=${numberOneSong.songId})}"
                             alt="Number 1 Song"
                             class="number-one-image">
                        <!-- Case 3: Song doesn't have image but album does - show album image -->
                        <img th:if="${!numberOneSong.hasImage and numberOneSong.albumHasImage and numberOneSong.albumId != null}"
                             th:src="@{/albums/{id}/image(id=${numberOneSong.albumId})}"
                             alt="Number 1 Song"
                             class="number-one-image inherited-cover">
                        <!-- Case 4: No image available -->
                        <div th:if="${!numberOneSong.hasImage and (!numberOneSong.albumHasImage or numberOneSong.albumId == null)}" class="number-one-placeholder">üéµ</div>
                    </div>
                </div>
                
                <div class="chart-section-header">
                    <span class="chart-section-icon">üéµ</span>
                    <h2 class="chart-section-title">Top 20 Songs</h2>
                    <div id="songsGenderPct" class="gender-pct"></div>
                    <button type="button" class="chart-playlist-btn" onclick="openWeeklySongsPlaylistGenerator()">üéµ Generate Playlist</button>
                </div>
                <div class="charts-table-container">
                    <table class="charts-table">
                        <thead>
                            <tr>
                                <th class="col-expand"></th>
                                <th class="col-position">Position</th>
                                <th class="col-image"></th>
                                <th class="col-title">Title</th>
                                <th class="col-artist">Artist</th>
                                <th class="col-plays">Plays</th>
                                <th class="col-peak">Peak</th>
                            <th class="col-weeks">Weeks</th>
                        </tr>
                    </thead>
                    <tbody>
                        <th:block th:each="entry : ${entries}">
                            <!-- Main row -->
                            <tr th:data-song-id="${entry.songId}" th:data-album="${entry.albumName}"
                                th:attr="data-gender=${entry.genderId}"
                                th:style="${entry.genderId == 1} ? 'background: rgba(236, 72, 153, 0.15); border-left: 3px solid rgba(236, 72, 153, 0.6);' : (${entry.genderId == 2} ? 'background: rgba(59, 130, 246, 0.15); border-left: 3px solid rgba(59, 130, 246, 0.6);' : '')">
                                <td class="col-expand">
                                    <button class="expand-btn"
                                            th:data-song-id="${entry.songId}"
                                            onclick="toggleChartRun(this)">+</button>
                                </td>
                                <td class="col-position">
                                    <div class="position-cell">
                                        <span class="position-number" th:text="${entry.position}">1</span>
                                        <span class="position-lw" th:classappend="${entry.positionChangeClass}">
                                            <span class="change-indicator" th:if="${entry.positionChange != null}">
                                                <span th:if="${entry.positionChange > 0}">‚Üë</span>
                                                <span th:if="${entry.positionChange < 0}">‚Üì</span>
                                                <span th:if="${entry.positionChange == 0}">=</span>
                                            </span>
                                            <span th:text="'LW: ' + ${entry.lastWeekDisplay}">LW: 3</span>
                                        </span>
                                    </div>
                                </td>
                                <td class="col-image">
                                    <!-- Case 1: Song has single_cover AND album has image - show album by default, song on hover -->
                                    <div th:if="${entry.hasImage and entry.albumHasImage and entry.albumId != null}" class="chart-entry-image-container">
                                        <img class="chart-entry-image album-image-default" th:src="@{/albums/{id}/image(id=${entry.albumId})}" alt="">
                                        <img class="chart-entry-image song-image-hover" th:src="@{/songs/{id}/image(id=${entry.songId})}" alt="">
                                    </div>
                                    <!-- Case 2: Song has single_cover but album doesn't - just show song image -->
                                    <img th:if="${entry.hasImage and (!entry.albumHasImage or entry.albumId == null)}"
                                         class="chart-entry-image" th:src="@{/songs/{id}/image(id=${entry.songId})}" alt="">
                                    <!-- Case 3: Song doesn't have single_cover but album does - show album image -->
                                    <img th:if="${!entry.hasImage and entry.albumHasImage and entry.albumId != null}"
                                         class="chart-entry-image" th:src="@{/albums/{id}/image(id=${entry.albumId})}" alt="">
                                    <!-- Case 4: No image available -->
                                    <div th:if="${!entry.hasImage and (!entry.albumHasImage or entry.albumId == null)}" class="chart-entry-placeholder">üéµ</div>
                                </td>
                                <td class="col-title">
                                    <a th:href="@{/songs/{id}(id=${entry.songId})}"
                                       class="chart-link chart-link-primary"
                                       th:text="${entry.songName}">Song Name</a>
                                </td>
                                <td class="col-artist">
                                    <a th:href="@{/artists/{id}(id=${entry.artistId})}"
                                       class="chart-link chart-link-secondary"
                                       th:text="${entry.artistName}">Artist Name</a>
                                </td>
                                <td class="col-plays">
                                    <div class="plays-cell">
                                        <span class="plays-count" th:text="${entry.playCount}">10</span>
                                        <span class="plays-lw" th:if="${entry.lastWeekPlayCount != null}"
                                              th:text="'LW: ' + ${entry.lastWeekPlayCount}">LW: 8</span>
                                    </div>
                                </td>
                                <td class="col-peak">
                                    <div class="peak-cell">
                                        <span class="peak-position" th:classappend="${entry.peakPosition == 1 ? 'peak-number-one' : ''}" th:text="${entry.peakPosition}">1</span>
                                        <span class="peak-times" th:text="${entry.timesAtPeak} + 'x'">1x</span>
                                    </div>
                                </td>
                                <td class="col-weeks" th:text="${entry.weeksOnChart}">5</td>
                            </tr>
                            <!-- Chart run detail row (hidden by default) -->
                            <tr class="chart-run-row" th:data-song-id="${entry.songId}">
                                <td colspan="8" class="chart-run-cell">
                                    <div class="chart-run-content" th:id="'chart-run-' + ${entry.songId}">
                                        <!-- Content loaded via AJAX -->
                                        <div style="text-align: center; color: #888;">Loading chart run...</div>
                                    </div>
                                </td>
                            </tr>
                        </th:block>
                    </tbody>
                </table>
            </div>
            </div>

            <!-- Top 10 Albums Section -->
            <div id="albumsSection" class="chart-section" style="display: none;" th:if="${albumEntries != null && !albumEntries.isEmpty()}">
                <!-- #1 Album Image -->
                <div class="number-one-section" th:if="${numberOneAlbum != null}">
                    <div class="number-one-card">
                        <div class="number-one-label">üíø #1 Album</div>
                        <img th:if="${numberOneAlbum.hasImage}" 
                             th:src="@{/albums/{id}/image(id=${numberOneAlbum.albumId})}" 
                             alt="Number 1 Album"
                             class="number-one-image">
                        <div th:unless="${numberOneAlbum.hasImage}" class="number-one-placeholder">üíø</div>
                    </div>
                </div>
                
                <div class="chart-section-header">
                    <span class="chart-section-icon">üíø</span>
                    <h2 class="chart-section-title">Top 10 Albums</h2>
                    <div id="albumsGenderPct" class="gender-pct"></div>
                </div>
                <div class="charts-table-container">
                    <table class="charts-table">
                        <thead>
                            <tr>
                                <th class="col-expand"></th>
                                <th class="col-position">Position</th>
                                <th class="col-image"></th>
                                <th class="col-title">Album</th>
                                <th class="col-artist">Artist</th>
                                <th class="col-plays">Plays</th>
                                <th class="col-peak">Peak</th>
                                <th class="col-weeks">Weeks</th>
                            </tr>
                        </thead>
                        <tbody>
                            <th:block th:each="entry : ${albumEntries}">
                                <!-- Main row -->
                                <tr th:data-album-id="${entry.albumId}"
                                    th:attr="data-gender=${entry.genderId}"
                                    th:style="${entry.genderId == 1} ? 'background: rgba(236, 72, 153, 0.15); border-left: 3px solid rgba(236, 72, 153, 0.6);' : (${entry.genderId == 2} ? 'background: rgba(59, 130, 246, 0.15); border-left: 3px solid rgba(59, 130, 246, 0.6);' : '')">
                                    <td class="col-expand">
                                        <button class="expand-btn"
                                                th:data-album-id="${entry.albumId}"
                                                onclick="toggleAlbumChartRun(this)">+</button>
                                    </td>
                                    <td class="col-position">
                                        <div class="position-cell">
                                            <span class="position-number" th:text="${entry.position}">1</span>
                                            <span class="position-lw" th:classappend="${entry.positionChangeClass}">
                                                <span class="change-indicator" th:if="${entry.positionChange != null}">
                                                    <span th:if="${entry.positionChange > 0}">‚Üë</span>
                                                    <span th:if="${entry.positionChange < 0}">‚Üì</span>
                                                    <span th:if="${entry.positionChange == 0}">=</span>
                                                </span>
                                                <span th:text="'LW: ' + ${entry.lastWeekDisplay}">LW: 3</span>
                                            </span>
                                        </div>
                                    </td>
                                    <td class="col-image">
                                        <img th:if="${entry.hasImage}" class="chart-entry-image" th:src="@{/albums/{id}/image(id=${entry.albumId})}" alt="">
                                        <div th:unless="${entry.hasImage}" class="chart-entry-placeholder">üíø</div>
                                    </td>
                                    <td class="col-title">
                                        <a th:href="@{/albums/{id}(id=${entry.albumId})}"
                                           class="chart-link chart-link-primary"
                                           th:text="${entry.albumName}">Album Name</a>
                                    </td>
                                    <td class="col-artist">
                                        <a th:href="@{/artists/{id}(id=${entry.artistId})}"
                                           class="chart-link chart-link-secondary"
                                           th:text="${entry.artistName}">Artist Name</a>
                                    </td>
                                    <td class="col-plays">
                                        <div class="plays-cell">
                                            <span class="plays-count" th:text="${entry.playCount}">10</span>
                                            <span class="plays-lw" th:if="${entry.lastWeekPlayCount != null}"
                                                  th:text="'LW: ' + ${entry.lastWeekPlayCount}">LW: 8</span>
                                        </div>
                                    </td>
                                    <td class="col-peak">
                                        <div class="peak-cell">
                                            <span class="peak-position" th:classappend="${entry.peakPosition == 1 ? 'peak-number-one' : ''}" th:text="${entry.peakPosition}">1</span>
                                            <span class="peak-times" th:text="${entry.timesAtPeak} + 'x'">1x</span>
                                        </div>
                                    </td>
                                    <td class="col-weeks" th:text="${entry.weeksOnChart}">5</td>
                                </tr>
                                <!-- Chart run detail row (hidden by default) -->
                                <tr class="chart-run-row album-chart-run-row" th:data-album-id="${entry.albumId}">
                                    <td colspan="8" class="chart-run-cell">
                                        <div class="chart-run-content" th:id="'album-chart-run-' + ${entry.albumId}">
                                            <!-- Content loaded via AJAX -->
                                            <div style="text-align: center; color: #888;">Loading chart run...</div>
                                        </div>
                                    </td>
                                </tr>
                            </th:block>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Actions Section (only for finalized charts) -->
    <div th:if="${hasChart and isPreview != true}" class="admin-actions-section" style="margin-top: 40px; padding: 20px; background: #111; border-radius: 12px; border: 1px solid #2a2a2a;">
        <h3 style="color: #888; font-size: 14px; margin-bottom: 16px; text-transform: uppercase; letter-spacing: 1px;">‚öôÔ∏è Admin Actions</h3>
        <div style="display: flex; gap: 16px; flex-wrap: wrap; align-items: center;">
            <button th:if="${missingWeeksCount > 0}" class="action-btn" onclick="startBulkGeneration()" style="background: #1e3a5f; border: 1px solid #2d5a8a; color: #7bb3e0;">
                üìä Generate <span th:text="${missingWeeksCount}">0</span> Missing Charts
            </button>
            <button class="action-btn danger-btn" onclick="confirmRegenerateAll()" style="background: #3b1f1f; border: 1px solid #5c2d2d; color: #e07b7b;">
                üîÑ Regenerate ALL Charts
            </button>
        </div>
    </div>

    <!-- Progress Modal -->
    <div class="progress-modal" id="progressModal">
        <div class="progress-modal-content">
            <h3 class="progress-modal-title" id="progressModalTitle">Generating Charts</h3>
            <div class="progress-bar-container">
                <div class="progress-bar" id="progressBar" style="width: 0%"></div>
            </div>
            <div class="progress-text">
                <span id="progressCount">0</span> of <span id="progressTotal">0</span> weeks completed
            </div>
            <div class="progress-text" style="margin-top: 8px;">
                Processing: <span class="progress-current-week" id="progressCurrentWeek">-</span>
            </div>
            <button id="closeModalBtn" class="action-btn" style="display: none; margin-top: 20px;" onclick="closeModalAndReload()">
                Close & Refresh
            </button>
        </div>
    </div>

    <!-- Confirmation Modal for Regenerating All Charts -->
    <div class="confirm-modal" id="confirmRegenerateModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.85); z-index: 1000; justify-content: center; align-items: center;">
        <div style="background: #1a1a1a; border: 1px solid #333; border-radius: 12px; padding: 32px; max-width: 500px; text-align: center;">
            <div style="font-size: 48px; margin-bottom: 16px;">‚ö†Ô∏è</div>
            <h3 style="color: #f87171; font-size: 24px; margin-bottom: 16px;">Regenerate ALL Charts?</h3>
            <p style="color: #999; margin-bottom: 8px;">This will <strong style="color: #f87171;">DELETE</strong> all existing weekly chart data and regenerate it from scratch.</p>
            <p style="color: #999; margin-bottom: 16px;">Total charts to regenerate: <strong id="regenerateCount" style="color: #fff;">-</strong></p>
            <p style="color: #f59e0b; font-size: 14px; margin-bottom: 24px;">‚ö†Ô∏è This action cannot be undone!</p>

            <div id="firstConfirmSection" style="margin-bottom: 20px;">
                <p style="color: #fff; margin-bottom: 12px;">Type <strong style="color: #f87171;">REGENERATE</strong> to confirm:</p>
                <input type="text" id="confirmInput" placeholder="Type REGENERATE"
                       style="width: 200px; padding: 10px; background: #111; border: 1px solid #333; color: #fff; border-radius: 6px; text-align: center; font-size: 16px;">
            </div>

            <div style="display: flex; gap: 16px; justify-content: center;">
                <button onclick="hideRegenerateModal()" style="background: #333; border: none; color: #fff; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-size: 16px;">
                    Cancel
                </button>
                <button id="finalConfirmBtn" onclick="finalConfirmRegenerate()"
                        style="background: #5c2d2d; border: none; color: #e07b7b; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-size: 16px; opacity: 0.5;" disabled>
                    üîÑ Regenerate All
                </button>
            </div>
        </div>
    </div>

    <script th:inline="javascript">
        /*<![CDATA[*/
        const currentPeriodKey = /*[[${periodKey}]]*/ null;
        
        // Chart type toggle functions
        function showSongsChart() {
            document.getElementById('songsSection').style.display = 'block';
            document.getElementById('albumsSection').style.display = 'none';
            document.getElementById('songsToggle').classList.add('active');
            document.getElementById('albumsToggle').classList.remove('active');
        }
        
        function showAlbumsChart() {
            document.getElementById('songsSection').style.display = 'none';
            document.getElementById('albumsSection').style.display = 'block';
            document.getElementById('songsToggle').classList.remove('active');
            document.getElementById('albumsToggle').classList.add('active');
        }
        
        // Navigate to a specific date's chart
        function navigateToDate(dateStr) {
            if (dateStr) {
                window.location.href = `/charts/weekly/by-date?date=${dateStr}`;
            }
        }
        
        // Cache for chart run data
        const chartRunCache = {};
        
        // Toggle chart run detail row
        async function toggleChartRun(button) {
            const songId = button.getAttribute('data-song-id');
            const detailRow = document.querySelector(`.chart-run-row[data-song-id="${songId}"]`);
            
            if (detailRow.classList.contains('visible')) {
                detailRow.classList.remove('visible');
                button.classList.remove('expanded');
                button.textContent = '+';
            } else {
                // Load data if not cached
                if (!chartRunCache[songId]) {
                    await loadChartRun(songId);
                }
                detailRow.classList.add('visible');
                button.classList.add('expanded');
                button.textContent = '‚àí';
            }
        }
        
        // Load chart run data via AJAX
        async function loadChartRun(songId) {
            try {
                const response = await fetch(`/charts/weekly/${currentPeriodKey}/song/${songId}/run`);
                if (!response.ok) throw new Error('Failed to load chart run');
                
                const data = await response.json();
                chartRunCache[songId] = data;
                
                // Render the chart run content
                const container = document.getElementById(`chart-run-${songId}`);
                container.innerHTML = renderChartRun(data);
            } catch (error) {
                console.error('Error loading chart run:', error);
                const container = document.getElementById(`chart-run-${songId}`);
                container.innerHTML = '<div style="color: #f87171;">Failed to load chart run data</div>';
            }
        }
        
        // Helper to consolidate consecutive absent weeks into a single box
        function consolidateAbsentWeeks(weeks, currentPeriodKey) {
            const result = [];
            let i = 0;
            while (i < weeks.length) {
                if (weeks[i].onChart) {
                    result.push(weeks[i]);
                    i++;
                } else {
                    // Count consecutive absent weeks
                    let count = 0;
                    let startIdx = i;
                    let hasCurrent = false;
                    while (i < weeks.length && !weeks[i].onChart) {
                        if (weeks[i].current) hasCurrent = true;
                        count++;
                        i++;
                    }
                    // Create a consolidated absent entry
                    result.push({
                        onChart: false,
                        consolidated: true,
                        count: count,
                        periodKey: weeks[startIdx].periodKey,
                        current: hasCurrent
                    });
                }
            }
            return result;
        }
        
        // Render chart run HTML
        function renderChartRun(data) {
            const consolidatedWeeks = consolidateAbsentWeeks(data.weeks, currentPeriodKey);
            let boxesHtml = consolidatedWeeks.map(week => {
                let classes = 'chart-run-box';
                if (week.onChart) {
                    classes += ' on-chart';
                    if (week.position === 1) classes += ' peak-one';
                    if (week.current) classes += ' current';
                    const tooltip = week.dateRange || week.periodKey;
                    return `<a href="/charts/weekly/${week.periodKey}" class="${classes}" title="${tooltip}">${week.display}</a>`;
                } else {
                    classes += ' absent consolidated';
                    if (week.current) classes += ' current';
                    return `<span class="${classes}" title="${week.count} weeks off chart">${week.count}√ó</span>`;
                }
            }).join('');
            
            return `
                <div class="chart-run-header">
                    Chart-run: <a href="/songs/${data.songId}">${data.songName}</a> by ${data.artistName}
                </div>
                <div class="chart-run-boxes">
                    ${boxesHtml}
                </div>
                <div class="chart-run-stats">
                    <div class="chart-run-stat">
                        <div class="chart-run-stat-label">Top 1</div>
                        <div class="chart-run-stat-value">${data.weeksAtTop1}</div>
                    </div>
                    <div class="chart-run-stat">
                        <div class="chart-run-stat-label">Top 5</div>
                        <div class="chart-run-stat-value">${data.weeksAtTop5}</div>
                    </div>
                    <div class="chart-run-stat">
                        <div class="chart-run-stat-label">Top 10</div>
                        <div class="chart-run-stat-value">${data.weeksAtTop10}</div>
                    </div>
                    <div class="chart-run-stat">
                        <div class="chart-run-stat-label">Top 20</div>
                        <div class="chart-run-stat-value">${data.weeksAtTop20}</div>
                    </div>
                </div>
            `;
        }
        
        // Cache for album chart run data
        const albumChartRunCache = {};
        
        // Toggle album chart run detail row
        async function toggleAlbumChartRun(button) {
            const albumId = button.getAttribute('data-album-id');
            const detailRow = document.querySelector(`.album-chart-run-row[data-album-id="${albumId}"]`);
            
            if (detailRow.classList.contains('visible')) {
                detailRow.classList.remove('visible');
                button.classList.remove('expanded');
                button.textContent = '+';
            } else {
                // Load data if not cached
                if (!albumChartRunCache[albumId]) {
                    await loadAlbumChartRun(albumId);
                }
                detailRow.classList.add('visible');
                button.classList.add('expanded');
                button.textContent = '‚àí';
            }
        }
        
        // Load album chart run data via AJAX
        async function loadAlbumChartRun(albumId) {
            try {
                const response = await fetch(`/charts/weekly/${currentPeriodKey}/album/${albumId}/run`);
                if (!response.ok) throw new Error('Failed to load chart run');
                
                const data = await response.json();
                albumChartRunCache[albumId] = data;
                
                // Render the chart run content
                const container = document.getElementById(`album-chart-run-${albumId}`);
                container.innerHTML = renderAlbumChartRun(data);
            } catch (error) {
                console.error('Error loading album chart run:', error);
                const container = document.getElementById(`album-chart-run-${albumId}`);
                container.innerHTML = '<div style="color: #f87171;">Failed to load chart run data</div>';
            }
        }
        
        // Render album chart run HTML
        function renderAlbumChartRun(data) {
            const consolidatedWeeks = consolidateAbsentWeeks(data.weeks, currentPeriodKey);
            let boxesHtml = consolidatedWeeks.map(week => {
                let classes = 'chart-run-box';
                if (week.onChart) {
                    classes += ' on-chart';
                    if (week.position === 1) classes += ' peak-one';
                    if (week.current) classes += ' current';
                    const tooltip = week.dateRange || week.periodKey;
                    return `<a href="/charts/weekly/${week.periodKey}" class="${classes}" title="${tooltip}">${week.display}</a>`;
                } else {
                    classes += ' absent consolidated';
                    if (week.current) classes += ' current';
                    return `<span class="${classes}" title="${week.count} weeks off chart">${week.count}√ó</span>`;
                }
            }).join('');
            
            return `
                <div class="chart-run-header">
                    Chart-run: <a href="/albums/${data.albumId}">${data.albumName}</a> by ${data.artistName}
                </div>
                <div class="chart-run-boxes">
                    ${boxesHtml}
                </div>
                <div class="chart-run-stats">
                    <div class="chart-run-stat">
                        <div class="chart-run-stat-label">Top 1</div>
                        <div class="chart-run-stat-value">${data.weeksAtTop1}</div>
                    </div>
                    <div class="chart-run-stat">
                        <div class="chart-run-stat-label">Top 5</div>
                        <div class="chart-run-stat-value">${data.weeksAtTop5}</div>
                    </div>
                    <div class="chart-run-stat">
                        <div class="chart-run-stat-label">Top 10</div>
                        <div class="chart-run-stat-value">${data.weeksAtTop10}</div>
                    </div>
                </div>
            `;
        }
        
        // Generate chart for a single week
        async function generateSingleChart(button) {
            const periodKey = button.getAttribute('data-period-key');
            if (!periodKey) {
                alert('No period key found');
                return;
            }

            button.disabled = true;
            button.textContent = 'Generating...';

            try {
                const response = await fetch('/charts/generate/' + periodKey, { method: 'POST' });
                const data = await response.json();

                if (data.success) {
                    // Redirect to the generated chart
                    window.location.href = '/charts/weekly/' + periodKey;
                } else {
                    alert('Failed to generate chart: ' + data.error);
                    button.disabled = false;
                    button.textContent = 'Generate Chart for This Week';
                }
            } catch (error) {
                alert('Error generating chart: ' + error.message);
                button.disabled = false;
                button.textContent = 'Generate Chart for This Week';
            }
        }

        // Bulk generation
        let generationSessionId = null;
        let progressInterval = null;
        
        async function startBulkGeneration() {
            try {
                const response = await fetch('/charts/generate-all', { method: 'POST' });
                const data = await response.json();
                
                if (data.success) {
                    generationSessionId = data.sessionId;
                    showProgressModal();
                    startProgressPolling();
                } else {
                    alert('Failed to start generation: ' + data.error);
                }
            } catch (error) {
                alert('Error starting generation: ' + error.message);
            }
        }
        
        function showProgressModal() {
            document.getElementById('progressModal').classList.add('visible');
        }
        
        function hideProgressModal() {
            document.getElementById('progressModal').classList.remove('visible');
            if (progressInterval) {
                clearInterval(progressInterval);
                progressInterval = null;
            }
        }
        
        function startProgressPolling() {
            progressInterval = setInterval(async () => {
                try {
                    const response = await fetch(`/charts/generate-all/progress/${generationSessionId}`);
                    const progress = await response.json();
                    
                    updateProgressUI(progress);
                    
                    // Jackson serializes isComplete() as "complete" in JSON
                    if (progress.complete || progress.isComplete) {
                        clearInterval(progressInterval);
                        progressInterval = null;
                        
                        if (progress.error) {
                            document.getElementById('progressModalTitle').textContent = 'Generation Failed';
                            document.getElementById('progressCurrentWeek').textContent = progress.error;
                        } else {
                            document.getElementById('progressModalTitle').textContent = 'Generation Complete!';
                            document.getElementById('progressCurrentWeek').textContent = 'Done';
                        }
                        // Show close button
                        document.getElementById('closeModalBtn').style.display = 'inline-block';
                    }
                } catch (error) {
                    console.error('Error polling progress:', error);
                }
            }, 500);
        }
        
        function closeModalAndReload() {
            hideProgressModal();
            window.location.reload();
        }
        
        function updateProgressUI(progress) {
            document.getElementById('progressBar').style.width = progress.percentage + '%';
            document.getElementById('progressCount').textContent = progress.completedWeeks;
            document.getElementById('progressTotal').textContent = progress.totalWeeks;
            document.getElementById('progressCurrentWeek').textContent = progress.currentWeek || 'Finishing...';
        }
        
        // ========== Regenerate All Charts ==========
        let regenerateSessionId = null;

        async function confirmRegenerateAll() {
            // Fetch count of existing charts
            try {
                const response = await fetch('/charts/weekly/count');
                const data = await response.json();
                document.getElementById('regenerateCount').textContent = data.count + ' weekly charts';
                document.getElementById('confirmInput').value = '';
                document.getElementById('finalConfirmBtn').disabled = true;
                document.getElementById('finalConfirmBtn').style.opacity = '0.5';
                document.getElementById('confirmRegenerateModal').style.display = 'flex';
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        function hideRegenerateModal() {
            document.getElementById('confirmRegenerateModal').style.display = 'none';
        }

        // Enable button when user types REGENERATE
        document.getElementById('confirmInput')?.addEventListener('input', function() {
            const btn = document.getElementById('finalConfirmBtn');
            if (this.value.toUpperCase() === 'REGENERATE') {
                btn.disabled = false;
                btn.style.opacity = '1';
            } else {
                btn.disabled = true;
                btn.style.opacity = '0.5';
            }
        });

        async function finalConfirmRegenerate() {
            const input = document.getElementById('confirmInput');
            if (input.value.toUpperCase() !== 'REGENERATE') {
                alert('Please type REGENERATE to confirm');
                return;
            }

            hideRegenerateModal();

            // Start regeneration
            try {
                const response = await fetch('/charts/regenerate-all', { method: 'POST' });
                const data = await response.json();

                if (data.success) {
                    regenerateSessionId = data.sessionId;
                    document.getElementById('progressModalTitle').textContent = 'Regenerating ALL Charts';
                    showProgressModal();
                    startRegenerateProgressPolling();
                } else {
                    alert('Failed to start regeneration: ' + data.error);
                }
            } catch (error) {
                alert('Error starting regeneration: ' + error.message);
            }
        }

        function startRegenerateProgressPolling() {
            progressInterval = setInterval(async () => {
                try {
                    const response = await fetch(`/charts/generate-all/progress/${regenerateSessionId}`);
                    const progress = await response.json();

                    updateProgressUI(progress);

                    if (progress.complete || progress.isComplete) {
                        clearInterval(progressInterval);
                        progressInterval = null;

                        if (progress.error) {
                            document.getElementById('progressModalTitle').textContent = 'Regeneration Failed';
                            document.getElementById('progressCurrentWeek').textContent = progress.error;
                        } else {
                            document.getElementById('progressModalTitle').textContent = 'Regeneration Complete!';
                            document.getElementById('progressCurrentWeek').textContent = 'Done';
                        }
                        document.getElementById('closeModalBtn').style.display = 'inline-block';
                    }
                } catch (error) {
                    console.error('Error polling progress:', error);
                }
            }, 500);
        }

        // Initialize Flatpickr date picker
        document.addEventListener('DOMContentLoaded', function() {
            const picker = document.getElementById('chartDatePicker');
            if (picker) {
                const fp = flatpickr(picker, {
                    dateFormat: 'd/m/Y',
                    allowInput: true,
                    theme: 'dark',
                    onChange: function(selectedDates, dateStr, instance) {
                        if (selectedDates.length > 0) {
                            // Convert to yyyy-mm-dd for the API
                            const d = selectedDates[0];
                            const year = d.getFullYear();
                            const month = String(d.getMonth() + 1).padStart(2, '0');
                            const day = String(d.getDate()).padStart(2, '0');
                            navigateToDate(`${year}-${month}-${day}`);
                        }
                    }
                });
                
                // Handle Enter key when user types a date manually
                picker.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        // Parse the typed date (dd/mm/yyyy format)
                        const parts = picker.value.split('/');
                        if (parts.length === 3) {
                            const day = parts[0].padStart(2, '0');
                            const month = parts[1].padStart(2, '0');
                            const year = parts[2];
                            navigateToDate(`${year}-${month}-${day}`);
                        }
                    }
                });
            }
        });
        
        /**
         * Open playlist generator for the weekly songs chart
         */
        function openWeeklySongsPlaylistGenerator() {
            // Get song data from the table
            const songs = [];
            const rows = document.querySelectorAll('#songsSection .charts-table tbody tr:not(.chart-run-row)');
            
            rows.forEach(row => {
                const songId = row.getAttribute('data-song-id');
                if (!songId) return;
                
                const titleLink = row.querySelector('.col-title a');
                const artistLink = row.querySelector('.col-artist a');
                const albumName = row.getAttribute('data-album') || '';
                
                if (titleLink && artistLink) {
                    songs.push({
                        id: parseInt(songId),
                        name: titleLink.textContent.trim(),
                        artist: artistLink.textContent.trim(),
                        album: albumName
                    });
                }
            });
            
            if (songs.length === 0) {
                alert('No songs found in the chart');
                return;
            }
            
            // Generate default name based on the period
            const periodText = document.querySelector('.charts-period');
            const defaultName = 'Weekly Chart' + (periodText ? ' - ' + periodText.textContent.trim() : '');
            
            // Open the playlist generator modal
            openPlaylistGeneratorModal(songs, defaultName);
        }
        /*]]>*/
    </script>
    
    <script th:inline="javascript">
        /*<![CDATA[*/
        function computeMalePct(listSelector, rowSelector, targetId) {
            const rows = document.querySelectorAll(listSelector + ' ' + rowSelector);
            let male = 0, total = 0;
            rows.forEach(r => {
                const g = r.getAttribute('data-gender');
                if (g != null) {
                    total++;
                    if (g === '2') male++;
                }
            });
            const el = document.getElementById(targetId);
            if (!el) return;
            if (total === 0) {
                el.textContent = '';
                el.classList.remove('gender-pct--full');
                el.classList.remove('gender-pct');
            } else {
                const malePct = Math.round((male / total) * 100);
                el.textContent = `${malePct}%`;
                el.classList.add('gender-pct');
                if (malePct === 100) el.classList.add('gender-pct--full');
                else el.classList.remove('gender-pct--full');
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Songs table: exclude detail rows
            computeMalePct('#songsSection .charts-table tbody', 'tr[data-song-id]', 'songsGenderPct');
            computeMalePct('#albumsSection .charts-table tbody', 'tr[data-album-id]', 'albumsGenderPct');
        });
        /*]]>*/
    </script>

    <!-- Playlist Generator Modal -->
    <th:block th:replace="~{fragments/playlist-generator-modal :: playlist-generator-modal}"></th:block>
</body>
</html>
