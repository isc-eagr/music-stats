<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Import Scrobbles</title>
    <link rel="stylesheet" th:href="@{/css/global.css}" />
    <th:block th:replace="~{fragments/navigation :: nav-styles}"></th:block>
    <style>
        /* Minor page-specific adjustments to match site look */
        .form-card { max-width: 880px; margin: 24px 0; padding: 28px; background: var(--surface); border: 1px solid rgba(255,255,255,0.06); border-radius: var(--radius); box-shadow: var(--shadow); }
        .hint { color: var(--text-muted); margin-bottom:16px; font-size: 14px; }
        .field-row { display:flex; gap:12px; align-items:center; }
        .checkbox-label { color: var(--text-muted); font-size:14px }
        .actions { display:flex; gap:8px; align-items:center; margin-top:12px }
        input[type=file] { background: transparent; color: var(--text); border: 1px solid rgba(255,255,255,0.06); padding:8px; border-radius:6px }
        input { width:100%; padding:8px; margin-bottom:12px; border-radius:6px; border:1px solid rgba(255,255,255,0.06); background:var(--surface-2); color:var(--text) }
        label { display: block; margin-bottom: 6px; font-size: 13px; color: var(--text-muted); }
        .error { color: #ff6b6b; margin-bottom:12px; }
    </style>
</head>
<body>
    <th:block th:replace="~{fragments/navigation :: navigation}"></th:block>

    <main class="container" style="padding-left: 60px; margin-left: 0; margin-right: auto;">
        <h1 style="margin: 24px 0 16px; font-size: 28px; font-weight: 650;">Import Scrobbles</h1>
        
        <!-- Max Last.fm ID per account -->
        <div th:if="${maxLastfmIds != null and !maxLastfmIds.isEmpty()}" class="form-card" style="margin-bottom: 16px; padding: 16px;">
            <p style="margin: 0 0 8px; font-size: 14px; color: var(--text-muted); font-weight: 600;">Latest Last.fm ID per account:</p>
            <div style="display: flex; gap: 24px; flex-wrap: wrap;">
                <div th:each="entry : ${maxLastfmIds}" style="display: flex; gap: 8px; align-items: center;">
                    <span style="color: var(--text-muted); font-size: 13px;" th:text="${entry.key != '' ? entry.key : '(blank)'}">account</span>
                    <span style="font-weight: 700; font-size: 15px; color: var(--text);" th:text="${entry.value}">0</span>
                </div>
            </div>
        </div>
        
        <div class="form-card">
            <p class="hint">Upload a CSV file containing scrobbles. The server will stream and save in batches to avoid high memory usage.</p>

            <div th:if="${error}">
                <p class="error" th:text="${error}"></p>
            </div>

            <form th:action="@{/scrobbles/upload}" method="post" enctype="multipart/form-data">
                <label for="file">CSV file</label>
                <input type="file" id="file" name="file" accept="text/csv" required />

                <label for="account">Account</label>
                <select id="account" name="account">
                    <option th:each="a: ${accounts}" th:value="${a}" th:text="${a}"></option>
                </select>

                <label for="batchSize">Batch size (rows per DB commit)</label>
                <input type="number" id="batchSize" name="batchSize" value="2000" min="1" />

                <div class="field-row">
                    <label class="checkbox-label"><input type="checkbox" name="dryRun" value="true" /> Dry run (do not write to DB)</label>
                </div>

                <div class="actions">
                    <button class="btn btn-action" type="submit">Upload & Import</button>
                    <a class="btn btn-negative" th:href="@{/}">Cancel</a>
                </div>
            </form>
        </div>
    </main>
</body>
</html>