<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${album.name} + ' - Music Stats'">Album Detail</title>
    <link rel="stylesheet" th:href="@{/css/global.css}">
    <th:block th:replace="~{fragments/navigation :: nav-styles}"></th:block>
    <link rel="stylesheet" th:href="@{/css/catalog-list.css}">
    <link rel="stylesheet" th:href="@{/css/album-detail.css}">
    <link rel="stylesheet" th:href="@{/css/top-tables.css}">
    <link rel="stylesheet" th:href="@{/css/detail-tabs.css}">
    <!-- Flatpickr Date Picker -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script th:src="@{/js/top-table-sort.js}" defer></script>
    <script th:src="@{/js/table-sort.js}" defer></script>
    <script th:src="@{/js/searchable-select.js}" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <th:block th:replace="~{fragments/navigation :: navigation}"></th:block>
    <div class="container-wide" th:classappend="${artistGender != null and artistGender.toLowerCase().contains('male') and !artistGender.toLowerCase().contains('female')} ? 'gender-male' : (${artistGender != null and artistGender.toLowerCase().contains('female')} ? 'gender-female' : '')">
        <div class="detail-grid">
            <!-- Left column: Image with name overlay -->
            <div class="detail-sidebar">
                <div class="item-name-overlay">
                    <h1 class="item-name-top" th:text="${album.name}">Album Name</h1>
                    <div class="album-metadata" style="font-size: 0.9em; font-weight: normal; margin-top: 10px; color: #ccc; line-height: 1.6;">
                        <div th:if="${artistName != null}">
                            <a th:href="@{'/artists/' + ${album.artistId}}" style="color: #e5e7eb; text-decoration: none; transition: color 0.2s;"
                               onmouseover="this.style.color='#fff'" onmouseout="this.style.color='#e5e7eb'"
                               th:text="${artistName}"></a>
                        </div>
                    </div>
                </div>
                <div class="item-image-container">
                    <img th:if="${hasImage}"
                         th:src="@{'/albums/' + ${album.id} + '/image'}"
                         th:alt="${album.name}"
                         id="albumImage"
                         class="item-image-large clickable-image"
                         onclick="openImageModal(this.src)"
                         style="cursor: pointer;">
                      <span th:if="${albumLengthFormatted != null and !#strings.isEmpty(albumLengthFormatted)}"
                          class="length-overlay"
                          th:text="${albumLengthFormatted}"></span>
                    <div th:unless="${hasImage}" class="no-image-large" id="noImagePlaceholder">
                        <span>üíø</span>
                    </div>

                    <span class="flag-overlay" th:if="${artistCountry != null and @countryCodeMapper.getCode(artistCountry) != null}"
                          th:title="${artistCountry}">
                        <img th:src="@{https://flagcdn.com/w40/{code}.png(code=${@countryCodeMapper.getCode(artistCountry)})}"
                             th:alt="${artistCountry}" />
                    </span>

                    <div class="image-upload-overlay">
                        <input type="file" id="imageInput" accept="image/*" style="display: none;" onchange="handleImageUpload(event)">
                        <button type="button" class="btn-upload-image" onclick="document.getElementById('imageInput').click()">
                            Upload Image
                        </button>
                        <button type="button" class="btn-remove-image" th:if="${hasImage}" onclick="removeImage()">
                            Remove
                        </button>
                    </div>
                </div>
                
                <div class="item-stats">
                    <div class="stat">
                        <span class="stat-icon">üéµ</span>
                        <span class="stat-value" th:text="${songCount}">0</span>
                    </div>
                    <div class="stat" title="Primary plays">
                        <span class="stat-icon primary-plays">‚èµ</span>
                        <span class="stat-value" th:text="${albumVatitoPlayCount != null ? albumVatitoPlayCount : 0}">0</span>
                    </div>
                    <div class="stat" title="Legacy plays">
                        <span class="stat-icon legacy-plays">‚èµ</span>
                        <span class="stat-value" th:text="${albumRobertloverPlayCount != null ? albumRobertloverPlayCount : 0}">0</span>
                    </div>
                    <div class="stat" title="Total plays">
                        <span class="stat-icon total-plays">‚èµ</span>
                        <span class="stat-value" th:text="${albumPlayCount != null ? albumPlayCount : 0}">0</span>
                    </div>
                </div>
                
                <!-- All Chips - Flowing Together -->
                <div class="winning-chips" style="margin-top: 15px; padding: 0 10px;">
                    <!-- Overall Position -->
                    <a th:if="${overallPosition != null}"
                       th:href="@{/albums}"
                       class="winning-chip rank-chip overall"
                       th:text="'#' + ${overallPosition} + ' overall'"
                       th:title="'Rank #' + ${overallPosition} + ' among all albums'"></a>

                    <!-- Weekly Chart Stats -->
                    <span th:if="${weeklyChartStats != null and weeklyChartStats.hasCharted()}"
                          class="winning-chip rank-chip chart-stats"
                          th:text="${weeklyChartStats.totalWeeks} + ' weeks (Peak #' + ${weeklyChartStats.peakPosition} + ' for ' + ${weeklyChartStats.weeksAtPeak} + (${weeklyChartStats.weeksAtPeak} == 1 ? ' week)' : ' weeks)')"
                          th:title="'Spent ' + ${weeklyChartStats.totalWeeks} + ' weeks on the weekly album chart with a peak of #' + ${weeklyChartStats.peakPosition}">
                    </span>

                    <!-- Position by Release Year -->
                    <span th:if="${rankByReleaseYear != null and releaseYear != null}"
                          class="winning-chip rank-chip release-year"
                          th:text="'#' + ${rankByReleaseYear} + ' released in ' + ${releaseYear}"
                          th:title="'Rank #' + ${rankByReleaseYear} + ' among albums released in ' + ${releaseYear}">
                    </span>

                    <!-- Position Among Artist's Albums -->
                    <a th:if="${rankByArtist != null and artistName != null}"
                       th:href="@{'/artists/' + ${album.artistId}}"
                       class="winning-chip rank-chip artist-rank"
                       th:text="'#' + ${rankByArtist} + ' ' + ${artistName} + ' album'"
                       th:title="'Rank #' + ${rankByArtist} + ' among all ' + ${artistName} + ' albums'"></a>

                    <!-- Gender Rank -->
                    <a th:if="${rankByGender != null and album.artistId != null and artist != null and artist.genderId != null}" 
                       th:href="@{/graphs(filterType='gender',filterId=${artist.genderId},filterName=${genders.get(artist.genderId)})}"
                       class="winning-chip rank-chip gender"
                       th:classappend="${genders.get(artist.genderId) != null and genders.get(artist.genderId).toLowerCase().contains('female')} ? 'female' : (${genders.get(artist.genderId) != null and genders.get(artist.genderId).toLowerCase().contains('male')} ? 'male' : '')"
                       th:text="'#' + ${rankByGender} + ' ' + ${genders.get(artist.genderId)}" 
                       th:title="'Rank #' + ${rankByGender} + ' among albums by ' + ${genders.get(artist.genderId)} + ' artists'"></a>
                    
                    <!-- Genre Rank -->
                    <a th:if="${rankByGenre != null and (album.overrideGenreId != null or (artist != null and artist.genreId != null))}" 
                       th:href="@{/graphs(filterType='genre',filterId=${album.overrideGenreId != null ? album.overrideGenreId : artist.genreId},filterName=${genres.get(album.overrideGenreId != null ? album.overrideGenreId : artist.genreId)})}"
                       class="winning-chip rank-chip genre" 
                       th:text="'#' + ${rankByGenre} + ' ' + ${genres.get(album.overrideGenreId != null ? album.overrideGenreId : artist.genreId)}" 
                       th:title="'Rank #' + ${rankByGenre} + ' among ' + ${genres.get(album.overrideGenreId != null ? album.overrideGenreId : artist.genreId)} + ' albums'"></a>
                    
                    <!-- Subgenre Rank -->
                    <a th:if="${rankBySubgenre != null and (album.overrideSubgenreId != null or (artist != null and artist.subgenreId != null))}" 
                       th:href="@{/graphs(filterType='subgenre',filterId=${album.overrideSubgenreId != null ? album.overrideSubgenreId : artist.subgenreId},filterName=${subgenres.get(album.overrideSubgenreId != null ? album.overrideSubgenreId : artist.subgenreId)})}"
                       class="winning-chip rank-chip subgenre" 
                       th:text="'#' + ${rankBySubgenre} + ' ' + ${subgenres.get(album.overrideSubgenreId != null ? album.overrideSubgenreId : artist.subgenreId)}" 
                       th:title="'Rank #' + ${rankBySubgenre} + ' among ' + ${subgenres.get(album.overrideSubgenreId != null ? album.overrideSubgenreId : artist.subgenreId)} + ' albums'"></a>
                    
                    <!-- Ethnicity Rank -->
                    <a th:if="${rankByEthnicity != null and artist != null and artist.ethnicityId != null}" 
                       th:href="@{/graphs(filterType='ethnicity',filterId=${artist.ethnicityId},filterName=${ethnicities.get(artist.ethnicityId)})}"
                       class="winning-chip rank-chip ethnicity" 
                       th:text="'#' + ${rankByEthnicity} + ' ' + ${ethnicities.get(artist.ethnicityId)}" 
                       th:title="'Rank #' + ${rankByEthnicity} + ' among albums by ' + ${ethnicities.get(artist.ethnicityId)} + ' artists'"></a>
                    
                    <!-- Language Rank -->
                    <a th:if="${rankByLanguage != null and (album.overrideLanguageId != null or (artist != null and artist.languageId != null))}" 
                       th:href="@{/graphs(filterType='language',filterId=${album.overrideLanguageId != null ? album.overrideLanguageId : artist.languageId},filterName=${languages.get(album.overrideLanguageId != null ? album.overrideLanguageId : artist.languageId)})}"
                       class="winning-chip rank-chip language" 
                       th:text="'#' + ${rankByLanguage} + ' ' + ${languages.get(album.overrideLanguageId != null ? album.overrideLanguageId : artist.languageId)}" 
                       th:title="'#' + ${rankByLanguage} + ' among ' + ${languages.get(album.overrideLanguageId != null ? album.overrideLanguageId : artist.languageId)} + ' albums'"></a>
                    
                    <!-- Spanish Rap Rank (special combination) -->
                    <a th:if="${rankBySpanishRap != null}"
                       th:href="@{/graphs(genre=${rapGenreId},genreMode='includes',language=${spanishLanguageId},languageMode='includes')}"
                       class="winning-chip rank-chip spanish-rap"
                       th:text="'#' + ${rankBySpanishRap} + ' Spanish Rap'"
                       th:title="'Rank #' + ${rankBySpanishRap} + ' among Spanish Rap albums'"></a>

                    <!-- Country Rank -->
                    <a th:if="${rankByCountry != null and artist != null and artist.country != null}" 
                       th:href="@{/graphs(country=${artist.country},countryMode='includes')}"
                       class="winning-chip rank-chip country" 
                       th:text="'#' + ${rankByCountry} + ' ' + ${artist.country}" 
                       th:title="'Rank #' + ${rankByCountry} + ' among albums by ' + ${artist.country} + ' artists'"></a>
                    
                    <!-- Year Ranks (only if <= 100) -->
                    <a th:each="yearEntry : ${ranksByYear}" 
                       th:if="${yearEntry.value != null and yearEntry.value <= 100}"
                       th:href="@{/graphs(listenedDateFrom=${yearEntry.key} + '-01-01',listenedDateTo=${yearEntry.key} + '-12-31')}"
                       class="winning-chip rank-chip year-rank" 
                       th:text="'#' + ${yearEntry.value} + ' most listened in ' + ${yearEntry.key}" 
                       th:title="'Rank #' + ${yearEntry.value} + ' most listened album in year ' + ${yearEntry.key}"></a>
                    
                    <!-- Yearly Chart Placements -->
                    <a th:each="entry : ${yearlyChartHistory}" 
                       th:href="@{/charts/yearly/{pk}(pk=${entry.periodKey})}"
                       class="winning-chip chart-chip yearly-chart"
                       th:text="${entry.displayName}"></a>
                    
                    <!-- Seasonal Chart Placements -->
                    <a th:each="entry : ${seasonalChartHistory}" 
                       th:href="@{/charts/seasonal/{pk}(pk=${entry.periodKey})}"
                       class="winning-chip chart-chip seasonal-chart">
                        <span th:if="${#strings.contains(entry.displayName, 'Winter')}">‚ùÑÔ∏è</span>
                        <span th:if="${#strings.contains(entry.displayName, 'Spring')}">üå∏</span>
                        <span th:if="${#strings.contains(entry.displayName, 'Summer')}">‚òÄÔ∏è</span>
                        <span th:if="${#strings.contains(entry.displayName, 'Fall')}">üçÇ</span>
                        <span th:text="${entry.displayName}"></span>
                    </a>
                </div>
            </div>
            
            <!-- Tab Navigation -->
            <div class="detail-tabs">
                <a th:href="@{'/albums/' + ${album.id}}" 
                   th:classappend="${activeTab == 'general' or activeTab == null} ? 'active' : ''"
                   class="detail-tab">General</a>
                <a th:href="@{'/albums/' + ${album.id} + '?tab=plays'}" 
                   th:classappend="${activeTab == 'plays'} ? 'active' : ''"
                   class="detail-tab">Plays</a>
                <a th:href="@{'/albums/' + ${album.id} + '?tab=featured'}" 
                   th:classappend="${activeTab == 'featured'} ? 'active' : ''"
                   class="detail-tab">Featured Artists</a>
                <a th:href="@{'/albums/' + ${album.id} + '?tab=chart-history'}" 
                   th:classappend="${activeTab == 'chart-history'} ? 'active' : ''"
                   class="detail-tab">Chart History</a>
            </div>
            
            <!-- Right side: Two-column layout for General and Statistics -->
            <div class="detail-right-section" th:if="${activeTab == 'general' or activeTab == null}">
                <!-- General Section (Left) -->
                <div class="detail-content-card">
                    <div class="section-header">
                        <h2 class="section-title">General</h2>
                        <div class="edit-button-container">
                            <button type="button" class="btn-action" id="editBtn" onclick="toggleEdit()">Edit</button>
                            <button type="button" class="btn-negative" id="deleteBtn" 
                                    th:disabled="${albumPlayCount > 0}"
                                    th:title="${albumPlayCount > 0 ? 'Cannot delete album with existing plays' : 'Delete this album and all associated songs'}"
                                    onclick="confirmDelete()">Delete</button>
                        </div>
                    </div>
                    
                    <form method="post" th:action="@{'/albums/' + ${album.id}}" th:object="${album}" id="albumForm">
                        <input type="hidden" id="artistId" name="artistId" th:field="*{artistId}" />
                        
                        <div class="form-section">
                            <!-- Name field (editable, only shown in edit mode) -->
                            <div class="form-group form-group-full-width name-field-group" id="nameFieldGroup" style="display:none;">
                                <label for="name">Name</label>
                                <span class="attribute-text" data-field="name" th:text="${album.name}" style="display:none;">Album Name</span>
                                <input type="text" id="name" name="name" th:field="*{name}" class="editable-input" />
                            </div>
                            <div class="attributes-grid">
                                <div class="form-group">
                                    <label for="releaseDate">Release Date</label>
                                    <span class="attribute-text" data-field="releaseDate" th:text="${album.releaseDateFormatted != null ? album.releaseDateFormatted : '-'}">-</span>
                                    <input type="text" id="releaseDate" name="releaseDate" th:value="${album.releaseDateInput}" placeholder="dd/MM/yyyy" pattern="\d{2}/\d{2}/\d{4}" style="display:none;" />
                                </div>
                                
                                <div class="form-group">
                                    <label for="overrideGenreId">
                                        <span class="label-view">Genre</span>
                                        <span class="label-edit" style="display:none;">Genre Override</span>
                                    </label>
                                    <span class="attribute-text" data-field="overrideGenreId" 
                                          th:classappend="${album.overrideGenreId != null ? 'attribute-overridden' : 'attribute-inherited'}"
                                          th:text="${album.overrideGenreId != null ? genres.get(album.overrideGenreId) : (effectiveGenreName != null ? effectiveGenreName : '-')}">-</span>
                                    <select id="overrideGenreId" name="overrideGenreId" disabled style="display:none;">
                                        <option value="" th:selected="${album.overrideGenreId == null}" th:text="'Inherit from artist (' + (${inheritedGenreName} != null ? ${inheritedGenreName} : 'none') + ')'">Inherit from artist</option>
                                        <option th:each="entry : ${genres}" 
                                                th:value="${entry.key}" 
                                                th:selected="${album.overrideGenreId != null and album.overrideGenreId.equals(entry.key)}"
                                                th:text="${entry.value}"></option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label for="overrideSubgenreId">
                                        <span class="label-view">Subgenre</span>
                                        <span class="label-edit" style="display:none;">Subgenre Override</span>
                                    </label>
                                    <span class="attribute-text" data-field="overrideSubgenreId"
                                          th:classappend="${album.overrideSubgenreId != null ? 'attribute-overridden' : 'attribute-inherited'}"
                                          th:text="${album.overrideSubgenreId != null ? subgenres.get(album.overrideSubgenreId) : (effectiveSubgenreName != null ? effectiveSubgenreName : '-')}">-</span>
                                    <select id="overrideSubgenreId" name="overrideSubgenreId" disabled style="display:none;">
                                        <option value="" th:selected="${album.overrideSubgenreId == null}" th:text="'Inherit from artist (' + (${inheritedSubgenreName} != null ? ${inheritedSubgenreName} : 'none') + ')'">Inherit from artist</option>
                                        <option th:each="entry : ${subgenres}" 
                                                th:value="${entry.key}" 
                                                th:selected="${album.overrideSubgenreId != null and album.overrideSubgenreId.equals(entry.key)}"
                                                th:text="${entry.value}"></option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label for="overrideLanguageId">
                                        <span class="label-view">Language</span>
                                        <span class="label-edit" style="display:none;">Language Override</span>
                                    </label>
                                    <span class="attribute-text" data-field="overrideLanguageId"
                                          th:classappend="${album.overrideLanguageId != null ? 'attribute-overridden' : 'attribute-inherited'}"
                                          th:text="${album.overrideLanguageId != null ? languages.get(album.overrideLanguageId) : (effectiveLanguageName != null ? effectiveLanguageName : '-')}">-</span>
                                    <select id="overrideLanguageId" name="overrideLanguageId" disabled style="display:none;">
                                        <option value="" th:selected="${album.overrideLanguageId == null}" th:text="'Inherit from artist (' + (${effectiveLanguageName} != null ? ${effectiveLanguageName} : 'none') + ')'">Inherit from artist</option>
                                        <option th:each="entry : ${languages}" 
                                                th:value="${entry.key}" 
                                                th:selected="${album.overrideLanguageId != null and album.overrideLanguageId.equals(entry.key)}"
                                                th:text="${entry.value}"></option>
                                    </select>
                                </div>
                                
                                <div class="form-group form-group-checkbox">
                                    <label class="field-label label-view">Organized</label>
                                    <span class="attribute-text" data-field="organized" th:text="${album.organized != null and album.organized ? 'üì¶ Yes' : 'üì¨ No'}">üì¨ No</span>
                                    <label class="inline-checkbox-label" style="display:none;">
                                        <input type="checkbox" id="organized" name="organized" th:field="*{organized}" />
                                        Organized
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-actions" id="formActions" style="display:none;">
                            <button type="submit" class="btn-action">Save</button>
                            <button type="button" class="btn-negative" onclick="cancelEdit()">Cancel</button>
                        </div>
                    </form>
                </div>
                
                <!-- Statistics Section (Right) -->
                <div class="detail-content-card">
                    <h2 class="section-title">Statistics</h2>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <span class="stat-label">Total Listening Time</span>
                            <span class="stat-value" th:text="${totalListeningTime}">0:00</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Average Song Length</span>
                            <span class="stat-value" th:text="${averageSongLength}">-</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Average Plays per Song</span>
                            <span class="stat-value" th:text="${averagePlaysPerSong}">-</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">First Listened</span>
                            <span class="stat-value" th:text="${firstListenedDate}">-</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Last Listened</span>
                            <span class="stat-value" th:text="${lastListenedDate}">-</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Songs List Section - Inside grid, spanning full width of right column -->
            <div class="detail-content-section" th:if="${(activeTab == 'general' or activeTab == null) and songs != null and !songs.isEmpty()}">
                <h2 class="section-title">Songs</h2>
                <div class="top-table-container">
                    <table class="top-table" id="songsTable">
                        <thead>
                            <tr>
                                <th data-sort="name">Song Name</th>
                                <th data-sort="length" class="numeric">Length</th>
                                <th data-sort="releasedate">Release Date</th>
                                <th data-sort="firstlistened">First Listened</th>
                                <th data-sort="lastlistened">Last Listened</th>
                                <th data-sort="primaryplays" class="numeric">Primary</th>
                                <th data-sort="legacyplays" class="numeric">Legacy</th>
                                <th data-sort="totalplays" class="numeric">Total</th>
                                <th data-sort="timelistened" class="numeric">Time Listened</th>
                            </tr>
                        </thead>
                        <tbody id="songsTableBody">
                            <tr th:each="song : ${songs}"
                                th:attr="data-name=${song.name},
                                        data-length=${song.length != null ? song.length : 0},
                                        data-releasedate=${song.releaseDate},
                                        data-firstlistened=${song.firstListenedDate},
                                        data-lastlistened=${song.lastListenedDate},
                                        data-primaryplays=${song.vatitoPlays},
                                        data-legacyplays=${song.robertloverPlays},
                                        data-totalplays=${song.totalPlays},
                                        data-timelistened=${song.totalListeningTimeSeconds}">
                                <td>
                                    <a th:href="@{'/songs/' + ${song.id}}" th:text="${song.name}">Song Name</a>
                                    <span th:if="${song.isSingle}" class="single-indicator" title="Single">üîπ</span>
                                </td>
                                <td class="numeric" th:text="${song.lengthFormatted != null ? song.lengthFormatted : '-'}">-</td>
                                <td th:text="${song.releaseDate != null ? song.releaseDate : '-'}">-</td>
                                <td th:text="${song.firstListenedDate != null ? song.firstListenedDate : '-'}">-</td>
                                <td th:text="${song.lastListenedDate != null ? song.lastListenedDate : '-'}">-</td>
                                <td class="numeric" th:text="${song.vatitoPlays != null ? song.vatitoPlays : 0}">0</td>
                                <td class="numeric" th:text="${song.robertloverPlays != null ? song.robertloverPlays : 0}">0</td>
                                <td class="numeric" th:classappend="${song.totalPlays != null and song.totalPlays >= 100} ? 'golden-plays' : ''" th:text="${song.totalPlays != null ? song.totalPlays : 0}">0</td>
                                <td class="numeric" th:text="${song.totalListeningTime != null ? song.totalListeningTime : '-'}">-</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Plays Tab Content -->
            <div class="plays-tab-content" th:if="${activeTab == 'plays'}">
                <!-- Plays by Year Chart -->
                <div class="detail-content-card plays-chart-section">
                    <h2 class="section-title">Plays by Year</h2>
                    <div class="chart-container">
                        <canvas id="playsByYearChart"></canvas>
                    </div>
                </div>
                
                <!-- Scrobbles Table -->
                <div class="detail-content-section">
                    <h2 class="section-title">Play History 
                        <span class="scrobble-count">(<span th:text="${scrobblesTotalCount}">0</span> plays)</span>
                    </h2>
                    
                    <!-- Top Pagination -->
                    <div class="pagination pagination-top" th:if="${scrobblesTotalPages > 1}">
                        <a th:href="@{'/albums/' + ${album.id} + '?tab=plays&playsPage=0'}"
                           th:classappend="${scrobblesPage == 0} ? 'disabled' : ''" class="page-link">&laquo; First</a>
                        <a th:href="@{'/albums/' + ${album.id} + '?tab=plays&playsPage=' + ${scrobblesPage - 1}}"
                           th:classappend="${scrobblesPage == 0} ? 'disabled' : ''" class="page-link">&lsaquo; Prev</a>
                        <span class="page-info">Page <span th:text="${scrobblesPage + 1}">1</span> of <span th:text="${scrobblesTotalPages}">1</span></span>
                        <a th:href="@{'/albums/' + ${album.id} + '?tab=plays&playsPage=' + ${scrobblesPage + 1}}"
                           th:classappend="${scrobblesPage >= scrobblesTotalPages - 1} ? 'disabled' : ''" class="page-link">Next &rsaquo;</a>
                        <a th:href="@{'/albums/' + ${album.id} + '?tab=plays&playsPage=' + ${scrobblesTotalPages - 1}}"
                           th:classappend="${scrobblesPage >= scrobblesTotalPages - 1} ? 'disabled' : ''" class="page-link">Last &raquo;</a>
                    </div>
                    
                    <div class="top-table-container">
                        <table class="top-table" id="scrobblesTable">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Song</th>
                                    <th>Account</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr th:each="scrobble : ${scrobbles}">
                                    <td th:text="${scrobble.scrobbleDate}">-</td>
                                    <td>
                                        <a th:href="@{'/songs/' + ${scrobble.songId}}" th:text="${scrobble.songName}">Song</a>
                                    </td>
                                    <td th:text="${scrobble.account}">-</td>
                                </tr>
                                <tr th:if="${scrobbles == null or scrobbles.isEmpty()}">
                                    <td colspan="3"><em>No plays recorded</em></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Bottom Pagination -->
                    <div class="pagination pagination-bottom" th:if="${scrobblesTotalPages > 1}">
                        <a th:href="@{'/albums/' + ${album.id} + '?tab=plays&playsPage=0'}"
                           th:classappend="${scrobblesPage == 0} ? 'disabled' : ''" class="page-link">&laquo; First</a>
                        <a th:href="@{'/albums/' + ${album.id} + '?tab=plays&playsPage=' + ${scrobblesPage - 1}}"
                           th:classappend="${scrobblesPage == 0} ? 'disabled' : ''" class="page-link">&lsaquo; Prev</a>
                        <span class="page-info">Page <span th:text="${scrobblesPage + 1}">1</span> of <span th:text="${scrobblesTotalPages}">1</span></span>
                        <a th:href="@{'/albums/' + ${album.id} + '?tab=plays&playsPage=' + ${scrobblesPage + 1}}"
                           th:classappend="${scrobblesPage >= scrobblesTotalPages - 1} ? 'disabled' : ''" class="page-link">Next &rsaquo;</a>
                        <a th:href="@{'/albums/' + ${album.id} + '?tab=plays&playsPage=' + ${scrobblesTotalPages - 1}}"
                           th:classappend="${scrobblesPage >= scrobblesTotalPages - 1} ? 'disabled' : ''" class="page-link">Last &raquo;</a>
                    </div>
                </div>
            </div>
            
            <!-- Featured Artists Tab Content -->
            <div class="featured-tab-content" th:if="${activeTab == 'featured'}">
                <div class="detail-content-card">
                    <h2 class="section-title">Featured Artists 
                        <span class="item-count">(<span th:text="${featuredArtistCards != null ? featuredArtistCards.size() : 0}">0</span>)</span>
                    </h2>
                    
                    <div th:if="${featuredArtistCards == null or featuredArtistCards.isEmpty()}" class="no-items-message">
                        <p>No featured artists for songs in this album.</p>
                    </div>
                    
                    <div th:if="${featuredArtistCards != null and !featuredArtistCards.isEmpty()}" class="featured-artist-grid">
                        <div th:each="artist : ${featuredArtistCards}" 
                             class="featured-artist-card"
                             th:title="${artist.songNamesFormatted}"
                             th:classappend="${artist.genderName != null and artist.genderName.toLowerCase().contains('male') and !artist.genderName.toLowerCase().contains('female')} ? 'gender-male' : (${artist.genderName != null and artist.genderName.toLowerCase().contains('female')} ? 'gender-female' : '')">
                            <a th:href="@{'/artists/' + ${artist.id}}" class="featured-artist-image item-image-container">
                                <img th:if="${artist.hasImage}"
                                     th:src="@{'/artists/' + ${artist.id} + '/image'}"
                                     th:alt="${artist.name}">
                                <div th:unless="${artist.hasImage}" class="no-image">
                                    <span th:text="${#strings.substring(artist.name, 0, 1)}"></span>
                                </div>
                                <span class="flag-overlay" th:if="${artist.country != null and @countryCodeMapper.getCode(artist.country) != null}"
                                      th:title="${artist.country}">
                                    <img th:src="@{https://flagcdn.com/w40/{code}.png(code=${@countryCodeMapper.getCode(artist.country)})}"
                                         th:alt="${artist.country}" />
                                </span>
                                <!-- Feature count badge for albums -->
                                <span th:if="${artist.featureCount > 1}" class="feature-count-badge" 
                                      th:text="${artist.featureCount}" th:title="${artist.featureCount + ' songs'}"></span>
                            </a>
                            <div class="featured-artist-info">
                                <a th:href="@{'/artists/' + ${artist.id}}">
                                    <h3 class="featured-artist-name" th:text="${artist.name}">Artist Name</h3>
                                </a>
                                <div class="featured-artist-details" th:if="${artist.genderName != null or artist.ethnicityName != null}">
                                    <span th:if="${artist.genderName != null}" th:text="${artist.genderName}"></span>
                                    <span th:if="${artist.genderName != null and artist.ethnicityName != null}"> ‚Ä¢ </span>
                                    <span th:if="${artist.ethnicityName != null}" th:text="${artist.ethnicityName}"></span>
                                </div>
                                <div class="featured-artist-metadata" th:if="${artist.genreName != null or artist.country != null}">
                                    <span th:if="${artist.genreName != null}" th:text="${artist.genreName}"></span>
                                    <span th:if="${artist.genreName != null and artist.country != null}"> ‚Ä¢ </span>
                                    <span th:if="${artist.country != null}" th:text="${artist.country}"></span>
                                </div>
                                <div class="featured-artist-stats">
                                    <div class="stat">
                                        <span class="stat-icon">üéµ</span>
                                        <span class="stat-value" th:text="${artist.songCount}">0</span>
                                    </div>
                                    <div class="stat">
                                        <span class="stat-icon total-plays">‚èµ</span>
                                        <span class="stat-value" th:text="${artist.playCount}">0</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Chart History Tab Content -->
            <div class="featured-tab-content" th:if="${activeTab == 'chart-history'}">
                <!-- Album Chart History -->
                <div class="detail-content-card">
                    <h2 class="section-title">üíø Album 
                        <span class="item-count">(<span th:text="${chartHistory != null ? chartHistory.size() : 0}">0</span>)</span>
                    </h2>
                    
                    <div th:if="${chartHistory == null or chartHistory.isEmpty()}" class="no-items-message">
                        <p>This album has not charted yet.</p>
                    </div>
                    
                    <div th:if="${chartHistory != null and !chartHistory.isEmpty()}">
                        <!-- Album Chart Run Display -->
                        <div id="albumChartRunContainer" class="chart-run-container" style="margin-bottom: 20px;">
                            <div style="text-align: center; color: #888;">Loading chart run...</div>
                        </div>
                        
                        <div class="table-wrapper">
                            <table class="table js-sortable">
                                <thead>
                                    <tr>
                                        <th>Album</th>
                                        <th class="numeric">Peak</th>
                                        <th class="numeric">Wks@Peak</th>
                                        <th>Release</th>
                                        <th>Debut</th>
                                        <th>Peak Date</th>
                                        <th class="numeric">Total Weeks</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr th:each="entry : ${chartHistory}">
                                        <td>
                                            <a th:href="@{'/albums/' + ${entry.id}}" th:text="${entry.name}">Album Name</a>
                                        </td>
                                        <td class="numeric">
                                            <span th:classappend="${entry.peakNumberOne} ? 'peak-number-one' : ''" 
                                                  th:text="${entry.peakPosition}">#1</span>
                                        </td>
                                        <td class="numeric">
                                            <span th:classappend="${entry.peakNumberOne} ? 'peak-number-one' : ''" 
                                                  th:text="${entry.weeksAtPeak}">1</span>
                                        </td>
                                        <td th:text="${entry.releaseDate != null ? entry.releaseDate : '-'}">-</td>
                                        <td>
                                            <a th:if="${entry.debutWeek != null}" th:href="@{/charts/weekly/{week}(week=${entry.debutWeek})}" th:text="${entry.debutDate}">-</a>
                                            <span th:unless="${entry.debutWeek != null}">-</span>
                                        </td>
                                        <td>
                                            <a th:if="${entry.peakWeek != null}" th:href="@{/charts/weekly/{week}(week=${entry.peakWeek})}" th:text="${entry.peakDate}">-</a>
                                            <span th:unless="${entry.peakWeek != null}">-</span>
                                        </td>
                                        <td class="numeric" th:text="${entry.totalWeeks}">5</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Songs Chart History -->
                <div class="detail-content-card" style="margin-top: 20px;">
                    <h2 class="section-title">üéµ Songs 
                        <span class="item-count">(<span th:text="${songChartHistory != null ? songChartHistory.size() : 0}">0</span>)</span>
                    </h2>
                    
                    <div th:if="${songChartHistory == null or songChartHistory.isEmpty()}" class="no-items-message">
                        <p>No songs from this album have charted yet.</p>
                    </div>
                    
                    <div th:if="${songChartHistory != null and !songChartHistory.isEmpty()}" class="table-wrapper">
                        <table class="table js-sortable">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th class="numeric">Peak</th>
                                    <th class="numeric">Wks@Peak</th>
                                    <th>Release</th>
                                    <th>Debut</th>
                                    <th>Peak Date</th>
                                    <th class="numeric">Total Weeks</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr th:each="entry : ${songChartHistory}">
                                    <td>
                                        <a th:href="@{'/songs/' + ${entry.id}}" th:text="${entry.name}">Song Name</a>
                                    </td>
                                    <td class="numeric">
                                        <span th:classappend="${entry.peakNumberOne} ? 'peak-number-one' : ''" 
                                              th:text="${entry.peakPosition}">#1</span>
                                    </td>
                                    <td class="numeric">
                                        <span th:classappend="${entry.peakNumberOne} ? 'peak-number-one' : ''" 
                                              th:text="${entry.weeksAtPeak}">1</span>
                                    </td>
                                    <td th:text="${entry.releaseDate != null ? entry.releaseDate : '-'}">-</td>
                                    <td>
                                        <a th:if="${entry.debutWeek != null}" th:href="@{/charts/weekly/{week}(week=${entry.debutWeek})}" th:text="${entry.debutDate}">-</a>
                                        <span th:unless="${entry.debutWeek != null}">-</span>
                                    </td>
                                    <td>
                                        <a th:if="${entry.peakWeek != null}" th:href="@{/charts/weekly/{week}(week=${entry.peakWeek})}" th:text="${entry.peakDate}">-</a>
                                        <span th:unless="${entry.peakWeek != null}">-</span>
                                    </td>
                                    <td class="numeric" th:text="${entry.totalWeeks}">5</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Album Seasonal/Yearly Charts Section -->
                <div th:if="${(seasonalChartHistory != null and !seasonalChartHistory.isEmpty()) or (yearlyChartHistory != null and !yearlyChartHistory.isEmpty())}" class="detail-content-card" style="margin-top: 20px;">
                    <h2 class="section-title">üìä Album Seasonal/Yearly Charts</h2>
                    <div class="winning-chips" style="justify-content: flex-start;">
                        <!-- Yearly entries first -->
                        <a th:each="entry : ${yearlyChartHistory}" 
                           th:href="@{/charts/yearly/{pk}(pk=${entry.periodKey})}"
                           class="winning-chip chart-chip yearly-chart"
                           th:text="${entry.displayName}">
                            #1 in 2024
                        </a>
                        <!-- Seasonal entries second -->
                        <a th:each="entry : ${seasonalChartHistory}" 
                           th:href="@{/charts/seasonal/{pk}(pk=${entry.periodKey})}"
                           class="winning-chip chart-chip seasonal-chart">
                            <span th:if="${#strings.contains(entry.displayName, 'Winter')}">‚ùÑÔ∏è</span>
                            <span th:if="${#strings.contains(entry.displayName, 'Spring')}">üå∏</span>
                            <span th:if="${#strings.contains(entry.displayName, 'Summer')}">‚òÄÔ∏è</span>
                            <span th:if="${#strings.contains(entry.displayName, 'Fall')}">üçÇ</span>
                            <span th:text="${entry.displayName}">#1 in Winter 2024</span>
                        </a>
                    </div>
                </div>
                
                <!-- Songs Seasonal/Yearly Charts Section -->
                <div th:if="${(seasonalSongChartHistory != null and !seasonalSongChartHistory.isEmpty()) or (yearlySongChartHistory != null and !yearlySongChartHistory.isEmpty())}" class="detail-content-card" style="margin-top: 20px;">
                    <h2 class="section-title">üéµ Songs Seasonal/Yearly Charts</h2>
                    <div class="table-wrapper">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Song</th>
                                    <th class="numeric">Position</th>
                                    <th>Period</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Yearly entries first -->
                                <tr th:each="entry : ${yearlySongChartHistory}">
                                    <td><a th:href="@{/songs/{id}(id=${entry.songId})}" th:text="${entry.songName}">Song Name</a></td>
                                    <td class="numeric" th:text="'#' + ${entry.position}">#1</td>
                                    <td>
                                        <a th:href="@{/charts/yearly/{pk}(pk=${entry.periodKey})}" style="text-decoration: none; color: inherit;">
                                            üìÖ <span th:text="${entry.displayName}">2024</span>
                                        </a>
                                    </td>
                                </tr>
                                <!-- Seasonal entries second -->
                                <tr th:each="entry : ${seasonalSongChartHistory}">
                                    <td><a th:href="@{/songs/{id}(id=${entry.songId})}" th:text="${entry.songName}">Song Name</a></td>
                                    <td class="numeric" th:text="'#' + ${entry.position}">#1</td>
                                    <td>
                                        <a th:href="@{/charts/seasonal/{pk}(pk=${entry.periodKey})}" style="text-decoration: none; color: inherit;">
                                            <span th:if="${#strings.contains(entry.displayName, 'Winter')}">‚ùÑÔ∏è</span>
                                            <span th:if="${#strings.contains(entry.displayName, 'Spring')}">üå∏</span>
                                            <span th:if="${#strings.contains(entry.displayName, 'Summer')}">‚òÄÔ∏è</span>
                                            <span th:if="${#strings.contains(entry.displayName, 'Fall')}">üçÇ</span>
                                            <span th:text="${entry.displayName}">Winter 2024</span>
                                        </a>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script th:if="${activeTab == 'plays'}" th:inline="javascript">
        // Initialize plays by year chart
        document.addEventListener('DOMContentLoaded', function() {
            const playsByYearData = /*[[${playsByYear}]]*/ [];
            const artistGender = /*[[${artistGender}]]*/ '';
            
            if (playsByYearData && playsByYearData.length > 0) {
                const ctx = document.getElementById('playsByYearChart').getContext('2d');
                
                // Fill in missing years with 0 plays (only between first and last year)
                const filledData = [];
                const years = playsByYearData.map(d => parseInt(d.year)).sort((a, b) => a - b);
                const minYear = years[0];
                const maxYear = years[years.length - 1];
                const yearMap = {};
                playsByYearData.forEach(d => yearMap[d.year] = d.playCount);
                
                for (let year = minYear; year <= maxYear; year++) {
                    filledData.push({
                        year: year.toString(),
                        playCount: yearMap[year.toString()] || 0
                    });
                }
                
                // Determine bar color based on gender
                const isFemale = artistGender && artistGender.toLowerCase().includes('female');
                const barColor = isFemale ? 'rgba(236, 72, 153, 0.8)' : 'rgba(59, 130, 246, 0.8)';
                const borderColor = isFemale ? 'rgba(236, 72, 153, 1)' : 'rgba(59, 130, 246, 1)';
                
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: filledData.map(d => d.year),
                        datasets: [{
                            label: 'Plays',
                            data: filledData.map(d => d.playCount),
                            backgroundColor: barColor,
                            borderColor: borderColor,
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { color: '#9ca3af' },
                                grid: { color: 'rgba(255,255,255,0.1)' }
                            },
                            x: {
                                ticks: { color: '#9ca3af' },
                                grid: { display: false }
                            }
                        }
                    }
                });
            }
        });
    </script>
    
    <script>
        let isEditing = false;
        
        function toggleEdit() {
            isEditing = !isEditing;
            const editBtn = document.getElementById('editBtn');
            const deleteBtn = document.getElementById('deleteBtn');
            const formActions = document.getElementById('formActions');
            const textInputs = document.querySelectorAll('#albumForm input.editable-input, #albumForm input[type="date"], #albumForm input[type="text"]:not([type="hidden"])');
            const selects = document.querySelectorAll('#albumForm select');
            const inlineCheckboxLabels = document.querySelectorAll('.inline-checkbox-label');
            const attributeTexts = document.querySelectorAll('.attribute-text');
            
            if (isEditing) {
                editBtn.style.display = 'none';
                deleteBtn.style.display = 'none';
                formActions.style.display = 'flex';
                
                // Show name field group
                const nameFieldGroup = document.getElementById('nameFieldGroup');
                if (nameFieldGroup) {
                    nameFieldGroup.style.display = 'block';
                }
                
                // Switch labels to edit mode (show "Override" labels)
                document.querySelectorAll('.label-view').forEach(el => el.style.display = 'none');
                document.querySelectorAll('.label-edit').forEach(el => el.style.display = 'inline');
                
                textInputs.forEach(input => {
                    if (input.type !== 'hidden') {
                        input.style.display = 'block';
                    }
                });
                selects.forEach(select => {
                    select.removeAttribute('disabled');
                    select.style.display = 'block';
                });
                inlineCheckboxLabels.forEach(label => {
                    label.style.display = 'inline-flex';
                });
                attributeTexts.forEach(text => {
                    if (text.dataset.field) {
                        text.style.display = 'none';
                    }
                });
                
                // Initialize searchable selects for dropdowns
                setTimeout(function() {
                    // Set select values based on selected options before initializing searchable selects
                    ['overrideGenreId', 'overrideSubgenreId', 'overrideLanguageId'].forEach(function(selectId) {
                        const select = document.getElementById(selectId);
                        if (select) {
                            const selectedOption = select.querySelector('option[selected]');
                            if (selectedOption) {
                                select.value = selectedOption.value;
                            }
                        }
                    });
                    
                    initSearchableSelect('overrideGenreId');
                    initSearchableSelect('overrideSubgenreId');
                    initSearchableSelect('overrideLanguageId');
                }, 50);
            } else {
                window.location.reload();
            }
        }
        
        function cancelEdit() {
            window.location.reload();
        }
        
        function confirmDelete() {
            const albumName = document.querySelector('.item-name-top').textContent;
            const playCount = /*[[${albumPlayCount}]]*/ 0;
            
            if (playCount > 0) {
                alert('Cannot delete album with existing plays (' + playCount + ' plays)');
                return;
            }
            
            if (confirm('Are you sure you want to delete "' + albumName + '"?\n\nThis will also delete all songs in this album. This action cannot be undone!')) {
                const albumId = window.location.pathname.split('/').pop();
                
                fetch(`/albums/${albumId}`, {
                    method: 'DELETE'
                })
                .then(response => response.text())
                .then(data => {
                    if (data === 'success') {
                        window.location.href = '/albums';
                    } else if (data.startsWith('error:')) {
                        alert(data.substring(6));
                    } else {
                        alert('Failed to delete album');
                    }
                })
                .catch(error => {
                    console.error('Error deleting album:', error);
                    alert('Error deleting album');
                });
            }
        }
        
        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!file.type.startsWith('image/')) {
                alert('Please select an image file');
                return;
            }
            
            if (file.size > 5 * 1024 * 1024) {
                alert('Image size must be less than 5MB');
                return;
            }
            
            const formData = new FormData();
            formData.append('image', file);
            
            const albumId = window.location.pathname.split('/').pop();
            
            fetch(`/albums/${albumId}/image`, {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (response.ok) {
                    window.location.reload();
                } else {
                    alert('Failed to upload image');
                }
            })
            .catch(error => {
                console.error('Error uploading image:', error);
                alert('Error uploading image');
            });
        }
        
        function removeImage() {
            if (!confirm('Are you sure you want to remove this image?')) {
                return;
            }
            
            const albumId = window.location.pathname.split('/').pop();
            
            fetch(`/albums/${albumId}/image`, {
                method: 'DELETE'
            })
            .then(response => {
                if (response.ok) {
                    window.location.reload();
                } else {
                    alert('Failed to remove image');
                }
            })
            .catch(error => {
                console.error('Error removing image:', error);
                alert('Error removing image');
            });
        }
        
        // Initialize table sorting using shared module
        document.addEventListener('DOMContentLoaded', function() {
            // Songs table sorting
            if (document.getElementById('songsTable')) {
                initTopTableSort('songsTable', {
                    defaultColumn: 'totalplays',
                    defaultDirection: 'desc'
                });
            }
        });
        
        // Tooltip functionality
        function showTooltip(element) {
            if (!element) return;
            const tooltip = element.classList.contains('tooltip') 
                ? element.querySelector('.tooltiptext')
                : element;
            if (tooltip) {
                const playsData = element.closest('.tooltip')?.dataset?.plays || element.dataset?.plays;
                if (playsData && tooltip.id === 'album-plays-tooltip') {
                    tooltip.textContent = playsData;
                }
                tooltip.style.opacity = '1';
                tooltip.style.visibility = 'visible';
                tooltip.style.transform = 'translateX(-50%) translateY(0)';
                tooltip.style.transition = 'opacity 180ms ease, transform 180ms ease, visibility 0s linear 0s';
            }
        }

        function hideTooltip(element) {
            if (!element) return;
            const tooltip = element.classList.contains('tooltip') 
                ? element.querySelector('.tooltiptext')
                : element;
            if (tooltip) {
                tooltip.style.opacity = '0';
                tooltip.style.visibility = 'hidden';
                tooltip.style.transform = 'translateX(-50%) translateY(6px)';
                tooltip.style.transition = 'opacity 180ms ease, transform 180ms ease, visibility 0s linear 180ms';
            }
        }
    </script>
    
    <style>
        /* Make disabled delete buttons visually distinct */
        .btn-negative:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            background-color: #4a4a4a;
            color: #888;
        }
        
        .btn-negative:disabled:hover {
            background-color: #4a4a4a;
            color: #888;
        }
        
        /* Name field styling */
        .name-field-group {
            grid-column: 1 / -1;
            margin-bottom: 10px;
        }
        
        .editable-input {
            width: 100%;
            padding: 8px 12px;
            background: #1f2937;
            border: 1px solid #374151;
            border-radius: 6px;
            color: #e5e7eb;
            font-size: 0.95em;
        }
        
        .editable-input:focus {
            outline: none;
            border-color: #22c55e;
            box-shadow: 0 0 0 2px rgba(34, 197, 94, 0.2);
        }
        
        /* Checkbox styling */
        .checkbox-container {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 0;
            flex-wrap: nowrap;
        }

        .checkbox-container input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .checkbox-label {
            font-size: 14px;
            color: #e5e7eb;
            cursor: pointer;
            white-space: nowrap;
        }
        /* Inline layout for checkbox form-groups (compact) */
        .form-group.form-group-checkbox {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            gap: 8px;
        }

        .form-group.form-group-checkbox .field-label {
            margin: 0;
            color: #cbd5e1;
            font-size: 0.95rem;
            white-space: nowrap;
        }

        .form-group.form-group-checkbox .attribute-text {
            margin-left: 4px;
        }

        .form-group.form-group-checkbox .checkbox-container {
            margin: 0;
            padding: 0;
        }

        .form-group.form-group-checkbox .checkbox-label { display: none; }

        .form-group.form-group-checkbox .inline-checkbox-label {
            justify-content: flex-start;
        }
        
        /* Clickable image cursor */
        .item-image-large.clickable {
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        
        .item-image-large.clickable:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
        }
        
        /* Chart Run Styles */
        .chart-run-container {
            background: #0a0a0a;
            border: 1px solid #2a2a2a;
            border-radius: 8px;
            padding: 16px;
        }
        /* Hide length overlay on image hover so upload/remove buttons can appear */
        .item-image-container:hover .length-overlay {
            opacity: 0;
            transition: opacity 0.15s ease;
        }
        
        .chart-run-header {
            font-size: 0.9rem;
            color: #888;
            margin-bottom: 12px;
        }
        
        .chart-run-header a {
            color: #22c55e;
            text-decoration: none;
        }
        
        .chart-run-header a:hover {
            text-decoration: underline;
        }
        
        .chart-run-boxes {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-bottom: 16px;
        }
        
        .chart-run-box {
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 600;
            border-radius: 4px;
            background: #1a1a1a;
            color: #888;
            border: 1px solid #333;
            text-decoration: none;
            cursor: pointer;
        }
        
        .chart-run-box:hover {
            text-decoration: none;
        }
        
        .chart-run-box.on-chart {
            background: #1a1a2e;
            color: #e5e7eb;
            border-color: #333;
        }
        
        .chart-run-box.on-chart.peak-one {
            background: #3d3012;
            color: #fbbf24;
            border-color: #6b5c1f;
            box-shadow: 0 0 8px rgba(251, 191, 36, 0.3);
        }
        
        .chart-run-box.absent {
            color: #555;
        }
        
        .chart-run-box.absent.consolidated {
            background: #2a2a2a;
            color: #888;
            font-size: 11px;
            padding: 4px 8px;
            cursor: default;
        }
        
        .chart-run-stats {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
        }
        
        .chart-run-stat {
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            border-radius: 8px;
            padding: 10px 14px;
            text-align: center;
        }
        
        .chart-run-stat-label {
            font-size: 0.75rem;
            color: #888;
            margin-bottom: 4px;
        }
        
        .chart-run-stat-value {
            font-size: 1.1rem;
            font-weight: bold;
            color: #fff;
        }
    </style>
    
    <!-- Image Modal -->
    <th:block th:replace="~{fragments/image-modal :: image-modal}"></th:block>
    
    <script th:inline="javascript">
        /*<![CDATA[*/
        const albumId = /*[[${album.id}]]*/ null;
        const activeTab = /*[[${activeTab}]]*/ 'general';
        const hasChartHistory = /*[[${chartHistory != null and !chartHistory.isEmpty()}]]*/ false;
        
        // Make album image clickable to open modal
        document.addEventListener('DOMContentLoaded', function() {
            const albumImage = document.getElementById('albumImage');
            if (albumImage) {
                albumImage.classList.add('clickable');
                albumImage.addEventListener('click', function() {
                    openImageModal(this.src);
                });
            }
            
            // Load album chart run if on chart-history tab and has chart history
            if (activeTab === 'chart-history' && hasChartHistory && albumId) {
                loadAlbumChartRun();
            }
        });
        
        // Load album chart run data
        async function loadAlbumChartRun() {
            const container = document.getElementById('albumChartRunContainer');
            if (!container) return;
            
            try {
                const response = await fetch(`/charts/album/${albumId}/run`);
                if (!response.ok) throw new Error('Failed to load chart run');
                
                const data = await response.json();
                container.innerHTML = renderAlbumChartRun(data);
            } catch (error) {
                console.error('Error loading album chart run:', error);
                container.innerHTML = '<div style="color: #f87171;">Failed to load chart run data</div>';
            }
        }
        
        // Helper to consolidate consecutive absent weeks into a single box
        function consolidateAbsentWeeks(weeks) {
            const result = [];
            let i = 0;
            while (i < weeks.length) {
                if (weeks[i].onChart) {
                    result.push(weeks[i]);
                    i++;
                } else {
                    // Count consecutive absent weeks
                    let count = 0;
                    let startIdx = i;
                    while (i < weeks.length && !weeks[i].onChart) {
                        count++;
                        i++;
                    }
                    // Create a consolidated absent entry
                    result.push({
                        onChart: false,
                        consolidated: true,
                        count: count,
                        periodKey: weeks[startIdx].periodKey
                    });
                }
            }
            return result;
        }
        
        // Render album chart run HTML
        function renderAlbumChartRun(data) {
            if (!data.weeks || data.weeks.length === 0) {
                return '<div style="color: #888;">No chart run data available</div>';
            }
            
            const consolidatedWeeks = consolidateAbsentWeeks(data.weeks);
            let boxesHtml = consolidatedWeeks.map(week => {
                let classes = 'chart-run-box';
                if (week.onChart) {
                    classes += ' on-chart';
                    if (week.position === 1) classes += ' peak-one';
                    const tooltip = week.dateRange || week.periodKey;
                    return `<a href="/charts/weekly/${week.periodKey}" class="${classes}" title="${tooltip}">${week.display}</a>`;
                } else {
                    classes += ' absent consolidated';
                    return `<span class="${classes}" title="${week.count} weeks off chart">${week.count}√ó</span>`;
                }
            }).join('');
            
            return `
                <div class="chart-run-header">
                    Chart-run: <a href="/albums/${data.albumId}">${data.albumName}</a> by ${data.artistName}
                </div>
                <div class="chart-run-boxes">
                    ${boxesHtml}
                </div>
                <div class="chart-run-stats">
                    <div class="chart-run-stat">
                        <div class="chart-run-stat-label">Top 1</div>
                        <div class="chart-run-stat-value">${data.weeksAtTop1}</div>
                    </div>
                    <div class="chart-run-stat">
                        <div class="chart-run-stat-label">Top 5</div>
                        <div class="chart-run-stat-value">${data.weeksAtTop5}</div>
                    </div>
                    <div class="chart-run-stat">
                        <div class="chart-run-stat-label">Top 10</div>
                        <div class="chart-run-stat-value">${data.weeksAtTop10}</div>
                    </div>
                </div>
            `;
        }
        
        // Initialize Flatpickr on releaseDate input
        document.addEventListener('DOMContentLoaded', function() {
            const releaseDateInput = document.getElementById('releaseDate');
            if (releaseDateInput) {
                flatpickr(releaseDateInput, {
                    dateFormat: 'd/m/Y',
                    allowInput: true,
                    theme: 'dark'
                });
            }
        });
        /*]]>*/
    </script>
</body>
</html>
