<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${song.name} + ' - Music Stats'">Song Detail</title>
    <!-- Load global styles first so fragment styles are layered predictably -->
    <link rel="stylesheet" th:href="@{/css/global.css}">
    <th:block th:replace="~{fragments/navigation :: nav-styles}"></th:block>
    <link rel="stylesheet" th:href="@{/css/catalog-list.css}">
    <link rel="stylesheet" th:href="@{/css/song-detail.css}">
    <link rel="stylesheet" th:href="@{/css/top-tables.css}">
    <link rel="stylesheet" th:href="@{/css/detail-tabs.css}">
    <!-- Flatpickr Date Picker -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script th:src="@{/js/table-sort.js}" defer></script>
    <script th:src="@{/js/searchable-select.js}" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation"></script>
    <style>
        /* Highlight for externally fetched data - uses gender colors */
        .field-highlight {
            box-shadow: 0 0 8px 2px #4CAF50 !important;
            border-color: #4CAF50 !important;
        }
        .gender-male .field-highlight {
            box-shadow: 0 0 8px 2px #4a90d9 !important;
            border-color: #4a90d9 !important;
        }
        .gender-female .field-highlight {
            box-shadow: 0 0 8px 2px #d94a8a !important;
            border-color: #d94a8a !important;
        }
    </style>
</head>
<body>
    <th:block th:replace="~{fragments/navigation :: navigation}"></th:block>
    <div class="container-wide" th:classappend="${artistGender != null and artistGender.toLowerCase().contains('male') and !artistGender.toLowerCase().contains('female')} ? 'gender-male' : (${artistGender != null and artistGender.toLowerCase().contains('female')} ? 'gender-female' : '')">
        <div class="detail-grid">
            <!-- Left column: Image with name overlay -->
            <div class="detail-sidebar">
                <div class="item-name-overlay">
                    <h1 class="item-name-top">
                        <span th:if="${song.inItunes != null}" 
                              th:classappend="${song.inItunes ? 'in-itunes' : 'not-in-itunes'}"
                              class="itunes-badge"
                              th:title="${song.inItunes ? 'In iTunes Library' : 'Not in iTunes Library'}"
                              th:text="${song.inItunes ? '‚úì' : '‚úó'}"></span><span th:text="${song.name}">Song Name</span>
                        <span th:if="${song.isSingle}" class="single-indicator" title="Single">üîπ</span>
                    </h1>
                    <div class="song-metadata" style="font-size: 0.9em; font-weight: normal; margin-top: 10px; color: #ccc; line-height: 1.6;">
                        <div th:if="${artistName != null}">
                            <a th:href="@{'/artists/' + ${song.artistId}}" style="color: #e5e7eb; text-decoration: none; transition: color 0.2s;" 
                               onmouseover="this.style.color='#fff'" onmouseout="this.style.color='#e5e7eb'"
                               th:text="${artistName}"></a>
                        </div>
                        <div th:if="${albumName != null}" style="margin-top: 6px;">
                            <a th:href="@{'/albums/' + ${song.albumId}}" style="color: #e5e7eb; text-decoration: none; transition: color 0.2s;"
                               onmouseover="this.style.color='#fff'" onmouseout="this.style.color='#e5e7eb'"
                               th:text="${albumName}"></a>
                        </div>
                    </div>
                </div>
                <div class="item-image-container">
                    <!-- Gallery Navigation Arrows -->
                    <button type="button" class="gallery-nav gallery-nav-left" id="galleryPrev" onclick="galleryNavigate(-1)" style="display: none;">
                        ‚ùÆ
                    </button>
                    <button type="button" class="gallery-nav gallery-nav-right" id="galleryNext" onclick="galleryNavigate(1)" style="display: none;">
                        ‚ùØ
                    </button>

                    <img th:if="${hasImage}"
                         th:src="@{'/songs/' + ${song.id} + '/image'}"
                         th:alt="${song.name}"
                         id="songImage"
                         class="item-image-large clickable-image"
                         onclick="openSongImageModal()"
                         style="cursor: pointer;">
                      <span th:if="${song.lengthFormatted != null and !#strings.isEmpty(song.lengthFormatted)}"
                          class="length-overlay"
                          th:text="${song.lengthFormatted}"></span>
                    <img th:if="${!hasImage and song.albumId != null}"
                         th:src="@{'/albums/' + ${song.albumId} + '/image'}"
                         th:alt="${song.name}"
                         id="albumImage"
                         class="item-image-large clickable-image"
                         style="cursor: pointer;"
                         onclick="openSongImageModal()"
                         onerror="this.style.display='none'; document.getElementById('noImagePlaceholder').style.display='flex';">
                    <div th:if="${!hasImage and song.albumId == null}" class="no-image-large" id="noImagePlaceholder">
                        <span>üéµ</span>
                    </div>
                    <div th:if="${!hasImage and song.albumId != null}" class="no-image-large" id="noImagePlaceholder" style="display: none;">
                        <span>üéµ</span>
                    </div>

                    <span class="flag-overlay" th:if="${artistCountry != null and @countryCodeMapper.getCode(artistCountry) != null}"
                          th:title="${artistCountry}">
                        <img th:src="@{https://flagcdn.com/w40/{code}.png(code=${@countryCodeMapper.getCode(artistCountry)})}"
                             th:alt="${artistCountry}" />
                    </span>

                    <!-- Image Counter -->
                    <div class="gallery-counter" id="galleryCounter" style="display: none;">
                        <span id="currentImageIndex">1</span> / <span id="totalImageCount">1</span>
                    </div>

                    <div class="image-upload-overlay">
                        <input type="file" autocomplete="off" id="imageInput" accept="image/*" style="display: none;" onchange="handleImageUpload(event)">
                        <button type="button" class="btn-upload-image" id="btnUploadImage" onclick="document.getElementById('imageInput').click()">
                            Upload
                        </button>
                        <button type="button" class="btn-fetch-external" id="btnFetchExternal" 
                                th:attr="data-artist=${artistName},data-song=${song.name},data-id=${song.id},data-has-image=${hasImage}"
                                onclick="openExternalFetchFromButton(this, 'song', 'image')">
                            Fetch
                        </button>
                        <button type="button" class="btn-remove-image" id="btnRemoveMain" th:if="${hasImage}" onclick="removeImage()">
                            Remove
                        </button>
                        <!-- Gallery-specific buttons -->
                        <button type="button" class="btn-set-default" id="btnSetDefault" onclick="setAsDefaultImage()" style="display: none;">
                            Default
                        </button>
                        <button type="button" class="btn-remove-gallery" id="btnRemoveGallery" onclick="removeGalleryImage()" style="display: none;">
                            Remove
                        </button>
                    </div>
                </div>
                
                <div class="item-stats">
                    <div class="stat" title="Primary plays">
                        <span class="stat-icon primary-plays">‚èµ</span>
                        <span class="stat-value" th:text="${songVatitoPlayCount != null ? songVatitoPlayCount : 0}">0</span>
                    </div>
                    <div class="stat" title="Legacy plays">
                        <span class="stat-icon legacy-plays">‚èµ</span>
                        <span class="stat-value" th:text="${songRobertloverPlayCount != null ? songRobertloverPlayCount : 0}">0</span>
                    </div>
                    <div class="stat" title="Total plays">
                        <span class="stat-icon total-plays">‚èµ</span>
                        <span class="stat-value" th:text="${songPlayCount != null ? songPlayCount : 0}">0</span>
                    </div>
                </div>
                
                <!-- All Chips - Flowing Together -->
                <div class="winning-chips" style="margin-top: 15px; padding: 0 10px;">
                    <!-- GROUP 1: Overall & Artist/Album Rankings -->
                    <!-- Overall Position -->
                    <a th:if="${overallPosition != null}"
                       th:href="@{/songs}"
                       target="_blank"
                       class="winning-chip rank-chip overall"
                       th:text="'#' + ${overallPosition} + ' overall'"
                       th:title="'Rank #' + ${overallPosition} + ' among all songs'"></a>

                    <!-- Position Among Artist's Songs -->
                    <a th:if="${rankByArtist != null and artistName != null}"
                       th:href="@{'/artists/' + ${song.artistId}}"
                       target="_blank"
                       class="winning-chip rank-chip artist-rank"
                       th:text="'#' + ${rankByArtist} + ' ' + ${artistName} + ' song'"
                       th:title="'Rank #' + ${rankByArtist} + ' among all ' + ${artistName} + ' songs'"></a>

                    <!-- Position Among Album's Songs -->
                    <a th:if="${rankByAlbum != null and albumName != null and song.albumId != null}"
                       th:href="@{'/albums/' + ${song.albumId}}"
                       target="_blank"
                       class="winning-chip rank-chip album-rank"
                       th:text="'#' + ${rankByAlbum} + ' ' + ${albumName} + ' song'"
                       th:title="'Rank #' + ${rankByAlbum} + ' among all songs in ' + ${albumName}"></a>

                    <!-- GROUP 2: Catalog Rankings (Gender > Genre > Subgenre > Ethnicity > Country > Language) -->
                    <div class="chip-group-separator"></div>
                    
                    <!-- Gender Rank -->
                    <a th:if="${rankByGender != null and artist != null and artist.genderId != null}" 
                       th:href="@{/graphs(filterType='gender',filterId=${artist.genderId},filterName=${genders.get(artist.genderId)})}"
                       target="_blank"
                       class="winning-chip rank-chip gender"
                       th:classappend="${genders.get(artist.genderId) != null and genders.get(artist.genderId).toLowerCase().contains('female')} ? 'female' : (${genders.get(artist.genderId) != null and genders.get(artist.genderId).toLowerCase().contains('male')} ? 'male' : '')"
                       th:text="'#' + ${rankByGender} + ' ' + ${genders.get(artist.genderId)}" 
                       th:title="'Rank #' + ${rankByGender} + ' among songs by ' + ${genders.get(artist.genderId)} + ' artists'"></a>
                    
                    <!-- Genre Rank -->
                    <a th:if="${rankByGenre != null and (song.overrideGenreId != null or (album != null and album.overrideGenreId != null) or (artist != null and artist.genreId != null))}" 
                       th:href="@{/graphs(filterType='genre',filterId=${song.overrideGenreId != null ? song.overrideGenreId : (album != null and album.overrideGenreId != null ? album.overrideGenreId : artist.genreId)},filterName=${genres.get(song.overrideGenreId != null ? song.overrideGenreId : (album != null and album.overrideGenreId != null ? album.overrideGenreId : artist.genreId))})}"
                       target="_blank"
                       class="winning-chip rank-chip genre" 
                       th:text="'#' + ${rankByGenre} + ' ' + ${genres.get(song.overrideGenreId != null ? song.overrideGenreId : (album != null and album.overrideGenreId != null ? album.overrideGenreId : artist.genreId))}" 
                       th:title="'Rank #' + ${rankByGenre} + ' among ' + ${genres.get(song.overrideGenreId != null ? song.overrideGenreId : (album != null and album.overrideGenreId != null ? album.overrideGenreId : artist.genreId))} + ' songs'"></a>
                    
                    <!-- Subgenre Rank -->
                    <a th:if="${rankBySubgenre != null and (song.overrideSubgenreId != null or (album != null and album.overrideSubgenreId != null) or (artist != null and artist.subgenreId != null))}" 
                       th:href="@{/graphs(filterType='subgenre',filterId=${song.overrideSubgenreId != null ? song.overrideSubgenreId : (album != null and album.overrideSubgenreId != null ? album.overrideSubgenreId : artist.subgenreId)},filterName=${subgenres.get(song.overrideSubgenreId != null ? song.overrideSubgenreId : (album != null and album.overrideSubgenreId != null ? album.overrideSubgenreId : artist.subgenreId))})}"
                       target="_blank"
                       class="winning-chip rank-chip subgenre" 
                       th:text="'#' + ${rankBySubgenre} + ' ' + ${subgenres.get(song.overrideSubgenreId != null ? song.overrideSubgenreId : (album != null and album.overrideSubgenreId != null ? album.overrideSubgenreId : artist.subgenreId))}" 
                       th:title="'Rank #' + ${rankBySubgenre} + ' among ' + ${subgenres.get(song.overrideSubgenreId != null ? song.overrideSubgenreId : (album != null and album.overrideSubgenreId != null ? album.overrideSubgenreId : artist.subgenreId))} + ' songs'"></a>
                    
                    <!-- Ethnicity Rank -->
                    <a th:if="${rankByEthnicity != null and artist != null and artist.ethnicityId != null}" 
                       th:href="@{/graphs(filterType='ethnicity',filterId=${artist.ethnicityId},filterName=${ethnicities.get(artist.ethnicityId)})}"
                       target="_blank"
                       class="winning-chip rank-chip ethnicity" 
                       th:text="'#' + ${rankByEthnicity} + ' ' + ${ethnicities.get(artist.ethnicityId)}" 
                       th:title="'Rank #' + ${rankByEthnicity} + ' among songs by ' + ${ethnicities.get(artist.ethnicityId)} + ' artists'"></a>
                    
                    <!-- Language Rank -->
                    <a th:if="${rankByLanguage != null and (song.overrideLanguageId != null or (album != null and album.overrideLanguageId != null) or (artist != null and artist.languageId != null))}" 
                       th:href="@{/graphs(filterType='language',filterId=${song.overrideLanguageId != null ? song.overrideLanguageId : (album != null and album.overrideLanguageId != null ? album.overrideLanguageId : artist.languageId)},filterName=${languages.get(song.overrideLanguageId != null ? song.overrideLanguageId : (album != null and album.overrideLanguageId != null ? album.overrideLanguageId : artist.languageId))})}"
                       target="_blank"
                       class="winning-chip rank-chip language" 
                       th:text="'#' + ${rankByLanguage} + ' ' + ${languages.get(song.overrideLanguageId != null ? song.overrideLanguageId : (album != null and album.overrideLanguageId != null ? album.overrideLanguageId : artist.languageId))}" 
                       th:title="'#' + ${rankByLanguage} + ' among ' + ${languages.get(song.overrideLanguageId != null ? song.overrideLanguageId : (album != null and album.overrideLanguageId != null ? album.overrideLanguageId : artist.languageId))} + ' songs'"></a>
                    
                    <!-- Spanish Rap Rank (special combination) -->
                    <a th:if="${rankBySpanishRap != null}"
                       th:href="@{/graphs(genre=${rapGenreId},genreMode='includes',language=${spanishLanguageId},languageMode='includes')}"
                       target="_blank"
                       class="winning-chip rank-chip spanish-rap"
                       th:text="'#' + ${rankBySpanishRap} + ' Spanish Rap'"
                       th:title="'Rank #' + ${rankBySpanishRap} + ' among Spanish Rap songs'"></a>

                    <!-- Country Rank -->
                    <a th:if="${rankByCountry != null and artist != null and artist.country != null}" 
                       th:href="@{/graphs(country=${artist.country},countryMode='includes')}"
                       target="_blank"
                       class="winning-chip rank-chip country" 
                       th:text="'#' + ${rankByCountry} + ' ' + ${artist.country}" 
                       th:title="'Rank #' + ${rankByCountry} + ' among songs by ' + ${artist.country} + ' artists'"></a>
                    
                    <!-- GROUP 3: Year-Based Rankings (Release Year, then Listened in Year) -->
                    <div class="chip-group-separator" th:if="${rankByReleaseYear != null or (ranksByYear != null and !ranksByYear.isEmpty())}"></div>
                    
                    <!-- Position by Release Year -->
                    <a th:if="${rankByReleaseYear != null and releaseYear != null}"
                       th:href="@{/graphs(releaseDateEntity=song,releaseDateMode=between,releaseDateFrom=${releaseYear + '-01-01'},releaseDateTo=${releaseYear + '-12-31'})}"
                       target="_blank"
                       class="winning-chip rank-chip release-year"
                       th:text="'#' + ${rankByReleaseYear} + ' released in ' + ${releaseYear}"
                       th:title="'Rank #' + ${rankByReleaseYear} + ' among songs released in ' + ${releaseYear}"></a>
                    
                    <!-- Year Ranks (only if <= 100) -->
                    <a th:each="yearEntry : ${ranksByYear}" 
                       th:if="${yearEntry.value != null and yearEntry.value <= 100}"
                       th:href="@{/graphs(listenedDateFrom=${yearEntry.key} + '-01-01',listenedDateTo=${yearEntry.key} + '-12-31')}"
                       target="_blank"
                       class="winning-chip rank-chip year-rank" 
                       th:text="'#' + ${yearEntry.value} + ' most listened in ' + ${yearEntry.key}" 
                       th:title="'Rank #' + ${yearEntry.value} + ' most listened song in year ' + ${yearEntry.key}"></a>
                    
                    <!-- GROUP 4: Chart-Based Rankings (Weekly > Seasonal > Yearly) -->
                    <div class="chip-group-separator" th:if="${(weeklyChartStats != null and weeklyChartStats.hasCharted()) or (seasonalChartHistory != null and !seasonalChartHistory.isEmpty()) or (yearlyChartHistory != null and !yearlyChartHistory.isEmpty())}"></div>
                    
                    <!-- Weekly Chart Stats -->
                    <span th:if="${weeklyChartStats != null and weeklyChartStats.hasCharted()}"
                          class="winning-chip rank-chip chart-stats"
                          th:text="${weeklyChartStats.totalWeeks} + ' weeks (Peak #' + ${weeklyChartStats.peakPosition} + ' for ' + ${weeklyChartStats.weeksAtPeak} + (${weeklyChartStats.weeksAtPeak} == 1 ? ' week)' : ' weeks)')"
                          th:title="'Spent ' + ${weeklyChartStats.totalWeeks} + ' weeks on the weekly chart with a peak of #' + ${weeklyChartStats.peakPosition}">
                    </span>
                    
                    <!-- Seasonal Chart Placements -->
                    <a th:each="entry : ${seasonalChartHistory}" 
                       th:href="@{/charts/seasonal/{pk}(pk=${entry.periodKey})}"
                       target="_blank"
                       class="winning-chip chart-chip seasonal-chart">
                        <span th:if="${#strings.contains(entry.displayName, 'Winter')}">‚ùÑÔ∏è</span>
                        <span th:if="${#strings.contains(entry.displayName, 'Spring')}">üå∏</span>
                        <span th:if="${#strings.contains(entry.displayName, 'Summer')}">‚òÄÔ∏è</span>
                        <span th:if="${#strings.contains(entry.displayName, 'Fall')}">üçÇ</span>
                        <span th:text="${entry.displayName}"></span>
                    </a>
                    
                    <!-- Yearly Chart Placements -->
                    <a th:each="entry : ${yearlyChartHistory}" 
                       th:href="@{/charts/yearly/{pk}(pk=${entry.periodKey})}"
                       target="_blank"
                       class="winning-chip chart-chip yearly-chart"
                       th:text="${entry.displayName}"></a>
                </div>
            </div>
            
            <!-- Tab Navigation -->
            <div class="detail-tabs">
                <a th:href="@{'/songs/' + ${song.id}}" 
                   th:classappend="${activeTab == 'general' or activeTab == null} ? 'active' : ''"
                   class="detail-tab">General</a>
                <a th:href="@{'/songs/' + ${song.id} + '?tab=plays'}" 
                   th:classappend="${activeTab == 'plays'} ? 'active' : ''"
                   class="detail-tab">Plays</a>
                <a th:href="@{'/songs/' + ${song.id} + '?tab=featured'}" 
                   th:classappend="${activeTab == 'featured'} ? 'active' : ''"
                   class="detail-tab">Featured Artists</a>
                <a th:href="@{'/songs/' + ${song.id} + '?tab=chart-history'}" 
                   th:classappend="${activeTab == 'chart-history'} ? 'active' : ''"
                   class="detail-tab">Chart History</a>
            </div>
            
            <!-- Right side: Stacked cards layout for General and Statistics -->
            <div class="detail-right-section" th:if="${activeTab == 'general' or activeTab == null}">
                <!-- General Section (Left) -->
                <div class="detail-content-card">
                    <div class="section-header">
                        <h2 class="section-title">General</h2>
                        <div class="edit-button-container">
                            <button type="button" class="btn-action" id="editBtn" onclick="toggleEdit()">Edit</button>
                            <button type="button" class="btn-negative" id="deleteBtn" 
                                    th:disabled="${songPlayCount > 0}"
                                    th:title="${songPlayCount > 0 ? 'Cannot delete song with existing plays' : 'Delete this song'}"
                                    onclick="confirmDelete()">Delete</button>
                        </div>
                    </div>
                    
                    <form method="post" th:action="@{'/songs/' + ${song.id}}" th:object="${song}" id="songForm">
                        <input type="hidden" id="artistId" name="artistId" th:field="*{artistId}" />
                            <input type="hidden" id="songNameHidden" th:value="${song.name}" />
                            <input type="hidden" id="artistNameHidden" th:value="${artistName}" />
                            <input type="hidden" id="albumNameHidden" th:value="${albumName}" />
                        
                        <div class="form-section">
                            <div class="attributes-grid">
                                <!-- Name field (editable, only shown in edit mode) -->
                                <div class="form-group form-group-full-width name-field-group" id="nameFieldGroup" style="display:none;">
                                    <label for="name">Name</label>
                                    <span class="attribute-text" data-field="name" th:text="${song.name}" style="display:none;">Song Name</span>
                                    <input type="text" autocomplete="off" id="name" name="name" th:field="*{name}" class="editable-input" />
                                </div>
                                
                                <!-- Album field (editable dropdown, only shown in edit mode) -->
                                <div class="form-group form-group-full-width album-field-group" id="albumFieldGroup" style="display:none;">
                                    <label for="albumId">Album</label>
                                    <span class="attribute-text" data-field="albumId" style="display:none;">
                                        <a th:if="${albumName != null}" th:href="@{'/albums/' + ${song.albumId}}" th:text="${albumName}"></a>
                                        <span th:if="${albumName == null}">-</span>
                                    </span>
                                    <select id="albumId" name="albumId">
                                        <option value="">No album (single)</option>
                                        <!-- Albums will be loaded via JavaScript -->
                                    </select>
                                </div>
                                
                                <!-- Column 1: Release Date, First/Last Listened, Length -->
                                <div class="form-group">
                                    <label for="releaseDate">Release Date</label>
                                    <span class="attribute-text" data-field="releaseDate"
                                          th:classappend="${song.releaseDateFormatted != null ? 'attribute-overridden' : (albumReleaseDate != null ? 'attribute-inherited' : '')}">
                                        <th:block th:if="${song.releaseDateFormatted != null}" th:text="${song.releaseDateFormatted}"></th:block>
                                        <th:block th:if="${song.releaseDateFormatted == null and albumReleaseDate != null}" th:text="${albumReleaseDate}"></th:block>
                                        <th:block th:if="${song.releaseDateFormatted == null and albumReleaseDate == null}">-</th:block>
                                        <th:block th:if="${artist != null and artist.birthDate != null and (song.releaseDate != null or (album != null and album.releaseDate != null))}">
                                            <th:block th:with="effectiveReleaseDate=${song.releaseDate != null ? song.releaseDate : album.releaseDate}">
                                                <th:block th:if="${artist.deathDate != null and effectiveReleaseDate.toLocalDate().isAfter(artist.deathDate)}">
                                                    <span class="release-age-text">(Posthumous)</span>
                                                </th:block>
                                                <th:block th:if="${artist.deathDate == null or !effectiveReleaseDate.toLocalDate().isAfter(artist.deathDate)}"
                                                          th:with="ageAtRelease=${T(java.time.temporal.ChronoUnit).YEARS.between(artist.birthDate, effectiveReleaseDate.toLocalDate())}">
                                                    <span class="release-age-text" th:text="' (at ' + ${ageAtRelease} + ' years old)'"></span>
                                                </th:block>
                                            </th:block>
                                        </th:block>
                                    </span>
                                    <input type="text" autocomplete="off"
                                           id="releaseDate" 
                                           name="releaseDate" 
                                           th:value="${song.releaseDateInput != null ? song.releaseDateInput : ''}" 
                                           placeholder="dd/MM/yyyy"
                                           pattern="\d{2}/\d{2}/\d{4}"
                                           class="editable-input"
                                           style="display:none;" />
                                </div>
                                
                                <!-- Column 2: Genre, Subgenre, Language, Country, Ethnicity -->
                                <div class="form-group">
                                    <label for="overrideGenreId">
                                        <span class="label-view">Genre</span>
                                        <span class="label-edit" style="display:none;">Genre Override</span>
                                    </label>
                                    <span class="attribute-text" data-field="overrideGenreId"
                                          th:classappend="${song.overrideGenreId != null ? 'attribute-overridden' : 'attribute-inherited'}"
                                          th:text="${song.overrideGenreId != null ? genres.get(song.overrideGenreId) : (effectiveGenreName != null ? effectiveGenreName : '-')}">-</span>
                                    <select id="overrideGenreId" name="overrideGenreId" disabled style="display:none;">
                                        <option value="" th:selected="${song.overrideGenreId == null}" th:text="'Inherit (' + (${inheritedGenreName} != null ? ${inheritedGenreName} : 'none') + ')'">Inherit</option>
                                        <option th:each="entry : ${genres}" 
                                                th:value="${entry.key}" 
                                                th:selected="${song.overrideGenreId != null and song.overrideGenreId.equals(entry.key)}"
                                                th:text="${entry.value}"></option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label>First Listened Date</label>
                                    <span class="attribute-text" th:text="${firstListenedDate}">-</span>
                                </div>
                                
                                <div class="form-group">
                                    <label for="overrideSubgenreId">
                                        <span class="label-view">Subgenre</span>
                                        <span class="label-edit" style="display:none;">Subgenre Override</span>
                                    </label>
                                    <span class="attribute-text" data-field="overrideSubgenreId"
                                          th:classappend="${song.overrideSubgenreId != null ? 'attribute-overridden' : 'attribute-inherited'}"
                                          th:text="${song.overrideSubgenreId != null ? subgenres.get(song.overrideSubgenreId) : (effectiveSubgenreName != null ? effectiveSubgenreName : '-')}">-</span>
                                    <select id="overrideSubgenreId" name="overrideSubgenreId" disabled style="display:none;">
                                        <option value="" th:selected="${song.overrideSubgenreId == null}" th:text="'Inherit (' + (${inheritedSubgenreName} != null ? ${inheritedSubgenreName} : 'none') + ')'">Inherit</option>
                                        <option th:each="entry : ${subgenres}" 
                                                th:value="${entry.key}" 
                                                th:selected="${song.overrideSubgenreId != null and song.overrideSubgenreId.equals(entry.key)}"
                                                th:text="${entry.value}"></option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label>Last Listened Date</label>
                                    <span class="attribute-text" th:text="${lastListenedDate}">-</span>
                                </div>
                                
                                <div class="form-group">
                                    <label for="overrideLanguageId">
                                        <span class="label-view">Language</span>
                                        <span class="label-edit" style="display:none;">Language Override</span>
                                    </label>
                                    <span class="attribute-text" data-field="overrideLanguageId"
                                          th:classappend="${song.overrideLanguageId != null ? 'attribute-overridden' : 'attribute-inherited'}"
                                          th:text="${song.overrideLanguageId != null ? languages.get(song.overrideLanguageId) : (effectiveLanguageName != null ? effectiveLanguageName : '-')}">-</span>
                                    <select id="overrideLanguageId" name="overrideLanguageId" disabled style="display:none;">
                                        <option value="" th:selected="${song.overrideLanguageId == null}" th:text="'Inherit (' + (${inheritedLanguageName} != null ? ${inheritedLanguageName} : 'none') + ')'">Inherit</option>
                                        <option th:each="entry : ${languages}" 
                                                th:value="${entry.key}" 
                                                th:selected="${song.overrideLanguageId != null and song.overrideLanguageId.equals(entry.key)}"
                                                th:text="${entry.value}"></option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label for="lengthFormatted">Length</label>
                                    <span class="attribute-text" data-field="lengthFormatted">
                                        <th:block th:if="${song.lengthSeconds != null}">
                                            <th:block th:with="minutes=${song.lengthSeconds / 60}, seconds=${song.lengthSeconds % 60}">
                                                <span th:text="${#numbers.formatInteger(minutes, 1) + ':' + #numbers.formatInteger(seconds, 2, 'NONE')}"></span>
                                            </th:block>
                                        </th:block>
                                        <th:block th:if="${song.lengthSeconds == null}">-</th:block>
                                    </span>
                                    <input type="text" autocomplete="off"
                                           id="lengthFormatted" 
                                           class="editable-input"
                                           placeholder="mm:ss"
                                           pattern="[0-9]{1,2}:[0-5][0-9]"
                                           style="display:none;" />
                                    <input type="hidden" id="lengthSeconds" name="lengthSeconds" th:value="${song.lengthSeconds}" />
                                </div>
                                
                                <div class="form-group view-only-field">
                                    <label>Country</label>
                                    <span class="attribute-text attribute-inherited" th:text="${artistCountry != null ? artistCountry : '-'}">-</span>
                                </div>
                                
                                <div class="form-group form-group-checkbox">
                                    <label class="field-label label-view">Is Single</label>
                                    <span class="attribute-text" data-field="isSingle" 
                                          th:classappend="${song.isSingle != null and song.isSingle ? 'checkbox-yes' : 'checkbox-no'}"
                                          th:text="${song.isSingle != null and song.isSingle ? '‚úì Yes' : '‚Äî No'}">‚Äî No</span>
                                    <label class="inline-checkbox-label" style="display:none;">
                                        <input type="checkbox" autocomplete="off" id="isSingle" name="isSingle" th:field="*{isSingle}" />
                                        Is Single
                                    </label>
                                </div>
                                
                                <div class="form-group">
                                    <label for="overrideEthnicityId">
                                        <span class="label-view">Ethnicity</span>
                                        <span class="label-edit" style="display:none;">Ethnicity Override</span>
                                    </label>
                                    <span class="attribute-text" data-field="overrideEthnicityId"
                                          th:classappend="${song.overrideEthnicityId != null ? 'attribute-overridden' : 'attribute-inherited'}"
                                          th:text="${song.overrideEthnicityId != null ? ethnicities.get(song.overrideEthnicityId) : (effectiveEthnicityName != null ? effectiveEthnicityName : '-')}">-</span>
                                    <select id="overrideEthnicityId" name="overrideEthnicityId" disabled style="display:none;">
                                        <option value="" th:selected="${song.overrideEthnicityId == null}" th:text="'Inherit (' + (${inheritedEthnicityName} != null ? ${inheritedEthnicityName} : 'none') + ')'">Inherit</option>
                                        <option th:each="entry : ${ethnicities}" 
                                                th:value="${entry.key}" 
                                                th:selected="${song.overrideEthnicityId != null and song.overrideEthnicityId.equals(entry.key)}"
                                                th:text="${entry.value}"></option>
                                    </select>
                                </div>
                                
                                <div class="form-group form-group-checkbox">
                                    <label class="field-label label-view">Organized</label>
                                    <span class="attribute-text" data-field="organized" 
                                          th:classappend="${song.organized != null and song.organized ? 'checkbox-yes' : 'checkbox-no'}"
                                          th:text="${song.organized != null and song.organized ? '‚úì Yes' : '‚Äî No'}">‚Äî No</span>
                                    <label class="inline-checkbox-label" style="display:none;">
                                        <input type="checkbox" autocomplete="off" id="organized" name="organized" th:field="*{organized}" />
                                        Organized
                                    </label>
                                </div>
                                
                                <div class="form-group">
                                    <label for="overrideGenderId">
                                        <span class="label-view">Gender</span>
                                        <span class="label-edit" style="display:none;">Gender Override</span>
                                    </label>
                                    <span class="attribute-text" data-field="overrideGenderId"
                                          th:classappend="${song.overrideGenderId != null ? 'attribute-overridden' : 'attribute-inherited'}"
                                          th:text="${song.overrideGenderId != null ? genders.get(song.overrideGenderId) : (effectiveGenderName != null ? effectiveGenderName : '-')}">-</span>
                                    <select id="overrideGenderId" name="overrideGenderId" disabled style="display:none;">
                                        <option value="" th:selected="${song.overrideGenderId == null}" th:text="'Inherit (' + (${inheritedGenderName} != null ? ${inheritedGenderName} : 'none') + ')'">Inherit</option>
                                        <option th:each="entry : ${genders}" 
                                                th:value="${entry.key}" 
                                                th:selected="${song.overrideGenderId != null and song.overrideGenderId.equals(entry.key)}"
                                                th:text="${entry.value}"></option>
                                    </select>
                                </div>
                                
                                <!-- Featured Artists field (spans full width) - only shown in edit mode -->
                                <div class="form-group form-group-full-width" id="featuredArtistsField" style="display:none;">
                                    <label>Featured Artists</label>
                                    <span class="attribute-text featured-artists-display" data-field="featuredArtists" style="display:none;">
                                        <th:block th:if="${featuredArtists != null and !featuredArtists.isEmpty()}">
                                            <th:block th:each="fa, stat : ${featuredArtists}">
                                                <a th:href="@{'/artists/' + ${fa.artistId}}" 
                                                   class="featured-artist-link"
                                                   th:text="${fa.artistName}"></a><th:block th:if="${!stat.last}">, </th:block>
                                            </th:block>
                                        </th:block>
                                        <th:block th:if="${featuredArtists == null or featuredArtists.isEmpty()}">-</th:block>
                                    </span>
                                    <!-- Featured Artists multi-select component (shown in edit mode) -->
                                    <div id="featuredArtistsContainer" class="featured-artists-container" style="display:none;">
                                        <div class="chips-input-wrapper">
                                            <div id="featuredArtistsChips" class="chips-container">
                                                <!-- Chips will be added here dynamically -->
                                            </div>
                                            <input type="text" 
                                                   id="featuredArtistsInput" 
                                                   class="chips-text-input"
                                                   placeholder="Search artists..."
                                                   autocomplete="off" />
                                        </div>
                                        <div id="featuredArtistsDropdown" class="chips-dropdown" style="display:none;">
                                            <!-- Search results will appear here -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-actions" id="formActions" style="display:none;">
                            <button type="submit" class="btn-action" onclick="clearAllHighlights()">Save</button>
                            <button type="button" class="btn-negative" onclick="clearAllHighlights(); cancelEdit()">Cancel</button>
                            <button type="button" class="btn-action" id="btnFetchItunes" onclick="fetchItunesData()" title="Fetch release date and length from local iTunes library">Local iTunes</button>
                            <button type="button" class="btn-fetch-external" id="btnFetchExternalMeta" 
                                    th:attr="data-artist=${artistName},data-song=${song.name},data-id=${song.id},data-has-image=${hasImage}"
                                    onclick="openSongExternalMetadataSearch()">External</button>
                        </div>
                    </form>
                </div>
                
                <!-- Statistics Section (Redesigned) -->
                <div class="detail-content-card">
                    <div class="section-header">
                        <h2 class="section-title">Statistics</h2>
                    </div>
                    
                    <!-- Hero Stat (Songs have only one hero stat) -->
                    <div class="stats-hero">
                        <div class="stat-hero-item" style="grid-column: 1 / -1;">
                            <span class="stat-label">Total Listening Time</span>
                            <span class="stat-value" th:text="${totalListeningTime}">0:00</span>
                        </div>
                    </div>
                    
                    <!-- Consistency Metrics -->
                    <div class="stats-consistency">
                        <div class="stat-mini">
                            <span class="stat-label">Days</span>
                            <span class="stat-value" th:text="${uniqueDaysPlayed}">0</span><span class="stat-value stat-total" th:text="' / ' + ${totalDaysSinceFirstPlay}"></span>
                        </div>
                        <div class="stat-mini">
                            <span class="stat-label">Weeks</span>
                            <span class="stat-value" th:text="${uniqueWeeksPlayed}">0</span><span class="stat-value stat-total" th:text="' / ' + ${totalWeeksSinceFirstPlay}"></span>
                        </div>
                        <div class="stat-mini">
                            <span class="stat-label">Months</span>
                            <span class="stat-value" th:text="${uniqueMonthsPlayed}">0</span><span class="stat-value stat-total" th:text="' / ' + ${totalMonthsSinceFirstPlay}"></span>
                        </div>
                        <div class="stat-mini">
                            <span class="stat-label">Years</span>
                            <span class="stat-value" th:text="${uniqueYearsPlayed}">0</span><span class="stat-value stat-total" th:text="' / ' + ${totalYearsSinceFirstPlay}"></span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Plays Tab Content -->
            <div class="plays-tab-content" th:if="${activeTab == 'plays'}">
                <!-- Plays by Year Chart -->
                <div class="detail-content-card plays-chart-section">
                    <h2 class="section-title">Plays by Year</h2>
                    <div class="chart-container">
                        <canvas id="playsByYearChart"></canvas>
                    </div>
                </div>
                
                <!-- Scrobbles Table -->
                <div class="detail-content-section">
                    <h2 class="section-title">Play History 
                        <span class="scrobble-count">(<span th:text="${scrobblesTotalCount}">0</span> plays)</span>
                    </h2>
                    
                    <!-- Top Pagination -->
                    <div class="pagination pagination-top" th:if="${scrobblesTotalPages > 1}">
                        <a th:href="@{'/songs/' + ${song.id} + '?tab=plays&playsPage=0'}"
                           th:classappend="${scrobblesPage == 0} ? 'disabled' : ''" class="page-link">&laquo; First</a>
                        <a th:href="@{'/songs/' + ${song.id} + '?tab=plays&playsPage=' + ${scrobblesPage - 1}}"
                           th:classappend="${scrobblesPage == 0} ? 'disabled' : ''" class="page-link">&lsaquo; Prev</a>
                        <span class="page-info">Page <span th:text="${scrobblesPage + 1}">1</span> of <span th:text="${scrobblesTotalPages}">1</span></span>
                        <a th:href="@{'/songs/' + ${song.id} + '?tab=plays&playsPage=' + ${scrobblesPage + 1}}"
                           th:classappend="${scrobblesPage >= scrobblesTotalPages - 1} ? 'disabled' : ''" class="page-link">Next &rsaquo;</a>
                        <a th:href="@{'/songs/' + ${song.id} + '?tab=plays&playsPage=' + ${scrobblesTotalPages - 1}}"
                           th:classappend="${scrobblesPage >= scrobblesTotalPages - 1} ? 'disabled' : ''" class="page-link">Last &raquo;</a>
                    </div>
                    
                    <div class="top-table-container">
                        <table class="top-table" id="scrobblesTable">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Account</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr th:each="scrobble : ${scrobbles}">
                                    <td th:text="${scrobble.scrobbleDate}">-</td>
                                    <td th:text="${scrobble.account}">-</td>
                                </tr>
                                <tr th:if="${scrobbles == null or scrobbles.isEmpty()}">
                                    <td colspan="2"><em>No plays recorded</em></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Bottom Pagination -->
                    <div class="pagination pagination-bottom" th:if="${scrobblesTotalPages > 1}">
                        <a th:href="@{'/songs/' + ${song.id} + '?tab=plays&playsPage=0'}"
                           th:classappend="${scrobblesPage == 0} ? 'disabled' : ''" class="page-link">&laquo; First</a>
                        <a th:href="@{'/songs/' + ${song.id} + '?tab=plays&playsPage=' + ${scrobblesPage - 1}}"
                           th:classappend="${scrobblesPage == 0} ? 'disabled' : ''" class="page-link">&lsaquo; Prev</a>
                        <span class="page-info">Page <span th:text="${scrobblesPage + 1}">1</span> of <span th:text="${scrobblesTotalPages}">1</span></span>
                        <a th:href="@{'/songs/' + ${song.id} + '?tab=plays&playsPage=' + ${scrobblesPage + 1}}"
                           th:classappend="${scrobblesPage >= scrobblesTotalPages - 1} ? 'disabled' : ''" class="page-link">Next &rsaquo;</a>
                        <a th:href="@{'/songs/' + ${song.id} + '?tab=plays&playsPage=' + ${scrobblesTotalPages - 1}}"
                           th:classappend="${scrobblesPage >= scrobblesTotalPages - 1} ? 'disabled' : ''" class="page-link">Last &raquo;</a>
                    </div>
                </div>
            </div>
            
            <!-- Featured Artists Tab Content -->
            <div class="featured-tab-content" th:if="${activeTab == 'featured'}">
                <div class="detail-content-card">
                    <h2 class="section-title">Featured Artists 
                        <span class="item-count">(<span th:text="${featuredArtistCards != null ? featuredArtistCards.size() : 0}">0</span>)</span>
                    </h2>
                    
                    <div th:if="${featuredArtistCards == null or featuredArtistCards.isEmpty()}" class="no-items-message">
                        <p>No featured artists for this song.</p>
                    </div>
                    
                    <div th:if="${featuredArtistCards != null and !featuredArtistCards.isEmpty()}" class="featured-artist-grid">
                        <div th:each="artist : ${featuredArtistCards}" 
                             class="featured-artist-card"
                             th:classappend="${artist.genderName != null and artist.genderName.toLowerCase().contains('male') and !artist.genderName.toLowerCase().contains('female')} ? 'gender-male' : (${artist.genderName != null and artist.genderName.toLowerCase().contains('female')} ? 'gender-female' : '')">
                            <a th:href="@{'/artists/' + ${artist.id}}" class="featured-artist-image item-image-container">
                                <img th:if="${artist.hasImage}"
                                     th:src="@{'/artists/' + ${artist.id} + '/image'}"
                                     th:alt="${artist.name}">
                                <div th:unless="${artist.hasImage}" class="no-image">
                                    <span th:text="${#strings.substring(artist.name, 0, 1)}"></span>
                                </div>
                                <span class="flag-overlay" th:if="${artist.country != null and @countryCodeMapper.getCode(artist.country) != null}"
                                      th:title="${artist.country}">
                                    <img th:src="@{https://flagcdn.com/w40/{code}.png(code=${@countryCodeMapper.getCode(artist.country)})}"
                                         th:alt="${artist.country}" />
                                </span>
                                <!-- Death indicator overlay -->
                                <span class="death-overlay" th:if="${artist.deathDate != null}" th:title="'Passed away on ' + ${#temporals.format(artist.deathDate, 'dd-MMM-yyyy')}">‚Ä†</span>
                            </a>
                            <div class="featured-artist-info">
                                <a th:href="@{'/artists/' + ${artist.id}}">
                                    <h3 class="featured-artist-name" th:text="${artist.name}">Artist Name</h3>
                                </a>
                                <div class="featured-artist-details" th:if="${artist.genderName != null or artist.ethnicityName != null}">
                                    <span th:if="${artist.genderName != null}" th:text="${artist.genderName}"></span>
                                    <span th:if="${artist.genderName != null and artist.ethnicityName != null}"> ‚Ä¢ </span>
                                    <span th:if="${artist.ethnicityName != null}" th:text="${artist.ethnicityName}"></span>
                                </div>
                                <div class="featured-artist-metadata" th:if="${artist.genreName != null or artist.country != null}">
                                    <span th:if="${artist.genreName != null}" th:text="${artist.genreName}"></span>
                                    <span th:if="${artist.genreName != null and artist.country != null}"> ‚Ä¢ </span>
                                    <span th:if="${artist.country != null}" th:text="${artist.country}"></span>
                                </div>
                                <div class="featured-artist-stats">
                                    <div class="stat">
                                        <span class="stat-icon total-plays">‚èµ</span>
                                        <span class="stat-value" th:text="${artist.playCount}">0</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Chart History Tab Content -->
            <div class="featured-tab-content" th:if="${activeTab == 'chart-history'}">
                <div class="detail-content-card">
                    <h2 class="section-title">Chart History 
                        <span class="item-count">(<span th:text="${chartHistory != null ? chartHistory.size() : 0}">0</span>)</span>
                    </h2>
                    
                    <div th:if="${chartHistory == null or chartHistory.isEmpty()}" class="no-items-message">
                        <p>This song has not charted yet.</p>
                    </div>
                    
                    <div th:if="${chartHistory != null and !chartHistory.isEmpty()}" class="table-wrapper">
                        <table class="table js-sortable">
                            <thead>
                                <tr>
                                    <th>Song</th>
                                    <th style="text-align:right;">Peak</th>
                                    <th style="text-align:right;">Wks@Peak</th>
                                    <th>Release</th>
                                    <th>Debut</th>
                                    <th>Peak Date</th>
                                    <th style="text-align:right;">Total Weeks</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr th:each="entry : ${chartHistory}">
                                    <td>
                                        <a th:href="@{'/songs/' + ${entry.id}}" th:text="${entry.name}">Song Name</a>
                                    </td>
                                    <td style="text-align:right;">
                                        <span th:classappend="${entry.peakNumberOne} ? 'peak-number-one' : ''" 
                                              th:text="${entry.peakPosition}">#1</span>
                                    </td>
                                    <td style="text-align:right;">
                                        <span th:classappend="${entry.peakNumberOne} ? 'peak-number-one' : ''" 
                                              th:text="${entry.weeksAtPeak}">1</span>
                                    </td>
                                    <td th:text="${entry.releaseDate != null ? entry.releaseDate : '-'}">-</td>
                                    <td>
                                        <a th:if="${entry.debutWeek != null}" th:href="@{/charts/weekly/{week}(week=${entry.debutWeek})}" th:text="${entry.debutDate}">-</a>
                                        <span th:unless="${entry.debutWeek != null}">-</span>
                                    </td>
                                    <td>
                                        <a th:if="${entry.peakWeek != null}" th:href="@{/charts/weekly/{week}(week=${entry.peakWeek})}" th:text="${entry.peakDate}">-</a>
                                        <span th:unless="${entry.peakWeek != null}">-</span>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Song Chart Run -->
                    <div id="songChartRunContainer" class="chart-run-container" style="margin-top: 20px;">
                        <!-- Chart run will be loaded via JavaScript -->
                    </div>
                </div>
                
                <!-- Seasonal/Yearly Charts Section -->
                <div th:if="${(seasonalChartHistory != null and !seasonalChartHistory.isEmpty()) or (yearlyChartHistory != null and !yearlyChartHistory.isEmpty())}" class="detail-content-card" style="margin-top: 20px;">
                    <h2 class="section-title">üìä Seasonal/Yearly Charts</h2>
                    <div class="winning-chips" style="justify-content: flex-start;">
                        <!-- Yearly entries first -->
                        <a th:each="entry : ${yearlyChartHistory}" 
                           th:href="@{/charts/yearly/{pk}(pk=${entry.periodKey})}"
                           class="winning-chip chart-chip yearly-chart"
                           th:text="${entry.displayName}">
                            #1 in 2024
                        </a>
                        <!-- Seasonal entries second -->
                        <a th:each="entry : ${seasonalChartHistory}" 
                           th:href="@{/charts/seasonal/{pk}(pk=${entry.periodKey})}"
                           class="winning-chip chart-chip seasonal-chart">
                            <span th:if="${#strings.contains(entry.displayName, 'Winter')}">‚ùÑÔ∏è</span>
                            <span th:if="${#strings.contains(entry.displayName, 'Spring')}">üå∏</span>
                            <span th:if="${#strings.contains(entry.displayName, 'Summer')}">‚òÄÔ∏è</span>
                            <span th:if="${#strings.contains(entry.displayName, 'Fall')}">üçÇ</span>
                            <span th:text="${entry.displayName}">#1 in Winter 2024</span>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script th:if="${activeTab == 'plays'}" th:inline="javascript">
        // Initialize plays by month chart (grouped by year)
        document.addEventListener('DOMContentLoaded', function() {
            const playsByMonthData = /*[[${playsByMonth}]]*/ [];
            const artistGender = /*[[${artistGender}]]*/ '';
            // Release date: use song's release date, fallback to album's release date
            const songReleaseDate = /*[[${song.releaseDate != null ? song.releaseDate.toString() : null}]]*/ null;
            const albumReleaseDate = /*[[${album != null && album.releaseDate != null ? album.releaseDate.toString() : null}]]*/ null;
            const effectiveReleaseDate = songReleaseDate || albumReleaseDate;
            
            if (playsByMonthData && playsByMonthData.length > 0) {
                const ctx = document.getElementById('playsByYearChart').getContext('2d');
                
                // Create styled tooltip div for year hovering
                const tooltipDiv = document.createElement('div');
                tooltipDiv.style.cssText = `
                    position: absolute;
                    background: rgba(0, 0, 0, 0.8);
                    color: white;
                    padding: 8px 12px;
                    border-radius: 6px;
                    font-size: 13px;
                    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
                    pointer-events: none;
                    z-index: 1000;
                    display: none;
                    white-space: nowrap;
                    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
                `;
                document.body.appendChild(tooltipDiv);
                
                // Create release chip for pre-chart releases
                const releaseChip = document.createElement('div');
                releaseChip.style.cssText = `
                    position: absolute;
                    background: linear-gradient(135deg, rgba(147, 51, 234, 0.95), rgba(79, 70, 229, 0.95));
                    color: white;
                    padding: 8px 14px;
                    border-radius: 20px;
                    font-size: 13px;
                    font-weight: 600;
                    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
                    pointer-events: none;
                    z-index: 1001;
                    display: none;
                    white-space: nowrap;
                    box-shadow: 0 4px 12px rgba(147, 51, 234, 0.4);
                    left: 10px;
                    top: 20px;
                `;
                const chartCanvas = document.getElementById('playsByYearChart');
                const chartParent = chartCanvas.parentElement;
                chartParent.style.position = 'relative';
                // Don't set overflow on parent, use body instead
                document.body.appendChild(releaseChip);
                
                // Add double-click for fullscreen
                chartCanvas.addEventListener('dblclick', () => {
                    openChartFullscreen();
                });
                chartCanvas.style.cursor = 'pointer';
                
                function openChartFullscreen() {
                    const modal = document.createElement('div');
                    modal.style.cssText = `
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0, 0, 0, 0.95);
                        z-index: 10000;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        padding: 40px;
                    `;
                    
                    const closeBtn = document.createElement('button');
                    closeBtn.textContent = '‚úï';
                    closeBtn.style.cssText = `
                        position: absolute;
                        top: 20px;
                        right: 20px;
                        background: rgba(255, 255, 255, 0.1);
                        border: 2px solid rgba(255, 255, 255, 0.3);
                        color: white;
                        font-size: 24px;
                        width: 50px;
                        height: 50px;
                        border-radius: 50%;
                        cursor: pointer;
                        transition: all 0.2s;
                    `;
                    closeBtn.onmouseover = () => {
                        closeBtn.style.background = 'rgba(255, 255, 255, 0.2)';
                        closeBtn.style.transform = 'scale(1.1)';
                    };
                    closeBtn.onmouseout = () => {
                        closeBtn.style.background = 'rgba(255, 255, 255, 0.1)';
                        closeBtn.style.transform = 'scale(1)';
                    };
                    closeBtn.onclick = () => document.body.removeChild(modal);
                    
                    const canvasClone = chartCanvas.cloneNode(true);
                    canvasClone.style.cssText = 'max-width: 100%; max-height: 100%; width: auto; height: auto;';
                    
                    modal.appendChild(closeBtn);
                    modal.appendChild(canvasClone);
                    document.body.appendChild(modal);
                    
                    modal.onclick = (e) => {
                        if (e.target === modal) document.body.removeChild(modal);
                    };
                    
                    // Re-render chart in fullscreen
                    const ctxClone = canvasClone.getContext('2d');
                    canvasClone.width = window.innerWidth - 100;
                    canvasClone.height = window.innerHeight - 100;
                    new Chart(ctxClone, chartInstance.config);
                }
                
                const canvasContainer = document.getElementById('playsByYearChart').parentElement;
                canvasContainer.addEventListener('mousemove', (e) => {
                    const rect = document.getElementById('playsByYearChart').getBoundingClientRect();
                    tooltipDiv.style.left = (e.pageX + 10) + 'px';
                    tooltipDiv.style.top = (e.pageY - 25) + 'px';
                });
                
                canvasContainer.addEventListener('mouseleave', () => {
                    hideYearTooltip();
                    hideReleaseChip();
                });
                
                function showYearTooltip(year, plays) {
                    tooltipDiv.textContent = year + ': ' + plays.toLocaleString() + ' plays';
                    tooltipDiv.style.display = 'block';
                }
                
                function hideYearTooltip() {
                    tooltipDiv.style.display = 'none';
                }
                
                function showReleaseChip(text) {
                    releaseChip.textContent = 'üìÖ ' + text;
                    const rect = chartCanvas.getBoundingClientRect();
                    releaseChip.style.left = (rect.left + 10) + 'px';
                    releaseChip.style.top = (rect.top + 20) + 'px';
                    // Apply gender-based colors
                    const chipGradient = isFemale 
                        ? 'linear-gradient(135deg, rgba(236, 72, 153, 0.95), rgba(219, 39, 119, 0.95))'
                        : 'linear-gradient(135deg, rgba(59, 130, 246, 0.95), rgba(37, 99, 235, 0.95))';
                    const chipShadow = isFemale 
                        ? '0 4px 12px rgba(236, 72, 153, 0.4)'
                        : '0 4px 12px rgba(59, 130, 246, 0.4)';
                    releaseChip.style.background = chipGradient;
                    releaseChip.style.boxShadow = chipShadow;
                    releaseChip.style.display = 'block';
                    console.log('Showing release chip:', text, 'at', releaseChip.style.left, releaseChip.style.top);
                }
                
                function hideReleaseChip() {
                    releaseChip.style.display = 'none';
                    console.log('Hiding release chip');
                }
                
                const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                
                // Build a map of existing data
                const dataMap = {};
                playsByMonthData.forEach(d => {
                    dataMap[d.year + '-' + d.month] = d.playCount;
                });
                
                // Find year range based on actual play data
                const allYears = [...new Set(playsByMonthData.map(d => parseInt(d.year)))].sort((a, b) => a - b);
                const minYear = allYears[0];
                const maxYear = allYears[allYears.length - 1];
                
                // Fill in all months between first and last play data point
                const filledData = [];
                for (let year = minYear; year <= maxYear; year++) {
                    for (let month = 1; month <= 12; month++) {
                        const monthStr = month.toString().padStart(2, '0');
                        const key = year + '-' + monthStr;
                        filledData.push({
                            year: year.toString(),
                            month: monthStr,
                            monthIndex: month - 1,
                            label: year + '-' + monthStr,
                            playCount: dataMap[key] || 0
                        });
                    }
                }
                
                // Determine bar color based on gender
                const isFemale = artistGender && artistGender.toLowerCase().includes('female');
                const barColor = isFemale ? 'rgba(236, 72, 153, 0.8)' : 'rgba(59, 130, 246, 0.8)';
                const borderColor = isFemale ? 'rgba(236, 72, 153, 1)' : 'rgba(59, 130, 246, 1)';
                // Release line color: lighter shade based on gender
                const releaseColor = isFemale ? 'rgba(244, 114, 182, 0.9)' : 'rgba(147, 197, 253, 0.9)';
                
                // Calculate total plays per year for hover display
                const yearTotals = {};
                filledData.forEach(d => {
                    if (!yearTotals[d.year]) yearTotals[d.year] = 0;
                    yearTotals[d.year] += d.playCount;
                });
                
                // Build release date annotation if available
                const annotations = {};
                let releaseBeforeChart = false;
                let releaseDisplayText = '';
                let releaseLineTooltip = null;
                
                if (effectiveReleaseDate) {
                    const releaseDate = new Date(effectiveReleaseDate);
                    const releaseYear = releaseDate.getUTCFullYear();
                    const releaseMonth = releaseDate.getUTCMonth(); // 0-11
                    releaseDisplayText = monthNames[releaseMonth] + ' ' + releaseYear;
                    
                    // Check if release is before the chart range
                    if (releaseYear < minYear || (releaseYear === minYear && releaseMonth < 0)) {
                        releaseBeforeChart = true;
                        releaseLineTooltip = 'üìÖ Released: ' + releaseDisplayText;
                    } else {
                        // Find the index in filledData that matches this year/month
                        const releaseIndex = filledData.findIndex(d => 
                            parseInt(d.year) === releaseYear && d.monthIndex === releaseMonth
                        );
                        
                        if (releaseIndex !== -1) {
                            releaseLineTooltip = 'üìÖ Released: ' + releaseDisplayText;
                            annotations.releaseLine = {
                                type: 'line',
                                xMin: releaseIndex,
                                xMax: releaseIndex,
                                borderColor: releaseColor,
                                borderWidth: 2,
                                borderDash: [6, 4]
                            };
                        }
                    }
                }
                
                const chartInstance = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: filledData.map(d => d.label),
                        datasets: [{
                            label: 'Plays',
                            data: filledData.map(d => d.playCount),
                            backgroundColor: barColor,
                            borderColor: borderColor,
                            borderWidth: 1
                        }]
                    },
                    plugins: [{
                        id: 'yearSeparators',
                        afterDatasetsDraw: function(chart) {
                            const ctx = chart.ctx;
                            const xAxis = chart.scales.x;
                            const yAxis = chart.scales.y;
                            
                            ctx.save();
                            ctx.strokeStyle = 'rgba(255,255,255,0.15)';
                            ctx.lineWidth = 1.5;
                            ctx.setLineDash([]);
                            
                            filledData.forEach((item, idx) => {
                                if (item.monthIndex === 0 && idx > 0) {
                                    const x = xAxis.getPixelForValue(idx - 0.5);
                                    ctx.beginPath();
                                    ctx.moveTo(x, yAxis.top);
                                    ctx.lineTo(x, yAxis.bottom);
                                    ctx.stroke();
                                }
                            });
                            ctx.restore();
                        }
                    }],
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        onHover: function(event, activeElements) {
                            const chart = chartInstance;
                            const canvasPosition = Chart.helpers.getRelativePosition(event, chart);
                            const dataX = chart.scales.x.getValueForPixel(canvasPosition.x);
                            
                            // Show release chip if release is before chart range
                            if (releaseBeforeChart && releaseDisplayText) {
                                console.log('Should show chip - releaseBeforeChart:', releaseBeforeChart, 'text:', releaseDisplayText);
                                showReleaseChip(releaseDisplayText);
                            } else {
                                console.log('Hiding chip - releaseBeforeChart:', releaseBeforeChart, 'text:', releaseDisplayText);
                                hideReleaseChip();
                            }
                            
                            // Priority 1: Show release tooltip when hovering near release line
                            if (annotations.releaseLine) {
                                const releaseIdx = annotations.releaseLine.xMin;
                                if (Math.abs(dataX - releaseIdx) < 0.5) {
                                    chart.canvas.title = releaseLineTooltip;
                                    hideYearTooltip();
                                    return;
                                }
                            }
                            
                            // Priority 2: If not hovering on a bar, show year total
                            if (activeElements.length === 0 && dataX >= 0 && dataX < filledData.length) {
                                const idx = Math.round(dataX);
                                const item = filledData[idx];
                                if (item && yearTotals[item.year] !== undefined) {
                                    showYearTooltip(item.year, yearTotals[item.year]);
                                    chart.canvas.title = '';
                                    return;
                                }
                            }
                            
                            chart.canvas.title = '';
                            hideYearTooltip();
                        },
                        plugins: {
                            legend: { display: false },
                            annotation: {
                                annotations: annotations
                            },
                            tooltip: {
                                callbacks: {
                                    title: function(tooltipItems) {
                                        const idx = tooltipItems[0].dataIndex;
                                        const item = filledData[idx];
                                        return monthNames[item.monthIndex] + ' ' + item.year;
                                    },
                                    afterTitle: function(tooltipItems) {
                                        // Check if hovering near release line
                                        if (annotations.releaseLine && tooltipItems.length > 0) {
                                            const idx = tooltipItems[0].dataIndex;
                                            const releaseIdx = annotations.releaseLine.xMin;
                                            if (Math.abs(idx - releaseIdx) < 0.5) {
                                                return releaseLineTooltip;
                                            }
                                        }
                                        return null;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { color: '#9ca3af' },
                                grid: { color: 'rgba(255,255,255,0.1)' }
                            },
                            x: {
                                offset: true,
                                ticks: { 
                                    color: '#9ca3af',
                                    callback: function(value, index) {
                                        // Only show label for January of each year
                                        const item = filledData[index];
                                        if (item.monthIndex === 0) {
                                            return item.year;
                                        }
                                        return '';
                                    },
                                    maxRotation: 0
                                },
                                grid: { 
                                    display: false
                                }
                            }
                        }
                    }
                });
            }
        });
    </script>
    
    <script th:inline="javascript">
        let isEditing = false;
        
        // Featured artists state
        let selectedFeaturedArtists = /*[[${featuredArtists}]]*/ [];
        let searchTimeout = null;
        
        // Initialize featured artists from server data
        document.addEventListener('DOMContentLoaded', function() {
            initializeFeaturedArtists();
        });
        
        function initializeFeaturedArtists() {
            // Convert server data to our format
            const serverData = /*[[${featuredArtists}]]*/ [];
            selectedFeaturedArtists = serverData.map(fa => ({
                artistId: fa.artistId,
                artistName: fa.artistName
            }));
        }
        
        // Add form submit handler to convert mm:ss to seconds and save featured artists
        document.getElementById('songForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const lengthFormatted = document.getElementById('lengthFormatted').value;
            const lengthSecondsField = document.getElementById('lengthSeconds');
            
            if (lengthFormatted && lengthFormatted.trim() !== '') {
                const parts = lengthFormatted.split(':');
                if (parts.length === 2) {
                    const minutes = parseInt(parts[0]) || 0;
                    const seconds = parseInt(parts[1]) || 0;
                    const totalSeconds = (minutes * 60) + seconds;
                    lengthSecondsField.value = totalSeconds;
                }
            }
            
            // Save featured artists first, then submit the form
            const songId = window.location.pathname.split('/').pop();
            const artistIds = selectedFeaturedArtists.map(a => a.artistId);
            
            fetch(`/songs/${songId}/featured-artists`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(artistIds)
            })
            .then(response => response.text())
            .then(data => {
                if (data === 'success' || data === 'error') {
                    // Submit the main form regardless (featured artists are saved separately)
                    e.target.submit();
                }
            })
            .catch(error => {
                console.error('Error saving featured artists:', error);
                // Still submit the main form
                e.target.submit();
            });
        });
        
        function toggleEdit() {
            isEditing = !isEditing;
            const editBtn = document.getElementById('editBtn');
            const deleteBtn = document.getElementById('deleteBtn');
            const formActions = document.getElementById('formActions');
            const fetchItunesDataBtn = document.getElementById('fetchItunesDataBtn');
            
            // Get all editable inputs by class and type
            const textInputs = document.querySelectorAll('#songForm .editable-input');
            const numberInputs = document.querySelectorAll('#songForm input[type="number"]');
            const checkboxInputs = document.querySelectorAll('#songForm input[type="checkbox"]');
            const selects = document.querySelectorAll('#songForm select');
            const attributeTexts = document.querySelectorAll('.attribute-text');
            
            if (isEditing) {
                editBtn.style.display = 'none';
                deleteBtn.style.display = 'none';
                formActions.style.display = 'flex';
                
                // Hide view-only fields (like Country which belongs to artist)
                document.querySelectorAll('.view-only-field').forEach(el => el.style.display = 'none');
                
                // Populate length formatted field with mm:ss value
                const lengthSeconds = document.getElementById('lengthSeconds').value;
                const lengthFormatted = document.getElementById('lengthFormatted');
                if (lengthSeconds && lengthSeconds !== '') {
                    const totalSeconds = parseInt(lengthSeconds);
                    const minutes = Math.floor(totalSeconds / 60);
                    const seconds = totalSeconds % 60;
                    lengthFormatted.value = minutes + ':' + (seconds < 10 ? '0' : '') + seconds;
                }
                
                // Show name field group
                const nameFieldGroup = document.getElementById('nameFieldGroup');
                if (nameFieldGroup) {
                    nameFieldGroup.style.display = 'block';
                }
                
                // Show album field group
                const albumFieldGroup = document.getElementById('albumFieldGroup');
                if (albumFieldGroup) {
                    albumFieldGroup.style.display = 'block';
                }
                
                // Switch labels to edit mode (show "Override" labels)
                document.querySelectorAll('.label-view').forEach(el => el.style.display = 'none');
                document.querySelectorAll('.label-edit').forEach(el => el.style.display = 'inline');
                
                // Show text inputs
                textInputs.forEach(input => {
                    input.style.display = 'block';
                });
                
                // Show number inputs
                numberInputs.forEach(input => {
                    input.style.display = 'block';
                });
                
                // Show checkboxes
                checkboxInputs.forEach(input => {
                    input.style.display = 'inline-block';
                });
                
                // Show inline checkbox labels
                document.querySelectorAll('.inline-checkbox-label').forEach(label => {
                    label.style.display = 'inline-flex';
                });
                
                // Show selects
                selects.forEach(select => {
                    select.removeAttribute('disabled');
                    select.style.display = 'block';
                });
                
                // Hide text displays
                attributeTexts.forEach(text => {
                    if (text.dataset.field) {
                        text.style.display = 'none';
                    }
                });
                
                // Load albums for the album dropdown
                loadAlbumsForArtist();
                
                // Show featured artists field and container
                const featuredArtistsField = document.getElementById('featuredArtistsField');
                if (featuredArtistsField) {
                    featuredArtistsField.style.display = 'block';
                }
                const featuredArtistsContainer = document.getElementById('featuredArtistsContainer');
                if (featuredArtistsContainer) {
                    featuredArtistsContainer.style.display = 'block';
                }
                
                // Initialize searchable selects for dropdowns
                setTimeout(function() {
                    // Set select values based on selected options before initializing searchable selects
                    ['overrideGenreId', 'overrideSubgenreId', 'overrideLanguageId', 'overrideGenderId', 'overrideEthnicityId'].forEach(function(selectId) {
                        const select = document.getElementById(selectId);
                        if (select) {
                            const selectedOption = select.querySelector('option[selected]');
                            if (selectedOption) {
                                select.value = selectedOption.value;
                            }
                        }
                    });
                    
                    initSearchableSelect('albumId');
                    initSearchableSelect('overrideGenreId');
                    initSearchableSelect('overrideSubgenreId');
                    initSearchableSelect('overrideLanguageId');
                    initSearchableSelect('overrideGenderId');
                    initSearchableSelect('overrideEthnicityId');
                }, 100); // Slightly longer delay to wait for album dropdown to populate
            } else {
                window.location.reload();
            }
        }
        
        // Load albums for the current artist to populate the album dropdown
        function loadAlbumsForArtist() {
            const artistId = document.getElementById('artistId').value;
            const albumSelect = document.getElementById('albumId');
            const currentAlbumId = /*[[${song.albumId}]]*/ null;
            
            if (!artistId) return;
            
            fetch(`/albums/api/albums?artistId=${artistId}`)
                .then(response => response.json())
                .then(albums => {
                    // Keep the "No album" option
                    albumSelect.innerHTML = '<option value="">No album (single)</option>';
                    
                    // Add each album as an option
                    albums.forEach(album => {
                        const option = document.createElement('option');
                        option.value = album.id;
                        option.textContent = album.name;
                        if (currentAlbumId && album.id == currentAlbumId) {
                            option.selected = true;
                        }
                        albumSelect.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error('Error loading albums:', error);
                });
        }
        
        function cancelEdit() {
            window.location.reload();
        }
        
        function confirmDelete() {
            const songName = /*[[${song.name}]]*/ '';
            const artistName = /*[[${artistName}]]*/ '';
            const playCount = /*[[${songPlayCount}]]*/ 0;
            
            if (playCount > 0) {
                showWarningToast('Cannot delete song with existing plays (' + playCount + ' plays)');
                return;
            }
            
            const displayName = artistName ? songName + ' by ' + artistName : songName;
            if (confirm('Are you sure you want to delete "' + displayName + '"?\n\nThis action cannot be undone!')) {
                const songId = window.location.pathname.split('/').pop();
                
                fetch(`/songs/${songId}`, {
                    method: 'DELETE'
                })
                .then(response => response.text())
                .then(data => {
                    if (data === 'success') {
                        window.location.href = '/songs';
                    } else if (data.startsWith('error:')) {
                        showErrorToast(data.substring(6));
                    } else {
                        showErrorToast('Failed to delete song');
                    }
                })
                .catch(error => {
                    console.error('Error deleting song:', error);
                    showErrorToast('Error deleting song');
                });
            }
        }
        
        function showTooltip(element) {
            const tooltip = element.querySelector('.tooltiptext') || element;
            if (tooltip.classList.contains('tooltiptext')) {
                const dataPlays = element.getAttribute('data-plays') || element.parentElement.getAttribute('data-plays');
                if (dataPlays) {
                    tooltip.textContent = dataPlays;
                }
                tooltip.style.opacity = '1';
                tooltip.style.visibility = 'visible';
            }
        }
        
        function hideTooltip(element) {
            const tooltip = element.querySelector('.tooltiptext') || element;
            if (tooltip.classList.contains('tooltiptext')) {
                tooltip.style.opacity = '0';
                tooltip.style.visibility = 'hidden';
            }
        }
        
        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!file.type.startsWith('image/')) {
                showWarningToast('Please select an image file');
                return;
            }
            
            if (file.size > 5 * 1024 * 1024) {
                showWarningToast('Image size must be less than 5MB');
                return;
            }
            
            const formData = new FormData();
            formData.append('image', file);
            
            const songId = window.location.pathname.split('/').pop();
            const hasDefaultImage = /*[[${hasImage}]]*/ false;

            // If there's already a default image, add to gallery instead
            const endpoint = hasDefaultImage ? `/songs/${songId}/images` : `/songs/${songId}/image`;

            fetch(endpoint, {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (response.ok) {
                    window.location.reload();
                } else {
                    showErrorToast('Failed to upload image');
                }
            })
            .catch(error => {
                console.error('Error uploading image:', error);
                showErrorToast('Error uploading image');
            });
        }
        
        function removeImage() {
            if (!confirm('Are you sure you want to remove this image?')) {
                return;
            }
            
            const songId = window.location.pathname.split('/').pop();
            
            fetch(`/songs/${songId}/image`, {
                method: 'DELETE'
            })
            .then(response => {
                if (response.ok) {
                    window.location.reload();
                } else {
                    showErrorToast('Failed to remove image');
                }
            })
            .catch(error => {
                console.error('Error removing image:', error);
                showErrorToast('Error removing image');
            });
        }
        
        // ============ GALLERY FUNCTIONALITY ============
        let galleryImages = [];
        let currentGalleryIndex = 0;
        const songId = window.location.pathname.split('/').pop();
        const hasDefaultImage = /*[[${hasImage}]]*/ false;

        document.addEventListener('DOMContentLoaded', function() {
            loadGallery();
        });

        function loadGallery() {
            fetch(`/songs/${songId}/images`)
                .then(response => response.json())
                .then(data => {
                    const imageIds = data.map(img => img.id);
                    console.log('Gallery images loaded:', imageIds, 'Has default:', hasDefaultImage);

                    if (hasDefaultImage) {
                        galleryImages = [0, ...imageIds];
                    } else {
                        galleryImages = imageIds.length > 0 ? imageIds : [0];
                    }

                    console.log('Total gallery images:', galleryImages.length);
                    updateGalleryUI();
                })
                .catch(error => {
                    console.error('Error loading gallery:', error);
                    galleryImages = [0];
                    updateGalleryUI();
                });
        }

        function updateGalleryUI() {
            const prevBtn = document.getElementById('galleryPrev');
            const nextBtn = document.getElementById('galleryNext');
            const counter = document.getElementById('galleryCounter');
            const currentIndexSpan = document.getElementById('currentImageIndex');
            const totalCountSpan = document.getElementById('totalImageCount');
            const btnSetDefault = document.getElementById('btnSetDefault');
            const btnRemoveGallery = document.getElementById('btnRemoveGallery');
            const btnRemoveMain = document.getElementById('btnRemoveMain');
            const btnUploadMain = document.getElementById('btnUploadImage');

            const hasMultipleImages = galleryImages.length > 1;
            const isOnSecondaryImage = galleryImages[currentGalleryIndex] !== 0;

            if (prevBtn) prevBtn.style.display = hasMultipleImages ? 'flex' : 'none';
            if (nextBtn) nextBtn.style.display = hasMultipleImages ? 'flex' : 'none';
            if (counter) counter.style.display = hasMultipleImages ? 'block' : 'none';
            if (currentIndexSpan) currentIndexSpan.textContent = currentGalleryIndex + 1;
            if (totalCountSpan) totalCountSpan.textContent = galleryImages.length;

            // Upload button is always visible
            if (btnUploadMain) btnUploadMain.style.display = 'inline-block';

            if (isOnSecondaryImage) {
                if (btnSetDefault) btnSetDefault.style.display = 'inline-block';
                if (btnRemoveGallery) btnRemoveGallery.style.display = 'inline-block';
                if (btnRemoveMain) btnRemoveMain.style.display = 'none';
            } else {
                if (btnSetDefault) btnSetDefault.style.display = 'none';
                if (btnRemoveGallery) btnRemoveGallery.style.display = 'none';
                // Only show remove button if this is the only image
                if (btnRemoveMain) btnRemoveMain.style.display = hasMultipleImages ? 'none' : 'inline-block';
            }
        }

        function galleryNavigate(direction) {
            let newIndex = currentGalleryIndex + direction;
            // Wrap around carousel
            if (newIndex < 0) newIndex = galleryImages.length - 1;
            if (newIndex >= galleryImages.length) newIndex = 0;
            currentGalleryIndex = newIndex;
            updateGalleryImage();
            updateGalleryUI();
        }

        function updateGalleryImage() {
            let img = document.getElementById('songImage');
            const albumImg = document.getElementById('albumImage');
            const placeholder = document.getElementById('noImagePlaceholder');
            const currentImageId = galleryImages[currentGalleryIndex];
            
            // If songImage doesn't exist but we need to show gallery images, create it dynamically
            if (!img && (currentImageId !== 0 || hasDefaultImage)) {
                img = document.createElement('img');
                img.id = 'songImage';
                img.className = 'item-image-large clickable-image';
                img.style.cursor = 'pointer';
                img.onclick = function() { openSongImageModal(); };
                const container = document.querySelector('.item-image-container');
                // Insert after the gallery nav buttons
                const navRight = document.getElementById('galleryNext');
                if (navRight && navRight.nextSibling) {
                    container.insertBefore(img, navRight.nextSibling);
                } else {
                    container.insertBefore(img, container.firstChild);
                }
            }
            
            if (currentImageId === 0) {
                if (hasDefaultImage) {
                    // Show the song's own image
                    if (img) {
                        img.src = `/songs/${songId}/image?t=${Date.now()}`;
                        img.style.display = 'block';
                    }
                    if (albumImg) albumImg.style.display = 'none';
                    if (placeholder) placeholder.style.display = 'none';
                } else {
                    // No song image - show album fallback or placeholder
                    if (img) img.style.display = 'none';
                    if (albumImg) albumImg.style.display = 'block';
                    if (placeholder && !albumImg) placeholder.style.display = 'flex';
                }
            } else {
                // Show secondary gallery image
                if (img) {
                    img.src = `/songs/${songId}/images/${currentImageId}?t=${Date.now()}`;
                    img.style.display = 'block';
                }
                if (albumImg) albumImg.style.display = 'none';
                if (placeholder) placeholder.style.display = 'none';
            }
        }

        function openSongImageModal() {
            const img = document.getElementById('songImage') || document.getElementById('albumImage');
            if (!img) return;
            
            // Build gallery context if there are multiple images
            if (galleryImages.length > 1) {
                const galleryContext = {
                    images: galleryImages,
                    entityType: 'songs',
                    entityId: songId,
                    currentIndex: currentGalleryIndex
                };
                openImageModal(img.src, galleryContext);
            } else {
                openImageModal(img.src);
            }
        }

        function setAsDefaultImage() {
            const currentImageId = galleryImages[currentGalleryIndex];
            if (currentImageId === 0) return; // Already on default
            fetch(`/songs/${songId}/images/${currentImageId}/set-default`, { method: 'POST' })
                .then(response => { if (response.ok) window.location.reload(); else showErrorToast('Failed to set as default'); })
                .catch(error => { console.error('Error:', error); showErrorToast('Error setting default image'); });
        }

        function removeGalleryImage() {
            const currentImageId = galleryImages[currentGalleryIndex];
            if (currentImageId === 0) return; // Can't remove default this way
            if (!confirm('Are you sure you want to remove this image from the gallery?')) return;
            fetch(`/songs/${songId}/images/${currentImageId}`, { method: 'DELETE' })
                .then(response => {
                    if (response.ok) {
                        galleryImages.splice(currentGalleryIndex, 1);
                        if (currentGalleryIndex >= galleryImages.length) currentGalleryIndex = galleryImages.length - 1;
                        updateGalleryImage();
                        updateGalleryUI();
                    } else { showErrorToast('Failed to remove image'); }
                })
                .catch(error => { console.error('Error:', error); showErrorToast('Error removing image'); });
        }
        // ============ END GALLERY FUNCTIONALITY ============

        // ============================================
        // Featured Artists Functions
        // ============================================
        
        function renderFeaturedArtistChips() {
            const chipsContainer = document.getElementById('featuredArtistsChips');
            if (!chipsContainer) return;
            
            chipsContainer.innerHTML = '';
            
            selectedFeaturedArtists.forEach(artist => {
                const chip = document.createElement('span');
                chip.className = 'artist-chip';
                chip.innerHTML = `
                    ${escapeHtml(artist.artistName)}
                    <button type="button" class="chip-remove" onclick="removeFeaturedArtist(${artist.artistId})">&times;</button>
                `;
                chipsContainer.appendChild(chip);
            });
        }
        
        function removeFeaturedArtist(artistId) {
            selectedFeaturedArtists = selectedFeaturedArtists.filter(a => a.artistId !== artistId);
            renderFeaturedArtistChips();
        }
        
        function addFeaturedArtist(artistId, artistName) {
            // Check if already added
            if (selectedFeaturedArtists.some(a => a.artistId === artistId)) {
                return;
            }
            
            selectedFeaturedArtists.push({ artistId, artistName });
            renderFeaturedArtistChips();
            
            // Clear input and hide dropdown
            const input = document.getElementById('featuredArtistsInput');
            if (input) {
                input.value = '';
            }
            hideFeaturedArtistsDropdown();
        }
        
        function searchFeaturedArtists(query) {
            if (!query || query.trim().length < 1) {
                hideFeaturedArtistsDropdown();
                return;
            }
            
            fetch(`/songs/api/artists/search?q=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(artists => {
                    const dropdown = document.getElementById('featuredArtistsDropdown');
                    if (!dropdown) return;
                    
                    // Filter out already selected artists
                    const availableArtists = artists.filter(a => 
                        !selectedFeaturedArtists.some(sa => sa.artistId === a.artistId)
                    );
                    
                    if (availableArtists.length === 0) {
                        dropdown.innerHTML = '<div class="dropdown-item no-results">No artists found</div>';
                    } else {
                        dropdown.innerHTML = availableArtists.map(a => `
                            <div class="dropdown-item" onclick="addFeaturedArtist(${a.artistId}, '${escapeHtml(a.artistName).replace(/'/g, "\\'")}')">
                                ${escapeHtml(a.artistName)}
                            </div>
                        `).join('');
                    }
                    
                    dropdown.style.display = 'block';
                })
                .catch(error => {
                    console.error('Error searching artists:', error);
                    hideFeaturedArtistsDropdown();
                });
        }
        
        function hideFeaturedArtistsDropdown() {
            const dropdown = document.getElementById('featuredArtistsDropdown');
            if (dropdown) {
                dropdown.style.display = 'none';
            }
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Set up featured artists input listener
        document.addEventListener('DOMContentLoaded', function() {
            const input = document.getElementById('featuredArtistsInput');
            if (input) {
                input.addEventListener('input', function(e) {
                    if (searchTimeout) {
                        clearTimeout(searchTimeout);
                    }
                    searchTimeout = setTimeout(() => {
                        searchFeaturedArtists(e.target.value);
                    }, 200);
                });
                
                input.addEventListener('focus', function() {
                    if (this.value.trim().length >= 1) {
                        searchFeaturedArtists(this.value);
                    }
                });
            }
            
            // Close dropdown when clicking outside
            document.addEventListener('click', function(e) {
                const container = document.getElementById('featuredArtistsContainer');
                if (container && !container.contains(e.target)) {
                    hideFeaturedArtistsDropdown();
                }
            });
            
            // Render initial chips when entering edit mode
            renderFeaturedArtistChips();
        });
        
        // Note: rely on global showTooltip/hideTooltip defined in fragments/navigation.html
    </script>
    
    <style>
        /* Make disabled delete buttons visually distinct */
        .btn-negative:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            background-color: #4a4a4a;
            color: #888;
        }
        
        .btn-negative:disabled:hover {
            background-color: #4a4a4a;
            color: #888;
        }
        
        /* Checkbox styling (compact inline) */
        .checkbox-container {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 0;
            flex-wrap: nowrap;
        }

        .checkbox-container input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .checkbox-label {
            font-size: 14px;
            color: #e5e7eb;
            cursor: pointer;
            white-space: nowrap;
        }
        /* Inline layout for checkbox form-groups (compact) */
        .form-group.form-group-checkbox {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            gap: 8px;
        }

        .form-group.form-group-checkbox .field-label {
            margin: 0;
            color: #cbd5e1;
            font-size: 0.95rem;
            white-space: nowrap;
        }

        .form-group.form-group-checkbox .attribute-text {
            margin-left: 4px;
        }

        .release-age-text {
            color: #999;
            font-size: 0.85em;
        }

        .form-group.form-group-checkbox .checkbox-container {
            margin: 0;
            padding: 0;
        }

        .form-group.form-group-checkbox .checkbox-label { display: none; }

        .form-group.form-group-checkbox .inline-checkbox-label {
            justify-content: flex-start;
        }
        
        /* Name and Album field styling */
        .name-field-group,
        .album-field-group {
            margin-bottom: 10px;
            padding: 0 10px;
        }
        
        .editable-input {
            width: 100%;
            padding: 8px 12px;
            background: #1f2937;
            border: 1px solid #374151;
            border-radius: 6px;
            color: #e5e7eb;
            font-size: 0.95em;
        }
        
        .editable-input:focus {
            outline: none;
            border-color: #22c55e;
            box-shadow: 0 0 0 2px rgba(34, 197, 94, 0.2);
        }
        
        #albumId {
            width: 100%;
            padding: 8px 12px;
            background: #1f2937;
            border: 1px solid #374151;
            border-radius: 6px;
            color: #e5e7eb;
            font-size: 0.95em;
        }
        
        #albumId:focus {
            outline: none;
            border-color: #22c55e;
            box-shadow: 0 0 0 2px rgba(34, 197, 94, 0.2);
        }
        
        /* Featured Artists Styles */
        .form-group-full-width {
            grid-column: 1 / -1;
        }
        
        .featured-artists-display {
            display: inline;
        }
        
        .featured-artist-link {
            color: #e5e7eb;
            text-decoration: none;
            transition: color 0.2s;
        }
        
        .featured-artist-link:hover {
            color: #fff;
            text-decoration: underline;
        }
        
        .featured-artists-container {
            position: relative;
            width: 100%;
        }
        
        .chips-input-wrapper {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 6px;
            padding: 8px 10px;
            background: #1f2937;
            border: 1px solid #374151;
            border-radius: 6px;
            min-height: 42px;
        }
        
        .chips-input-wrapper:focus-within {
            border-color: #22c55e;
            box-shadow: 0 0 0 2px rgba(34, 197, 94, 0.2);
        }
        
        .chips-container {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }
        
        .artist-chip {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            background: #334155;
            color: #fff;
            border-radius: 4px;
            font-size: 0.85em;
            white-space: nowrap;
        }
        
        .chip-remove {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 16px;
            height: 16px;
            padding: 0;
            margin-left: 2px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 50%;
            color: #fff;
            font-size: 12px;
            line-height: 1;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .chip-remove:hover {
            background: rgba(255, 255, 255, 0.4);
        }
        
        .chips-text-input {
            flex: 1;
            min-width: 120px;
            padding: 4px 0;
            background: transparent;
            border: none;
            color: #e5e7eb;
            font-size: 0.9em;
            outline: none;
        }
        
        .chips-text-input::placeholder {
            color: #6b7280;
        }
        
        .chips-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            max-height: 200px;
            overflow-y: auto;
            background: #1f2937;
            border: 1px solid #374151;
            border-top: none;
            border-radius: 0 0 6px 6px;
            z-index: 100;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        .dropdown-item {
            padding: 10px 12px;
            color: #e5e7eb;
            cursor: pointer;
            transition: background 0.15s;
        }
        
        .dropdown-item:hover {
            background: #374151;
        }
        
        .dropdown-item.no-results {
            color: #6b7280;
            font-style: italic;
            cursor: default;
        }
        
        .dropdown-item.no-results:hover {
            background: transparent;
        }
        
        /* Clickable image cursor */
        .item-image-large.clickable {
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        
        .item-image-large.clickable:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
        }
        
        /* Hide length overlay on image hover so upload/remove buttons can appear */
        .item-image-container:hover .length-overlay {
            opacity: 0;
            transition: opacity 0.15s ease;
        }
        
        /* Chart Run Styles */
        .chart-run-container {
            margin-top: 20px;
            padding-left: 16px;
            padding-right: 16px;
        }
        
        .chart-run-header {
            font-size: 1rem;
            color: #fff;
            margin-bottom: 15px;
        }
        
        .chart-run-boxes {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-bottom: 15px;
            max-width: 100%;
            overflow-x: auto;
        }
        
        .chart-run-box {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: 600;
            border-radius: 4px;
            background: #1a1a1a;
            color: #888;
            border: 1px solid #333;
            text-decoration: none;
            cursor: pointer;
        }
        
        .chart-run-box:hover {
            text-decoration: none;
        }
        
        .chart-run-box.on-chart {
            background: #1a1a2e;
            color: #e5e7eb;
            border-color: #333;
        }
        
        .chart-run-box.on-chart.peak-one {
            background: #3d3012;
            color: #fbbf24;
            border-color: #6b5c1f;
            box-shadow: 0 0 8px rgba(251, 191, 36, 0.3);
        }
        
        .chart-run-box.absent {
            color: #555;
        }
        
        .chart-run-box.absent.consolidated {
            background: #2a2a2a;
            color: #888;
            font-size: 11px;
            padding: 4px 8px;
            cursor: default;
        }
        
        .chart-run-stats {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }
        
        .chart-run-stat {
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            border-radius: 8px;
            padding: 12px 16px;
            text-align: center;
        }
        
        .chart-run-stat-label {
            font-size: 0.75rem;
            color: #888;
            margin-bottom: 4px;
        }
        
        .chart-run-stat-value {
            font-size: 1.2rem;
            font-weight: bold;
            color: #fff;
        }
    </style>
    
    <!-- Image Modal -->
    <th:block th:replace="~{fragments/image-modal :: image-modal}"></th:block>
    
    <!-- External Fetch Modal (iTunes Store, Spotify, Deezer) -->
    <th:block th:replace="~{fragments/external-fetch-modal :: external-fetch-modal}"></th:block>
    
    <script>
        // Make song/album image clickable to open modal
        document.addEventListener('DOMContentLoaded', function() {
            const songImage = document.getElementById('songImage');
            const albumImage = document.getElementById('albumImage');
            
            if (songImage) {
                songImage.classList.add('clickable');
                // Note: click handler is already set inline via onclick attribute
            }
            
            if (albumImage && albumImage.style.display !== 'none') {
                albumImage.classList.add('clickable');
                // Note: click handler is already set inline via onclick attribute
            }
            
            // Load song chart run if on chart-history tab
            const chartRunContainer = document.getElementById('songChartRunContainer');
            if (chartRunContainer) {
                loadSongChartRun();
            }
        });
        
        function loadSongChartRun() {
            const songId = [[${song.id}]];
            fetch(`/charts/song/${songId}/run`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Chart run not found');
                    }
                    return response.json();
                })
                .then(data => {
                    renderSongChartRun(data);
                })
                .catch(error => {
                    console.log('No chart run data available:', error);
                    document.getElementById('songChartRunContainer').style.display = 'none';
                });
        }
        
        // Helper to consolidate consecutive absent weeks into a single box
        function consolidateAbsentWeeks(weeks) {
            const result = [];
            let i = 0;
            while (i < weeks.length) {
                if (weeks[i].onChart) {
                    result.push(weeks[i]);
                    i++;
                } else {
                    // Count consecutive absent weeks
                    let count = 0;
                    let startIdx = i;
                    while (i < weeks.length && !weeks[i].onChart) {
                        count++;
                        i++;
                    }
                    // Create a consolidated absent entry
                    result.push({
                        onChart: false,
                        consolidated: true,
                        count: count,
                        periodKey: weeks[startIdx].periodKey
                    });
                }
            }
            return result;
        }
        
        function renderSongChartRun(data) {
            const container = document.getElementById('songChartRunContainer');
            if (!data || !data.weeks || data.weeks.length === 0) {
                container.style.display = 'none';
                return;
            }
            
            const consolidatedWeeks = consolidateAbsentWeeks(data.weeks);
            let boxesHtml = consolidatedWeeks.map(week => {
                let classes = 'chart-run-box';
                if (week.onChart) {
                    classes += ' on-chart';
                    if (week.position === 1) {
                        classes += ' peak-one';
                    }
                    const tooltip = week.dateRange || week.periodKey;
                    return `<a href="/charts/weekly/${week.periodKey}" class="${classes}" title="${tooltip}">${week.display}</a>`;
                } else {
                    classes += ' absent consolidated';
                    return `<span class="${classes}" title="${week.count} weeks off chart">${week.count}√ó</span>`;
                }
            }).join('');
            
            let html = `
                <div class="chart-run-header">Chart Run</div>
                <div class="chart-run-boxes">
                    ${boxesHtml}
                </div>
                <div class="chart-run-stats">
                    <div class="chart-run-stat">
                        <div class="chart-run-stat-label">Top 1</div>
                        <div class="chart-run-stat-value">${data.weeksAtTop1 || 0}</div>
                    </div>
                    <div class="chart-run-stat">
                        <div class="chart-run-stat-label">Top 5</div>
                        <div class="chart-run-stat-value">${data.weeksAtTop5 || 0}</div>
                    </div>
                    <div class="chart-run-stat">
                        <div class="chart-run-stat-label">Top 10</div>
                        <div class="chart-run-stat-value">${data.weeksAtTop10 || 0}</div>
                    </div>
                    <div class="chart-run-stat">
                        <div class="chart-run-stat-label">Top 20</div>
                        <div class="chart-run-stat-value">${data.weeksAtTop20 || 0}</div>
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
        }
        
        // Fetch release date and song length from iTunes XML (by fields)
        function fetchItunesData() {
            const button = document.getElementById('btnFetchItunes');
            const songName = document.getElementById('songNameHidden') ? document.getElementById('songNameHidden').value : '';
            const artistName = document.getElementById('artistNameHidden') ? document.getElementById('artistNameHidden').value : '';
            const albumName = document.getElementById('albumNameHidden') ? document.getElementById('albumNameHidden').value : '';

            if ((!songName || songName.trim() === '') && (!artistName || artistName.trim() === '')) {
                showWarningToast('Missing song or artist name for lookup');
                return;
            }

            // Disable button and show loading state
            const originalText = button.innerHTML;
            button.disabled = true;
            button.innerHTML = '‚è≥ Fetching...';

            fetch(`/songs/fetch-itunes-by-fields`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ songName: songName, artistName: artistName, albumName: albumName })
            })
            .then(response => response.json())
            .then(data => {
                button.disabled = false;
                button.innerHTML = originalText;

                if (data.success) {
                    // Check if this is a partial match and ask for confirmation
                    if (data.matchType === 'partial') {
                        const confirmMsg = '‚ö†Ô∏è Partial match found (artist + song only, album did not match).\n\n' +
                                         'Do you want to use this data anyway?';
                        if (!confirm(confirmMsg)) {
                            return; // User canceled
                        }
                    }

                    // Populate release date if found and allowed
                    if (data.releaseDate && data.populateReleaseDate) {
                        // Convert YYYY-MM-DD to dd/MM/yyyy format
                        const parts = data.releaseDate.split('-');
                        if (parts.length === 3) {
                            const formatted = `${parts[2]}/${parts[1]}/${parts[0]}`;
                            const releaseDateField = document.getElementById('releaseDate');
                            // Only populate if different from current value
                            if (releaseDateField.value !== formatted) {
                                releaseDateField.value = formatted;
                                highlightField('releaseDate');
                            }
                        }
                    }

                    // Populate length if found
                    if (data.lengthSeconds) {
                        const ls = document.getElementById('lengthSeconds');
                        const lf = document.getElementById('lengthFormatted');
                        // Only populate if different from current value
                        if (ls && ls.value !== String(data.lengthSeconds)) {
                            ls.value = data.lengthSeconds;
                        }
                        if (lf && data.lengthFormatted && lf.value !== data.lengthFormatted) {
                            lf.value = data.lengthFormatted;
                            highlightField('lengthFormatted');
                        }
                    }

                    // Show success message
                    let message = 'Successfully fetched from iTunes:\n';
                    if (data.matchType === 'partial') {
                        message = '‚ö†Ô∏è Partial match - Successfully fetched from iTunes:\n';
                    }
                    if (data.releaseDate) {
                        message += `- Release Date: ${data.releaseDate}`;
                        if (!data.populateReleaseDate) {
                            message += ' (skipped - same as album release date)';
                        }
                        message += '\n';
                    }
                    if (data.lengthFormatted) {
                        message += `- Length: ${data.lengthFormatted}`;
                    }
                    showSuccessToast(message);
                } else {
                    showErrorToast(data.message || 'Failed to fetch data from iTunes library');
                }
            })
            .catch(error => {
                button.disabled = false;
                button.innerHTML = originalText;
                console.error('Error fetching iTunes data:', error);
                showErrorToast('Error fetching data from iTunes library');
            });
        }
        
        // Initialize Flatpickr on releaseDate input
        document.addEventListener('DOMContentLoaded', function() {
            const releaseDateInput = document.getElementById('releaseDate');
            if (releaseDateInput) {
                flatpickr(releaseDateInput, {
                    dateFormat: 'd/m/Y',
                    allowInput: true,
                    theme: 'dark'
                });
            }
        });
        
        // ==================== External Metadata Search for Song Edit ====================
        function highlightField(elementId) {
            const el = document.getElementById(elementId);
            if (el) {
                el.classList.add('field-highlight');
                // Remove highlight when field value changes
                const removeHighlight = () => {
                    el.classList.remove('field-highlight');
                    el.removeEventListener('input', removeHighlight);
                    el.removeEventListener('change', removeHighlight);
                };
                el.addEventListener('input', removeHighlight);
                el.addEventListener('change', removeHighlight);
            }
        }
        
        // Remove all highlights (called on cancel/save)
        function clearAllHighlights() {
            document.querySelectorAll('.field-highlight').forEach(el => el.classList.remove('field-highlight'));
        }
        
        function openSongExternalMetadataSearch() {
            const artistName = document.getElementById('artistNameHidden') ? document.getElementById('artistNameHidden').value : '';
            const songName = document.getElementById('name').value || /*[[${song.name}]]*/ '';
            const hasImage = /*[[${hasImage}]]*/ false;
            
            // Open the unified external fetch modal in 'metadata' mode
            openExternalFetchModal(artistName, songName, songId, 'song', hasImage, 'metadata', function(selectedItem) {
                // Callback to populate form fields with selected metadata
                
                // Set release date if available
                if (selectedItem.releaseDate) {
                    const dateParts = selectedItem.releaseDate.split('-');
                    if (dateParts.length === 3) {
                        const formatted = `${dateParts[2]}/${dateParts[1]}/${dateParts[0]}`;
                        const releaseDateEl = document.getElementById('releaseDate');
                        const oldValue = releaseDateEl.value;
                        releaseDateEl.value = formatted;
                        // Trigger Flatpickr update
                        const fp = releaseDateEl._flatpickr;
                        if (fp) fp.setDate(formatted, true, 'd/m/Y');
                        // Only highlight if value changed
                        if (oldValue !== formatted) {
                            highlightField('releaseDate');
                        }
                    }
                }
                
                // Set length if available
                if (selectedItem.lengthSeconds && selectedItem.lengthFormatted) {
                    const lengthSecondsEl = document.getElementById('lengthSeconds');
                    const lengthFormattedEl = document.getElementById('lengthFormatted');
                    const oldLengthValue = lengthFormattedEl ? lengthFormattedEl.value : '';
                    if (lengthSecondsEl) lengthSecondsEl.value = selectedItem.lengthSeconds;
                    if (lengthFormattedEl) {
                        lengthFormattedEl.value = selectedItem.lengthFormatted;
                        // Only highlight if value changed
                        if (oldLengthValue !== selectedItem.lengthFormatted) {
                            highlightField('lengthFormatted');
                        }
                    }
                }
            });
        }
        
        // ==================== Apple Music Metadata Search for Song Edit (Legacy - kept for reference) ====================
        function openSongAppleMetadataSearch() {
            const artistName = /*[[${artistName}]]*/ '';
            const songName = document.getElementById('name').value || /*[[${song.name}]]*/ '';
            
            // Create modal if needed
            let modal = document.getElementById('songAppleMetadataModal');
            if (!modal) {
                createSongAppleMetadataModal();
                modal = document.getElementById('songAppleMetadataModal');
            }
            
            document.getElementById('songAppleMetaSearchInput').value = artistName + ' - ' + songName;
            document.getElementById('songAppleMetaResults').innerHTML = '<div style="text-align:center; color:#888; padding:40px;">Click Search to find results</div>';
            document.getElementById('songAppleMetaStatus').style.display = 'none';
            
            modal.style.display = 'flex';
            performSongAppleMetadataSearch();
        }
        
        function createSongAppleMetadataModal() {
            const modalHtml = `
                <div id="songAppleMetadataModal" class="am-modal" onclick="if(event.target===this) closeSongAppleMetadataModal()">
                    <div class="am-modal-content" onclick="event.stopPropagation()">
                        <div class="am-modal-header">
                            <h3>Search Apple Music for Song</h3>
                            <button class="am-modal-close" onclick="closeSongAppleMetadataModal()">&times;</button>
                        </div>
                        <div class="am-modal-body">
                            <div class="am-search-form">
                                <input type="text" id="songAppleMetaSearchInput" class="am-search-input" placeholder="Artist - Song">
                                <select id="songAppleMetaCountrySelect" class="am-country-select" style="width:100px;">
                                    <option value="us">üá∫üá∏ US</option>
                                    <option value="mx">üá≤üáΩ MX</option>
                                    <option value="es">üá™üá∏ ES</option>
                                    <option value="gb">üá¨üáß UK</option>
                                </select>
                                <button type="button" class="am-btn-search" onclick="performSongAppleMetadataSearch()">Search</button>
                            </div>
                            <div id="songAppleMetaStatus" class="am-search-status" style="display:none;">Searching...</div>
                            <div id="songAppleMetaResults" class="am-results-grid" style="display:none;"></div>
                        </div>
                        <div class="am-modal-footer">
                            <span style="color:#888; font-size:12px;">Select an item to populate release date, length and image</span>
                            <button type="button" class="am-btn-cancel" onclick="closeSongAppleMetadataModal()">Cancel</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }
        
        function closeSongAppleMetadataModal() {
            const modal = document.getElementById('songAppleMetadataModal');
            if (modal) modal.style.display = 'none';
        }
        
        function performSongAppleMetadataSearch() {
            const searchInput = document.getElementById('songAppleMetaSearchInput').value.trim();
            const country = document.getElementById('songAppleMetaCountrySelect').value;
            if (!searchInput) return;
            
            const statusEl = document.getElementById('songAppleMetaStatus');
            const resultsEl = document.getElementById('songAppleMetaResults');
            statusEl.style.display = 'block';
            resultsEl.style.display = 'none';
            
            const parts = searchInput.split(' - ');
            const artist = parts[0] || searchInput;
            const title = parts.length > 1 ? parts.slice(1).join(' - ') : parts[0];
            
            fetch(`/api/apple-music/search?artist=${encodeURIComponent(artist)}&title=${encodeURIComponent(title)}&country=${country}`)
                .then(r => r.json())
                .then(data => {
                    statusEl.style.display = 'none';
                    if (!data || data.length === 0) {
                        resultsEl.innerHTML = '<div style="text-align:center; color:#888; padding:40px;">No results found</div>';
                        resultsEl.style.display = 'block';
                        return;
                    }
                    songAppleMetaSearchResults = sortSongAppleMetaResults(data, artist, title);
                    renderSongAppleMetaResults();
                    resultsEl.style.display = 'grid';
                })
                .catch(err => {
                    statusEl.style.display = 'none';
                    resultsEl.innerHTML = '<div style="text-align:center; color:#ff6b6b; padding:40px;">Error searching Apple Music</div>';
                    resultsEl.style.display = 'block';
                });
        }
        
        function sortSongAppleMetaResults(results, searchArtist, searchTitle) {
            const normArtist = (searchArtist || '').toLowerCase().replace(/[^a-z0-9]/g, '');
            const normTitle = (searchTitle || '').toLowerCase().replace(/[^a-z0-9]/g, '');
            const fuzzyTitle = removeSongVariationKeywords(searchTitle);
            
            return results.map(item => {
                const itemArtist = (item.artistName || '').toLowerCase().replace(/[^a-z0-9]/g, '');
                const itemTitle = (item.title || '').toLowerCase().replace(/[^a-z0-9]/g, '');
                const itemTitleFuzzy = removeSongVariationKeywords(item.title);
                
                let score = 0, matchType = 'none';
                if (itemArtist === normArtist && itemTitle === normTitle) { score = 1000; matchType = 'exact'; }
                else if (itemArtist === normArtist && itemTitleFuzzy === fuzzyTitle && fuzzyTitle) { score = 950; matchType = 'fuzzy'; }
                else if (itemArtist === normArtist) { score = 500; matchType = 'artist'; }
                else if (itemTitle === normTitle) { score = 400; matchType = 'title'; }
                else if (itemArtist.includes(normArtist) || normArtist.includes(itemArtist)) { score = 200; }
                else if (itemTitle.includes(normTitle) || normTitle.includes(itemTitle)) { score = 100; }
                return { ...item, matchScore: score, matchType };
            }).sort((a, b) => b.matchScore - a.matchScore);
        }
        
        function removeSongVariationKeywords(str) {
            if (!str) return '';
            const keywords = ['remix', 'remaster', 'remastered', 'live', 'acoustic', 'radio edit', 'version', 'explicit', 'clean', 'feat', 'ft'];
            let normalized = str.toLowerCase();
            keywords.forEach(k => normalized = normalized.replace(new RegExp(k, 'gi'), ''));
            return normalized.trim().replace(/[^a-z0-9]/g, '');
        }
        
        function renderSongAppleMetaResults() {
            const resultsEl = document.getElementById('songAppleMetaResults');
            resultsEl.innerHTML = songAppleMetaSearchResults.map((item, idx) => {
                const matchClass = item.matchType === 'exact' ? 'exact-match' : item.matchType === 'fuzzy' ? 'fuzzy-match' : '';
                const matchBadge = item.matchType === 'exact' ? '<span class="match-badge exact">Exact</span>' :
                                  item.matchType === 'fuzzy' ? '<span class="match-badge fuzzy">Close</span>' : '';
                let releaseDateDisplay = '';
                if (item.releaseDate) {
                    const d = new Date(item.releaseDate + 'T00:00:00');
                    releaseDateDisplay = d.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
                }
                const metaLine = [releaseDateDisplay, item.lengthFormatted].filter(x => x).join(' ‚Ä¢ ');
                return `
                    <div class="am-result-item ${matchClass}" onclick="selectSongAppleMetaResult(${idx})" style="cursor:pointer;">
                        <span class="am-result-type">${item.type}</span>
                        ${matchBadge}
                        <img class="am-result-image" src="${item.thumbnailUrl}" alt="" loading="lazy">
                        <div class="am-result-info">
                            <div class="am-result-title" title="${escapeSongAttr(item.title)}">${escapeSongHtml(item.title)}</div>
                            <div class="am-result-artist">${escapeSongHtml(item.artistName)}</div>
                            ${item.albumName ? `<div class="am-result-album">${escapeSongHtml(item.albumName)}</div>` : ''}
                            ${metaLine ? `<div class="am-result-meta">${metaLine}</div>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function escapeSongHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function escapeSongAttr(text) {
            if (!text) return '';
            return text.replace(/"/g, '&quot;').replace(/'/g, '&#39;');
        }
        
        function selectSongAppleMetaResult(index) {
            const item = songAppleMetaSearchResults[index];
            if (!item) return;
            
            const statusEl = document.getElementById('songAppleMetadataStatus');
            const parts = [];
            
            // Set release date if available
            if (item.releaseDate) {
                const dateParts = item.releaseDate.split('-');
                if (dateParts.length === 3) {
                    const formatted = `${dateParts[2]}/${dateParts[1]}/${dateParts[0]}`;
                    document.getElementById('releaseDate').value = formatted;
                    // Trigger Flatpickr update
                    const fp = document.getElementById('releaseDate')._flatpickr;
                    if (fp) fp.setDate(formatted, true, 'd/m/Y');
                    parts.push('Release: ' + formatted);
                }
            }
            
            // Set length if available
            if (item.lengthSeconds && item.lengthFormatted) {
                const lengthSecondsEl = document.getElementById('lengthSeconds');
                const lengthFormattedEl = document.getElementById('lengthFormatted');
                if (lengthSecondsEl) lengthSecondsEl.value = item.lengthSeconds;
                if (lengthFormattedEl) lengthFormattedEl.value = item.lengthFormatted;
                parts.push('Length: ' + item.lengthFormatted);
            }
            
            // Save image via API
            if (item.fullUrl) {
                parts.push('Image...');
                fetch('/api/apple-music/save-images', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        imageUrls: [item.fullUrl],
                        entityId: songId,
                        entityType: 'song',
                        hasExistingImage: /*[[${hasImage}]]*/ false
                    })
                }).then(r => r.json()).then(data => {
                    if (data.success && statusEl) {
                        statusEl.textContent = '‚úì Selected + Image saved!';
                        statusEl.style.color = '#69db7c';
                    }
                }).catch(err => console.error('Failed to save image:', err));
            }
            
            if (statusEl) {
                statusEl.textContent = '‚úì ' + (parts.length > 0 ? parts.join(', ') : 'Selected from Apple Music');
                statusEl.style.color = '#69db7c';
            }
            
            closeSongAppleMetadataModal();
        }
        
        // ==================== Spotify Metadata Search for Song Edit ====================
        let songSpotifyMetaSearchResults = [];
        
        function openSongSpotifyMetadataSearch() {
            const artistName = /*[[${artistName}]]*/ '';
            const songName = document.getElementById('name').value || /*[[${song.name}]]*/ '';
            
            // Create modal if needed
            let modal = document.getElementById('songSpotifyMetadataModal');
            if (!modal) {
                createSongSpotifyMetadataModal();
                modal = document.getElementById('songSpotifyMetadataModal');
            }
            
            document.getElementById('songSpotifyMetaSearchInput').value = artistName + ' - ' + songName;
            document.getElementById('songSpotifyMetaResults').innerHTML = '<div style="text-align:center; color:#888; padding:40px;">Click Search to find results</div>';
            document.getElementById('songSpotifyMetaStatus').style.display = 'none';
            
            modal.style.display = 'flex';
            performSongSpotifyMetadataSearch();
        }
        
        function createSongSpotifyMetadataModal() {
            const modalHtml = `
                <div id="songSpotifyMetadataModal" class="sp-modal" onclick="if(event.target===this) closeSongSpotifyMetadataModal()">
                    <div class="sp-modal-content" onclick="event.stopPropagation()">
                        <div class="sp-modal-header">
                            <h3><span class="spotify-logo">‚óè</span> Search Spotify for Song</h3>
                            <button class="sp-modal-close" onclick="closeSongSpotifyMetadataModal()">&times;</button>
                        </div>
                        <div class="sp-modal-body">
                            <div class="sp-search-form">
                                <input type="text" id="songSpotifyMetaSearchInput" class="sp-search-input" placeholder="Artist - Song">
                                <select id="songSpotifyMetaCountrySelect" class="sp-country-select" style="width:100px;">
                                    <option value="US">üá∫üá∏ US</option>
                                    <option value="MX">üá≤üáΩ MX</option>
                                    <option value="ES">üá™üá∏ ES</option>
                                    <option value="GB">üá¨üáß UK</option>
                                </select>
                                <button type="button" class="sp-btn-search" onclick="performSongSpotifyMetadataSearch()">Search</button>
                            </div>
                            <div id="songSpotifyMetaStatus" class="sp-search-status" style="display:none;">Searching...</div>
                            <div id="songSpotifyMetaResults" class="sp-results-grid" style="display:none;"></div>
                        </div>
                        <div class="sp-modal-footer">
                            <span style="color:#888; font-size:12px;">Select an item to populate release date, length and image</span>
                            <button type="button" class="sp-btn-cancel" onclick="closeSongSpotifyMetadataModal()">Cancel</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }
        
        function closeSongSpotifyMetadataModal() {
            const modal = document.getElementById('songSpotifyMetadataModal');
            if (modal) modal.style.display = 'none';
        }
        
        function performSongSpotifyMetadataSearch() {
            const searchInput = document.getElementById('songSpotifyMetaSearchInput').value.trim();
            const market = document.getElementById('songSpotifyMetaCountrySelect').value;
            if (!searchInput) return;
            
            const statusEl = document.getElementById('songSpotifyMetaStatus');
            const resultsEl = document.getElementById('songSpotifyMetaResults');
            statusEl.style.display = 'block';
            resultsEl.style.display = 'none';
            
            const parts = searchInput.split(' - ');
            const artist = parts[0] || searchInput;
            const title = parts.length > 1 ? parts.slice(1).join(' - ') : parts[0];
            
            fetch(`/api/spotify/search?artist=${encodeURIComponent(artist)}&title=${encodeURIComponent(title)}&market=${market}`)
                .then(r => r.json())
                .then(data => {
                    statusEl.style.display = 'none';
                    if (!data || data.length === 0) {
                        resultsEl.innerHTML = '<div style="text-align:center; color:#888; padding:40px;">No results found</div>';
                        resultsEl.style.display = 'block';
                        return;
                    }
                    songSpotifyMetaSearchResults = sortSongAppleMetaResults(data, artist, title); // Reuse same sorting logic
                    renderSongSpotifyMetaResults();
                    resultsEl.style.display = 'grid';
                })
                .catch(err => {
                    statusEl.style.display = 'none';
                    resultsEl.innerHTML = '<div style="text-align:center; color:#ff6b6b; padding:40px;">Error searching Spotify</div>';
                    resultsEl.style.display = 'block';
                });
        }
        
        function renderSongSpotifyMetaResults() {
            const resultsEl = document.getElementById('songSpotifyMetaResults');
            resultsEl.innerHTML = songSpotifyMetaSearchResults.map((item, idx) => {
                const matchClass = item.matchType === 'exact' ? 'exact-match' : item.matchType === 'fuzzy' ? 'fuzzy-match' : '';
                const matchBadge = item.matchType === 'exact' ? '<span class="sp-match-badge exact">Exact</span>' :
                                  item.matchType === 'fuzzy' ? '<span class="sp-match-badge fuzzy">Close</span>' : '';
                let releaseDateDisplay = '';
                if (item.releaseDate) {
                    const d = new Date(item.releaseDate + 'T00:00:00');
                    releaseDateDisplay = d.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
                }
                const metaLine = [releaseDateDisplay, item.lengthFormatted].filter(x => x).join(' ‚Ä¢ ');
                return `
                    <div class="sp-result-item ${matchClass}" onclick="selectSongSpotifyMetaResult(${idx})" style="cursor:pointer;">
                        <span class="sp-result-type">${item.type}</span>
                        ${matchBadge}
                        <img class="sp-result-image" src="${item.thumbnailUrl}" alt="" loading="lazy">
                        <div class="sp-result-info">
                            <div class="sp-result-title" title="${escapeSongAttr(item.title)}">${escapeSongHtml(item.title)}</div>
                            <div class="sp-result-artist">${escapeSongHtml(item.artistName)}</div>
                            ${item.albumName ? `<div class="sp-result-album">${escapeSongHtml(item.albumName)}</div>` : ''}
                            ${metaLine ? `<div class="sp-result-meta">${metaLine}</div>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function selectSongSpotifyMetaResult(index) {
            const item = songSpotifyMetaSearchResults[index];
            if (!item) return;
            
            const statusEl = document.getElementById('songAppleMetadataStatus');
            const parts = [];
            
            // Set release date if available
            if (item.releaseDate) {
                const dateParts = item.releaseDate.split('-');
                if (dateParts.length === 3) {
                    const formatted = `${dateParts[2]}/${dateParts[1]}/${dateParts[0]}`;
                    document.getElementById('releaseDate').value = formatted;
                    // Trigger Flatpickr update
                    const fp = document.getElementById('releaseDate')._flatpickr;
                    if (fp) fp.setDate(formatted, true, 'd/m/Y');
                    parts.push('Release: ' + formatted);
                }
            }
            
            // Set length if available
            if (item.lengthSeconds && item.lengthFormatted) {
                const lengthSecondsEl = document.getElementById('lengthSeconds');
                const lengthFormattedEl = document.getElementById('lengthFormatted');
                if (lengthSecondsEl) lengthSecondsEl.value = item.lengthSeconds;
                if (lengthFormattedEl) lengthFormattedEl.value = item.lengthFormatted;
                parts.push('Length: ' + item.lengthFormatted);
            }
            
            // Save image via Spotify API
            if (item.fullUrl) {
                parts.push('Image...');
                fetch('/api/spotify/save-images', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        imageUrls: [item.fullUrl],
                        entityId: songId,
                        entityType: 'song',
                        hasExistingImage: /*[[${hasImage}]]*/ false
                    })
                }).then(r => r.json()).then(data => {
                    if (data.success && statusEl) {
                        statusEl.textContent = '‚úì From Spotify + Image saved!';
                        statusEl.style.color = '#1DB954';
                    }
                }).catch(err => console.error('Failed to save image:', err));
            }
            
            if (statusEl) {
                statusEl.textContent = '‚úì From Spotify: ' + (parts.length > 0 ? parts.join(', ') : 'Selected');
                statusEl.style.color = '#1DB954';
            }
            
            closeSongSpotifyMetadataModal();
        }
    </script>
</body>
</html>