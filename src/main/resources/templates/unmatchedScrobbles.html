<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Unmatched Scrobbles</title>
    <link rel="stylesheet" th:href="@{/css/global.css}" />
    <th:block th:replace="~{fragments/navigation :: nav-styles}"></th:block>
    <th:block th:replace="~{fragments/unmatched-scrobbles-modal :: modal-styles}"></th:block>
    <style>
        .content-card { max-width: 1200px; margin: 24px 0; padding: 20px; background: var(--surface); border: 1px solid rgba(255,255,255,0.06); border-radius: var(--radius); box-shadow: var(--shadow); }
        .hint { color: var(--text-muted); font-size: 14px; margin-bottom: 16px; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 8px 10px; border-bottom: 1px solid rgba(255,255,255,0.06); text-align: left; }
        th { color: var(--text-muted); font-weight: 600; }
        .count { text-align: right; font-weight: 700; }
        .filters { display:flex; gap:12px; align-items:center; margin-bottom:12px }
        .filters label { color: var(--text-muted); font-size: 13px; }
        .action-col { width: 220px; text-align: center; white-space: nowrap; }
        .action-col .btn { padding: 4px 8px; font-size: 11px; margin: 0 2px; }
        .btn-delete { background: transparent; border: 1px solid #dc3545; color: #dc3545; }
        .btn-delete:hover { background: #dc3545; color: white; }
        
        /* Clickable links in table */
        td a { transition: color 0.2s ease; }
        td a:hover { color: #60a5fa !important; text-decoration: underline !important; }
        
        /* Delete confirmation modal */
        .delete-modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: none; justify-content: center; align-items: center; z-index: 2000; }
        .delete-modal-overlay.active { display: flex; }
        .delete-modal { background: var(--surface); border: 2px solid #dc3545; border-radius: var(--radius); padding: 24px; max-width: 500px; width: 90%; }
        .delete-modal h3 { color: #dc3545; margin: 0 0 16px 0; display: flex; align-items: center; gap: 8px; }
        .delete-modal .warning-icon { font-size: 24px; }
        .delete-modal .scrobble-info { background: rgba(220,53,69,0.1); border: 1px solid rgba(220,53,69,0.3); border-radius: 4px; padding: 12px; margin: 12px 0; font-size: 13px; }
        .delete-modal .scrobble-info p { margin: 4px 0; }
        .delete-modal .scrobble-info strong { color: var(--text-muted); }
        .delete-modal .warning-text { color: #dc3545; font-weight: 600; margin: 16px 0; }
        .delete-modal .btn-row { display: flex; gap: 12px; justify-content: flex-end; margin-top: 20px; }
        .delete-modal .btn-cancel { background: var(--surface-raised); border: 1px solid rgba(255,255,255,0.1); color: var(--text); padding: 8px 16px; border-radius: 4px; cursor: pointer; }
        .delete-modal .btn-confirm-delete { background: #dc3545; border: none; color: white; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-weight: 600; }
        .delete-modal .btn-confirm-delete:hover { background: #c82333; }
        .delete-modal .btn-confirm-delete:disabled { opacity: 0.5; cursor: not-allowed; }
        .delete-modal .final-confirm { margin-top: 16px; padding-top: 16px; border-top: 1px solid rgba(220,53,69,0.3); }
        .delete-modal .checkbox-row { display: flex; align-items: center; gap: 8px; margin-bottom: 12px; }
        .delete-modal .checkbox-row input { width: 18px; height: 18px; accent-color: #dc3545; }
        .delete-modal .checkbox-row label { color: #dc3545; font-weight: 500; }
    </style>
</head>
<body>
    <th:block th:replace="~{fragments/navigation :: navigation}"></th:block>

    <main class="container" style="padding-left: 60px; margin-left: 0; margin-right: auto;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin: 24px 0 16px;">
            <div>
                <h1 style="margin: 0; font-size: 28px; font-weight: 650;">Unmatched Scrobbles</h1>
                <p style="margin: 8px 0 0; color: var(--text-muted); font-size: 14px;">
                    <span th:text="${totalUnmatchedCount}">0</span> total scrobbles in 
                    <span th:text="${unmatchedGroupCount}">0</span> groups
                </p>
            </div>
            
            <!-- Filter form: choose account -> submit GET to same endpoint -->
            <form method="get" th:action="@{/scrobbles/unmatched}" style="display: flex; gap: 8px; align-items: center;">
                <label for="accountSelect" style="color: var(--text-muted); font-size: 13px;">Account:</label>
                <select id="accountSelect" name="account" th:onchange="this.form.submit()">
                    <option value="" th:selected="${selectedAccount == ''}">All accounts</option>
                    <option th:if="${#lists.contains(accounts, '')}" value="__BLANK__" th:selected="${selectedAccount == '__BLANK__'}">(blank)</option>
                    <option th:each="acc : ${accounts}" th:if="${acc != ''}"
                            th:value="${acc}"
                            th:text="${acc}"
                            th:selected="${acc == selectedAccount}">
                    </option>
                </select>
                <noscript><button type="submit" class="btn btn-primary">Filter</button></noscript>
            </form>
        </div>
        
        <div class="content-card">
            <p class="hint">List of scrobbles (account / artist / album / song) that do not have a matched song_id, ordered by frequency. Use <strong>Create</strong> to add new artist/album/song, or <strong>Match</strong> to link to an existing song.</p>

            <div th:if="${unmatched == null or #lists.isEmpty(unmatched)}">
                <p>No unmatched scrobbles found.</p>
            </div>

            <div th:if="${unmatched != null and !#lists.isEmpty(unmatched)}">
                <table>
                    <thead>
                        <tr>
                            <th style="width:32px"><input type="checkbox" autocomplete="off" id="selectAllCheckbox" onchange="toggleSelectAll(this)"></th>
                            <th>Account</th>
                            <th>Artist</th>
                            <th>Album</th>
                            <th>Song</th>
                            <th class="count">Count</th>
                            <th class="action-col">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="unmatchedTableBody">
                        <tr th:each="row, iter : ${unmatched}" th:data-index="${iter.index}">
                            <td><input type="checkbox" autocomplete="off" class="rowCheckbox" th:data-index="${iter.index}" onchange="toggleRowSelection(this)"></td>
                            <td th:text="${row.account}">account</td>
                            <td>
                                <a th:href="@{/artists(q=${row.artist})}" 
                                   th:text="${row.artist}"
                                   target="_blank"
                                   style="color: inherit; text-decoration: none;">Artist</a>
                            </td>
                            <td>
                                <a th:href="@{/albums(q=${row.album})}" 
                                   th:text="${row.album}"
                                   target="_blank"
                                   style="color: inherit; text-decoration: none;">Album</a>
                            </td>
                            <td>
                                <a th:href="@{/songs(q=${row.song})}" 
                                   th:text="${row.song}"
                                   target="_blank"
                                   style="color: inherit; text-decoration: none;">Song</a>
                            </td>
                            <td class="count" th:text="${row.cnt}">0</td>
                            <td class="action-col">
                                <button class="btn btn-action" 
                                        th:data-index="${iter.index}"
                                        onclick="openCreateWizardFromTable(this.dataset.index)">
                                    Create
                                </button>
                                <button class="btn btn-secondary" 
                                        th:data-index="${iter.index}"
                                        onclick="openMatchModalFromTable(this.dataset.index)">
                                    Match
                                </button>
                                <button class="btn btn-delete" 
                                        th:data-index="${iter.index}"
                                        onclick="openDeleteConfirmation(this.dataset.index)">
                                    Delete
                                </button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div style="margin-top:12px; display:flex; gap:8px; align-items:center">
                <button id="bulkDeleteBtn" class="btn btn-delete" style="padding:6px 10px;" disabled onclick="openBulkDeleteConfirmation()">Delete Selected</button>
                <span id="selectedCountHint" style="color:var(--text-muted); font-size:13px;">0 selected</span>
            </div>

            <div style="margin-top:12px">
            </div>
        </div>
    </main>
    
    <!-- Include shared modal fragments -->
    <th:block th:replace="~{fragments/unmatched-scrobbles-modal :: create-wizard-modal}"></th:block>
    <th:block th:replace="~{fragments/unmatched-scrobbles-modal :: match-modal}"></th:block>
    
    <!-- Include shared modal scripts -->
    <th:block th:replace="~{fragments/unmatched-scrobbles-modal :: modal-scripts}"></th:block>
    
    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="delete-modal-overlay">
        <div class="delete-modal">
            <h3><span class="warning-icon">⚠️</span> Delete Scrobbles</h3>
            <p>You are about to permanently delete the following scrobbles:</p>
            <div class="scrobble-info">
                <p><strong>Account:</strong> <span id="deleteAccount">-</span></p>
                <p><strong>Artist:</strong> <span id="deleteArtist">-</span></p>
                <p><strong>Album:</strong> <span id="deleteAlbum">-</span></p>
                <p><strong>Song:</strong> <span id="deleteSong">-</span></p>
                <p><strong>Count:</strong> <span id="deleteCount">0</span> scrobbles</p>
            </div>
            <p class="warning-text">⚠️ This action cannot be undone! These scrobbles will be permanently deleted from the database.</p>
            
            <div class="final-confirm">
                <div class="checkbox-row">
                    <input type="checkbox" autocomplete="off" id="confirmDeleteCheckbox" onchange="updateDeleteButtonState()">
                    <label for="confirmDeleteCheckbox">I understand this is permanent and want to delete these scrobbles</label>
                </div>
            </div>
            
            <div class="btn-row">
                <button class="btn-cancel" onclick="closeDeleteModal()">Cancel</button>
                <button class="btn-confirm-delete" id="confirmDeleteBtn" disabled onclick="executeDelete()">Delete Permanently</button>
            </div>
        </div>
    </div>
    
    <!-- Bulk Delete Confirmation Modal -->
    <div id="bulkDeleteModal" class="delete-modal-overlay">
        <div class="delete-modal">
            <h3><span class="warning-icon">⚠️</span> Delete Selected Scrobbles</h3>
            <p>You are about to permanently delete the following selected scrobble groups:</p>
            <div class="scrobble-info" id="bulkScrobbleList" style="max-height:220px; overflow:auto;"></div>
            <p class="warning-text">⚠️ This action cannot be undone! These scrobbles will be permanently deleted from the database.</p>
            <div class="final-confirm">
                <div class="checkbox-row">
                    <input type="checkbox" autocomplete="off" id="confirmBulkDeleteCheckbox" onchange="updateBulkDeleteButtonState()">
                    <label for="confirmBulkDeleteCheckbox">I understand this is permanent and want to delete these scrobbles</label>
                </div>
            </div>
            <div class="btn-row">
                <button class="btn-cancel" onclick="closeBulkDeleteModal()">Cancel</button>
                <button class="btn-confirm-delete" id="confirmBulkDeleteBtn" disabled onclick="executeBulkDelete()">Delete Permanently</button>
            </div>
        </div>
    </div>
    
    <script th:inline="javascript">
        // Initialize unmatched list from server data
        const unmatchedFromServer = /*[[${unmatched}]]*/ [];
        unmatchedList = unmatchedFromServer.map(row => ({
            artist: row.artist || '',
            album: row.album || '',
            song: row.song || '',
            account: row.account || '',
            cnt: row.cnt || 0
        }));
        
        let deleteTargetIndex = null;
        
        function openCreateWizardFromTable(index) {
            openCreateWizard(parseInt(index));
        }
        
        function openMatchModalFromTable(index) {
            openMatchModal(parseInt(index));
        }
        
        function openDeleteConfirmation(index) {
            deleteTargetIndex = parseInt(index);
            const row = unmatchedList[deleteTargetIndex];
            
            document.getElementById('deleteAccount').textContent = row.account || '(blank)';
            document.getElementById('deleteArtist').textContent = row.artist || '(blank)';
            document.getElementById('deleteAlbum').textContent = row.album || '(blank)';
            document.getElementById('deleteSong').textContent = row.song || '(blank)';
            document.getElementById('deleteCount').textContent = row.cnt;
            
            // Reset confirmation state
            document.getElementById('confirmDeleteCheckbox').checked = false;
            document.getElementById('confirmDeleteBtn').disabled = true;
            
            document.getElementById('deleteModal').classList.add('active');
        }
        
        function closeDeleteModal() {
            document.getElementById('deleteModal').classList.remove('active');
            deleteTargetIndex = null;
        }
        
        function updateDeleteButtonState() {
            const checkbox = document.getElementById('confirmDeleteCheckbox');
            document.getElementById('confirmDeleteBtn').disabled = !checkbox.checked;
        }
        
        async function executeDelete() {
            if (deleteTargetIndex === null) return;
            
            const row = unmatchedList[deleteTargetIndex];
            const btn = document.getElementById('confirmDeleteBtn');
            btn.disabled = true;
            btn.textContent = 'Deleting...';
            
            try {
                const response = await fetch('/scrobbles/api/unmatched', {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        account: row.account,
                        artist: row.artist,
                        album: row.album,
                        song: row.song
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    closeDeleteModal();
                    location.reload();
                } else {
                    alert('Error deleting scrobbles: ' + (result.error || 'Unknown error'));
                    btn.disabled = false;
                    btn.textContent = 'Delete Permanently';
                }
            } catch (err) {
                alert('Error deleting scrobbles: ' + err.message);
                btn.disabled = false;
                btn.textContent = 'Delete Permanently';
            }
        }
        
        // Selection tracking for bulk actions
        const selectedIndices = new Set();

        function toggleRowSelection(checkbox) {
            const idx = parseInt(checkbox.dataset.index);
            if (checkbox.checked) selectedIndices.add(idx); else selectedIndices.delete(idx);
            updateSelectedCount();
        }

        function toggleSelectAll(master) {
            const checks = document.querySelectorAll('.rowCheckbox');
            checks.forEach(cb => { cb.checked = master.checked; const idx = parseInt(cb.dataset.index); if (master.checked) selectedIndices.add(idx); else selectedIndices.delete(idx); });
            updateSelectedCount();
        }

        function updateSelectedCount() {
            const count = selectedIndices.size;
            document.getElementById('selectedCountHint').textContent = count + ' selected';
            document.getElementById('bulkDeleteBtn').disabled = count === 0;
            const master = document.getElementById('selectAllCheckbox');
            if (master) {
                const total = document.querySelectorAll('.rowCheckbox').length;
                master.checked = total > 0 && count === total;
            }
        }

        function openBulkDeleteConfirmation() {
            if (selectedIndices.size === 0) return;
            const listEl = document.getElementById('bulkScrobbleList');
            listEl.innerHTML = '';
            const items = Array.from(selectedIndices).sort();
            let totalCount = 0;
            items.forEach(i => {
                const row = unmatchedList[i];
                totalCount += row.cnt || 0;
                const p = document.createElement('p');
                p.style.margin = '6px 0';
                p.textContent = `${row.account || '(blank)'} / ${row.artist || '(blank)'} / ${row.album || '(blank)'} / ${row.song || '(blank)'} — ${row.cnt || 0}`;
                listEl.appendChild(p);
            });
            document.getElementById('confirmBulkDeleteCheckbox').checked = false;
            document.getElementById('confirmBulkDeleteBtn').disabled = true;
            document.getElementById('bulkDeleteModal').classList.add('active');
        }

        function closeBulkDeleteModal() {
            document.getElementById('bulkDeleteModal').classList.remove('active');
        }

        function updateBulkDeleteButtonState() {
            const checkbox = document.getElementById('confirmBulkDeleteCheckbox');
            document.getElementById('confirmBulkDeleteBtn').disabled = !checkbox.checked;
        }

        async function executeBulkDelete() {
            const btn = document.getElementById('confirmBulkDeleteBtn');
            btn.disabled = true; btn.textContent = 'Deleting...';
            try {
                const items = Array.from(selectedIndices).map(i => unmatchedList[i]).map(r => ({ account: r.account, artist: r.artist, album: r.album, song: r.song }));
                const response = await fetch('/scrobbles/api/unmatched/delete-selected', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ items })
                });
                const result = await response.json();
                if (result.success) {
                    closeBulkDeleteModal();
                    location.reload();
                } else {
                    alert('Error deleting scrobbles: ' + (result.error || 'Unknown error'));
                    btn.disabled = false; btn.textContent = 'Delete Permanently';
                }
            } catch (err) {
                alert('Error deleting scrobbles: ' + err.message);
                btn.disabled = false; btn.textContent = 'Delete Permanently';
            }
        }

        // Close modal on escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                if (document.getElementById('deleteModal').classList.contains('active')) closeDeleteModal();
                if (document.getElementById('bulkDeleteModal').classList.contains('active')) closeBulkDeleteModal();
            }
        });
        
        // Override refreshUnmatchedList to reload page for /unmatched
        const originalRefreshUnmatchedList = refreshUnmatchedList;
        refreshUnmatchedList = function() {
            // For the /unmatched page, just reload to get fresh data from DB
            location.reload();
        };
    </script>
</body>
</html>
